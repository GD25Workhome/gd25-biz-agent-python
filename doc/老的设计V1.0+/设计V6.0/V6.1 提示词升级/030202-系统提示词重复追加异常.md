# 系统提示词重复追加异常修复方案

## 一、问题描述

### 1.1 问题现象

在实施方案三（LangGraph 系统消息机制）后，发现系统提示词（role=system）在 Langfuse 中被记录了两次，导致：
- Langfuse 中每条 LLM 调用记录包含两条系统消息
- 系统消息内容可能不一致（一条包含未填充的占位符，一条包含已填充的完整提示词）
- 影响可观测性和调试效率

### 1.2 问题影响

1. **可观测性影响**：Langfuse 中的消息列表不准确，难以分析实际的 LLM 输入
2. **调试困难**：需要手动识别哪条系统消息是实际使用的
3. **Token 统计偏差**：可能导致 Token 统计不准确（如果 Langfuse 统计了重复的系统消息）

## 二、问题根因分析

### 2.1 代码执行流程

#### 阶段一：Agent 创建时（`domain/agents/factory.py:272-276`）

```python
# 4. 创建 ReAct Agent
return create_react_agent(
    model=llm,
    tools=tools,
    prompt=system_prompt  # 包含未填充占位符的提示词
)
```

**行为**：
- `create_react_agent` 会将 `prompt` 参数转换为 `SystemMessage`
- 在每次调用 Agent 时，系统消息会被**自动插入**到消息列表的开头
- 此时系统消息可能包含未填充的占位符（如 `{{user_id}}`, `{{session_id}}`）

#### 阶段二：运行时调用（`domain/router/graph.py:183-194`）

```python
# 4. 创建系统消息（包含完整的上下文信息）
system_message = SystemMessage(content=filled_prompt)

# 5. 处理消息列表：移除旧的系统消息（如果存在），添加新的系统消息
filtered_messages = [
    msg for msg in messages
    if not isinstance(msg, SystemMessage) or
    not (hasattr(msg, 'content') and '{{' in str(msg.content))
]

# 在消息列表开头插入新的系统消息
messages_with_context = [system_message] + filtered_messages

# 6. 调用 Agent
result = await agent_node.ainvoke({"messages": messages_with_context})
```

**行为**：
- 创建新的 `SystemMessage`，包含已填充所有占位符的完整提示词
- 移除消息列表中包含占位符的旧系统消息
- 在消息列表开头插入新的系统消息
- 调用 Agent

### 2.2 问题根源

**核心问题**：`create_react_agent` 在内部会自动将创建时传入的 `prompt` 转换为 `SystemMessage` 并添加到消息列表，即使我们在运行时已经手动添加了系统消息，`create_react_agent` 仍然会在内部自动添加，导致系统消息被添加了两次：

1. **第一次**：`create_react_agent` 内部自动添加（基于创建时的 `prompt` 参数，可能包含未填充的占位符）
2. **第二次**：运行时手动添加（已填充所有占位符的完整系统消息）

### 2.3 验证方法

在 Langfuse 中检查 LLM 调用记录：
- 打开任意一条 LLM 调用记录
- 查看消息列表（Messages）
- 发现存在两条 `role=system` 的消息
- 其中一条可能包含未填充的占位符（如 `{{user_id}}`）
- 另一条包含已填充的完整提示词

## 三、解决方案

### 3.1 方案选择

**方案 A：在 Agent 创建时不传入 `prompt` 参数（推荐）**

**核心思路**：不在 Agent 创建时传入 `prompt`，完全由运行时动态注入系统消息。

**优点**：
1. ✅ **架构清晰**：系统消息完全由运行时控制，避免双重添加
2. ✅ **更灵活**：可以根据不同的 state 生成不同的系统消息
3. ✅ **符合方案三的设计理念**：运行时动态注入系统消息
4. ✅ **易于维护**：职责清晰，Agent 创建只负责创建 Agent 实例，不涉及系统消息

**缺点**：
- 需要修改 Agent 创建逻辑（影响较小）

**方案 B：在运行时移除 `create_react_agent` 自动添加的系统消息**

**核心思路**：在调用 Agent 后，从返回结果中移除自动添加的系统消息。

**缺点**：
- 实现复杂，需要识别和过滤系统消息
- 可能影响其他功能（如 checkpointer 机制）
- 不符合方案三的设计理念

### 3.2 推荐方案：方案 A

**实施步骤**：

1. **修改 Agent 创建逻辑**（`domain/agents/factory.py`）
   - 移除 `create_react_agent` 调用中的 `prompt` 参数
   - 保留提示词加载逻辑（用于运行时使用）

2. **验证运行时系统消息注入**
   - 确保 `domain/router/graph.py` 中的 `with_user_context` 正确注入系统消息
   - 验证系统消息内容完整且占位符已填充

3. **测试验证**
   - 验证 Langfuse 中每条 LLM 调用只有一条系统消息
   - 验证系统消息内容正确（已填充所有占位符）
   - 验证 Agent 功能正常

## 四、API 升级方案

### 4.1 API 过时问题

在实施修复方案时，发现 `create_react_agent` 接口已经过时：

**当前代码**（`domain/agents/factory.py:12`）：
```python
from langgraph.prebuilt import create_react_agent
```

**过时警告**：
```
create_react_agent has been moved to `langchain.agents`. 
Please update your import to `from langchain.agents import create_agent`.
```

### 4.2 新 API 说明

**新接口位置**：`langchain.agents.create_agent`

**API 变更**：
- 函数名从 `create_react_agent` 变更为 `create_agent`
- 导入路径从 `langgraph.prebuilt` 变更为 `langchain.agents`
- 参数和返回值保持一致（向后兼容）

**新 API 使用方式**：
```python
from langchain.agents import create_agent

agent = create_agent(
    model=llm,
    tools=tools,
    prompt=system_prompt  # 可选，如果不在创建时传入，则在运行时动态注入
)
```

### 4.3 升级方案

**方案一：直接升级到新 API（推荐）**

在修复系统消息重复问题的同时，升级到新 API：

```python
# 修改前
from langgraph.prebuilt import create_react_agent

return create_react_agent(
    model=llm,
    tools=tools,
    prompt=system_prompt  # 移除此参数
)

# 修改后
from langchain.agents import create_agent

return create_agent(
    model=llm,
    tools=tools,
    # 不传入 prompt，由运行时动态注入
)
```

**方案二：分步升级**

1. 先修复系统消息重复问题（移除 `prompt` 参数，但保留旧 API）
2. 再升级到新 API（修改导入路径和函数名）

**推荐方案一**：一次性完成两个修复，减少代码变更次数。

## 五、实施计划

### 5.1 代码修改清单

#### 5.1.1 修改 `domain/agents/factory.py`

**修改点 1：更新导入语句**

```python
# 修改前
from langgraph.prebuilt import create_react_agent

# 修改后
from langchain.agents import create_agent
```

**修改点 2：更新函数调用**

```python
# 修改前（第 271-276 行）
# 4. 创建 ReAct Agent
return create_react_agent(
    model=llm,
    tools=tools,
    prompt=system_prompt
)

# 修改后
# 4. 创建 ReAct Agent（不传入 prompt，由运行时动态注入系统消息）
# 注意：system_prompt 仍然需要加载，用于运行时填充占位符
return create_agent(
    model=llm,
    tools=tools,
    # 不传入 prompt 参数，避免 create_agent 自动添加系统消息
    # 系统消息将在运行时（domain/router/graph.py:with_user_context）动态注入
)
```

**修改点 3：更新注释和文档字符串**

- 更新相关注释，说明不再在创建时传入 `prompt`
- 说明系统消息由运行时动态注入

#### 5.1.2 验证 `domain/router/graph.py`

确保 `with_user_context` 函数正确实现系统消息注入（无需修改，当前实现已正确）：

```python
# 当前实现已正确，无需修改
# 4. 创建系统消息（包含完整的上下文信息）
system_message = SystemMessage(content=filled_prompt)

# 5. 处理消息列表：移除旧的系统消息（如果存在），添加新的系统消息
filtered_messages = [
    msg for msg in messages
    if not isinstance(msg, SystemMessage) or
    not (hasattr(msg, 'content') and '{{' in str(msg.content))
]

# 在消息列表开头插入新的系统消息
messages_with_context = [system_message] + filtered_messages
```

### 5.2 测试验证

#### 5.2.1 单元测试

1. **测试 Agent 创建**
   - 验证 Agent 可以正常创建（不传入 `prompt`）
   - 验证 Agent 功能正常

2. **测试系统消息注入**
   - 验证运行时系统消息正确注入
   - 验证占位符正确填充

#### 5.2.2 集成测试

1. **端到端测试**
   - 发送聊天请求
   - 验证 Agent 正常响应
   - 验证系统消息正确注入

2. **Langfuse 验证**
   - 检查 Langfuse 中的 LLM 调用记录
   - 验证每条调用只有一条系统消息（role=system）
   - 验证系统消息内容正确（已填充所有占位符）
   - 验证没有未填充的占位符（如 `{{user_id}}`）

#### 5.2.3 回归测试

1. **功能回归**
   - 验证所有 Agent 功能正常
   - 验证多轮对话正常
   - 验证占位符填充正常

2. **性能回归**
   - 验证 Agent 创建性能（应该不受影响）
   - 验证运行时性能（应该不受影响或略有提升）

### 5.3 风险评估

#### 5.3.1 技术风险

1. **API 兼容性风险**
   - 风险：新 API 可能与旧 API 有细微差异
   - 缓解：新 API 设计为向后兼容，参数和返回值保持一致
   - 验证：通过单元测试和集成测试验证

2. **系统消息注入风险**
   - 风险：移除 `prompt` 参数后，如果运行时注入失败，Agent 可能没有系统消息
   - 缓解：运行时注入逻辑已经实现并测试，风险较低
   - 验证：通过集成测试验证系统消息正确注入

#### 5.3.2 业务风险

1. **功能影响风险**
   - 风险：修改后可能影响 Agent 功能
   - 缓解：修改范围小，只涉及 Agent 创建逻辑，不影响运行时逻辑
   - 验证：通过回归测试验证

2. **性能影响风险**
   - 风险：修改后可能影响性能
   - 缓解：移除 `prompt` 参数可能略微提升 Agent 创建性能（减少一次系统消息转换）
   - 验证：通过性能测试验证

### 5.4 回滚方案

如果修改后出现问题，可以快速回滚：

1. **回滚代码**
   - 恢复 `domain/agents/factory.py` 中的导入和函数调用
   - 恢复 `prompt` 参数传入

2. **回滚验证**
   - 验证 Agent 功能恢复正常
   - 验证 Langfuse 记录恢复正常（虽然会有重复，但不影响功能）

## 六、实施步骤

### 6.1 第一步：代码修改

1. 修改 `domain/agents/factory.py`：
   - 更新导入语句：`from langchain.agents import create_agent`
   - 更新函数调用：`create_agent(model=llm, tools=tools)`（移除 `prompt` 参数）
   - 更新相关注释

### 6.2 第二步：本地测试

1. 运行单元测试，验证 Agent 创建正常
2. 运行集成测试，验证系统消息注入正常
3. 检查 Langfuse，验证系统消息不再重复

### 6.3 第三步：代码审查

1. 提交代码变更
2. 进行代码审查
3. 根据审查意见调整代码

### 6.4 第四步：部署验证

1. 部署到测试环境
2. 进行端到端测试
3. 验证 Langfuse 记录正常
4. 验证 Agent 功能正常

### 6.5 第五步：生产部署

1. 部署到生产环境
2. 监控系统运行情况
3. 验证 Langfuse 记录正常
4. 收集反馈并优化

## 七、预期效果

### 7.1 问题解决

1. ✅ **系统消息不再重复**：Langfuse 中每条 LLM 调用只有一条系统消息
2. ✅ **系统消息内容正确**：系统消息包含已填充所有占位符的完整提示词
3. ✅ **API 升级完成**：使用新 API，避免过时警告

### 7.2 架构改进

1. ✅ **职责更清晰**：Agent 创建只负责创建 Agent 实例，系统消息由运行时注入
2. ✅ **更符合方案三设计**：运行时动态注入系统消息，灵活可控
3. ✅ **代码更简洁**：移除不必要的 `prompt` 参数传递

### 7.3 可维护性提升

1. ✅ **易于理解**：系统消息注入逻辑集中在一处（`with_user_context`）
2. ✅ **易于调试**：系统消息内容可以在运行时查看和验证
3. ✅ **易于扩展**：可以轻松支持更复杂的系统消息生成逻辑

## 八、总结

本方案通过以下两个关键修改解决了系统提示词重复追加的问题：

1. **移除 Agent 创建时的 `prompt` 参数**：避免 `create_agent` 自动添加系统消息
2. **升级到新 API**：使用 `langchain.agents.create_agent` 替代过时的 `langgraph.prebuilt.create_react_agent`

修改后，系统消息将仅在运行时动态注入一次，确保 Langfuse 中每条 LLM 调用只有一条系统消息，且内容正确完整。

**优先级**：高（推荐立即实施）

**预计工作量**：1-2 天（包括代码修改、测试验证、文档更新）

