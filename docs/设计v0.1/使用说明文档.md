# GD25 Biz Agent Python 使用说明文档 (v0.2)

## 1. 环境准备

### 1.1 系统要求
- Python 3.10+
- PostgreSQL 15+ (需安装 `pgvector` 插件)
- Redis (可选)

### 1.2 安装依赖
```bash
pip install -r requirements.txt
```

### 1.3 配置环境变量
复制示例配置文件并编辑：
```bash
cp .env.example .env
```

**关键配置项 (.env)**:
```ini
# 数据库配置 (需确保数据库已创建且安装了 vector 插件)
DB_HOST=localhost
DB_PORT=5433
DB_USER=postgres
DB_PASSWORD=your_password
DB_NAME=doctor_agent_db

# LLM 配置 (支持 OpenAI 兼容接口)
OPENAI_API_KEY=sk-xxxxxxxx
OPENAI_BASE_URL=https://api.deepseek.com/v1  # 或其他服务商
LLM_MODEL=deepseek-chat

# RAG 配置 (默认使用本地模型)
USE_LOCAL_EMBEDDING=True
EMBEDDING_MODEL=moka-ai/m3e-base
HF_ENDPOINT=https://hf-mirror.com
```

### 1.4 初始化数据库
```bash
# 1. 创建数据库
psql -U postgres -c "CREATE DATABASE gd25_agent;"

# 2. 运行迁移 (自动创建表结构和向量扩展)
python -m alembic upgrade head
```

---

### 1.5 功能测试指南

#### 1. RAG 知识库测试
*注: 首次运行时会自动下载 Embedding 模型 (约 700MB)，请耐心等待。*
```bash
# 验证脚本 (自动写入测试数据并查询)
python -m scripts.verify_milestones
```
**预期输出**:
- Terminal 显示 "Successfully loaded embedding model..."
- "Found 1 relevant documents"
- 没有任何 404 报错。

---

## 3. 启动服务

### 3.1 启动 API 服务
```bash
python -m app.main
```
服务默认运行在 `http://localhost:8000`。

### 3.2 接口文档
启动服务后，访问 `http://localhost:8000/docs` 查看 Swagger UI。

---

## 4. 功能测试指南

### 4.1 场景一：血压管理 (Blood Pressure Agent)
**目标**: 记录血压并查询历史。

**Step 1: 记录血压**
```bash
curl -X POST "http://localhost:8000/api/v1/chat" \
     -H "Content-Type: application/json" \
     -d '{
           "message": "我今天的高压是130，低压85，心率72",
           "session_id": "test-session-bp",
           "user_id": "user-001"
         }'
```
**预期响应**: Agent 调用 `add_blood_pressure` 工具，返回“已成功记录...”。

**Step 2: 查询历史**
```bash
curl -X POST "http://localhost:8000/api/v1/chat" \
     -H "Content-Type: application/json" \
     -d '{
           "message": "我最近的血压记录怎么样？",
           "session_id": "test-session-bp",
           "user_id": "user-001"
         }'
```
**预期响应**: Agent 调用 `query_blood_pressure_history` 工具，列出最近的记录。

### 4.2 场景二：医疗咨询 (Diagnosis Agent + RAG)
**目标**: 基于知识库回答医学问题。

**前提**: 知识库中需有相关数据（验证脚本会自动插入一条关于“高血压”的数据）。

**测试请求**:
```bash
curl -X POST "http://localhost:8000/api/v1/chat" \
     -H "Content-Type: application/json" \
     -d '{
           "message": "什么是高血压？有什么症状？",
           "session_id": "test-session-diag",
           "user_id": "user-001"
         }'
```
**预期响应**: 
1. Supervisor 识别意图，路由至 `DiagnosisAgent`。
2. Agent 调用 `search_knowledge_base` 检索“高血压”。
3. Agent 基于检索到的内容（如收缩压≥140等标准）回答用户。

---

## 5. 常见问题 (Troubleshooting)

1.  **Alembic Migration 失败**:
    *   确保本地 PG 已安装 `pgvector` (`brew install pgvector` 或源码安装)。
    *   检查 `alembic/env.py` 中的 DB URL 是否正确。

2.  **RAG 检索报错 (404/401)**:
    *   通常是 Embedding 模型配置问题。DeepSeek 官方 API 某些版本不支持 Embedding，建议使用 OpenAI 官方 Key 或 SiliconFlow/DashScope 等兼容接口。

3.  **Docker Compose**:
    *   本项目已移除 `docker-compose.yml`，改为直连本地数据库。如需 Docker 环境，请参考旧版文档自行配置。
