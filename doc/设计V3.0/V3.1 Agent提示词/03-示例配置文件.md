# 提示词管理方案 - 示例配置文件

本文档提供提示词管理方案的示例配置文件，帮助理解和使用该方案。

## 一、模板配置文件示例

### 1.1 血压智能体模板配置

```yaml
# config/prompts/templates/blood_pressure_agent.yaml
agent_key: blood_pressure_agent
version: 1.0.0
description: "血压记录智能体提示词模板"

modules:
  # ========== 必需模块 ==========
  
  # Agent职责
  role:
    type: required
    loader: config
    source: config/prompts/modules/blood_pressure/role.txt
    enabled: true
  
  # 返回消息格式
  response_format:
    type: required
    loader: config
    source: config/prompts/modules/blood_pressure/response_format.txt
    enabled: true
  
  # ========== 可选模块 ==========
  
  # 用户信息（动态加载）
  user_info:
    type: optional
    loader: dynamic
    source: runtime
    enabled: true
    condition: "{user_id is not None}"
    template: |
      系统提供的用户ID：{user_id}。
      已收集字段：{collected_fields}。
      待补全字段（必填优先）：{missing_fields}。
      请只询问缺失字段，字段齐全时直接调用 record_blood_pressure 工具，不要重复询问已提供的数据。
  
  # 参考文章（预留，当前版本不实现）
  reference_articles:
    type: optional
    loader: database
    source: database://rag/articles/blood_pressure
    enabled: false
    description: "从RAG系统加载相关参考文章（预留功能）"
  
  # 回答样本（Few-shot）
  few_shot_examples:
    type: optional
    loader: config
    source: config/prompts/modules/blood_pressure/few_shot_examples.txt
    enabled: true
  
  # ========== 业务模块 ==========
  
  # 功能说明
  function_description:
    type: business
    loader: config
    source: config/prompts/modules/blood_pressure/function_description.txt
    enabled: true
  
  # 数据完整性检查
  data_validation:
    type: business
    loader: config
    source: config/prompts/modules/blood_pressure/data_validation.txt
    enabled: true
  
  # 澄清机制
  clarification:
    type: business
    loader: config
    source: config/prompts/modules/blood_pressure/clarification.txt
    enabled: true
  
  # 注意事项
  notes:
    type: business
    loader: config
    source: config/prompts/modules/blood_pressure/notes.txt
    enabled: true

# 模板组合规则
composition:
  # 模块组合顺序
  order:
    - role
    - function_description
    - data_validation
    - clarification
    - response_format
    - user_info  # 动态模块，根据条件注入
    - few_shot_examples
    - notes
  # 模块之间的分隔符
  separator: "\n\n"
  # 是否在开头添加分隔符
  prefix: false
  # 是否在结尾添加分隔符
  suffix: false
```

### 1.2 预约智能体模板配置

```yaml
# config/prompts/templates/appointment_agent.yaml
agent_key: appointment_agent
version: 1.0.0
description: "复诊管理智能体提示词模板"

modules:
  # 必需模块
  role:
    type: required
    loader: config
    source: config/prompts/modules/appointment/role.txt
    enabled: true
  
  response_format:
    type: required
    loader: config
    source: config/prompts/modules/appointment/response_format.txt
    enabled: true
  
  # 可选模块
  user_info:
    type: optional
    loader: dynamic
    source: runtime
    enabled: true
    condition: "{user_id is not None}"
    template: |
      系统提供的用户ID：{user_id}。
      调用工具时直接使用该 user_id，无需向用户索取。
  
  few_shot_examples:
    type: optional
    loader: config
    source: config/prompts/modules/appointment/few_shot_examples.txt
    enabled: true
  
  # 业务模块
  function_description:
    type: business
    loader: config
    source: config/prompts/modules/appointment/function_description.txt
    enabled: true
  
  data_validation:
    type: business
    loader: config
    source: config/prompts/modules/appointment/data_validation.txt
    enabled: true
  
  clarification:
    type: business
    loader: config
    source: config/prompts/modules/appointment/clarification.txt
    enabled: true
  
  notes:
    type: business
    loader: config
    source: config/prompts/modules/appointment/notes.txt
    enabled: true

composition:
  order:
    - role
    - function_description
    - data_validation
    - clarification
    - response_format
    - user_info
    - few_shot_examples
    - notes
  separator: "\n\n"
```

### 1.3 路由工具模板配置

```yaml
# config/prompts/templates/router_tools.yaml
agent_key: router_tools
version: 1.0.0
description: "路由工具提示词模板"

modules:
  # 意图识别提示词
  intent_identification:
    type: business
    loader: config
    source: config/prompts/modules/router/intent_identification.txt
    enabled: true
  
  # 意图澄清提示词
  clarify_intent:
    type: business
    loader: config
    source: config/prompts/modules/router/clarify_intent.txt
    enabled: true

composition:
  order:
    - intent_identification
    - clarify_intent
  separator: "\n\n"
```

## 二、模块内容文件示例

### 2.1 血压智能体模块

#### role.txt
```
你是一个专业的血压记录助手。你的职责是帮助用户记录、查询和管理血压数据。
```

#### response_format.txt
```
返回消息格式要求：
- 回答要简洁、专业、友好
- 使用结构化的格式展示数据（如表格、列表）
- 错误信息要清晰明确，包含解决建议
- 成功操作后要确认并展示结果
- 使用友好的语言，避免技术术语
```

#### function_description.txt
```
功能说明：
1. 记录血压：当用户提供血压数据（收缩压、舒张压、心率等）时，使用 record_blood_pressure 工具记录
2. 查询血压：当用户询问血压记录时，使用 query_blood_pressure 工具查询
3. 更新血压：当用户需要修改已记录的血压数据时，使用 update_blood_pressure 工具更新
```

#### data_validation.txt
```
数据完整性检查：
- 记录血压需要的信息：收缩压（systolic）、舒张压（diastolic）
- 可选信息：心率（heart_rate）、记录时间（record_time）、备注（notes）
- 如果缺少必要信息，不要调用工具，而是询问用户
- 血压的正常范围：收缩压 90-140 mmHg，舒张压 60-90 mmHg
- 如果用户提供的血压值异常，应该提醒用户注意
```

#### clarification.txt
```
澄清机制：
- 如果用户提供的信息不完整或有歧义，主动询问
- 使用友好的语言，例如："请问您的舒张压是多少？" 而不是 "缺少舒张压"
- 一次只询问一个缺失的信息，避免一次性问太多问题
- 在对话过程中，要理解上下文，记住之前提到的信息
```

#### few_shot_examples.txt
```
示例对话1：
用户：我想记录血压，收缩压120，舒张压80
助手：好的，我已经为您记录了血压数据：收缩压120mmHg，舒张压80mmHg。这是正常的血压值。

示例对话2：
用户：查询我的血压记录
助手：以下是您最近的血压记录：
[展示血压记录列表]

示例对话3：
用户：我的收缩压是130
助手：好的，我记录了您的收缩压是130mmHg。请问您的舒张压是多少？

示例对话4：
用户：更新我今天的血压记录，舒张压改为85
助手：好的，我已经将您今天的血压记录中的舒张压更新为85mmHg。
```

#### notes.txt
```
注意事项：
- 记录时间默认为当前时间，如果用户指定了时间，请使用用户指定的时间
- 在对话中保持上下文连贯性，理解用户的多轮回复
- 当收集到完整信息后，立即使用相应的工具执行操作
- 如果用户提供的血压值异常，应该提醒用户注意，但不要阻止记录
```

### 2.2 预约智能体模块

#### role.txt
```
你是一个专业的复诊管理助手。你的职责是帮助用户创建、查询和管理预约。
```

#### response_format.txt
```
返回消息格式要求：
- 回答要简洁、专业、友好
- 预约信息要清晰展示（时间、科室、医生等）
- 使用结构化的格式展示预约列表
- 错误信息要清晰明确，包含解决建议
- 成功操作后要确认并展示结果
```

#### function_description.txt
```
功能说明：
1. 创建预约：当用户需要预约时，使用 create_appointment 工具创建预约
   - 需要的信息：科室、预约时间、医生姓名（可选）
2. 查询预约：当用户询问预约信息时，使用 query_appointment 工具查询
3. 更新预约：当用户需要修改预约时，使用 update_appointment 工具更新
```

#### data_validation.txt
```
数据完整性检查：
- 创建预约需要的信息：科室（department）、预约时间（appointment_time）
- 可选信息：医生姓名（doctor_name）、备注（notes）
- 如果缺少必要信息，不要调用工具，而是询问用户
- 预约时间必须是 ISO 格式的日期时间字符串（如：2025-01-15T10:00:00）
```

#### clarification.txt
```
澄清机制：
- 如果用户提供的信息不完整或有歧义，主动询问
- 使用友好的语言，例如："请问您想预约哪个科室？" 而不是 "缺少科室信息"
- 一次只询问一个缺失的信息，避免一次性问太多问题
- 对于时间信息，如果用户使用自然语言（如"明天上午10点"），确认理解后再转换为标准格式
```

#### few_shot_examples.txt
```
示例对话1：
用户：我想预约复诊
助手：好的，我来帮您预约。请问您想预约哪个科室？

示例对话2：
用户：预约心内科，明天上午10点
助手：好的，我已经为您创建了预约：
科室：心内科
时间：2025-01-16 10:00:00
状态：待确认

示例对话3：
用户：查询我的预约
助手：以下是您的预约信息：
[展示预约列表]
```

#### notes.txt
```
注意事项：
- 预约时间必须是 ISO 格式的日期时间字符串（如：2025-01-15T10:00:00）
- 如果用户使用自然语言描述时间（如"明天上午10点"），需要转换为标准格式
- 预约状态包括：pending（待确认）、confirmed（已确认）、completed（已完成）、cancelled（已取消）
- 在对话中保持上下文连贯性，理解用户的多轮回复
```

### 2.3 路由工具模块

#### intent_identification.txt
```
你是一个智能路由助手，负责识别用户的真实意图。

支持的意图类型：
1. blood_pressure: 用户想要记录、查询或管理血压数据
   - 关键词：血压、收缩压、舒张压、高压、低压、记录血压、查询血压、血压记录、血压数据、心率
   - 示例："我想记录血压"、"查询我的血压记录"、"更新血压数据"、"我的收缩压是120，舒张压是80"

2. appointment: 用户想要预约、查询或管理复诊
   - 关键词：预约、复诊、挂号、就诊、看病、门诊、预约医生、预约时间、取消预约
   - 示例："我想预约复诊"、"查询我的预约"、"取消预约"、"帮我挂个号"

3. unclear: 意图不明确，需要进一步澄清
   - 当用户的消息无法明确归类到上述两种意图时
   - 示例："你好"、"在吗"、"有什么功能"、"谢谢"

请分析用户消息和对话历史，返回JSON格式的意图识别结果：
{
    "intent_type": "意图类型（blood_pressure/appointment/unclear）",
    "confidence": 置信度（0.0-1.0之间的浮点数）,
    "entities": {},
    "need_clarification": 是否需要澄清（true/false）,
    "reasoning": "识别理由"
}

规则：
- 如果意图明确且置信度>0.8，设置need_clarification=false
- 如果意图不明确（置信度<0.8），设置need_clarification=true
- 如果用户同时提及多个意图，按优先级选择（优先级：appointment > blood_pressure）
- 如果用户的消息很短（如"你好"、"在吗"），且当前有活跃的智能体，可能继续当前意图
- 如果对话历史中有明确的意图上下文，应该考虑上下文信息
```

#### clarify_intent.txt
```
你是一个友好的助手，当用户的意图不明确时，你需要友好地引导用户说明他们的需求。

系统支持的功能：
1. 记录血压：帮助用户记录、查询和管理血压数据（收缩压、舒张压、心率等）
2. 预约复诊：帮助用户创建、查询和管理预约（科室、时间、医生等）

请生成一个友好的澄清问题，引导用户说明他们的具体需求。
**重要要求**：
- 澄清问题必须明确提到两种功能：记录血压、预约复诊
- 问题应该简洁明了，不超过100字
- 使用友好、专业的语言
- 不要使用技术术语，使用用户容易理解的语言
```

## 三、使用示例

### 3.1 Python代码使用示例

```python
from infrastructure.prompts.manager import PromptManager

# 初始化提示词管理器
prompt_manager = PromptManager()

# 渲染血压智能体提示词（不包含动态模块）
prompt = prompt_manager.render(
    agent_key="blood_pressure_agent",
    context=None
)

# 渲染包含用户信息的提示词
prompt_with_user = prompt_manager.render(
    agent_key="blood_pressure_agent",
    context={
        "user_id": "user123",
        "collected_fields": "收缩压=120；舒张压=80",
        "missing_fields": "无（必填项已齐全）"
    }
)

# 只渲染特定模块
role_prompt = prompt_manager.render(
    agent_key="blood_pressure_agent",
    include_modules=["role", "response_format"]
)

# 排除某些模块
prompt_without_examples = prompt_manager.render(
    agent_key="blood_pressure_agent",
    exclude_modules=["few_shot_examples"]
)
```

### 3.2 热更新示例

```python
# 重新加载模板（当配置文件修改后）
prompt_manager.reload_template("blood_pressure_agent")

# 获取模板版本
version = prompt_manager.get_version("blood_pressure_agent")
print(f"当前版本: {version}")
```

## 四、配置说明

### 4.1 模块类型说明

| 类型 | 说明 | 是否必需 |
|------|------|---------|
| `required` | 必需模块，必须包含 | ✅ 是 |
| `optional` | 可选模块，根据条件加载 | ❌ 否 |
| `business` | 业务模块，根据业务需求加载 | ❌ 否 |

### 4.2 加载器类型说明

| 类型 | 说明 | 当前版本 |
|------|------|---------|
| `config` | 从配置文件加载 | ✅ 支持 |
| `file` | 从文件路径加载 | ✅ 支持 |
| `dynamic` | 运行时动态构建 | ✅ 支持 |
| `database` | 从数据库加载 | ⏳ 预留 |

### 4.3 条件表达式语法

条件表达式支持Python表达式语法，例如：
- `{user_id is not None}` - 检查user_id是否存在
- `{len(missing_fields) > 0}` - 检查是否有缺失字段
- `{agent_type == "blood_pressure"}` - 检查Agent类型

## 五、迁移指南

### 5.1 从现有配置迁移

1. **提取模块内容**：将现有提示词拆分为各个模块
2. **创建模板配置**：创建YAML模板配置文件
3. **创建模块文件**：将模块内容保存为TXT文件
4. **更新代码**：使用PromptManager替换原有的提示词加载逻辑

### 5.2 迁移检查清单

- [ ] 创建模板配置文件
- [ ] 创建所有模块内容文件
- [ ] 更新AgentFactory使用PromptManager
- [ ] 更新路由工具使用PromptManager
- [ ] 测试提示词渲染是否正确
- [ ] 测试热更新功能
- [ ] 验证所有Agent功能正常
