æ˜ç™½äº†ï¼ä½ å·²ç»æœ‰ä¸€ä¸ªåŸºäº **LangGraph** çš„ Python é¡¹ç›®ï¼Œç°åœ¨å¸Œæœ›å¯¹æ¥ **Langfuse** â€”â€” è¿™æ˜¯ä¸€ä¸ªç”¨äº LLM åº”ç”¨çš„å¯è§‚æµ‹æ€§ï¼ˆObservabilityï¼‰å¹³å°ï¼Œæ”¯æŒè¿½è¸ªé“¾è·¯ã€è¯„ä¼°æ€§èƒ½ã€è®°å½•æç¤ºè¯å’Œè¾“å‡ºç­‰ã€‚

Langfuse å®˜æ–¹å¯¹ **LangChain** å’Œ **LangGraph** æœ‰è‰¯å¥½æ”¯æŒï¼ˆå› ä¸º LangGraph æ˜¯ LangChain ç”Ÿæ€çš„ä¸€éƒ¨åˆ†ï¼‰ï¼Œå¯¹æ¥éå¸¸æ–¹ä¾¿ã€‚

---

## âœ… å¯¹æ¥ Langfuse åˆ° LangGraph é¡¹ç›®çš„æ­¥éª¤

### ç¬¬ä¸€æ­¥ï¼šå®‰è£…ä¾èµ–

```bash
pip install langfuse langchain
```

> æ³¨æ„ï¼š`langfuse` åŒ…ä¼šè‡ªåŠ¨é›†æˆåˆ° LangChain çš„å›è°ƒç³»ç»Ÿä¸­ã€‚

---

### ç¬¬äºŒæ­¥ï¼šè®¾ç½® Langfuse å‡­æ®

ä½ éœ€è¦åœ¨ [https://cloud.langfuse.com](https://cloud.langfuse.com)ï¼ˆæˆ–ä½ çš„è‡ªå»ºå®ä¾‹ï¼‰è·å–ï¼š

- `LANGFUSE_PUBLIC_KEY`
- `LANGFUSE_SECRET_KEY`
- `LANGFUSE_HOST`ï¼ˆé»˜è®¤ä¸º `https://cloud.langfuse.com`ï¼‰

å»ºè®®é€šè¿‡ç¯å¢ƒå˜é‡é…ç½®ï¼š

```bash
export LANGFUSE_PUBLIC_KEY="your-public-key"
export LANGFUSE_SECRET_KEY="your-secret-key"
export LANGFUSE_HOST="https://cloud.langfuse.com"
```

æˆ–è€…åœ¨ä»£ç ä¸­æ˜¾å¼ä¼ å…¥ï¼ˆä¸æ¨èç”¨äºç”Ÿäº§ï¼‰ã€‚

---

### ç¬¬ä¸‰æ­¥ï¼šåœ¨ LangGraph ä¸­å¯ç”¨ Langfuse å›è°ƒ

LangGraph æ„å»ºçš„å›¾æœ¬è´¨ä¸Šæ˜¯åŸºäº LangChain çš„ Runnable æ¥å£ï¼Œå› æ­¤å¯ä»¥ç›´æ¥ä½¿ç”¨ `langfuse_context` æˆ–å›è°ƒæœºåˆ¶ã€‚

#### âœ… æ¨èæ–¹å¼ï¼šä½¿ç”¨ `with_langfuse()` ä¸Šä¸‹æ–‡ï¼ˆé€‚ç”¨äº LangGraph >= 0.1ï¼‰

```python
from langgraph.graph import StateGraph, END
from langfuse import Langfuse
from langfuse.decorators import langfuse_context, observe
from langchain_core.runnables import RunnableConfig

# åˆå§‹åŒ– Langfuseï¼ˆå¯é€‰ï¼Œè‡ªåŠ¨ä» env è¯»å–ï¼‰
langfuse = Langfuse()

# ç¤ºä¾‹çŠ¶æ€
class GraphState(TypedDict):
    messages: list

def node_a(state: GraphState) -> GraphState:
    # ä½ çš„èŠ‚ç‚¹é€»è¾‘
    return {"messages": state["messages"] + ["Hello from A"]}

def node_b(state: GraphState) -> GraphState:
    return {"messages": state["messages"] + ["Hello from B"]}

# æ„å»ºå›¾
workflow = StateOfGraph(GraphState)
workflow.add_node("a", node_a)
workflow.add_node("b", node_b)
workflow.set_entry_point("a")
workflow.add_edge("a", "b")
workflow.add_edge("b", END)

app = workflow.compile()

# è°ƒç”¨æ—¶ä¼ å…¥ Langfuse å›è°ƒ
from langfuse.langchain import LangfuseCallbackHandler

callback = LangfuseCallbackHandler()

config = RunnableConfig(callbacks=[callback])

result = app.invoke({"messages": ["Start"]}, config=config)
```

> âš ï¸ æ³¨æ„ï¼šLangGraph çš„ `invoke()`ã€`stream()` ç­‰æ–¹æ³•éƒ½æ¥å— `config` å‚æ•°ï¼Œå…¶ä¸­å¯ä¼ å…¥å›è°ƒã€‚

---

### ç¬¬å››æ­¥ï¼ˆæ›´ç®€æ´ï¼‰ï¼šå…¨å±€è‡ªåŠ¨è¿½è¸ªï¼ˆæ¨èï¼‰

Langfuse æ”¯æŒè‡ªåŠ¨è¿½è¸ªæ‰€æœ‰ LangChain/LangGraph è°ƒç”¨ï¼Œæ— éœ€æ‰‹åŠ¨ä¼  callbackï¼š

```python
from langfuse import Langfuse
from langfuse.context import set_current_trace

# è‡ªåŠ¨æ³¨å…¥å›è°ƒï¼ˆåªè¦ä½¿ç”¨äº† Runnable æ¥å£å°±ä¼šè¢«è¿½è¸ªï¼‰
langfuse = Langfuse()

# ç›´æ¥è°ƒç”¨ï¼Œè‡ªåŠ¨ä¸ŠæŠ¥
result = app.invoke({"messages": ["Start"]})
```

ä½†ä¸ºäº†ç¡®ä¿ trace å…³è”æ¸…æ™°ï¼Œ**å»ºè®®æ˜¾å¼åˆ›å»º trace å¹¶ä¼ å…¥**ï¼š

```python
from langfuse import Langfuse

langfuse = Langfuse()

# åˆ›å»ºä¸€ä¸ª trace
trace = langfuse.trace(name="my-langgraph-workflow")

# å°† trace_id æ³¨å…¥åˆ° RunnableConfig
config = {"callbacks": [trace.get_langchain_handler()]}

result = app.invoke({"messages": ["Start"]}, config=config)

# æœ€å flushï¼ˆå¯é€‰ï¼Œç¨‹åºç»“æŸå‰è‡ªåŠ¨ flushï¼‰
langfuse.flush()
```

---

### ç¬¬äº”æ­¥ï¼šæŸ¥çœ‹ç»“æœ

è®¿é—® [Langfuse Dashboard](https://cloud.langfuse.com)ï¼Œä½ ä¼šçœ‹åˆ°ï¼š

- æ¯æ¬¡ `invoke` å¯¹åº”ä¸€ä¸ª Trace
- æ¯ä¸ª LangGraph èŠ‚ç‚¹ä½œä¸º Span æ˜¾ç¤º
- è¾“å…¥/è¾“å‡ºã€è€—æ—¶ã€tokens ä½¿ç”¨æƒ…å†µç­‰

---

## ğŸ”§ é«˜çº§ç”¨æ³•

### 1. ç»™èŠ‚ç‚¹å‘½åï¼ˆä¾¿äºè¯†åˆ«ï¼‰
åœ¨å®šä¹‰èŠ‚ç‚¹å‡½æ•°æ—¶ï¼Œå¯ä»¥ç”¨ `@observe()` è£…é¥°å™¨ï¼š

```python
from langfuse.decorators import observe

@observe(as_type="generation")
def call_llm(messages):
    # è°ƒç”¨ LLM
    return llm.invoke(messages)
```

### 2. æ·»åŠ è‡ªå®šä¹‰å…ƒæ•°æ®
```python
trace = langfuse.trace(
    name="user-query",
    user_id="user-123",
    metadata={"version": "v1.2", "feature": "chat"}
)
```

### 3. ä¸ LangSmith å¯¹æ¯”
Langfuse æ˜¯å¼€æºå‹å¥½çš„æ›¿ä»£æ–¹æ¡ˆï¼Œæ”¯æŒç§æœ‰éƒ¨ç½²ï¼Œä¸”å¯¹ LangGraph åŸç”Ÿå…¼å®¹ã€‚

---

## ğŸ“Œ æ€»ç»“

| æ­¥éª¤ | æ“ä½œ |
|------|------|
| 1 | å®‰è£… `langfuse` |
| 2 | è®¾ç½® `LANGFUSE_PUBLIC_KEY` ç­‰ç¯å¢ƒå˜é‡ |
| 3 | åœ¨ `app.invoke(...)` æ—¶ä¼ å…¥ `LangfuseCallbackHandler` |
| 4 | ï¼ˆæ¨èï¼‰ä½¿ç”¨ `trace.get_langchain_handler()` ç²¾ç»†æ§åˆ¶ |
| 5 | æŸ¥çœ‹ Langfuse æ§åˆ¶å°åˆ†ææ‰§è¡Œæµç¨‹ |

---

å¦‚æœä½ æä¾›ä¸€æ®µä½ çš„ LangGraph ä»£ç ç‰‡æ®µï¼Œæˆ‘å¯ä»¥å¸®ä½ ç›´æ¥æ’å…¥ Langfuse å¯¹æ¥ä»£ç ã€‚æ¬¢è¿ç»§ç»­æé—®ï¼