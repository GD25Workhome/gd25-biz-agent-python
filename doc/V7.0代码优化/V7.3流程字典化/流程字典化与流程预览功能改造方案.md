# 流程字典化与流程预览功能改造方案

## 文档说明

本文档详细描述流程字典化和流程预览功能的改造方案，包括后端API设计、前端界面改造和流程图生成机制。

**文档版本**：V1.0  
**创建时间**：2025-01-XX

---

## 目录

1. [需求概述](#一需求概述)
2. [架构设计](#二架构设计)
3. [后端实现方案](#三后端实现方案)
4. [前端实现方案](#四前端实现方案)
5. [流程图生成方案](#五流程图生成方案)
6. [数据模型设计](#六数据模型设计)
7. [API设计](#七api设计)
8. [实施步骤](#八实施步骤)
9. [注意事项](#九注意事项)

---

## 一、需求概述

### 1.1 功能需求

1. **流程字典API**
   - 前端聊天对话中的流程选择数据源改为使用后端API
   - 后端提供统一的流程字典API，返回所有可用流程的基本信息

2. **流程预览Tab页**
   - 在主界面添加"流程预览"Tab页（与聊天会话同级别）
   - 显示当前系统的所有流程列表
   - 展示每个流程的流程图（LangGraph编译后的可视化图）

3. **流程图生成机制**
   - 独立的流程图预览功能，不与业务流程编译耦合
   - 流程图图片存储在固定路径
   - 支持按需生成流程图（点击流程时生成）
   - 前端根据图片是否存在决定是否展示

### 1.2 设计原则

- **解耦原则**：流程图预览功能独立，不影响现有的流程编译和执行逻辑
- **按需生成**：流程图仅在需要预览时生成，避免不必要的资源消耗
- **缓存机制**：生成的流程图图片缓存到固定目录，避免重复生成
- **向后兼容**：所有改动不影响现有功能

---

## 二、架构设计

### 2.1 整体架构

```
┌─────────────────────────────────────────────────────────────┐
│                         前端界面                              │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐     │
│  │ 聊天对话Tab  │  │ 流程预览Tab  │  │  其他Tab页   │     │
│  │              │  │              │  │              │     │
│  │ 流程选择下拉 │  │ 流程列表     │  │              │     │
│  │ (API数据源)  │  │ + 流程图预览 │  │              │     │
│  └──────────────┘  └──────────────┘  └──────────────┘     │
└─────────────────────────────────────────────────────────────┘
                            │
                            │ HTTP API
                            │
┌─────────────────────────────────────────────────────────────┐
│                        后端API层                              │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐               │
│  │ 流程字典API      │  │ 流程图预览API    │               │
│  │ /api/v1/flows   │  │ /api/v1/flows/  │               │
│  │                  │  │   {name}/preview│               │
│  └──────────────────┘  └──────────────────┘               │
└─────────────────────────────────────────────────────────────┘
                            │
                            │
┌─────────────────────────────────────────────────────────────┐
│                       业务逻辑层                              │
├─────────────────────────────────────────────────────────────┤
│  ┌──────────────────┐  ┌──────────────────┐               │
│  │ FlowManager      │  │ FlowPreviewService│               │
│  │ (流程管理)       │  │ (流程预览服务)   │               │
│  │                  │  │                  │               │
│  │ _flow_definitions│  │ - 生成流程图     │               │
│  │ _compiled_graphs │  │ - 缓存管理       │               │
│  └──────────────────┘  └──────────────────┘               │
└─────────────────────────────────────────────────────────────┘
                            │
                            │
┌─────────────────────────────────────────────────────────────┐
│                        数据模型层                             │
├─────────────────────────────────────────────────────────────┤
│  FlowDefinition (基础流程定义)                                │
│       ↑                                                      │
│  FlowPreviewInfo (流程预览信息，继承FlowDefinition)          │
│  - is_compiled: bool                                         │
│  - preview_image_path: Optional[str]                         │
└─────────────────────────────────────────────────────────────┘
                            │
                            │
┌─────────────────────────────────────────────────────────────┐
│                        存储层                                 │
├─────────────────────────────────────────────────────────────┤
│  流程图图片存储目录:                                          │
│  {project_root}/static/flow_previews/                        │
│    ├── medical_agent.png                                     │
│    ├── work_plan_agent.png                                   │
│    └── ...                                                   │
└─────────────────────────────────────────────────────────────┘
```

### 2.2 数据流向

1. **流程字典获取**
   ```
   前端 → GET /api/v1/flows → FlowManager._flow_definitions（直接使用缓存）
   → 转换为FlowPreviewInfo列表 → 返回JSON
   ```
   
   **说明**：系统启动时（`backend/main.py`的`lifespan`函数）已经调用`FlowManager.scan_flows()`将流程定义缓存到`_flow_definitions`中，API直接使用缓存数据即可，无需重新扫描。

2. **流程图预览**
   ```
   前端 → GET /api/v1/flows/{name}/preview → FlowPreviewService
   → 检查图片是否存在 → 不存在则生成 → 返回图片URL
   ```

---

## 三、后端实现方案

### 3.1 数据模型扩展

#### 3.1.1 创建FlowPreviewInfo类

**文件位置**：`backend/domain/flows/definition.py`

新增一个继承自`FlowDefinition`的类，用于流程预览信息：

```python
class FlowPreviewInfo(FlowDefinition):
    """流程预览信息（继承FlowDefinition，增加预览相关属性）"""
    is_compiled: bool = Field(default=False, description="是否已编译")
    preview_image_path: Optional[str] = Field(default=None, description="流程图预览图片路径（相对于static目录）")
    
    class Config:
        json_schema_extra = {
            "example": {
                "name": "medical_agent",
                "version": "1.0.0",
                "description": "医疗咨询流程",
                "is_compiled": True,
                "preview_image_path": "/static/flow_previews/medical_agent.png"
            }
        }
```

#### 3.1.2 修改说明

- `FlowPreviewInfo`继承`FlowDefinition`的所有属性
- 新增`is_compiled`字段：标识流程是否已编译（从`FlowManager._compiled_graphs`中判断）
- 新增`preview_image_path`字段：流程图预览图片的相对路径
- 不影响现有的`FlowDefinition`类

### 3.2 流程图预览服务

#### 3.2.1 创建FlowPreviewService

**文件位置**：`backend/domain/flows/preview_service.py`（新建文件）

```python
"""
流程预览服务
负责流程图的生成和缓存管理
"""
import logging
from pathlib import Path
from typing import Optional
from PIL import Image
import io

from backend.domain.flows.manager import FlowManager
from backend.app.config import find_project_root

logger = logging.getLogger(__name__)


class FlowPreviewService:
    """流程预览服务"""
    
    # 流程图预览图片存储目录（相对于项目根目录）
    PREVIEW_DIR_NAME = "static/flow_previews"
    
    @classmethod
    def _get_preview_dir(cls) -> Path:
        """获取预览图片存储目录"""
        project_root = find_project_root()
        preview_dir = project_root / cls.PREVIEW_DIR_NAME
        preview_dir.mkdir(parents=True, exist_ok=True)
        return preview_dir
    
    @classmethod
    def get_preview_image_path(cls, flow_name: str) -> Optional[Path]:
        """
        获取流程图预览图片路径
        
        Args:
            flow_name: 流程名称
            
        Returns:
            Path: 图片文件路径，如果不存在则返回None
        """
        preview_dir = cls._get_preview_dir()
        image_path = preview_dir / f"{flow_name}.png"
        if image_path.exists():
            return image_path
        return None
    
    @classmethod
    def generate_preview_image(cls, flow_name: str) -> Path:
        """
        生成流程图预览图片
        
        Args:
            flow_name: 流程名称
            
        Returns:
            Path: 生成的图片文件路径
            
        Raises:
            ValueError: 流程不存在或编译失败
        """
        # 检查流程定义是否存在（直接使用缓存，系统启动时已加载）
        if flow_name not in FlowManager._flow_definitions:
            raise ValueError(f"流程定义不存在: {flow_name}")
        
        # 获取或编译流程图
        try:
            graph = FlowManager.get_flow(flow_name)
        except Exception as e:
            logger.error(f"编译流程失败: {flow_name}, 错误: {e}")
            raise ValueError(f"编译流程失败: {flow_name}")
        
        # 生成流程图图片
        preview_dir = cls._get_preview_dir()
        image_path = preview_dir / f"{flow_name}.png"
        
        try:
            # 使用LangGraph的get_graph方法获取图对象
            graph_obj = graph.get_graph()
            
            # 使用graphviz生成图片（需要安装graphviz和pygraphviz）
            # 如果LangGraph支持直接生成图片，使用对应方法
            # 这里使用临时方案：使用matplotlib或其他工具生成
            # 具体实现需要根据LangGraph的API调整
            
            # 临时实现：生成一个占位图片
            # TODO: 实现真正的流程图可视化
            cls._generate_placeholder_image(image_path, flow_name)
            
            logger.info(f"成功生成流程图预览: {flow_name}")
            return image_path
        except Exception as e:
            logger.error(f"生成流程图预览失败: {flow_name}, 错误: {e}")
            raise ValueError(f"生成流程图预览失败: {flow_name}")
    
    @classmethod
    def _generate_placeholder_image(cls, image_path: Path, flow_name: str):
        """
        生成占位图片（临时实现）
        
        TODO: 替换为真正的流程图生成逻辑
        """
        # 使用PIL生成一个简单的占位图片
        from PIL import Image, ImageDraw, ImageFont
        
        img = Image.new('RGB', (800, 600), color='white')
        draw = ImageDraw.Draw(img)
        
        # 绘制标题
        try:
            font = ImageFont.truetype("/System/Library/Fonts/Helvetica.ttc", 24)
        except:
            font = ImageFont.load_default()
        
        text = f"流程图预览: {flow_name}\n(待实现真正的可视化)"
        draw.text((50, 50), text, fill='black', font=font)
        
        img.save(image_path, 'PNG')
```

**注意事项**：
- 流程图可视化需要根据LangGraph的实际API实现
- 可能需要安装`graphviz`和`pygraphviz`等依赖
- 如果LangGraph不支持直接生成图片，需要寻找替代方案

### 3.3 API路由实现

#### 3.3.1 创建流程字典API路由

**文件位置**：`backend/app/api/routes/flows.py`（新建文件）

```python
"""
流程相关路由
提供流程字典和预览功能
"""
import logging
from typing import List
from fastapi import APIRouter, HTTPException
from fastapi.responses import FileResponse
from pathlib import Path

from backend.domain.flows.manager import FlowManager
from backend.domain.flows.definition import FlowPreviewInfo
from backend.domain.flows.preview_service import FlowPreviewService
from backend.app.config import find_project_root

logger = logging.getLogger(__name__)
router = APIRouter()


@router.get("/flows", response_model=List[FlowPreviewInfo])
async def list_flows():
    """
    获取所有流程列表（流程字典）
    
    Returns:
        List[FlowPreviewInfo]: 流程列表，包含基本信息和预览信息
    """
    try:
        # 直接使用FlowManager的缓存数据（系统启动时已通过scan_flows()缓存）
        flow_definitions = FlowManager._flow_definitions
        
        # 转换为FlowPreviewInfo列表
        preview_infos = []
        for flow_name, flow_def in flow_definitions.items():
            # 检查是否已编译
            is_compiled = flow_name in FlowManager._compiled_graphs
            
            # 检查预览图片是否存在
            preview_image_path = None
            image_path = FlowPreviewService.get_preview_image_path(flow_name)
            if image_path:
                # 返回相对于static目录的路径
                preview_image_path = f"/static/flow_previews/{flow_name}.png"
            
            # 创建FlowPreviewInfo对象
            preview_info = FlowPreviewInfo(
                **flow_def.model_dump(),
                is_compiled=is_compiled,
                preview_image_path=preview_image_path
            )
            preview_infos.append(preview_info)
        
        return preview_infos
    except Exception as e:
        logger.error(f"获取流程列表失败: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"获取流程列表失败: {str(e)}")


@router.get("/flows/{flow_name}/preview")
async def generate_flow_preview(flow_name: str, force: bool = False):
    """
    生成或获取流程图预览图片
    
    Args:
        flow_name: 流程名称
        force: 是否强制重新生成（默认False，如果图片已存在则直接返回）
        
    Returns:
        FileResponse: 图片文件响应
    """
    try:
        # 检查流程是否存在（直接使用缓存，系统启动时已加载）
        if flow_name not in FlowManager._flow_definitions:
            raise HTTPException(status_code=404, detail=f"流程不存在: {flow_name}")
        
        # 检查图片是否已存在
        image_path = FlowPreviewService.get_preview_image_path(flow_name)
        
        # 如果不存在或强制重新生成，则生成新图片
        if not image_path or force:
            image_path = FlowPreviewService.generate_preview_image(flow_name)
        
        # 返回图片文件
        return FileResponse(
            path=str(image_path),
            media_type="image/png",
            filename=f"{flow_name}.png"
        )
    except ValueError as e:
        raise HTTPException(status_code=400, detail=str(e))
    except Exception as e:
        logger.error(f"生成流程图预览失败: {flow_name}, 错误: {e}", exc_info=True)
        raise HTTPException(status_code=500, detail=f"生成流程图预览失败: {str(e)}")
```

#### 3.3.2 注册路由

**文件位置**：`backend/app/api/routes/__init__.py`

在现有路由注册代码中添加：

```python
from backend.app.api.routes.flows import router as flows_router

# 在router.include_router部分添加
router.include_router(flows_router, prefix="/api/v1", tags=["流程管理"])
```

### 3.4 静态文件服务配置

#### 3.4.1 配置静态文件路由

**文件位置**：`backend/main.py`

需要在FastAPI应用中添加静态文件服务：

```python
from fastapi.staticfiles import StaticFiles

# 在创建app后，挂载静态文件目录
project_root = find_project_root()
static_dir = project_root / "static"
static_dir.mkdir(exist_ok=True)

app.mount("/static", StaticFiles(directory=str(static_dir)), name="static")
```

---

## 四、前端实现方案

### 4.1 流程字典API集成

#### 4.1.1 修改聊天组件流程选择

**文件位置**：`frontend/js/chat.js`

修改流程选择相关的代码：

1. **添加流程列表数据源**
```javascript
// 在setup函数中添加
const flowList = ref([]);
const loadingFlows = ref(false);

// 加载流程列表
const loadFlowList = async () => {
    loadingFlows.value = true;
    try {
        const resp = await fetch(`${API_BASE}/api/v1/flows`);
        if (!resp.ok) throw new Error('加载流程列表失败');
        const data = await resp.json();
        flowList.value = data || [];
    } catch (e) {
        console.error('加载流程列表失败:', e);
        ElMessage.error('加载流程列表失败: ' + e.message);
        // 失败时使用默认流程列表
        flowList.value = [
            { name: 'medical_agent', description: '医疗分身Agent' },
            { name: 'work_plan_agent', description: '工作计划Agent' }
        ];
    } finally {
        loadingFlows.value = false;
    }
};
```

2. **修改登录弹框中的流程选择**
```javascript
// 在template的登录弹框中，修改流程选择部分
<el-select 
    v-model="loginSelectedFlow" 
    style="width: 100%;"
    placeholder="请选择流程"
    :loading="loadingFlows"
>
    <el-option 
        v-for="flow in flowList" 
        :key="flow.name"
        :label="flow.description || flow.name" 
        :value="flow.name"
    ></el-option>
</el-select>
```

3. **在组件挂载时加载流程列表**
```javascript
onMounted(async () => {
    initFlowSelection();
    initDateTimeInput();
    await loadFlowList(); // 加载流程列表
    // ... 其他初始化代码
});
```

### 4.2 流程预览Tab页实现

#### 4.2.1 创建流程预览组件

**文件位置**：`frontend/js/flow-preview.js`（新建文件）

```javascript
/**
 * 流程预览模块
 */

(function() {
    'use strict';
    
    const { defineComponent, ref, reactive, onMounted, nextTick } = Vue;
    const { ElMessage, ElMessageBox, ElLoading } = ElementPlus;
    const icons = ElementPlusIconsVue;

    window.FlowPreviewComponent = defineComponent({
        name: 'FlowPreviewComponent',
        props: {
            tabId: {
                type: String,
                required: true
            }
        },
        setup(props) {
            const API_BASE = 'http://localhost:8000';
            const FLOWS_API_URL = `${API_BASE}/api/v1/flows`;
            
            // 流程列表数据
            const flowList = ref([]);
            const loading = ref(false);
            const selectedFlow = ref(null);
            const previewImageUrl = ref('');
            const generatingPreview = ref(false);
            
            // 加载流程列表
            const loadFlowList = async () => {
                loading.value = true;
                try {
                    const resp = await fetch(FLOWS_API_URL);
                    if (!resp.ok) throw new Error('加载流程列表失败');
                    const data = await resp.json();
                    flowList.value = data || [];
                } catch (e) {
                    console.error('加载流程列表失败:', e);
                    ElMessage.error('加载流程列表失败: ' + e.message);
                } finally {
                    loading.value = false;
                }
            };
            
            // 生成流程图预览
            const generatePreview = async (flowName, force = false) => {
                generatingPreview.value = true;
                try {
                    const url = `${FLOWS_API_URL}/${flowName}/preview${force ? '?force=true' : ''}`;
                    const resp = await fetch(url);
                    if (!resp.ok) throw new Error('生成流程图失败');
                    
                    // 获取图片URL（使用blob URL或直接使用API URL）
                    const blob = await resp.blob();
                    previewImageUrl.value = URL.createObjectURL(blob);
                    
                    ElMessage.success('流程图生成成功');
                } catch (e) {
                    console.error('生成流程图失败:', e);
                    ElMessage.error('生成流程图失败: ' + e.message);
                } finally {
                    generatingPreview.value = false;
                }
            };
            
            // 选择流程
            const selectFlow = async (flow) => {
                selectedFlow.value = flow;
                previewImageUrl.value = '';
                
                // 如果已有预览图片路径，直接使用
                if (flow.preview_image_path) {
                    previewImageUrl.value = `${API_BASE}${flow.preview_image_path}`;
                } else {
                    // 否则生成预览图
                    await generatePreview(flow.name, false);
                }
            };
            
            // 重新生成流程图
            const regeneratePreview = async () => {
                if (!selectedFlow.value) return;
                await generatePreview(selectedFlow.value.name, true);
            };
            
            // 初始化
            onMounted(async () => {
                await loadFlowList();
                // 默认选择第一个流程
                if (flowList.value.length > 0) {
                    await selectFlow(flowList.value[0]);
                }
            });
            
            return {
                flowList,
                loading,
                selectedFlow,
                previewImageUrl,
                generatingPreview,
                loadFlowList,
                selectFlow,
                regeneratePreview
            };
        },
        template: `
            <div style="height: 100%; display: flex; flex-direction: column; background: #f5f7fa;">
                <!-- 头部工具栏 -->
                <div style="padding: 16px 20px; background: #fff; border-bottom: 1px solid #e4e7ed;">
                    <div style="display: flex; justify-content: space-between; align-items: center;">
                        <h2 style="margin: 0; font-size: 18px; color: #303133;">流程预览</h2>
                        <div style="display: flex; gap: 12px;">
                            <el-button 
                                @click="loadFlowList" 
                                :loading="loading"
                                size="small"
                            >
                                <el-icon style="margin-right: 4px;"><Refresh /></el-icon>
                                刷新列表
                            </el-button>
                            <el-button 
                                v-if="selectedFlow"
                                @click="regeneratePreview" 
                                :loading="generatingPreview"
                                type="primary"
                                size="small"
                            >
                                <el-icon style="margin-right: 4px;"><Refresh /></el-icon>
                                重新生成流程图
                            </el-button>
                        </div>
                    </div>
                </div>
                
                <!-- 主体内容 -->
                <div style="flex: 1; display: flex; overflow: hidden;">
                    <!-- 左侧流程列表 -->
                    <div style="width: 300px; background: #fff; border-right: 1px solid #e4e7ed; overflow-y: auto;">
                        <div v-if="loading" style="padding: 20px; text-align: center; color: #909399;">
                            加载中...
                        </div>
                        <div v-else-if="flowList.length === 0" style="padding: 20px; text-align: center; color: #909399;">
                            暂无流程
                        </div>
                        <div v-else style="padding: 12px;">
                            <div
                                v-for="flow in flowList"
                                :key="flow.name"
                                @click="selectFlow(flow)"
                                style="padding: 12px; border: 1px solid #e4e7ed; border-radius: 8px; margin-bottom: 8px; cursor: pointer; transition: all 0.2s;"
                                :style="selectedFlow && selectedFlow.name === flow.name ? 'background: #e0f2fe; border-color: #409eff;' : ''"
                                @mouseenter="$event.currentTarget.style.background = (selectedFlow && selectedFlow.name === flow.name) ? '#e0f2fe' : '#f3f4f6'"
                                @mouseleave="$event.currentTarget.style.background = (selectedFlow && selectedFlow.name === flow.name) ? '#e0f2fe' : '#fff'"
                            >
                                <div style="font-weight: bold; margin-bottom: 4px; color: #303133;">{{ flow.description || flow.name }}</div>
                                <div style="font-size: 12px; color: #909399; margin-bottom: 4px;">
                                    名称: {{ flow.name }} | 版本: {{ flow.version }}
                                </div>
                                <div style="font-size: 12px; color: #909399;">
                                    <span :style="flow.is_compiled ? 'color: #67c23a;' : 'color: #e6a23c;'">
                                        {{ flow.is_compiled ? '✓ 已编译' : '○ 未编译' }}
                                    </span>
                                    <span v-if="flow.preview_image_path" style="margin-left: 8px; color: #67c23a;">
                                        ✓ 有预览图
                                    </span>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <!-- 右侧流程图预览 -->
                    <div style="flex: 1; background: #fff; display: flex; flex-direction: column; overflow: hidden;">
                        <div v-if="!selectedFlow" style="flex: 1; display: flex; align-items: center; justify-content: center; color: #909399;">
                            <div style="text-align: center;">
                                <div style="font-size: 48px; margin-bottom: 16px;">📊</div>
                                <div>请选择流程查看流程图</div>
                            </div>
                        </div>
                        <div v-else style="flex: 1; padding: 20px; overflow: auto;">
                            <!-- 流程信息 -->
                            <div style="margin-bottom: 20px; padding: 16px; background: #f5f7fa; border-radius: 8px;">
                                <h3 style="margin: 0 0 8px 0; color: #303133;">{{ selectedFlow.description || selectedFlow.name }}</h3>
                                <div style="font-size: 14px; color: #606266;">
                                    <div>流程名称: {{ selectedFlow.name }}</div>
                                    <div>版本: {{ selectedFlow.version }}</div>
                                    <div v-if="selectedFlow.description">描述: {{ selectedFlow.description }}</div>
                                </div>
                            </div>
                            
                            <!-- 流程图预览 -->
                            <div v-if="generatingPreview" style="text-align: center; padding: 40px; color: #909399;">
                                <el-icon class="is-loading" style="font-size: 32px; margin-bottom: 16px;"><Loading /></el-icon>
                                <div>正在生成流程图...</div>
                            </div>
                            <div v-else-if="previewImageUrl" style="text-align: center;">
                                <img 
                                    :src="previewImageUrl" 
                                    alt="流程图预览"
                                    style="max-width: 100%; border: 1px solid #e4e7ed; border-radius: 8px; box-shadow: 0 2px 8px rgba(0,0,0,0.1);"
                                />
                            </div>
                            <div v-else style="text-align: center; padding: 40px; color: #909399;">
                                <div style="font-size: 48px; margin-bottom: 16px;">📋</div>
                                <div>流程图预览不可用</div>
                                <el-button @click="regeneratePreview" type="primary" style="margin-top: 16px;">
                                    生成流程图
                                </el-button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        `,
        components: {
            Refresh: icons.Refresh,
            Loading: icons.Loading
        }
    });
})();
```

#### 4.2.2 在主界面中集成流程预览Tab

**文件位置**：`frontend/index.html`

1. **添加流程预览菜单项**
```html
<el-menu-item index="flow-preview">
    <el-icon><Document /></el-icon>
    <span>流程预览</span>
</el-menu-item>
```

2. **引入流程预览组件脚本**
```html
<script src="js/flow-preview.js"></script>
```

3. **在框架组件中注册流程预览组件**

**文件位置**：`frontend/js/framework.js`

在`useFramework`函数中添加流程预览组件的支持：

```javascript
// 在组件映射中添加
const componentMap = {
    'chat': ChatComponent,
    'blood-pressure': BloodPressureComponent,
    'users': UsersComponent,
    'flow-preview': FlowPreviewComponent  // 新增
};

// 在handleMenuSelect函数中添加
case 'flow-preview':
    openTab('flow-preview', '流程预览', 'flow-preview');
    break;
```

4. **注册图标组件**

**文件位置**：`frontend/index.html`

```javascript
app.component('Document', icons.Document);
```

---

## 五、流程图生成方案

### 5.1 LangGraph流程图可视化

LangGraph支持通过`get_graph()`方法获取图对象，然后可以使用`graphviz`等工具进行可视化。

#### 5.1.1 依赖安装

需要安装以下依赖：

```bash
pip install pygraphviz graphviz
```

**注意**：`graphviz`还需要系统级安装：
- macOS: `brew install graphviz`
- Ubuntu/Debian: `apt-get install graphviz`
- Windows: 下载安装包并添加到PATH

#### 5.1.2 流程图生成实现

**文件位置**：`backend/domain/flows/preview_service.py`

完善`generate_preview_image`方法：

```python
@classmethod
def generate_preview_image(cls, flow_name: str) -> Path:
    """
    生成流程图预览图片
    """
    # ... 前面的代码不变 ...
    
    try:
        # 获取图对象
        graph_obj = graph.get_graph()
        
        # 使用graphviz生成图片
        try:
            import pygraphviz as pgv
            
            # 将LangGraph图转换为graphviz图
            # 注意：这里需要根据LangGraph的实际API调整
            # 可能需要遍历节点和边，手动构建graphviz图
            dot_graph = cls._convert_to_graphviz(graph_obj, flow_name)
            
            # 生成PNG图片
            dot_graph.layout(prog='dot')
            dot_graph.draw(str(image_path), format='png')
            
        except ImportError:
            logger.warning("pygraphviz未安装，使用占位图片")
            cls._generate_placeholder_image(image_path, flow_name)
        except Exception as e:
            logger.warning(f"使用graphviz生成图片失败: {e}，使用占位图片")
            cls._generate_placeholder_image(image_path, flow_name)
        
        return image_path
    except Exception as e:
        # ... 错误处理 ...
```

**注意事项**：
- LangGraph的`get_graph()`方法返回的图对象结构需要实际测试
- 如果LangGraph不直接支持graphviz，可能需要手动构建graphviz图
- 如果实现复杂，可以先使用占位图片，后续再完善

### 5.2 替代方案

如果LangGraph的流程图可视化实现困难，可以考虑以下替代方案：

1. **使用Mermaid图表**
   - 手动解析流程定义，生成Mermaid语法
   - 使用mermaid库在服务端渲染为图片

2. **使用NetworkX + Matplotlib**
   - 将流程转换为NetworkX图
   - 使用Matplotlib绘制

3. **前端渲染**
   - 后端只提供流程结构数据
   - 前端使用D3.js、Cytoscape.js等库渲染

---

## 六、数据模型设计

### 6.1 FlowDefinition（现有）

```python
class FlowDefinition(BaseModel):
    name: str
    version: str
    description: Optional[str]
    nodes: List[NodeDefinition]
    edges: List[EdgeDefinition]
    entry_node: str
    flow_dir: Optional[str]
```

### 6.2 FlowPreviewInfo（新增）

```python
class FlowPreviewInfo(FlowDefinition):
    is_compiled: bool  # 是否已编译
    preview_image_path: Optional[str]  # 预览图片路径
```

### 6.3 API响应格式

**GET /api/v1/flows 响应示例**：

```json
[
    {
        "name": "medical_agent",
        "version": "1.0.0",
        "description": "医疗咨询流程",
        "nodes": [...],
        "edges": [...],
        "entry_node": "start",
        "flow_dir": "medical_agent",
        "is_compiled": true,
        "preview_image_path": "/static/flow_previews/medical_agent.png"
    },
    {
        "name": "work_plan_agent",
        "version": "1.0.0",
        "description": "工作计划流程",
        "nodes": [...],
        "edges": [...],
        "entry_node": "start",
        "flow_dir": "work_plan_agent",
        "is_compiled": false,
        "preview_image_path": null
    }
]
```

---

## 七、API设计

### 7.1 流程字典API

**端点**：`GET /api/v1/flows`

**描述**：获取所有流程列表

**响应**：`List[FlowPreviewInfo]`

**状态码**：
- 200: 成功
- 500: 服务器错误

### 7.2 流程图预览API

**端点**：`GET /api/v1/flows/{flow_name}/preview`

**描述**：获取或生成流程图预览图片

**路径参数**：
- `flow_name`: 流程名称

**查询参数**：
- `force`: boolean，是否强制重新生成（默认false）

**响应**：图片文件（PNG格式）

**状态码**：
- 200: 成功
- 404: 流程不存在
- 400: 参数错误
- 500: 服务器错误

---

## 八、实施步骤

### 阶段一：后端基础实现（1-2天）

1. ✅ 创建`FlowPreviewInfo`类
2. ✅ 创建`FlowPreviewService`服务类
3. ✅ 实现流程字典API
4. ✅ 实现流程图预览API（使用占位图片）
5. ✅ 配置静态文件服务
6. ✅ 测试API功能

### 阶段二：前端流程选择改造（0.5天）

1. ✅ 修改聊天组件，使用API获取流程列表
2. ✅ 更新登录弹框中的流程选择
3. ✅ 测试流程选择功能

### 阶段三：流程预览Tab页（1-2天）

1. ✅ 创建流程预览组件
2. ✅ 集成到主界面
3. ✅ 实现流程图展示功能
4. ✅ 测试预览功能

### 阶段四：流程图可视化实现（2-3天，可选）

1. ⚠️ 研究LangGraph的流程图可视化API
2. ⚠️ 实现真正的流程图生成逻辑
3. ⚠️ 替换占位图片实现
4. ⚠️ 测试和优化

### 阶段五：测试和优化（1天）

1. ⚠️ 端到端测试
2. ⚠️ 性能优化
3. ⚠️ 错误处理完善
4. ⚠️ 文档完善

---

## 九、注意事项

### 9.1 代码隔离

- 流程图预览功能独立于业务流程编译
- 预览图片生成不影响流程执行
- `FlowPreviewService`独立于`FlowManager`

### 9.2 性能考虑

- 流程图生成可能比较耗时，考虑异步生成
- 生成的图片缓存到固定目录，避免重复生成
- 前端可以根据图片是否存在决定是否显示

### 9.3 错误处理

- API调用失败时，前端应该有降级方案（使用默认流程列表）
- 流程图生成失败时，应该给出友好的错误提示
- 静态文件服务需要处理文件不存在的情况

### 9.4 安全性

- 流程名称需要验证，防止路径遍历攻击
- 静态文件服务应该限制访问范围
- API应该添加适当的权限控制（如果需要）

### 9.5 向后兼容

- 所有改动不影响现有的流程编译和执行逻辑
- `FlowDefinition`类保持不变
- 现有的API不受影响

### 9.6 流程图可视化

- LangGraph的流程图可视化可能需要进一步研究
- 如果实现复杂，可以先使用占位图片
- 后续可以根据实际需求选择最适合的可视化方案

---

## 十、总结

本方案实现了以下功能：

1. ✅ **流程字典API**：后端提供统一的流程列表API
2. ✅ **前端流程选择改造**：聊天界面使用API数据源
3. ✅ **流程预览Tab页**：新增独立的流程预览界面
4. ✅ **流程图生成机制**：独立的预览服务，支持按需生成

所有实现都遵循解耦原则，不影响现有功能，可以分阶段实施。

---

**文档版本**：V1.0  
**最后更新**：2025-01-XX

---

## 十一、实际开发情况

### 开发时间
2025-01-XX

### 已完成的工作

#### 阶段一：后端基础实现 ✅

1. ✅ **创建`FlowPreviewInfo`类**
   - 文件位置：`backend/domain/flows/definition.py`
   - 继承自`FlowDefinition`，新增`is_compiled`和`preview_image_path`字段
   - 代码已实现并测试通过

2. ✅ **创建`FlowPreviewService`服务类**
   - 文件位置：`backend/domain/flows/preview_service.py`
   - 实现了流程图预览图片的生成和缓存管理
   - 当前使用占位图片实现（PIL生成），待后续实现真正的流程图可视化

3. ✅ **实现流程字典API**
   - 文件位置：`backend/app/api/routes/flows.py`
   - API端点：`GET /api/v1/flows`
   - 直接从`FlowManager._flow_definitions`缓存获取数据
   - 返回`FlowPreviewInfo`列表，包含流程基本信息和预览信息

4. ✅ **实现流程图预览API**
   - 文件位置：`backend/app/api/routes/flows.py`
   - API端点：`GET /api/v1/flows/{flow_name}/preview`
   - 支持按需生成流程图预览图片
   - 支持`force`参数强制重新生成

5. ✅ **注册路由**
   - 文件位置：`backend/app/api/routes/__init__.py`
   - 已将流程管理路由注册到主路由

6. ⚠️ **静态文件服务配置**
   - **待完成**：需要配置静态文件服务，使流程图预览图片可通过HTTP访问
   - **问题说明**：当前`/static`已挂载到`frontend`目录，而流程图预览图片存储在项目根目录的`static/flow_previews/`目录
   - **待解决**：需要新增一个路径（如`/flow_previews/`）来挂载`static/flow_previews/`目录，或者调整存储路径

### 已完成的工作（阶段二和阶段三）

#### 阶段二：前端流程选择改造 ✅

1. ✅ **修改聊天组件流程选择**
   - 文件位置：`frontend/js/chat.js`
   - ✅ 添加`FLOWS_API_URL`常量
   - ✅ 添加`flowList`和`loadingFlows`变量
   - ✅ 添加`loadFlowList`函数，从API获取流程列表
   - ✅ 修改登录弹框中的流程选择下拉框，使用API数据源（v-for循环flowList）
   - ✅ 在组件挂载时加载流程列表（onMounted中调用loadFlowList）
   - ✅ 在return语句中添加flowList、loadingFlows、loadFlowList

#### 阶段三：流程预览Tab页 ✅

1. ✅ **创建流程预览组件**
   - 文件位置：`frontend/js/flow-preview.js`（已新建）
   - ✅ 实现流程列表展示
   - ✅ 实现流程图预览功能
   - ✅ 实现重新生成流程图功能
   - ✅ 支持选择流程并显示流程图预览
   - ✅ 支持刷新流程列表

2. ✅ **集成流程预览Tab到主界面**
   - 文件位置：`frontend/index.html`、`frontend/js/framework.js`
   - ✅ 在菜单中添加"流程预览"选项
   - ✅ 在框架组件中注册流程预览组件（tabConfigs中添加flow-preview配置）
   - ✅ 注册相关图标组件（Document图标）
   - ✅ 引入flow-preview.js脚本
   - ✅ 注册FlowPreviewComponent组件

### 待完成的工作

#### 阶段四：流程图可视化实现 ⚠️

1. ⚠️ **实现真正的流程图可视化**
   - 当前使用PIL生成占位图片
   - 需要研究LangGraph的流程图可视化API
   - 需要实现真正的流程图生成逻辑（可能需要graphviz或替代方案）

#### 其他待解决问题

1. ⚠️ **静态文件服务配置**
   - 需要解决流程图预览图片的访问路径问题
   - 建议方案：在`main.py`中新增路径`/flow_previews/`挂载项目根目录的`static/flow_previews/`目录
   - 或者调整存储路径为`frontend/flow_previews/`，使用现有的`/static`挂载

2. ⚠️ **测试**
   - 需要测试API功能（流程字典API、流程图预览API）
   - 需要测试前端功能（流程选择、流程预览）
   - 需要端到端测试

### 代码文件清单

#### 已创建/修改的文件

1. `backend/domain/flows/definition.py` - 新增`FlowPreviewInfo`类
2. `backend/domain/flows/preview_service.py` - 新建，流程预览服务
3. `backend/app/api/routes/flows.py` - 新建，流程管理API路由
4. `backend/app/api/routes/__init__.py` - 修改，注册流程管理路由

#### 已创建/修改的文件（阶段二和阶段三）

5. `frontend/js/chat.js` - ✅ 已修改，添加流程列表API集成
6. `frontend/js/flow-preview.js` - ✅ 已新建，流程预览组件
7. `frontend/js/framework.js` - ✅ 已修改，注册流程预览组件
8. `frontend/index.html` - ✅ 已修改，添加流程预览菜单项和图标

#### 待创建/修改的文件

1. `backend/main.py` - ⚠️ 需要修改，配置流程图预览图片的静态文件服务

### 开发建议

1. ⚠️ **优先完成静态文件服务配置**：这是流程图预览功能正常工作的前提（待完成）
2. ✅ **前端流程选择改造**：已完成，可以验证API功能
3. ✅ **流程预览Tab页**：已完成，但需要静态文件服务配置才能完整工作
4. ⚠️ **流程图可视化**：当前使用占位图片，需要后续实现真正的可视化

### 已知问题

1. **静态文件路径冲突**：`/static`已挂载到`frontend`目录，流程图预览图片需要使用不同的路径
2. **流程图可视化**：当前使用占位图片，需要研究LangGraph的实际API
3. **PIL依赖**：`preview_service.py`中使用了PIL（Pillow），需要确认`requirements.txt`中是否包含该依赖

