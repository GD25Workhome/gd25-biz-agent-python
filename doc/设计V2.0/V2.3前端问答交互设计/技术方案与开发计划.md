# V2.3 前端问答交互设计 - 技术方案与开发计划

## 背景与目标
- 需求：为现有 `/api/v1/chat` 接口提供一个最简 HTML 网页聊天界面，便于业务方快速验证多轮对话。
- 目标：前端无需框架，页面能自动适配 .env 配置的服务端口；保留对话上下文并展示问答记录；保持接口兼容性。

## 功能范围与接口
- 后端接口：`POST /api/v1/chat`，请求体包含 `message`、`session_id`、`user_id`、可选 `conversation_history`。
- 响应字段：`response`（助手回复）、`session_id`、`intent`、`agent`。
- CORS 已允许全部来源，前端可直接通过 Fetch 访问。

## 技术方案
### 前端（纯 HTML + 原生 JS）
- 静态资源路径：`/web/chat.html`；通过 `app.main` 挂载 `StaticFiles` 暴露。
- API 地址：`const apiUrl = \`\${window.location.origin}/api/v1/chat\``，自动复用当前 host 与 port，满足 .env 端口切换。
- 状态管理：在前端维护 `history` 数组，发送请求时随 `conversation_history` 一并传递，保持多轮上下文。
- 交互要点：输入 `user_id` 与 `session_id`（默认生成时间戳），文本区输入消息；点击发送或 `Ctrl/Cmd + Enter` 触发；重置按钮清空历史并刷新会话 ID。
- 体验与可用性：简单样式、滚动日志、发送过程禁用按钮，错误提示展示后端 detail。

### 后端改造
- 配置：`app/core/config.py` 新增 `APP_HOST`、`APP_PORT`，从 `.env` 加载，默认 `0.0.0.0:8000`。
- 启动：`app.main.run_server()` 使用 `uvicorn.run("app.main:app", host=APP_HOST, port=APP_PORT, reload=DEBUG)`，允许通过 `.env` 动态修改端口。
- 静态资源：在 `app.main` 通过 `StaticFiles` 挂载 `/web`，指向仓库根目录下的 `web` 目录，供前端页面访问。
- 兼容性：现有 API 路由与中间件保持不变，新增能力不影响原有调用方。

### 配置与部署
- `.env` 示例：
  - `APP_HOST=0.0.0.0`
  - `APP_PORT=8000`
- 启动命令（二选一）：
  - `python -m app.main`（走 `run_server`，读取 .env）
  - `uvicorn app.main:app --host $APP_HOST --port $APP_PORT --reload`
- 访问方式：启动后打开 `http://<APP_HOST>:<APP_PORT>/web/chat.html`，直接在页面内调试对话。

## 开发计划
- 任务 1：新增 APP_HOST/APP_PORT 配置与 `.env` 示例，封装 uvicorn 启动入口。**状态：已完成**
- 任务 2：挂载静态目录 `/web`，确保页面可被 FastAPI 提供。**状态：已完成**
- 任务 3：实现纯 HTML 聊天页面（输入/发送/重置、历史渲染、错误提示）。**状态：已完成**
- 任务 4：编写技术方案与测试要点文档，确认对外使用指引。**状态：已完成**

## 测试计划
- 接口联调：新会话首次提问返回正常；同一 `session_id` 连续多轮能带上下文；变更 `APP_PORT` 后仍可正常访问。
- 异常验证：后端 4xx/5xx 时前端能展示 `detail`；必填字段为空时前端拦截并提示。
- 跨域与路径：`/web/chat.html` 打开后可直接访问 `window.location.origin/api/v1/chat`，无需额外配置；确认 HTTPS/HTTP 均能正确拼接端点。
