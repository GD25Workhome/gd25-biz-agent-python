# æµç¨‹å›¾è¾¹è·¯ç”±é—­åŒ…é—®é¢˜æ·±åº¦åˆ†æ

## ä¸€ã€é—®é¢˜æè¿°

### 1.1 ç”¨æˆ·å‘ç°çš„é—®é¢˜

ç”¨æˆ·åœ¨å®é™…æµ‹è¯•ä¸­å‘ç°ï¼š
- å½“ LangGraph æµç¨‹ç¬¬ä¸€æ¬¡è¿›å…¥ `builder.py:64-65` è¿™è¡Œä»£ç æ—¶
- `edges_list` çš„å€¼æ˜¯ `config/flows/medical_agent_v2/flow.yaml:87-93` çš„è¾¹ï¼ˆ`record_agent` çš„è¾¹ï¼‰
- è€Œä¸æ˜¯é¢„æœŸçš„ `config/flows/medical_agent_v2/flow.yaml:78-79` çš„è¾¹ï¼ˆ`intent_recognition` çš„è¾¹ï¼‰

**é—®é¢˜è¡¨ç°**ï¼š
- `intent_recognition` èŠ‚ç‚¹çš„è·¯ç”±å‡½æ•°ä½¿ç”¨äº† `record_agent` èŠ‚ç‚¹çš„è¾¹
- å¯¼è‡´ `intent_recognition` èŠ‚ç‚¹çš„è·¯ç”±é€»è¾‘é”™è¯¯

### 1.2 ç›¸å…³ä»£ç 

**é—®é¢˜ä»£ç ä½ç½®**ï¼š`backend/domain/flows/builder.py:48-82`

```python
# æ·»åŠ è¾¹
for from_node, edges in edges_by_from.items():
    # æ£€æŸ¥æ˜¯å¦æœ‰æ¡ä»¶è¾¹ï¼ˆéalwaysçš„è¾¹ï¼‰
    conditional_edges = [e for e in edges if e.condition != "always"]
    always_edges = [e for e in edges if e.condition == "always"]
    
    if conditional_edges and always_edges:
        raise ValueError(f"èŠ‚ç‚¹ {from_node} åŒæ—¶åŒ…å«æ¡ä»¶è¾¹å’Œæ™®é€šè¾¹ï¼Œä¸æ”¯æŒ")
    
    if conditional_edges:
        # æ¡ä»¶è¾¹ï¼šåˆ›å»ºè·¯ç”±å‡½æ•°
        # ä½¿ç”¨åˆ—è¡¨æ•è·ï¼Œé¿å…é—­åŒ…é—®é¢˜
        edges_list = conditional_edges.copy()  # â† é—®é¢˜æ‰€åœ¨
        
        def route_func(state: FlowState):  # â† é—­åŒ…æ•è·äº† edges_list
            """è·¯ç”±å‡½æ•°"""
            for edge in edges_list:  # â† è¿™é‡Œå¼•ç”¨çš„ edges_list æ˜¯å¾ªç¯å˜é‡
                if GraphBuilder._evaluate_condition(edge.condition, state):
                    if edge.to_node == "END":
                        return END
                    return edge.to_node
            return END
        
        # æ„å»ºè·¯ç”±æ˜ å°„
        route_map = {}
        for edge in conditional_edges:
            target = END if edge.to_node == "END" else edge.to_node
            route_map[target] = target
        route_map[END] = END
        
        graph.add_conditional_edges(from_node, route_func, route_map)
```

## äºŒã€é—­åŒ…é—®é¢˜æ ¹æºåˆ†æ

### 2.1 Python é—­åŒ…æœºåˆ¶

**é—­åŒ…çš„å®šä¹‰**ï¼š
- é—­åŒ…æ˜¯ä¸€ä¸ªå‡½æ•°å¯¹è±¡ï¼Œå®ƒå¼•ç”¨äº†å¤–éƒ¨ä½œç”¨åŸŸçš„å˜é‡
- é—­åŒ…åœ¨å‡½æ•°å®šä¹‰æ—¶æ•è·å˜é‡çš„**å¼•ç”¨**ï¼Œè€Œä¸æ˜¯å˜é‡çš„**å€¼**

**å…³é”®ç‚¹**ï¼š
- Python çš„é—­åŒ…æ•è·çš„æ˜¯**å˜é‡å**ï¼Œè€Œä¸æ˜¯å˜é‡çš„**å€¼**
- å¦‚æœå˜é‡åœ¨é—­åŒ…åˆ›å»ºåè¢«ä¿®æ”¹ï¼Œé—­åŒ…å†…éƒ¨è®¿é—®çš„ä¹Ÿæ˜¯ä¿®æ”¹åçš„å€¼

### 2.2 é—®é¢˜ä»£ç çš„æ‰§è¡Œæµç¨‹

å‡è®¾ `edges_by_from` çš„è¿­ä»£é¡ºåºæ˜¯ï¼š
1. `intent_recognition` â†’ 4æ¡è¾¹
2. `record_agent` â†’ 2æ¡è¾¹
3. `after_record_agent` â†’ 1æ¡è¾¹
4. `query_agent` â†’ 1æ¡è¾¹
5. `qa_agent` â†’ 1æ¡è¾¹
6. `unclear_agent` â†’ 1æ¡è¾¹

**æ‰§è¡Œè¿‡ç¨‹**ï¼š

```python
# ç¬¬ä¸€æ¬¡å¾ªç¯ï¼šfrom_node = "intent_recognition"
conditional_edges = [intent_recognitionçš„4æ¡è¾¹]
edges_list = [intent_recognitionçš„4æ¡è¾¹].copy()  # åˆ›å»ºæ–°åˆ—è¡¨

def route_func(state: FlowState):
    for edge in edges_list:  # â† é—­åŒ…æ•è·äº†å˜é‡å edges_list
        ...

graph.add_conditional_edges("intent_recognition", route_func, route_map)
# æ­¤æ—¶ route_func å†…éƒ¨å¼•ç”¨çš„ edges_list å˜é‡åæŒ‡å‘ [intent_recognitionçš„4æ¡è¾¹]

# ç¬¬äºŒæ¬¡å¾ªç¯ï¼šfrom_node = "record_agent"
conditional_edges = [record_agentçš„2æ¡è¾¹]
edges_list = [record_agentçš„2æ¡è¾¹].copy()  # â† é‡æ–°èµ‹å€¼ï¼å˜é‡å edges_list ç°åœ¨æŒ‡å‘æ–°åˆ—è¡¨

def route_func(state: FlowState):
    for edge in edges_list:  # â† é—­åŒ…æ•è·äº†å˜é‡å edges_listï¼ˆåŒä¸€ä¸ªå˜é‡åï¼ï¼‰
        ...

graph.add_conditional_edges("record_agent", route_func, route_map)
# æ­¤æ—¶ï¼š
# - "intent_recognition" çš„ route_func å†…éƒ¨å¼•ç”¨çš„ edges_list å˜é‡åç°åœ¨æŒ‡å‘ [record_agentçš„2æ¡è¾¹]ï¼
# - "record_agent" çš„ route_func å†…éƒ¨å¼•ç”¨çš„ edges_list å˜é‡åæŒ‡å‘ [record_agentçš„2æ¡è¾¹]
```

**é—®é¢˜æ ¹æº**ï¼š
- è™½ç„¶ `edges_list = conditional_edges.copy()` åˆ›å»ºäº†æ–°çš„åˆ—è¡¨å¯¹è±¡
- ä½†æ˜¯æ‰€æœ‰ `route_func` å‡½æ•°éƒ½å¼•ç”¨**åŒä¸€ä¸ªå˜é‡å** `edges_list`
- å½“å¾ªç¯ç»§ç»­æ‰§è¡Œæ—¶ï¼Œ`edges_list` å˜é‡è¢«é‡æ–°èµ‹å€¼
- æ‰€æœ‰ä¹‹å‰åˆ›å»ºçš„ `route_func` å‡½æ•°å†…éƒ¨å¼•ç”¨çš„ `edges_list` éƒ½å˜æˆäº†æœ€åä¸€æ¬¡å¾ªç¯çš„å€¼ï¼

### 2.3 ä¸ºä»€ä¹ˆ `.copy()` ä¸èƒ½è§£å†³é—®é¢˜

**é”™è¯¯ç†è§£**ï¼š
- è®¤ä¸º `edges_list = conditional_edges.copy()` åˆ›å»ºäº†æ–°åˆ—è¡¨ï¼Œå°±èƒ½é¿å…é—­åŒ…é—®é¢˜
- å®é™…ä¸Šï¼Œ`.copy()` åªæ˜¯åˆ›å»ºäº†æ–°çš„åˆ—è¡¨å¯¹è±¡ï¼Œä½†å˜é‡å `edges_list` ä»ç„¶åœ¨å¾ªç¯ä¸­è¢«é‡æ–°èµ‹å€¼

**æ­£ç¡®çš„ç†è§£**ï¼š
- é—­åŒ…æ•è·çš„æ˜¯**å˜é‡å**ï¼Œä¸æ˜¯å˜é‡å€¼
- å³ä½¿åˆ›å»ºäº†æ–°å¯¹è±¡ï¼Œå¦‚æœå˜é‡åè¢«é‡æ–°èµ‹å€¼ï¼Œæ‰€æœ‰é—­åŒ…éƒ½ä¼šçœ‹åˆ°æ–°å€¼

### 2.4 éªŒè¯é—®é¢˜

**æµ‹è¯•ä»£ç **ï¼ˆæ¨¡æ‹Ÿé—®é¢˜ï¼‰ï¼š

```python
functions = []
for i in range(3):
    data = [i]  # åˆ›å»ºæ–°åˆ—è¡¨
    def func():
        return data  # é—­åŒ…æ•è·å˜é‡å data
    functions.append(func)

# æ‰€æœ‰å‡½æ•°éƒ½è¿”å› [2]ï¼Œå› ä¸ºå˜é‡å data åœ¨æœ€åä¸€æ¬¡å¾ªç¯æ—¶è¢«èµ‹å€¼ä¸º [2]
print([f() for f in functions])  # è¾“å‡º: [[2], [2], [2]]
```

## ä¸‰ã€è§£å†³æ–¹æ¡ˆ

### 3.1 æ–¹æ¡ˆ1ï¼šä½¿ç”¨é»˜è®¤å‚æ•°ï¼ˆæ¨èï¼‰

**åŸç†**ï¼š
- Python å‡½æ•°çš„é»˜è®¤å‚æ•°åœ¨å‡½æ•°å®šä¹‰æ—¶æ±‚å€¼
- é»˜è®¤å‚æ•°çš„å€¼ä¼šè¢«"å†»ç»“"åœ¨å‡½æ•°å¯¹è±¡ä¸­
- å³ä½¿å¤–éƒ¨å˜é‡è¢«ä¿®æ”¹ï¼Œé»˜è®¤å‚æ•°çš„å€¼ä¸ä¼šæ”¹å˜

**ä¿®å¤ä»£ç **ï¼š

```python
if conditional_edges:
    # æ¡ä»¶è¾¹ï¼šåˆ›å»ºè·¯ç”±å‡½æ•°
    edges_list = conditional_edges.copy()
    
    def route_func(state: FlowState, edges_list=edges_list):  # â† ä½¿ç”¨é»˜è®¤å‚æ•°
        """è·¯ç”±å‡½æ•°"""
        for edge in edges_list:  # â† ä½¿ç”¨é»˜è®¤å‚æ•°ï¼Œè€Œä¸æ˜¯å¤–éƒ¨å˜é‡
            if GraphBuilder._evaluate_condition(edge.condition, state):
                if edge.to_node == "END":
                    return END
                return edge.to_node
        return END
    
    # æ„å»ºè·¯ç”±æ˜ å°„
    route_map = {}
    for edge in conditional_edges:
        target = END if edge.to_node == "END" else edge.to_node
        route_map[target] = target
    route_map[END] = END
    
    graph.add_conditional_edges(from_node, route_func, route_map)
```

**ä¼˜ç‚¹**ï¼š
- âœ… ç®€å•ç›´æ¥
- âœ… æ€§èƒ½å¥½ï¼ˆé»˜è®¤å‚æ•°åœ¨å‡½æ•°å®šä¹‰æ—¶æ±‚å€¼ä¸€æ¬¡ï¼‰
- âœ… ä»£ç æ”¹åŠ¨æœ€å°

### 3.2 æ–¹æ¡ˆ2ï¼šä½¿ç”¨ lambda å’Œé»˜è®¤å‚æ•°

**ä¿®å¤ä»£ç **ï¼š

```python
if conditional_edges:
    # æ¡ä»¶è¾¹ï¼šåˆ›å»ºè·¯ç”±å‡½æ•°
    edges_list = conditional_edges.copy()
    
    route_func = lambda state, edges=edges_list: (  # â† ä½¿ç”¨ lambda å’Œé»˜è®¤å‚æ•°
        next(
            (END if edge.to_node == "END" else edge.to_node)
            for edge in edges
            if GraphBuilder._evaluate_condition(edge.condition, state)
        ),
        END
    )[0] if any(GraphBuilder._evaluate_condition(e.condition, state) for e in edges) else END
    
    # æˆ–è€…æ›´æ¸…æ™°çš„å†™æ³•ï¼š
    def create_route_func(edges):
        """åˆ›å»ºè·¯ç”±å‡½æ•°çš„å·¥å‚å‡½æ•°"""
        edges_list = edges.copy()
        def route_func(state: FlowState):
            for edge in edges_list:
                if GraphBuilder._evaluate_condition(edge.condition, state):
                    if edge.to_node == "END":
                        return END
                    return edge.to_node
            return END
        return route_func
    
    route_func = create_route_func(conditional_edges)
```

**ä¼˜ç‚¹**ï¼š
- âœ… æ›´å‡½æ•°å¼ç¼–ç¨‹é£æ ¼
- âœ… æ˜ç¡®åœ°å°†è¾¹åˆ—è¡¨ä½œä¸ºå‚æ•°ä¼ å…¥

### 3.3 æ–¹æ¡ˆ3ï¼šä½¿ç”¨å·¥å‚å‡½æ•°ï¼ˆæœ€æ¸…æ™°ï¼‰

**ä¿®å¤ä»£ç **ï¼š

```python
if conditional_edges:
    # æ¡ä»¶è¾¹ï¼šåˆ›å»ºè·¯ç”±å‡½æ•°
    def create_route_func(edges):
        """åˆ›å»ºè·¯ç”±å‡½æ•°çš„å·¥å‚å‡½æ•°"""
        edges_list = edges.copy()  # åœ¨å·¥å‚å‡½æ•°å†…éƒ¨åˆ›å»ºå‰¯æœ¬
        
        def route_func(state: FlowState):
            """è·¯ç”±å‡½æ•°"""
            for edge in edges_list:  # â† é—­åŒ…æ•è·å·¥å‚å‡½æ•°çš„å±€éƒ¨å˜é‡
                if GraphBuilder._evaluate_condition(edge.condition, state):
                    if edge.to_node == "END":
                        return END
                    return edge.to_node
            return END
        
        return route_func
    
    route_func = create_route_func(conditional_edges)
    
    # æ„å»ºè·¯ç”±æ˜ å°„
    route_map = {}
    for edge in conditional_edges:
        target = END if edge.to_node == "END" else edge.to_node
        route_map[target] = target
    route_map[END] = END
    
    graph.add_conditional_edges(from_node, route_func, route_map)
```

**ä¼˜ç‚¹**ï¼š
- âœ… æœ€æ¸…æ™°ï¼Œé€»è¾‘æœ€æ˜ç¡®
- âœ… æ¯ä¸ªè·¯ç”±å‡½æ•°éƒ½æœ‰ç‹¬ç«‹çš„é—­åŒ…ä½œç”¨åŸŸ
- âœ… æ˜“äºç†è§£å’Œç»´æŠ¤

## å››ã€æ¨èä¿®å¤æ–¹æ¡ˆ

### 4.1 æ¨èä½¿ç”¨æ–¹æ¡ˆ1ï¼ˆé»˜è®¤å‚æ•°ï¼‰

**åŸå› **ï¼š
1. ä»£ç æ”¹åŠ¨æœ€å°
2. æ€§èƒ½æœ€å¥½ï¼ˆé»˜è®¤å‚æ•°åœ¨å‡½æ•°å®šä¹‰æ—¶æ±‚å€¼ä¸€æ¬¡ï¼‰
3. æ˜“äºç†è§£

**å®Œæ•´ä¿®å¤ä»£ç **ï¼š

```python
# æ·»åŠ è¾¹
for from_node, edges in edges_by_from.items():
    # æ£€æŸ¥æ˜¯å¦æœ‰æ¡ä»¶è¾¹ï¼ˆéalwaysçš„è¾¹ï¼‰
    conditional_edges = [e for e in edges if e.condition != "always"]
    always_edges = [e for e in edges if e.condition == "always"]
    
    if conditional_edges and always_edges:
        # æ··åˆæƒ…å†µï¼šæ—¢æœ‰æ¡ä»¶è¾¹åˆæœ‰æ™®é€šè¾¹ï¼ˆä¸æ”¯æŒï¼ŒæŠ¥é”™ï¼‰
        raise ValueError(f"èŠ‚ç‚¹ {from_node} åŒæ—¶åŒ…å«æ¡ä»¶è¾¹å’Œæ™®é€šè¾¹ï¼Œä¸æ”¯æŒ")
    
    if conditional_edges:
        # æ¡ä»¶è¾¹ï¼šåˆ›å»ºè·¯ç”±å‡½æ•°
        # å…³é”®ä¿®å¤ï¼šä½¿ç”¨é»˜è®¤å‚æ•°é¿å…é—­åŒ…é—®é¢˜
        edges_list = conditional_edges.copy()
        
        def route_func(state: FlowState, edges_list=edges_list):  # â† ä¿®å¤ï¼šä½¿ç”¨é»˜è®¤å‚æ•°
            """è·¯ç”±å‡½æ•°"""
            for edge in edges_list:  # â† ä½¿ç”¨é»˜è®¤å‚æ•°ï¼Œè€Œä¸æ˜¯å¤–éƒ¨å˜é‡
                if GraphBuilder._evaluate_condition(edge.condition, state):
                    # å¦‚æœç›®æ ‡æ˜¯å­—ç¬¦ä¸² "END"ï¼Œè½¬æ¢ä¸º END å¯¹è±¡
                    if edge.to_node == "END":
                        return END
                    return edge.to_node
            return END
        
        # æ„å»ºè·¯ç”±æ˜ å°„
        route_map = {}
        for edge in conditional_edges:
            # å¦‚æœç›®æ ‡æ˜¯å­—ç¬¦ä¸² "END"ï¼Œè½¬æ¢ä¸º END å¯¹è±¡
            target = END if edge.to_node == "END" else edge.to_node
            route_map[target] = target
        
        # ç¡®ä¿ END åœ¨è·¯ç”±æ˜ å°„ä¸­ï¼ˆå³ä½¿æ²¡æœ‰æ˜¾å¼ä½¿ç”¨ï¼‰
        route_map[END] = END
        
        graph.add_conditional_edges(from_node, route_func, route_map)
    else:
        # æ™®é€šè¾¹
        for edge in always_edges:
            # å¦‚æœç›®æ ‡æ˜¯å­—ç¬¦ä¸² "END"ï¼Œè½¬æ¢ä¸º END å¯¹è±¡
            target = END if edge.to_node == "END" else edge.to_node
            graph.add_edge(edge.from_node, target)
```

## äº”ã€é—®é¢˜éªŒè¯

### 5.1 éªŒè¯æ–¹æ³•

**æµ‹è¯•ä»£ç **ï¼š

```python
# æ¨¡æ‹Ÿé—®é¢˜åœºæ™¯
edges_by_from = {
    "intent_recognition": [edge1, edge2, edge3, edge4],
    "record_agent": [edge5, edge6],
}

functions = []
for from_node, edges in edges_by_from.items():
    edges_list = edges.copy()
    
    # é”™è¯¯æ–¹å¼ï¼ˆæœ‰é—­åŒ…é—®é¢˜ï¼‰
    def route_func_wrong(state):
        return [e.to_node for e in edges_list]
    functions.append(("wrong", from_node, route_func_wrong))
    
    # æ­£ç¡®æ–¹å¼ï¼ˆä½¿ç”¨é»˜è®¤å‚æ•°ï¼‰
    def route_func_correct(state, edges_list=edges_list):
        return [e.to_node for e in edges_list]
    functions.append(("correct", from_node, route_func_correct))

# éªŒè¯
for method, from_node, func in functions:
    result = func(None)
    print(f"{method} - {from_node}: {result}")
```

**é¢„æœŸè¾“å‡º**ï¼š
```
wrong - intent_recognition: [edge5.to_node, edge6.to_node]  # â† é”™è¯¯ï¼ä½¿ç”¨äº† record_agent çš„è¾¹
wrong - record_agent: [edge5.to_node, edge6.to_node]
correct - intent_recognition: [edge1.to_node, edge2.to_node, edge3.to_node, edge4.to_node]  # â† æ­£ç¡®
correct - record_agent: [edge5.to_node, edge6.to_node]
```

## å…­ã€æ€»ç»“

### 6.1 é—®é¢˜æ ¹æº

1. **é—­åŒ…æ•è·å˜é‡å**ï¼šPython é—­åŒ…æ•è·çš„æ˜¯å˜é‡åï¼Œä¸æ˜¯å˜é‡å€¼
2. **å¾ªç¯å˜é‡è¢«é‡æ–°èµ‹å€¼**ï¼šåœ¨å¾ªç¯ä¸­ï¼Œå˜é‡å `edges_list` è¢«å¤šæ¬¡é‡æ–°èµ‹å€¼
3. **æ‰€æœ‰é—­åŒ…å…±äº«å˜é‡å**ï¼šæ‰€æœ‰ `route_func` å‡½æ•°éƒ½å¼•ç”¨åŒä¸€ä¸ªå˜é‡å `edges_list`
4. **æœ€åçš„å€¼è¦†ç›–æ‰€æœ‰é—­åŒ…**ï¼šå¾ªç¯ç»“æŸåï¼Œæ‰€æœ‰é—­åŒ…éƒ½çœ‹åˆ°æœ€åä¸€æ¬¡èµ‹å€¼çš„å€¼

### 6.2 ä¿®å¤è¦ç‚¹

1. **ä½¿ç”¨é»˜è®¤å‚æ•°**ï¼šå°†è¾¹åˆ—è¡¨ä½œä¸ºé»˜è®¤å‚æ•°ä¼ å…¥ï¼Œé»˜è®¤å‚æ•°åœ¨å‡½æ•°å®šä¹‰æ—¶æ±‚å€¼
2. **æˆ–è€…ä½¿ç”¨å·¥å‚å‡½æ•°**ï¼šä¸ºæ¯ä¸ªèŠ‚ç‚¹åˆ›å»ºç‹¬ç«‹çš„é—­åŒ…ä½œç”¨åŸŸ
3. **é¿å…åœ¨å¾ªç¯ä¸­ç›´æ¥ä½¿ç”¨å¤–éƒ¨å˜é‡**ï¼šç¡®ä¿æ¯ä¸ªé—­åŒ…éƒ½æœ‰ç‹¬ç«‹çš„æ•°æ®å‰¯æœ¬

### 6.3 æ•™è®­

1. **`.copy()` ä¸èƒ½è§£å†³é—­åŒ…é—®é¢˜**ï¼šåˆ›å»ºæ–°å¯¹è±¡ä¸ç­‰äºè§£å†³é—­åŒ…é—®é¢˜
2. **é—­åŒ…æ•è·çš„æ˜¯å˜é‡å**ï¼šç†è§£ Python é—­åŒ…æœºåˆ¶çš„å…³é”®
3. **é»˜è®¤å‚æ•°æ˜¯è§£å†³æ–¹æ¡ˆ**ï¼šåœ¨å‡½æ•°å®šä¹‰æ—¶æ±‚å€¼ï¼Œå¯ä»¥"å†»ç»“"å€¼

---

**æ–‡æ¡£ç‰ˆæœ¬**ï¼šV1.0  
**åˆ›å»ºæ—¶é—´**ï¼š2025-01-28  
**é—®é¢˜ä¸¥é‡æ€§**ï¼šğŸ”´ ä¸¥é‡ï¼ˆå¯¼è‡´è·¯ç”±é€»è¾‘å®Œå…¨é”™è¯¯ï¼‰

