# 安全边界提示词的Agent讨论

## 一、安全边界规则文档分析

### 1.1 文档内容概览

**文件**：`config/prompts/local/素材/210-安全边界规则（兜底Agent）.md`

**文档规模**：1435行，内容非常详细和全面

**核心组成部分**：

1. **核心原则**（7大原则）：
   - 个人信息保护
   - 内容准确性&专业性&安全性
   - 科室领域限制
   - 非诊断原则
   - 非治疗原则
   - 涉药原则
   - 紧急情况指引

2. **边界场景定义及回复话术**（8大类场景）：
   - 诊疗相关
   - 药物相关
   - 危重症等紧急情况（16种具体症状）
   - 院内资源/政策咨询
   - 通用打招呼
   - 其他科室问题咨询
   - 非医学类问题
   - 涉及儿童内容回答边界

3. **特点分析**：
   - **全面性**：覆盖了医疗AI助手可能遇到的各种边界场景
   - **具体性**：每个场景都有详细的特征描述和标准回复话术
   - **规范性**：提供了大量固定话术模板，确保回复的合规性
   - **兜底性**：文档标题明确标注为"兜底Agent"，说明其作用是作为最后的安全保障

### 1.2 文档定位

根据文档标题和内容特点，这个安全边界规则文档的定位是：

- **兜底Agent的提示词**：用于创建一个专门的安全边界检查Agent
- **全流程安全保障**：应该应用到所有Agent的回复中，而不仅仅是某个特定节点
- **合规性保障**：确保所有医疗AI助手的回复都符合医疗规范和法律法规要求

---

## 二、当前流程设计现状分析

### 2.1 clarify_intent节点的职责

**节点位置**：`domain/router/node.py` - `clarify_intent_node()`

**当前功能**：
1. **触发条件**：当意图识别结果为 `unclear` 或 `need_clarification=True` 时触发
2. **核心职责**：生成友好的澄清问题，引导用户说明具体需求
3. **执行流程**：
   ```
   用户消息 → route节点 → 意图识别为unclear → clarify_intent节点 → 
   调用clarify_intent工具 → 生成澄清问题 → 返回route节点
   ```
4. **使用的提示词**：`router_clarify_intent_prompt`（当前约50行，简洁明了）

**当前提示词特点**：
- 专注于"澄清意图"这一单一职责
- 提示词简洁（约50行），便于LLM理解和执行
- 输出格式要求返回JSON，包含 `response_content` 和 `reasoning_summary`

### 2.2 当前流程中的安全边界处理

**现状**：
- 当前流程中**没有专门的安全边界检查节点**
- 安全边界规则**没有集成到任何Agent节点中**
- 从代码搜索结果看，项目中有安全审核相关的设计文档，但**尚未实现**

**潜在风险**：
- 所有Agent（血压、健康事件、用药、症状）的回复都没有安全边界检查
- 只有在意图不明确时才会触发 `clarify_intent` 节点，大部分正常对话不会经过该节点
- 如果只在 `clarify_intent` 节点嵌入安全边界规则，**无法覆盖大部分正常对话场景**

### 2.3 路由图结构分析

**当前路由图结构**：
```
route节点（入口）
  ├─→ clarify_intent节点（意图不明确时）
  │     └─→ 返回route节点
  │
  └─→ Agent节点（意图明确时）
        ├─→ blood_pressure_agent
        ├─→ health_event_agent
        ├─→ medication_agent
        └─→ symptom_agent
        └─→ 返回route节点
```

**关键发现**：
- `clarify_intent` 节点只在意图不明确时触发，**不是所有回复的必经节点**
- 大部分正常对话会直接路由到具体的Agent节点，**不会经过clarify_intent节点**
- 如果只在 `clarify_intent` 节点嵌入安全边界规则，**无法保护大部分正常对话**

---

## 三、可行性分析

### 3.1 将安全边界规则嵌入clarify_intent节点的可行性

#### ❌ **不推荐的原因**

1. **职责不匹配**：
   - `clarify_intent` 节点的职责是"澄清意图"，而不是"安全检查"
   - 将1435行的安全边界规则嵌入澄清节点，会**混淆节点职责**，违反单一职责原则

2. **覆盖范围不足**：
   - `clarify_intent` 节点只在意图不明确时触发（约占对话的10-20%）
   - 大部分正常对话（80-90%）会直接路由到具体Agent节点，**不会经过clarify_intent节点**
   - 如果只在clarify_intent节点嵌入安全边界规则，**无法保护大部分正常对话场景**

3. **提示词复杂度问题**：
   - 当前 `clarify_intent` 提示词约50行，简洁明了
   - 安全边界规则文档1435行，**体量巨大**
   - 将1435行的规则嵌入澄清节点，会导致：
     - 提示词过于复杂，可能影响澄清问题的生成质量
     - LLM需要同时处理"澄清意图"和"安全检查"两个任务，可能顾此失彼
     - Token消耗大幅增加，影响性能和成本

4. **维护困难**：
   - 安全边界规则和澄清逻辑混在一起，后续维护和更新会变得困难
   - 如果需要调整安全边界规则，可能会影响澄清功能的正常使用

5. **不符合文档定位**：
   - 文档标题明确标注为"兜底Agent"，说明应该创建一个独立的Agent
   - 而不是嵌入到现有的澄清节点中

### 3.2 潜在影响分析

如果强制将安全边界规则嵌入clarify_intent节点：

**正面影响**：
- ✅ 在意图不明确时，可以确保澄清问题符合安全边界
- ✅ 实现成本相对较低（只需修改一个节点的提示词）

**负面影响**：
- ❌ **无法保护大部分正常对话**（80-90%的对话不会经过clarify_intent节点）
- ❌ 提示词过于复杂，可能影响澄清问题的生成质量
- ❌ 职责混淆，违反单一职责原则
- ❌ 维护困难，后续更新安全边界规则可能影响澄清功能

---

## 四、建议方案

### 4.1 推荐方案：创建独立的安全边界Agent（兜底Agent）

**方案概述**：
创建一个专门的安全边界Agent，作为所有Agent回复的最后一道安全防线。

**实现方式**：

#### 方案A：在路由图中添加安全检查节点（推荐）

**架构设计**：
```
route节点（入口）
  ├─→ clarify_intent节点（意图不明确时）
  │     └─→ 返回route节点
  │
  └─→ Agent节点（意图明确时）
        ├─→ blood_pressure_agent
        ├─→ health_event_agent
        ├─→ medication_agent
        └─→ symptom_agent
        └─→ safety_boundary_check节点（新增）
              └─→ 返回route节点或END
```

**实现步骤**：

1. **创建安全边界检查节点**：
   ```python
   def safety_boundary_check_node(state: RouterState) -> RouterState:
       """
       安全边界检查节点：检查Agent回复是否符合安全边界规则
       
       功能：
       1. 检查最后一条AI消息是否符合安全边界规则
       2. 如果不符合，生成符合安全边界的回复
       3. 如果符合，直接通过
       """
       messages = state.get("messages", [])
       # 获取最后一条AI消息
       last_ai_message = ...
       
       # 加载安全边界规则提示词
       safety_prompt = load_safety_boundary_prompt()
       
       # 使用LLM检查回复是否符合安全边界
       # 如果不符合，生成符合安全边界的回复
       ...
       
       return state
   ```

2. **修改路由图**：
   - 所有Agent节点执行后，先经过 `safety_boundary_check` 节点
   - `safety_boundary_check` 节点检查通过后，再返回route节点

3. **创建安全边界提示词模板**：
   - 将 `210-安全边界规则（兜底Agent）.md` 转换为提示词模板
   - 存储在 `config/prompts/local/safety_boundary_check_prompt.txt`
   - 或上传到Langfuse作为模板

**优点**：
- ✅ **覆盖所有Agent回复**：所有Agent的回复都会经过安全检查
- ✅ **职责清晰**：安全检查节点独立，不影响其他节点功能
- ✅ **易于维护**：安全边界规则独立管理，更新不影响其他功能
- ✅ **符合文档定位**：作为"兜底Agent"，在最后一道防线进行检查

**缺点**：
- ⚠️ 需要修改路由图结构
- ⚠️ 增加一次LLM调用（可能影响性能）

#### 方案B：在所有Agent节点中嵌入安全边界规则

**实现方式**：
- 在每个Agent的提示词模板中，添加安全边界规则的核心原则
- 使用占位符或模板继承机制，确保所有Agent都包含安全边界规则

**优点**：
- ✅ 实现相对简单
- ✅ 不需要修改路由图结构

**缺点**：
- ❌ 提示词会变得非常庞大（每个Agent都要包含1435行的规则）
- ❌ Token消耗大幅增加
- ❌ 维护困难（需要在多个Agent中同步更新规则）
- ❌ 可能影响Agent的核心功能（提示词过于复杂）

#### 方案C：在clarify_intent节点中嵌入安全边界规则（不推荐）

**实现方式**：
- 将安全边界规则添加到 `router_clarify_intent_prompt` 中
- 在生成澄清问题时，同时检查是否符合安全边界

**优点**：
- ✅ 实现最简单

**缺点**：
- ❌ **无法保护大部分正常对话**（80-90%的对话不会经过clarify_intent节点）
- ❌ 职责混淆
- ❌ 提示词过于复杂，可能影响澄清问题生成质量

### 4.2 最终推荐：方案A（独立的安全边界检查节点）

**推荐理由**：

1. **覆盖范围最广**：
   - 所有Agent的回复都会经过安全检查
   - 确保100%的对话都符合安全边界规则

2. **职责清晰**：
   - 安全检查节点独立，职责单一
   - 不影响其他节点的核心功能

3. **易于维护**：
   - 安全边界规则独立管理
   - 更新规则时，只需修改一个节点的提示词

4. **符合文档定位**：
   - 作为"兜底Agent"，在最后一道防线进行检查
   - 符合文档标题和内容的定位

5. **性能可控**：
   - 虽然增加一次LLM调用，但可以通过以下方式优化：
     - 使用更小的模型进行安全检查
     - 使用规则引擎进行初步筛选，只对可疑回复进行LLM检查
     - 缓存常见的安全检查结果

### 4.3 实施建议

**阶段一：创建安全边界检查节点**（推荐先实施）

1. 创建 `domain/router/node.py` 中的 `safety_boundary_check_node()` 函数
2. 创建安全边界提示词模板（基于 `210-安全边界规则（兜底Agent）.md`）
3. 修改路由图，在所有Agent节点后添加安全检查节点

**阶段二：优化性能**（可选）

1. 实现规则引擎进行初步筛选
2. 使用更小的模型进行安全检查
3. 实现缓存机制

**阶段三：增强功能**（可选）

1. 添加安全边界检查的日志和监控
2. 实现人工审核机制（对于高风险回复）
3. 添加安全边界检查的评估指标

---

## 五、总结

### 5.1 核心结论

**将安全边界规则嵌入clarify_intent节点不可行**，主要原因：

1. ❌ **覆盖范围不足**：clarify_intent节点只在意图不明确时触发，无法保护大部分正常对话
2. ❌ **职责不匹配**：clarify_intent节点的职责是"澄清意图"，而不是"安全检查"
3. ❌ **提示词过于复杂**：1435行的规则会严重影响澄清问题的生成质量
4. ❌ **不符合文档定位**：文档明确标注为"兜底Agent"，应该创建独立的Agent

### 5.2 推荐方案

**创建独立的安全边界检查节点**，作为所有Agent回复的最后一道安全防线。

**实施优先级**：
- 🔴 **高优先级**：创建安全边界检查节点（方案A）
- 🟡 **中优先级**：优化性能（使用规则引擎、缓存等）
- 🟢 **低优先级**：增强功能（日志、监控、人工审核等）

### 5.3 下一步行动

1. **确认方案**：与团队确认是否采用方案A（独立的安全边界检查节点）
2. **创建节点**：实现 `safety_boundary_check_node()` 函数
3. **创建提示词模板**：将 `210-安全边界规则（兜底Agent）.md` 转换为提示词模板
4. **修改路由图**：在所有Agent节点后添加安全检查节点
5. **测试验证**：测试安全边界检查节点是否正常工作

---

**文档生成时间**：2025-01-XX  
**基于代码版本**：当前代码库状态  
**分析依据**：
- `domain/router/node.py` - clarify_intent节点实现
- `domain/router/tools/router_tools.py` - clarify_intent工具实现
- `domain/router/graph.py` - 路由图结构
- `config/prompts/local/素材/210-安全边界规则（兜底Agent）.md` - 安全边界规则文档

