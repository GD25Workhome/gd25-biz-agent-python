# LangGraphFlow V2.0 开发计划与里程碑

## 文档说明

本文档详细描述了 LangGraphFlow V2.0 版本的开发计划，采用里程碑式开发方式，确保每个阶段都有可用的版本。

**文档版本**：V2.0  
**创建时间**：2025-01-XX

---

## 目录

1. [开发策略](#一开发策略)
2. [里程碑概览](#二里程碑概览)
3. [Milestone 1: MVP 版本](#三milestone-1-mvp-版本)
4. [Milestone 2: 功能增强](#四milestone-2-功能增强)
5. [Milestone 3: 生产就绪](#五milestone-3-生产就绪)
6. [开发规范](#六开发规范)

---

## 一、开发策略

### 1.1 开发原则

1. **渐进式开发**：分阶段实现功能，每个里程碑都有可用版本
2. **测试驱动**：每个功能都包含单元测试和集成测试
3. **文档同步**：开发过程中同步更新文档
4. **代码质量**：遵循代码规范，使用类型提示和文档字符串

### 1.2 里程碑定义

每个里程碑包含：
- **功能范围**：明确的功能列表
- **验收标准**：可测试的验收标准
- **时间估算**：预计开发时间
- **依赖关系**：与其他里程碑的依赖

---

## 二、里程碑概览

| 里程碑 | 名称 | 功能范围 | 预计时间 | 状态 |
|--------|------|----------|----------|------|
| M1 | MVP 版本 | 血压 + 预约智能体 | 2-3 周 | 待开始 |
| M2 | 功能增强 | 诊断智能体 + RAG | 3-4 周 | 待开始 |
| M3 | 生产就绪 | 安全审核 + 优化 | 2-3 周 | 待开始 |

---

## 三、Milestone 1: MVP 版本

### 3.1 目标

实现最小可用版本（MVP），包含：
- 基础架构搭建
- 血压记录智能体
- 复诊管理智能体
- 基础路由功能

### 3.2 功能范围

#### 3.2.1 基础设施层

- [x] **数据库设计**
  - [x] 用户模型（User）
  - [x] 血压记录模型（BloodPressureRecord）
  - [x] 预约模型（Appointment）
  - [x] 数据库连接和连接池
  - [x] Alembic 迁移配置

- [x] **Repository 模式**
  - [x] BaseRepository 基础类
  - [x] UserRepository
  - [x] BloodPressureRepository
  - [x] AppointmentRepository

- [x] **LLM 客户端**
  - [x] LLM 客户端封装
  - [x] 支持 DeepSeek API

- [x] **外部服务集成**
  - [x] Java 微服务客户端（用于预约功能）

#### 3.2.2 领域层

- [x] **路由系统**
  - [x] RouterState 定义
  - [x] 路由图构建
  - [x] 路由节点实现
  - [x] 意图识别工具（只支持血压和预约）
  - [x] 路由决策逻辑

- [x] **血压记录智能体**
  - [x] 智能体节点工厂函数
  - [x] 系统提示词
  - [x] 工具实现：
    - [x] record_blood_pressure（记录血压）
    - [x] query_blood_pressure（查询血压）
    - [x] update_blood_pressure（更新血压）

- [x] **复诊管理智能体**
  - [x] 智能体节点工厂函数
  - [x] 系统提示词
  - [x] 工具实现：
    - [x] create_appointment（创建预约）
    - [x] query_appointment（查询预约）
    - [x] update_appointment（更新预约）

- [x] **工具注册表**
  - [x] TOOL_REGISTRY 实现
  - [x] 工具注册机制

- [x] **智能体工厂**
  - [x] AgentFactory 实现
  - [x] 配置文件加载（agents.yaml）

#### 3.2.3 应用层

- [x] **FastAPI 应用**
  - [x] main.py 应用入口
  - [x] 生命周期管理（lifespan）
  - [x] 健康检查接口

- [x] **配置管理**
  - [x] Settings 类（Pydantic Settings）
  - [x] 环境变量配置
  - [x] .env.example 文件（已创建，但被 .gitignore 阻止写入，需要手动创建）

- [x] **API 路由**
  - [x] 聊天接口（POST /api/v1/chat）
  - [x] 请求/响应模型（Pydantic Schemas）

- [x] **中间件**
  - [x] 日志中间件
  - [x] 异常处理中间件

#### 3.2.4 配置文件

- [x] **智能体配置**
  - [x] config/agents.yaml
  - [x] 血压智能体配置
  - [x] 预约智能体配置

- [x] **提示词文件**
  - [x] config/prompts/blood_pressure_prompt.txt
  - [x] config/prompts/appointment_prompt.txt

#### 3.2.5 测试

- [ ] **单元测试**
  - [ ] Repository 测试
  - [ ] 工具测试
  - [ ] 路由逻辑测试

- [ ] **集成测试**
  - [ ] API 接口测试
  - [ ] 智能体端到端测试

#### 3.2.6 文档

- [ ] **开发文档**
  - [ ] README.md 更新
  - [ ] API 文档
  - [ ] 部署文档

### 3.3 验收标准

1. **功能完整性**
   - ✅ 可以记录、查询、更新血压数据
   - ✅ 可以创建、查询、更新预约
   - ✅ 路由系统可以正确识别意图并路由到对应智能体

2. **代码质量**
   - ✅ 所有代码都有类型提示
   - ✅ 所有函数都有文档字符串
   - ✅ 通过代码检查（ruff, mypy）

3. **测试覆盖**
   - ✅ 单元测试覆盖率 > 70%
   - ✅ 集成测试通过
   - ✅ 所有关键路径都有测试

4. **文档完整性**
   - ✅ README 包含快速开始指南
   - ✅ API 文档完整
   - ✅ 配置文件有注释说明

### 3.4 详细任务分解

#### Week 1: 基础设施搭建

**Day 1-2: 项目初始化**
- [x] 创建目录结构
- [ ] 配置开发环境（conda、依赖管理）
- [ ] 初始化 Git 仓库
- [ ] 配置代码检查工具（black、ruff、mypy）

**Day 3-4: 数据库设计**
- [x] 设计数据库模型（User、BloodPressureRecord、Appointment）
- [x] 实现 SQLAlchemy 模型
- [x] 配置 Alembic
- [ ] 创建初始迁移脚本（需要运行 alembic revision --autogenerate）
- [x] 实现数据库连接和连接池

**Day 5: Repository 实现**
- [x] 实现 BaseRepository
- [x] 实现 UserRepository
- [x] 实现 BloodPressureRepository
- [x] 实现 AppointmentRepository
- [ ] 编写 Repository 单元测试

#### Week 2: 领域层实现

**Day 1-2: 路由系统**
- [x] 实现 RouterState 定义
- [x] 实现路由图构建
- [x] 实现路由节点
- [x] 实现意图识别工具（简化版，只支持血压和预约）
- [x] 实现路由决策逻辑

**Day 3-4: 血压记录智能体**
- [x] 实现血压记录工具（record、query、update）
- [x] 实现血压智能体节点工厂函数
- [x] 编写系统提示词
- [x] 配置 agents.yaml
- [ ] 编写工具单元测试

**Day 5: 复诊管理智能体**
- [x] 实现 Java 微服务客户端
- [x] 实现预约工具（create、query、update）
- [x] 实现预约智能体节点工厂函数
- [x] 编写系统提示词
- [x] 配置 agents.yaml

#### Week 3: 应用层和集成

**Day 1-2: FastAPI 应用**
- [x] 实现 main.py 应用入口
- [x] 实现生命周期管理
- [x] 实现配置管理（Settings）
- [x] 实现 API 路由
- [x] 实现中间件（日志、异常处理）

**Day 3: 工具注册和工厂**
- [x] 实现工具注册表
- [x] 实现智能体工厂
- [ ] 测试配置加载（需要实际运行测试）

**Day 4: 集成测试**
- [ ] 编写端到端测试
- [ ] 测试完整流程（记录血压、创建预约）
- [ ] 修复发现的问题

**Day 5: 文档和部署**
- [ ] 更新 README
- [ ] 编写 API 文档
- [ ] 创建 .env.example
- [ ] 编写部署文档

### 3.5 技术债务

以下功能在 MVP 版本中**不实现**，留待后续里程碑：

- ❌ 诊断智能体系统
- ❌ RAG 检索功能
- ❌ 安全审核功能
- ❌ 多科室诊断支持
- ❌ 复杂的时间解析（只支持标准格式）
- ❌ 统计功能（血压统计等）

### 3.6 预计时间

- **总时间**：2-3 周
- **开发时间**：10-12 个工作日
- **测试时间**：2-3 个工作日
- **文档时间**：1 个工作日

---

## 四、Milestone 2: 功能增强

### 4.1 目标

在 MVP 版本基础上，添加诊断智能体系统和 RAG 检索功能。

### 4.2 功能范围

#### 4.2.1 RAG 系统

- [ ] **向量存储**
  - [ ] PgVector 实现
  - [ ] ADB PG 实现（可选）
  - [ ] 向量存储工厂

- [ ] **嵌入服务**
  - [ ] 本地嵌入模型支持
  - [ ] 远程嵌入 API 支持

- [ ] **文档处理**
  - [ ] 文档加载器
  - [ ] 文本分割器
  - [ ] 知识库导入脚本

- [ ] **检索工具**
  - [ ] retrieve_diagnosis_knowledge 工具

#### 4.2.2 诊断智能体系统

- [ ] **诊断智能体基类**
  - [ ] 基础诊断智能体实现

- [ ] **各科室诊断智能体**
  - [ ] 内科诊断智能体
  - [ ] 外科诊断智能体
  - [ ] 儿科诊断智能体
  - [ ] 妇科诊断智能体
  - [ ] 心血管科诊断智能体
  - [ ] 通用诊断智能体

- [ ] **路由扩展**
  - [ ] 扩展意图识别（支持诊断意图）
  - [ ] 扩展路由决策（支持诊断智能体路由）

#### 4.2.3 功能增强

- [ ] **时间解析增强**
  - [ ] 相对时间解析（"今天早上8点"等）
  - [ ] LLM 辅助时间解析

- [ ] **统计功能**
  - [ ] 血压统计工具
  - [ ] 预约统计工具

### 4.3 验收标准

1. **功能完整性**
   - ✅ 可以检索诊断知识库
   - ✅ 各科室诊断智能体可以正常工作
   - ✅ 路由系统可以正确识别诊断意图并路由到对应科室

2. **性能要求**
   - ✅ 向量检索响应时间 < 500ms
   - ✅ 知识库检索准确率 > 80%

3. **测试覆盖**
   - ✅ RAG 系统单元测试
   - ✅ 诊断智能体集成测试

### 4.4 预计时间

- **总时间**：3-4 周
- **开发时间**：15-18 个工作日
- **测试时间**：3-4 个工作日
- **文档时间**：1-2 个工作日

---

## 五、Milestone 3: 生产就绪

### 5.1 目标

完善系统，使其达到生产环境要求。

### 5.2 功能范围

#### 5.2.1 安全审核

- [ ] **输入安全检查**
  - [ ] 敏感信息过滤
  - [ ] 输入验证

- [ ] **内容审核**
  - [ ] 输入内容审核
  - [ ] 回复内容审核
  - [ ] 审核服务集成

#### 5.2.2 性能优化

- [ ] **缓存机制**
  - [ ] Redis 集成
  - [ ] 查询结果缓存
  - [ ] 意图识别结果缓存

- [ ] **数据库优化**
  - [ ] 索引优化
  - [ ] 查询优化
  - [ ] 连接池优化

#### 5.2.3 监控和日志

- [ ] **日志系统**
  - [ ] 结构化日志
  - [ ] 日志级别管理
  - [ ] 日志聚合

- [ ] **监控指标**
  - [ ] 性能指标收集
  - [ ] 错误率监控
  - [ ] 健康检查增强

#### 5.2.4 测试完善

- [ ] **测试覆盖**
  - [ ] 单元测试覆盖率 > 80%
  - [ ] 集成测试完善
  - [ ] 压力测试

#### 5.2.5 文档完善

- [ ] **用户文档**
  - [ ] 用户手册
  - [ ] API 文档完善

- [ ] **运维文档**
  - [ ] 部署指南
  - [ ] 运维手册
  - [ ] 故障排查指南

### 5.3 验收标准

1. **安全性**
   - ✅ 通过安全审核测试
   - ✅ 敏感信息过滤正常

2. **性能**
   - ✅ API 响应时间 < 2s（P95）
   - ✅ 支持并发用户数 > 100

3. **稳定性**
   - ✅ 系统可用性 > 99%
   - ✅ 错误率 < 1%

4. **文档**
   - ✅ 所有文档完整
   - ✅ 部署文档清晰

### 5.4 预计时间

- **总时间**：2-3 周
- **开发时间**：10-12 个工作日
- **测试时间**：3-4 个工作日
- **文档时间**：2-3 个工作日

---

## 六、开发规范

### 6.1 代码规范

1. **类型提示**
   - 所有函数必须有类型提示
   - 使用 `typing` 模块的类型

2. **文档字符串**
   - 所有公共函数必须有文档字符串
   - 使用 Google 风格文档字符串

3. **代码格式**
   - 使用 `black` 格式化代码
   - 使用 `ruff` 检查代码
   - 使用 `mypy` 进行类型检查

4. **命名规范**
   - 函数和变量：`snake_case`
   - 类：`PascalCase`
   - 常量：`UPPER_SNAKE_CASE`

### 6.2 测试规范

1. **单元测试**
   - 每个模块都要有单元测试
   - 测试覆盖率 > 70%（MVP），> 80%（生产）

2. **集成测试**
   - 关键流程要有集成测试
   - 使用 pytest 框架

3. **测试数据**
   - 使用 fixtures 管理测试数据
   - 测试后清理数据

### 6.3 Git 工作流

1. **分支策略**
   - `main`: 主分支，稳定版本
   - `develop`: 开发分支
   - `feature/*`: 功能分支
   - `milestone/*`: 里程碑分支

2. **提交规范**
   - 使用清晰的提交信息
   - 格式：`<type>: <description>`
   - 类型：feat, fix, docs, test, refactor

3. **代码审查**
   - 所有代码必须经过审查
   - 至少一人审查通过才能合并

### 6.4 文档规范

1. **代码文档**
   - 所有公共 API 必须有文档
   - 使用中文文档字符串

2. **设计文档**
   - 重大设计决策需要文档
   - 架构变更需要更新文档

3. **API 文档**
   - 使用 OpenAPI/Swagger
   - 所有接口必须有文档

---

## 七、风险与应对

### 7.1 技术风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| LLM API 不稳定 | 高 | 实现重试机制和降级方案 |
| 数据库性能问题 | 中 | 提前进行性能测试和优化 |
| 外部服务依赖 | 中 | 实现优雅降级和错误处理 |

### 7.2 进度风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 开发时间估算不准确 | 中 | 预留缓冲时间，及时调整计划 |
| 需求变更 | 中 | 明确里程碑范围，控制变更 |

### 7.3 质量风险

| 风险 | 影响 | 应对措施 |
|------|------|----------|
| 测试覆盖不足 | 高 | 制定测试标准，强制执行 |
| 代码质量下降 | 中 | 代码审查，自动化检查 |

---

## 八、总结

本开发计划采用里程碑式开发方式，确保每个阶段都有可用的版本。第一个里程碑（MVP）专注于核心功能（血压和预约），为后续开发奠定基础。

**关键成功因素**：
1. 严格按照里程碑范围开发，避免范围蔓延
2. 保持代码质量，确保可维护性
3. 及时测试和文档更新
4. 团队协作和沟通

---

**文档版本**：V2.0  
**创建时间**：2025-01-XX  
**维护者**：开发团队

