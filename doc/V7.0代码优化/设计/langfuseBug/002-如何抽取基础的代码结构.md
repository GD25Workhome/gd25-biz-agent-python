# 如何抽取基础的代码结构

## 文档目的

本文档说明如何从生产代码中抽取最小化的代码结构，用于在 `cursor_test/langfuse/02flow` 目录下进行Langfuse动态流程日志记录问题的测试。

**核心原则**：
- 抽取核心依赖代码到测试目录
- 保持最小化，只包含必要的代码
- 配置从项目根目录的 `.env` 文件读取
- 在测试文件中定制化修改，不影响生产代码

---

## 一、代码抽取架构图

```
cursor_test/langfuse/02flow/
├── test_minimal_flow.py          # 测试主文件（定制化修改）
├── core/                         # 核心代码（从生产代码复制）
│   ├── __init__.py
│   ├── config.py                 # 配置（简化版，只保留Langfuse相关）
│   ├── state.py                  # 状态定义
│   └── definition.py             # 流程定义
├── langfuse/                     # Langfuse相关（完整复制）
│   ├── __init__.py
│   └── handler.py                # Langfuse Handler（完整复制）
├── flows/                        # 流程构建（简化版）
│   ├── __init__.py
│   └── builder.py                # 流程构建器（简化版）
├── agents/                       # Agent创建（简化版）
│   ├── __init__.py
│   └── factory.py                # Agent工厂（简化版）
└── llm/                          # LLM客户端（简化版）
    ├── __init__.py
    ├── client.py                 # LLM客户端（简化版）
    └── providers/
        ├── __init__.py
        ├── registry.py           # 供应商注册表（简化版）
        └── manager.py            # 供应商管理器（简化版）
```

---

## 二、核心代码清单

### 2.1 必须完整复制的代码

这些代码是核心依赖，需要完整复制，但可以简化配置读取：

#### 1. Langfuse Handler（完整复制）

**源文件**：`backend/infrastructure/observability/langfuse_handler.py`

**目标位置**：`cursor_test/langfuse/02flow/langfuse/handler.py`

**需要修改**：
- 修改导入路径：`from backend.app.config import settings` → `from core.config import settings`

**核心功能**：
- `set_langfuse_trace_context()` - 设置Trace上下文
- `create_langfuse_handler()` - 创建Handler
- `get_current_trace_id()` - 获取当前trace_id
- `normalize_langfuse_trace_id()` - 规范化trace_id
- `get_langfuse_client()` - 获取Langfuse客户端
- `is_langfuse_available()` - 检查Langfuse是否可用

**依赖项**：
- `core.config.settings`（配置）
- `contextvars.ContextVar`（标准库）
- `langfuse` 库

---

#### 2. 配置管理（简化版）

**源文件**：`backend/app/config.py`

**目标位置**：`cursor_test/langfuse/02flow/core/config.py`

**需要保留**：
- `find_project_root()` 函数（用于查找项目根目录的 `.env` 文件）
- `Settings` 类中的Langfuse相关配置
- 模型配置（如果需要测试LLM调用）

**可以移除**：
- 数据库配置
- 其他业务相关配置

**简化后的配置类**：
```python
# 只保留Langfuse和LLM相关配置
class Settings(BaseSettings):
    # Langfuse配置
    LANGFUSE_ENABLED: bool = Field(default=False)
    LANGFUSE_PUBLIC_KEY: Optional[str] = None
    LANGFUSE_SECRET_KEY: Optional[str] = None
    LANGFUSE_HOST: Optional[str] = None
    
    # LLM配置（可选，如果测试需要）
    OPENAI_API_KEY: Optional[str] = None
    DOUBAO_API_KEY: Optional[str] = None
    LLM_TEMPERATURE: float = Field(default=0.7)
```

---

### 2.2 需要简化复制的代码

这些代码需要复制核心逻辑，但可以移除不必要的依赖：

#### 3. 状态定义（完整复制）

**源文件**：`backend/domain/state.py`

**目标位置**：`cursor_test/langfuse/02flow/core/state.py`

**修改**：无，直接复制（只有类型定义）

---

#### 4. 流程定义（完整复制）

**源文件**：`backend/domain/flows/definition.py`

**目标位置**：`cursor_test/langfuse/02flow/core/definition.py`

**修改**：无，直接复制（只有数据模型）

---

#### 5. 流程构建器（简化版）

**源文件**：`backend/domain/flows/builder.py`

**目标位置**：`cursor_test/langfuse/02flow/flows/builder.py`

**需要保留**：
- `GraphBuilder.build_graph()` - 构建图的核心逻辑
- `GraphBuilder._create_node_function()` - 创建节点函数（关键！）
- `GraphBuilder._evaluate_condition()` - 条件评估

**需要修改**：
- 导入路径改为相对导入
- 简化Agent创建逻辑（可以使用Mock Agent）

**核心代码片段**（需要保留的关键逻辑）：
```python
def _create_node_function(node_def: NodeDefinition, flow_def: FlowDefinition) -> Callable:
    """创建节点函数"""
    
    if node_def.type == "agent":
        # 1. 创建Agent（编译时）
        agent_executor = AgentFactory.create_agent(...)
        
        # 2. 创建节点函数（编译时）
        def agent_node(state: FlowState) -> FlowState:
            """Agent节点函数（运行时执行）"""
            
            # 3. 运行时：从ContextVar获取trace_id（关键！）
            trace_id = get_current_trace_id()
            
            # 4. 运行时：创建Langfuse Handler（关键！）
            callbacks = []
            if trace_id:
                langfuse_handler = create_langfuse_handler()
                if langfuse_handler:
                    callbacks.append(langfuse_handler)
            
            # 5. 运行时：执行Agent，传递callbacks（关键！）
            result = agent_executor.invoke(
                {"input": input_text},
                callbacks=callbacks if callbacks else None
            )
            
            return new_state
        
        return agent_node
```

---

#### 6. Agent工厂（简化版）

**源文件**：`backend/domain/agents/factory.py`

**目标位置**：`cursor_test/langfuse/02flow/agents/factory.py`

**需要保留**：
- `AgentExecutor` 类（关键：如何传递callbacks）
- `AgentFactory.create_agent()` 的核心逻辑

**可以简化**：
- 移除工具相关逻辑（测试时可以不使用工具）
- 简化提示词加载（可以使用硬编码的提示词）
- 移除TokenContext相关逻辑

**核心代码片段**（需要保留的关键逻辑）：
```python
class AgentExecutor:
    """Agent执行器包装类"""
    
    def invoke(self, input_data: dict, callbacks: Optional[List] = None) -> dict:
        """调用Agent（关键：如何传递callbacks）"""
        
        # 如果提供了callbacks，添加到config中
        if callbacks:
            config["callbacks"] = callbacks  # 关键！
        
        # 调用LangGraph图
        result = self.graph.invoke({"messages": messages}, config)
        
        return {"output": output, "messages": result.get("messages", [])}
```

---

#### 7. LLM客户端（简化版）

**源文件**：`backend/infrastructure/llm/client.py`

**目标位置**：`cursor_test/langfuse/02flow/llm/client.py`

**需要保留**：
- `get_llm()` 函数的核心逻辑
- 自动添加Langfuse Handler的逻辑

**可以简化**：
- 移除ProviderManager依赖（测试时可以直接使用配置）
- 简化供应商配置读取

**核心代码片段**（需要保留的关键逻辑）：
```python
def get_llm(
    provider: str,
    model: str,
    callbacks: Optional[List[BaseCallbackHandler]] = None,
    **kwargs
) -> BaseChatModel:
    """获取 LLM 客户端实例"""
    
    # 准备回调处理器列表
    callback_list = list(callbacks) if callbacks else []
    
    # 自动添加Langfuse回调处理器（关键！）
    if not callbacks:
        langfuse_handler = create_langfuse_handler(...)
        if langfuse_handler:
            callback_list.append(langfuse_handler)
    
    # 创建 LLM 客户端
    llm = ChatOpenAI(
        model=model,
        callbacks=callback_list if callback_list else None,
        ...
    )
    
    return llm
```

---

#### 8. 供应商管理器（简化版）

**源文件**：`backend/infrastructure/llm/providers/manager.py`

**目标位置**：`cursor_test/langfuse/02flow/llm/providers/manager.py`

**可以简化**：
- 不需要读取YAML配置文件
- 可以直接从配置或环境变量读取
- 简化注册逻辑

**简化后的版本**：
```python
class ProviderManager:
    """模型供应商管理器（简化版）"""
    
    @classmethod
    def get_provider(cls, provider: str) -> Optional[ProviderConfig]:
        """获取模型供应商配置（从环境变量读取）"""
        
        from core.config import settings
        
        api_key = getattr(settings, f"{provider.upper()}_API_KEY", None)
        base_url = getattr(settings, f"{provider.upper()}_BASE_URL", None)
        
        if not api_key:
            return None
        
        return ProviderConfig(
            provider=provider,
            api_key=api_key,
            base_url=base_url or ""
        )
```

---

### 2.3 不需要的代码（可以Mock或简化）

以下代码在最小化测试中不需要：

1. **提示词管理器**（`prompts/manager.py`）
   - 测试时可以使用硬编码的提示词
   - 或者创建一个简化的版本

2. **工具注册表**（`tools/registry.py`）
   - 测试时可以不使用工具
   - 如果测试需要，创建一个简化的版本

3. **流程管理器**（`flows/manager.py`）
   - 测试时可以直接构建图，不需要流程加载

4. **上下文管理**（`context/`）
   - 测试时可以不使用上下文

---

## 三、代码抽取步骤

### 步骤1：创建目录结构

```bash
mkdir -p cursor_test/langfuse/02flow/{core,langfuse,flows,agents,llm/providers}
```

### 步骤2：复制核心代码

按以下顺序复制代码（因为存在依赖关系）：

1. **配置** → `core/config.py`
2. **状态定义** → `core/state.py`
3. **流程定义** → `core/definition.py`
4. **Langfuse Handler** → `langfuse/handler.py`
5. **供应商注册表** → `llm/providers/registry.py`
6. **供应商管理器** → `llm/providers/manager.py`
7. **LLM客户端** → `llm/client.py`
8. **Agent工厂** → `agents/factory.py`
9. **流程构建器** → `flows/builder.py`

### 步骤3：修改导入路径

将所有 `from backend.xxx` 改为相对导入或新的模块路径：

```python
# 原代码
from backend.app.config import settings
from backend.domain.state import FlowState

# 修改后
from core.config import settings
from core.state import FlowState
```

### 步骤4：简化代码

根据上述说明，移除不必要的依赖和逻辑。

---

## 四、最小化测试文件示例

### 测试文件：`test_minimal_flow.py`

```python
"""
最小化流程测试
测试动态流程与Langfuse日志记录的核心功能
"""
import secrets
from langchain_core.messages import HumanMessage
from langgraph.graph import StateGraph
from langgraph.checkpoint.memory import MemorySaver

# 导入抽取的代码
from core.state import FlowState
from core.definition import FlowDefinition, NodeDefinition, EdgeDefinition
from flows.builder import GraphBuilder
from langfuse.handler import set_langfuse_trace_context


def create_minimal_flow_definition() -> FlowDefinition:
    """创建最小化流程定义"""
    return FlowDefinition(
        name="test_flow",
        version="1.0.0",
        nodes=[
            NodeDefinition(
                name="agent_node",
                type="agent",
                config={
                    "prompt": "你是一个助手，请回答用户的问题。",
                    "model": {
                        "provider": "doubao",
                        "name": "doubao-seed-1-6-251015",
                        "temperature": 0.7
                    },
                    "tools": []
                }
            )
        ],
        edges=[
            EdgeDefinition(from_node="agent_node", to_node="END", condition="always")
        ],
        entry_node="agent_node"
    )


def test_minimal_flow():
    """测试最小化流程"""
    
    # 1. 设置Trace上下文（关键！）
    trace_id = secrets.token_hex(16)
    set_langfuse_trace_context(
        name="test_flow",
        trace_id=trace_id,
        metadata={"test": True}
    )
    
    # 2. 创建流程定义
    flow_def = create_minimal_flow_definition()
    
    # 3. 构建图
    graph = GraphBuilder.build_graph(flow_def)
    
    # 4. 编译图
    checkpoint = MemorySaver()
    compiled_graph = graph.compile(checkpointer=checkpoint)
    
    # 5. 构建初始状态
    initial_state: FlowState = {
        "messages": [HumanMessage(content="Hello")],
        "session_id": "test_session",
    }
    
    # 6. 执行流程
    config = {"configurable": {"thread_id": "test_session"}}
    result = compiled_graph.invoke(initial_state, config)
    
    # 7. 验证结果
    print(f"Result: {result}")
    print(f"Trace ID: {trace_id}")
    
    # TODO: 验证Langfuse日志记录


if __name__ == "__main__":
    test_minimal_flow()
```

---

## 五、依赖关系图

```
test_minimal_flow.py
  ↓
flows/builder.py
  ├─ core/state.py (FlowState)
  ├─ core/definition.py (FlowDefinition)
  ├─ agents/factory.py
  │   ├─ llm/client.py
  │   │   ├─ langfuse/handler.py (create_langfuse_handler)
  │   │   ├─ llm/providers/manager.py
  │   │   └─ core/config.py (settings)
  │   └─ (简化：不需要prompts, tools)
  └─ langfuse/handler.py (get_current_trace_id)
      └─ core/config.py (settings)
```

**关键依赖链**：
1. `test_minimal_flow.py` → 设置Trace上下文 → `langfuse/handler.py`
2. `flows/builder.py` → 创建节点函数 → 运行时获取trace_id → `langfuse/handler.py`
3. `agents/factory.py` → 创建Agent → `llm/client.py` → 创建Handler → `langfuse/handler.py`
4. 所有代码 → 读取配置 → `core/config.py` → 项目根目录的 `.env`

---

## 六、配置读取策略

### 6.1 配置从项目根目录读取

**`core/config.py` 中的 `find_project_root()` 函数需要修改**：

```python
def find_project_root() -> Path:
    """
    查找项目根目录（包含 .env 文件的目录）
    
    从测试目录向上查找，直到找到项目根目录
    """
    # 当前文件位于 cursor_test/langfuse/02flow/core/config.py
    # 项目根目录应该是 current.parent.parent.parent.parent.parent
    current = Path(__file__).resolve()
    
    # 向上查找：cursor_test/langfuse/02flow/core/ -> 项目根目录
    # 02flow -> langfuse -> cursor_test -> 项目根目录
    project_root = current.parent.parent.parent.parent.parent
    
    # 验证项目根目录是否存在 .env 文件
    env_file = project_root / ".env"
    if env_file.exists():
        return project_root
    
    # 如果找不到，向上查找
    for parent in current.parents:
        env_file = parent / ".env"
        if env_file.exists():
            return parent
    
    # 如果都找不到，返回计算出的项目根目录
    return project_root
```

### 6.2 环境变量读取

所有配置都通过 `pydantic-settings` 从 `.env` 文件读取：

```python
class Settings(BaseSettings):
    model_config = SettingsConfigDict(
        env_file=find_project_root() / ".env",  # 从项目根目录读取
        env_file_encoding="utf-8",
        case_sensitive=True,
        extra="ignore"
    )
    
    # Langfuse配置
    LANGFUSE_ENABLED: bool = Field(default=False)
    LANGFUSE_PUBLIC_KEY: Optional[str] = None
    LANGFUSE_SECRET_KEY: Optional[str] = None
    # ...
```

---

## 七、测试定制化修改点

在 `test_minimal_flow.py` 中可以进行以下定制化修改：

1. **简化流程定义**
   - 只创建单节点流程
   - 移除不必要的配置

2. **Mock Agent（可选）**
   - 如果不想实际调用LLM，可以Mock Agent

3. **简化工具**
   - 测试时可以不使用工具

4. **定制化Handler创建**
   - 可以测试不同的Handler创建方式
   - 可以测试不同的trace_context传递方式

5. **验证逻辑**
   - 添加Langfuse日志验证逻辑
   - 检查Trace是否正确记录

---

## 八、下一步行动

1. **创建目录结构**
   ```bash
   mkdir -p cursor_test/langfuse/02flow/{core,langfuse,flows,agents,llm/providers}
   ```

2. **按顺序复制代码**
   - 从配置开始，按依赖关系顺序复制

3. **修改导入路径**
   - 将所有 `backend.xxx` 改为相对导入

4. **简化代码**
   - 移除不必要的依赖
   - 保留核心逻辑

5. **创建测试文件**
   - 创建 `test_minimal_flow.py`
   - 实现最小化测试场景

6. **运行测试**
   - 验证代码是否正常工作
   - 验证Langfuse日志是否正确记录

---

**文档生成时间**：2025-01-06  
**目的**：指导如何抽取代码结构用于测试Langfuse动态流程日志记录问题

