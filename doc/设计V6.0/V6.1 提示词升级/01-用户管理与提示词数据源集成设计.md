# 用户管理与提示词数据源集成设计

## 1. 需求概述

### 1.1 背景
当前血压Agent提示词模板需要使用 `{{user_info}}` 和 `{{history_msg}}` 占位符，但这些数据源尚未建立。需要完善用户管理功能，让提示词模板能够获取到患者基础信息和历史对话信息。

### 1.2 目标
1. **用户表扩展**：在用户表中新增字段，存储患者基础信息（用于填充 `{{user_info}}`）
2. **用户选择优化**：会话界面支持从用户列表中选择用户，并支持用户名查询
3. **前端交互升级**：将当前的弹窗式用户管理改为多Tab页设计（会话Tab + 用户管理Tab）

### 1.3 涉及文件
- **数据库层**：`infrastructure/database/models/user.py`
- **数据迁移**：`alembic/versions/`（新增迁移文件）
- **API层**：`app/api/routes.py`
- **Schema层**：`app/schemas/user.py`、`app/schemas/chat.py`
- **前端界面**：`web/chat.html`
- **占位符管理**：`infrastructure/prompts/placeholder.py`

## 2. 数据库设计

### 2.1 用户表字段扩展

在 `biz_agent_users` 表中新增以下字段：

| 字段名 | 类型 | 可空 | 默认值 | 说明 |
|--------|------|------|--------|------|
| `user_info` | TEXT | 是 | NULL | 患者基础信息（多行文本格式，用于填充提示词 `{{user_info}}`） |
| `user_info_updated_at` | DateTime(timezone=True) | 是 | NULL | 患者基础信息更新时间 |

**字段说明**：
- `user_info`：存储患者的基础信息，格式为多行文本，直接用于提示词替换，不需要JSON格式转换
- `user_info_updated_at`：记录患者基础信息最后更新时间，用于追踪数据变更

**示例文本格式**：
```
患者姓名：张三
年龄：55岁
性别：男
疾病诊断：高血压、高血脂
目标血压值：收缩压130mmHg，舒张压80mmHg
用药情况：降压药A、降脂药B
其他信息：备注信息
```

### 2.2 数据库迁移

**迁移文件命名**：`alembic/versions/xxxxxx_add_user_info_field.py`

**迁移内容**：
1. 添加 `user_info` 字段（TEXT类型，可空）
2. 添加 `user_info_updated_at` 字段（DateTime类型，可空）

**回滚策略**：
- 支持回滚删除新增字段
- 回滚前需要备份数据（如果有）

## 3. 后端API设计

### 3.1 用户Schema扩展

**修改文件**：`app/schemas/user.py`

#### 3.1.1 新增字段定义

```python
class UserBase(BaseModel):
    """用户基础模型"""
    username: str = Field(..., description="用户名", min_length=1, max_length=100)
    phone: Optional[str] = Field(default=None, description="手机号", max_length=20)
    email: Optional[str] = Field(default=None, description="邮箱", max_length=100)
    is_active: bool = Field(default=True, description="是否激活")
    user_info: Optional[str] = Field(default=None, description="患者基础信息（多行文本）")  # 新增

class UserResponse(UserBase):
    """用户响应模型"""
    id: str = Field(..., description="用户ID")
    created_at: datetime = Field(..., description="创建时间")
    updated_at: datetime = Field(..., description="更新时间")
    user_info_updated_at: Optional[datetime] = Field(default=None, description="患者基础信息更新时间")  # 新增
```

#### 3.1.2 字段说明

- `user_info` 字段为可选的多行文本字段，不进行格式验证，直接存储原始文本

### 3.2 用户列表查询接口增强

**修改接口**：`GET /api/v1/users`

**新增查询参数**：
- `username_search` (可选，string)：用户名模糊查询，支持部分匹配
- `limit` (可选，int，默认100)：返回数量限制
- `offset` (可选，int，默认0)：偏移量

**响应格式**：保持不变，但支持按用户名搜索

**实现逻辑**：
```python
@router.get("/users", response_model=UserListResponse)
async def list_users(
    username_search: Optional[str] = None,  # 新增
    limit: int = 100,
    offset: int = 0,
    session: AsyncSession = Depends(get_async_session)
) -> UserListResponse:
    """
    获取用户列表（支持用户名搜索）
    """
    user_repo = UserRepository(session)
    
    # 如果提供了用户名搜索，使用模糊查询
    if username_search:
        users = await user_repo.search_by_username(username_search, limit=limit, offset=offset)
    else:
        users = await user_repo.get_all(limit=limit, offset=offset)
    
    # ... 其余逻辑保持不变
```

### 3.3 用户仓储扩展

**修改文件**：`infrastructure/database/repository/user_repository.py`

**新增方法**：
```python
async def search_by_username(self, username: str, limit: int = 100, offset: int = 0) -> List[User]:
    """
    根据用户名模糊查询用户
    
    Args:
        username: 用户名（支持部分匹配）
        limit: 限制数量
        offset: 偏移量
        
    Returns:
        用户列表
    """
    result = await self.session.execute(
        select(User)
        .where(User.username.ilike(f"%{username}%"))
        .limit(limit)
        .offset(offset)
        .order_by(User.created_at.desc())
    )
    return result.scalars().all()
```

### 3.4 用户创建/更新接口

**修改接口**：`POST /api/v1/users` 和 `PUT /api/v1/users/{user_id}`

**变更内容**：
1. 支持接收和保存 `user_info` 字段（多行文本，无需格式验证）
2. 在更新 `user_info` 时，自动更新 `user_info_updated_at` 字段

**实现逻辑**：
- 创建/更新用户时，直接保存 `user_info` 文本内容
- 更新用户时，如果更新了 `user_info`，需要更新 `user_info_updated_at` 为当前时间

## 4. 前端界面设计

### 4.1 整体布局改造

**改造前**：
- 单一会话页面
- 用户管理通过弹窗实现

**改造后**：
- 多Tab页设计
- Tab 1：会话页面（默认显示）
- Tab 2：用户管理页面

### 4.2 Tab页结构

```
┌─────────────────────────────────────────────┐
│  [会话]  [用户管理]                          │
├─────────────────────────────────────────────┤
│                                              │
│  Tab内容区域                                 │
│                                              │
└─────────────────────────────────────────────┘
```

### 4.3 会话Tab页设计

#### 4.3.1 用户选择区域优化

**当前设计**：
- 用户ID输入框（只读）
- "选择用户"按钮（打开弹窗）

**优化后设计**：
- 用户选择下拉框（支持搜索）
- 下拉框显示用户名，选择后自动填充用户ID

**实现方案**：
1. 使用 `<select>` 或自定义下拉组件
2. 支持输入关键字进行实时搜索（调用 `GET /api/v1/users?username_search=xxx`）
3. 选择用户后，自动填充用户ID到隐藏字段

**界面布局**：
```
┌─────────────────────────────────────┐
│ 用户选择: [搜索框/下拉选择]          │
│ 用户ID: [自动填充，只读]             │
└─────────────────────────────────────┘
```

#### 4.3.2 其他功能保持不变

- Trace ID 输入/生成
- 消息输入框
- 发送按钮
- 重置会话按钮
- 自动生成Trace ID开关
- 消息日志显示

### 4.4 用户管理Tab页设计

#### 4.4.1 功能模块

1. **用户列表展示**
   - 显示用户列表（ID、用户名、手机号、邮箱、激活状态）
   - 支持分页（如果用户数量较多）
   - 支持用户名搜索（实时搜索）

2. **用户表单**
   - 新增用户表单
   - 编辑用户表单
   - 字段包括：
     - 用户名（必填）
     - 手机号（可选）
     - 邮箱（可选）
     - 是否激活（复选框）
     - **患者基础信息**（多行文本输入框，带示例按钮）

3. **操作按钮**
   - 新增用户
   - 编辑用户
   - 删除用户
   - 刷新列表
   - 清除表单

#### 4.4.2 患者基础信息编辑

**实现方案**：
- 使用 `<textarea>` 多行文本输入框，默认为空
- 在输入框旁边添加"查看示例"按钮
- 点击示例按钮后，在弹窗或提示框中显示推荐的文本格式示例：
  ```
  患者姓名：张三
  年龄：55岁
  性别：男
  疾病诊断：高血压、高血脂
  目标血压值：收缩压130mmHg，舒张压80mmHg
  用药情况：降压药A、降脂药B
  其他信息：备注信息
  ```
- 不进行任何格式验证，直接保存用户输入的原始文本

#### 4.4.3 界面布局

```
┌─────────────────────────────────────────────┐
│  用户管理                                    │
├─────────────────────────────────────────────┤
│  ┌─────────────────────────────────────┐   │
│  │ 用户表单（新增/编辑）                │   │
│  │ - 用户名: [________]                │   │
│  │ - 手机号: [________]                │   │
│  │ - 邮箱:   [________]                │   │
│  │ - 激活:   [☑]                       │   │
│  │ - 患者基础信息:                     │   │
│  │   [多行文本输入框] [查看示例]       │   │
│  │ [保存] [取消]                       │   │
│  └─────────────────────────────────────┘   │
│                                              │
│  ┌─────────────────────────────────────┐   │
│  │ 用户列表                             │   │
│  │ 搜索: [____________] [刷新]          │   │
│  │ ┌─────────────────────────────────┐ │   │
│  │ │ 用户1 | 手机 | 邮箱 | [编辑][删除]│ │   │
│  │ │ 用户2 | 手机 | 邮箱 | [编辑][删除]│ │   │
│  │ │ ...                             │ │   │
│  │ └─────────────────────────────────┘ │   │
│  └─────────────────────────────────────┘   │
└─────────────────────────────────────────────┘
```

### 4.5 前端实现技术细节

#### 4.5.1 Tab切换实现

- 使用CSS + JavaScript实现Tab切换
- 默认显示"会话"Tab
- Tab切换时保持各自的状态（不需要重新加载）

#### 4.5.2 用户搜索功能

- 实现防抖（debounce），避免频繁请求
- 搜索延迟建议：300-500ms
- 搜索结果实时更新用户选择下拉框

#### 4.5.3 数据同步

- 会话Tab中选择用户后，用户管理Tab中的对应用户应该高亮显示（如果打开用户管理Tab）
- 用户管理Tab中新增/编辑用户后，会话Tab中的用户列表应该自动更新

## 5. 提示词数据源集成

### 5.1 占位符数据传递

**实现方案**：由前端HTML在调用聊天API时，直接传入 `user_info` 和 `history_msg` 字段

#### 5.1.1 API接口修改

**修改文件**：`app/api/routes.py`

**修改接口**：`POST /api/v1/chat`

**新增请求字段**：
```python
class ChatRequest(BaseModel):
    """聊天请求模型"""
    message: str = Field(..., description="用户消息")
    session_id: str = Field(..., description="会话ID")
    user_id: str = Field(..., description="用户ID")
    conversation_history: Optional[List[ChatMessage]] = Field(
        default=None,
        description="对话历史（可选）"
    )
    user_info: Optional[str] = Field(default=None, description="患者基础信息（多行文本）")  # 新增
    history_msg: Optional[str] = Field(default=None, description="历史对话信息（格式化文本）")  # 新增
```

#### 5.1.2 数据传递逻辑

1. **前端实现**（`web/chat.html`）：
   - 在会话Tab中，选择用户后，从用户数据中获取 `user_info` 字段
   - 在发送消息前，将当前对话历史格式化为文本（`history_msg`）
   - 调用 `/api/v1/chat` 时，将 `user_info` 和 `history_msg` 作为请求参数传入

2. **后端实现**（`app/api/routes.py`）：
   - 接收 `user_info` 和 `history_msg` 字段
   - 将这两个字段添加到 `RouterState` 中，供占位符管理器使用
   ```python
   initial_state: RouterState = {
       "messages": messages,
       "current_intent": None,
       "current_agent": None,
       "need_reroute": True,
       "session_id": request.session_id,
       "user_id": request.user_id,
       "trace_id": trace_id,
       "user_info": request.user_info or "暂无患者基础信息",  # 新增
       "history_msg": request.history_msg or "暂无历史对话",  # 新增
   }
   ```

#### 5.1.3 占位符管理器扩展

**修改文件**：`infrastructure/prompts/placeholder.py`

**扩展占位符**：
```python
SYSTEM_PLACEHOLDERS = {
    # ... 现有占位符 ...
    "user_info": lambda state: state.get("user_info", "暂无患者基础信息"),
    "history_msg": lambda state: state.get("history_msg", "暂无历史对话"),
}
```

**说明**：
- `user_info`：直接从state中获取，如果为空则使用默认值
- `history_msg`：直接从state中获取，如果为空则使用默认值
- 不需要从数据库查询，不需要格式转换，直接使用前端传入的原始文本

#### 5.1.4 前端历史消息格式化

**实现位置**：`web/chat.html`

**实现逻辑**：
```javascript
function formatHistoryMessages(history) {
    if (!history || history.length === 0) {
        return "暂无历史对话";
    }
    
    const lines = [];
    history.forEach(msg => {
        if (msg.role === 'user') {
            lines.push(`用户: ${msg.content}`);
        } else if (msg.role === 'assistant') {
            lines.push(`助手: ${msg.content}`);
        }
    });
    
    return lines.join('\n');
}

// 在发送消息时调用
async function sendMessage() {
    // ... 现有逻辑 ...
    
    // 获取用户信息（从选中的用户对象中获取）
    const selectedUser = getUserById(userId);
    const userInfo = selectedUser?.user_info || '';
    
    // 格式化历史消息
    const historyMsg = formatHistoryMessages(history);
    
    // 发送请求
    const resp = await fetch(chatApiUrl, {
        method: 'POST',
        headers: headers,
        body: JSON.stringify({
            message: text,
            session_id: currentSessionId,
            user_id: userId,
            conversation_history: history,
            user_info: userInfo,  // 新增
            history_msg: historyMsg,  // 新增
        })
    });
    
    // ... 其余逻辑 ...
}
```

## 6. 开发计划

### 6.1 开发阶段

**阶段1：数据库层改造**（2-3小时）
1. 修改User模型，添加新字段
2. 创建数据库迁移文件
3. 执行迁移测试
4. 更新UserRepository，支持用户名搜索

**阶段2：后端API改造**（2-3小时）
1. 更新UserSchema，添加新字段
2. 修改用户列表接口，支持搜索
3. 修改用户创建/更新接口，支持user_info字段
4. 编写API测试

**阶段3：占位符集成**（1-2小时）
1. 扩展ChatRequest Schema，添加user_info和history_msg字段
2. 修改聊天API接口，接收并传递user_info和history_msg到state
3. 扩展占位符管理器，支持user_info和history_msg占位符
4. 前端实现历史消息格式化函数
5. 前端在发送消息时传入user_info和history_msg
6. 测试提示词模板占位符填充

**阶段4：前端界面改造**（4-6小时）
1. 改造HTML结构，实现Tab页布局
2. 实现会话Tab的用户选择下拉框（支持搜索）
3. 实现用户管理Tab的用户列表和表单
4. 实现患者基础信息的多行文本输入框和示例按钮
5. 实现用户搜索功能（带防抖）
6. 实现Tab切换和数据同步
7. 实现前端历史消息格式化函数
8. 实现发送消息时传入user_info和history_msg
9. 测试前端功能

**阶段5：联调测试**（2-3小时）
1. 前后端联调
2. 提示词模板测试（验证user_info和history_msg填充）
3. 完整流程测试
4. Bug修复

### 6.2 测试要点

1. **数据库测试**
   - 字段添加是否正确
   - 迁移脚本是否可回滚
   - TEXT字段存储和读取是否正常（多行文本）

2. **API测试**
   - 用户列表搜索功能
   - 用户创建/更新时user_info字段处理（文本存储）
   - 聊天接口接收user_info和history_msg字段

3. **前端测试**
   - Tab切换功能
   - 用户搜索功能（防抖效果）
   - 用户选择下拉框
   - 患者基础信息多行文本输入和示例按钮
   - 数据同步
   - 历史消息格式化功能
   - 发送消息时正确传入user_info和history_msg

4. **提示词测试**
   - user_info占位符是否正确填充（直接使用原始文本）
   - history_msg占位符是否正确填充（格式化后的文本）
   - 空值处理是否正确（使用默认值）

## 7. 注意事项

### 7.1 兼容性考虑

1. **数据库迁移**：
   - 新字段设置为可空，不影响现有数据
   - 迁移前需要备份数据库（生产环境）

2. **API兼容性**：
   - user_info字段为可选，现有客户端不受影响
   - 响应中新增字段不影响旧版本客户端

3. **前端兼容性**：
   - 保持现有会话功能不变
   - 用户管理功能通过新Tab提供，不影响原有流程

### 7.2 性能考虑

1. **用户搜索**：
   - 实现防抖，减少API请求
   - 考虑添加搜索索引（如果用户量大）
   - 限制搜索结果数量（避免返回过多数据）

2. **历史消息格式化**：
   - 前端格式化历史消息，如果消息量大，考虑限制格式化数量（如只格式化最近10条）
   - 在同一session内，历史消息格式化结果可以复用

3. **数据传递**：
   - user_info和history_msg由前端传入，不需要后端查询数据库
   - 减少数据库查询次数，提升性能

### 7.3 安全性考虑

1. **用户信息存储**：
   - user_info字段存储多行文本，不需要格式验证
   - 建议限制文本大小（如最大10KB），避免存储过大数据
   - 前端输入时可以考虑添加长度限制提示

2. **权限控制**：
   - 用户管理功能应该有权限控制（当前版本可以暂时不实现，后续补充）
   - 防止未授权访问用户信息

### 7.4 用户体验

1. **表单输入**：
   - 患者基础信息输入框提供示例按钮，方便用户参考格式
   - 保存成功后给出反馈
   - 多行文本输入框高度适中，方便输入

2. **加载状态**：
   - 搜索时显示加载动画
   - 保存时禁用表单，防止重复提交

3. **错误处理**：
   - 网络错误时给出友好提示
   - API错误时显示详细错误信息

## 8. 后续优化方向

1. **患者基础信息模板**：
   - 提供常见疾病的患者信息模板
   - 支持导入/导出患者信息

2. **历史对话管理**：
   - 支持查看完整历史对话记录
   - 支持导出历史对话

3. **用户权限管理**：
   - 实现用户角色和权限控制
   - 区分管理员和普通用户

4. **数据统计**：
   - 用户活跃度统计
   - 患者信息完整性统计

5. **批量操作**：
   - 支持批量导入用户
   - 支持批量更新患者信息

## 9. 参考资料

- 当前用户表模型：`infrastructure/database/models/user.py`
- 当前用户API：`app/api/routes.py`
- 当前前端界面：`web/chat.html`
- 提示词模板：`config/prompts/local/blood_pressure_agent_prompt.txt`
- 占位符管理器：`infrastructure/prompts/placeholder.py`
