# 配置管理说明

## 配置架构

所有配置统一通过 `backend/app/config.py` 模块管理，配置从 `.env` 文件中读取。

### 配置模块位置

- **配置文件**：`backend/app/config.py`
- **配置类**：`Settings` (继承自 `pydantic_settings.BaseSettings`)
- **全局实例**：`settings` (在模块级别创建的单例)

### 配置读取流程

```
.env 文件
  ↓
Pydantic Settings (自动读取)
  ↓
Settings 类实例 (settings)
  ↓
各个模块通过 `from backend.app.config import settings` 导入使用
```

## 配置项说明

### 数据库配置

```env
DATABASE_URL=postgresql+psycopg://user:password@host:port/dbname
DB_TIMEZONE=Asia/Shanghai
```

### 模型供应商API密钥

```env
OPENAI_API_KEY=your_openai_key
DOUBAO_API_KEY=your_doubao_key
DEEPSEEK_API_KEY=your_deepseek_key
```

### 默认模型配置

```env
LLM_MODEL=doubao-seed-1-6-251015
LLM_TEMPERATURE=0.7
```

### 配置文件路径

```env
MODEL_PROVIDERS_CONFIG=config/model_providers.yaml
```

### Langfuse可观测性配置

```env
# 是否启用Langfuse（true/false）
LANGFUSE_ENABLED=true

# Langfuse公钥（从Langfuse控制台获取）
LANGFUSE_PUBLIC_KEY=pk-xxx

# Langfuse密钥（从Langfuse控制台获取）
LANGFUSE_SECRET_KEY=sk-xxx

# Langfuse服务器地址（可选，默认使用cloud.langfuse.com）
# 如果使用自托管Langfuse，设置此值
LANGFUSE_HOST=http://10.160.4.84:3000
```

## 使用方式

### 在代码中使用配置

**正确方式**（从统一配置模块读取）：

```python
from backend.app.config import settings

# 读取配置
database_url = settings.DATABASE_URL
langfuse_enabled = settings.LANGFUSE_ENABLED
langfuse_public_key = settings.LANGFUSE_PUBLIC_KEY
```

**错误方式**（直接从环境变量读取）：

```python
import os

# ❌ 不要这样做
langfuse_enabled = os.getenv("LANGFUSE_ENABLED")
```

### 配置验证

Pydantic Settings 会自动验证配置：
- 类型检查
- 必填字段检查
- 默认值设置

如果配置缺失或类型错误，应用启动时会抛出异常。

## 配置模块结构

```python
class Settings(BaseSettings):
    """应用配置"""
    
    model_config = SettingsConfigDict(
        env_file=find_project_root() / ".env",  # 自动从.env读取
        env_file_encoding="utf-8",
        case_sensitive=True,
        extra="ignore"
    )
    
    # 配置项定义
    DATABASE_URL: str
    LANGFUSE_ENABLED: bool = False
    # ... 其他配置项

# 全局配置实例
settings = Settings()
```

## 环境变量命名规范

- 使用大写字母和下划线
- 与配置类字段名保持一致
- 例如：`LANGFUSE_ENABLED` 对应 `settings.LANGFUSE_ENABLED`

## 配置优先级

1. **环境变量**（系统级别，最高优先级）
2. **.env 文件**（项目级别）
3. **默认值**（代码中定义）

## 注意事项

1. **不要直接使用 `os.getenv()`**：
   - 所有配置都应该从 `settings` 对象读取
   - 这样可以确保配置的统一管理和验证

2. **.env 文件位置**：
   - 应该放在项目根目录
   - 不要提交到版本控制系统（添加到 `.gitignore`）

3. **配置更新**：
   - 修改 `.env` 文件后，需要重启应用才能生效
   - Pydantic Settings 在应用启动时读取配置

4. **类型安全**：
   - 使用 Pydantic 的类型验证
   - 配置项有明确的类型定义

## 示例：添加新配置

1. **在 `Settings` 类中添加字段**：

```python
class Settings(BaseSettings):
    # ... 现有配置
    
    # 新配置项
    NEW_FEATURE_ENABLED: bool = Field(
        default=False,
        description="是否启用新功能"
    )
    NEW_FEATURE_API_KEY: Optional[str] = Field(
        default=None,
        description="新功能API密钥"
    )
```

2. **在 `.env` 文件中添加配置**：

```env
NEW_FEATURE_ENABLED=true
NEW_FEATURE_API_KEY=your_api_key
```

3. **在代码中使用**：

```python
from backend.app.config import settings

if settings.NEW_FEATURE_ENABLED:
    api_key = settings.NEW_FEATURE_API_KEY
    # 使用配置...
```

## 迁移指南

如果代码中使用了 `os.getenv()`，需要迁移到统一配置：

**迁移前**：
```python
import os
langfuse_enabled = os.getenv("LANGFUSE_ENABLED", "false").lower() == "true"
```

**迁移后**：
```python
from backend.app.config import settings
langfuse_enabled = settings.LANGFUSE_ENABLED
```

