# 提示词流程统一方案

## 一、当前代码现状分析

### 1.1 提示词加载流程概览

当前系统中，提示词模板的加载和处理分散在多个位置，存在代码重复和职责不清的问题。

#### 流程时序图

```
用户请求
    ↓
API层 (routes.py)
    ↓
路由图 (graph.py:create_router_graph)
    ↓
Agent节点 (graph.py:with_user_context)
    ├─ 加载提示词模板 (_load_agent_template)
    ├─ 获取占位符值 (PlaceholderManager.get_placeholders)
    ├─ 填充占位符 (PlaceholderManager.fill_placeholders)
    └─ 创建系统消息并调用Agent
```

### 1.2 代码重复问题

#### 问题1：提示词加载逻辑重复

**位置1：`domain/agents/factory.py` (186-259行)**

```python
# 3. 获取系统提示词（支持多源读取）
system_prompt = None
prompt_source_mode = settings.PROMPT_SOURCE_MODE.lower()

# 从Langfuse加载提示词（如果模式为langfuse或auto）
if prompt_source_mode in ("langfuse", "auto"):
    langfuse_template = agent_config.get("langfuse_template")
    if langfuse_template:
        try:
            from infrastructure.prompts.langfuse_adapter import LangfusePromptAdapter
            adapter = LangfusePromptAdapter()
            template_version = agent_config.get("langfuse_template_version")
            
            system_prompt = adapter.get_template(
                template_name=langfuse_template,
                version=template_version
            )
            # ... 错误处理
        except Exception as e:
            # ... 错误处理

# 从本地文件加载提示词（如果模式为local，或auto模式下Langfuse失败）
if not system_prompt and prompt_source_mode in ("local", "auto"):
    # ... 本地文件加载逻辑
```

**位置2：`domain/router/graph.py` (29-103行)**

```python
def _load_agent_template(agent_key: str) -> str:
    """加载 Agent 的原始提示词模板（包含占位符）"""
    # 获取 Agent 配置
    agent_config = AgentFactory._config.get(agent_key, {})
    
    prompt_source_mode = settings.PROMPT_SOURCE_MODE.lower()
    template = None
    
    # 从Langfuse加载提示词（如果模式为langfuse或auto）
    if prompt_source_mode in ("langfuse", "auto"):
        langfuse_template = agent_config.get("langfuse_template")
        if langfuse_template:
            try:
                from infrastructure.prompts.langfuse_adapter import LangfusePromptAdapter
                adapter = LangfusePromptAdapter()
                template_version = agent_config.get("langfuse_template_version")
                
                template = adapter.get_template(
                    template_name=langfuse_template,
                    version=template_version
                )
                # ... 错误处理
            except Exception as e:
                # ... 错误处理
    
    # 从本地文件加载提示词（如果模式为local，或auto模式下Langfuse失败）
    if not template and prompt_source_mode in ("local", "auto"):
        # ... 本地文件加载逻辑（与factory.py中的逻辑几乎完全相同）
```

**问题分析**：
- ✅ 两处代码逻辑**几乎完全相同**（约70行重复代码）
- ❌ `factory.py` 中加载的提示词**实际上没有被使用**（因为不再传入 `prompt` 参数）
- ❌ 代码维护成本高：修改加载逻辑需要在两处同步修改
- ❌ 容易产生不一致：两处代码可能因为修改不同步而产生差异

#### 问题2：职责不清

**`domain/agents/factory.py` 的职责混乱**：

```python
# 当前代码（261-276行）
# 注意：不再在 Agent 创建时传入 prompt 参数
# 原因：
# 1. 避免 create_agent 自动添加系统消息，导致运行时系统消息重复
# 2. 系统消息将在运行时（domain/router/graph.py:with_user_context）动态注入
# 3. 这样可以确保系统消息包含完整的上下文信息（已填充所有占位符）
# 
# system_prompt 的加载逻辑仍然保留，因为运行时需要加载模板来填充占位符
# 占位符填充将在运行时进行（domain/router/graph.py:with_user_context）

# 4. 创建 ReAct Agent（不传入 prompt，由运行时动态注入系统消息）
return create_agent(
    model=llm,
    tools=tools,
    # 不传入 prompt 参数，避免 create_agent 自动添加系统消息
    # 系统消息将在运行时（domain/router/graph.py:with_user_context）动态注入
)
```

**问题分析**：
- ❌ `factory.py` 加载了提示词但**不使用**，代码注释说明"保留是为了运行时需要"，但实际上运行时在 `graph.py` 中**重新加载**
- ❌ 职责不清：`factory.py` 应该只负责创建 Agent 实例，不应该涉及提示词加载（因为不使用）
- ❌ 代码可读性差：加载了但不使用，容易让人困惑

#### 问题3：占位符处理分散

**位置1：`domain/agents/factory.py` (191行)**

```python
# 加载Agent特定占位符（如果配置了）
PlaceholderManager.load_agent_placeholders(agent_key, agent_config)
```

**位置2：`domain/router/graph.py` (153行)**

```python
# 1. 从 state 中获取所有占位符值
placeholders = PlaceholderManager.get_placeholders(agent_name, state=state)
```

**问题分析**：
- ✅ 占位符加载在 `factory.py` 中（Agent创建时）
- ✅ 占位符获取在 `graph.py` 中（运行时）
- ⚠️ 职责分离合理，但代码注释和文档不够清晰

### 1.3 代码结构问题总结

| 问题 | 位置 | 影响 | 严重程度 |
|------|------|------|----------|
| 提示词加载逻辑重复 | `factory.py` 186-259行<br>`graph.py` 29-103行 | 代码重复约70行，维护成本高 | 🔴 高 |
| 职责不清 | `factory.py` 加载但不使用提示词 | 代码可读性差，容易困惑 | 🟡 中 |
| 占位符处理分散 | `factory.py` 加载占位符配置<br>`graph.py` 获取占位符值 | 逻辑合理但文档不清 | 🟢 低 |

## 二、统一方案设计

### 2.1 设计原则

1. **单一职责原则**：每个模块只负责自己的职责
   - `factory.py`：只负责创建 Agent 实例（LLM、工具、Agent 图）
   - `graph.py`：负责运行时系统消息注入（加载模板、填充占位符、创建系统消息）
   - `placeholder.py`：负责占位符管理（加载配置、获取值、填充）

2. **DRY原则**：消除代码重复
   - 提示词加载逻辑统一到一个地方
   - 提供统一的加载接口

3. **清晰性原则**：代码意图明确
   - 移除不必要的代码（factory.py 中不使用的提示词加载）
   - 添加清晰的注释和文档

### 2.2 架构设计

#### 2.2.1 提示词加载服务

**创建统一的提示词加载服务**：`infrastructure/prompts/template_loader.py`

```python
"""
统一的提示词模板加载服务
负责从 Langfuse 或本地文件加载提示词模板
"""
from typing import Optional
from pathlib import Path
from app.core.config import settings
from infrastructure.prompts.langfuse_adapter import LangfusePromptAdapter
import logging

logger = logging.getLogger(__name__)


class AgentTemplateLoader:
    """Agent 提示词模板加载器"""
    
    @staticmethod
    def load_template(agent_key: str, agent_config: dict) -> str:
        """
        加载 Agent 的提示词模板（统一入口）
        
        Args:
            agent_key: Agent键名
            agent_config: Agent配置字典
            
        Returns:
            提示词模板内容（包含占位符）
            
        Raises:
            ValueError: 无法加载模板
            FileNotFoundError: 本地文件不存在（当模式为local时）
        """
        prompt_source_mode = settings.PROMPT_SOURCE_MODE.lower()
        template = None
        
        # 从Langfuse加载提示词（如果模式为langfuse或auto）
        if prompt_source_mode in ("langfuse", "auto"):
            langfuse_template = agent_config.get("langfuse_template")
            if langfuse_template:
                try:
                    adapter = LangfusePromptAdapter()
                    template_version = agent_config.get("langfuse_template_version")
                    
                    template = adapter.get_template(
                        template_name=langfuse_template,
                        version=template_version
                    )
                    
                    logger.debug(f"从Langfuse加载提示词模板: {agent_key}, 模版: {langfuse_template}")
                    return template
                except Exception as e:
                    logger.warning(f"从Langfuse加载提示词模板失败: {agent_key}, 错误: {str(e)}")
                    if prompt_source_mode == "langfuse":
                        raise ValueError(f"无法从Langfuse加载提示词模板: {agent_key}, 错误: {str(e)}")
                    # 如果模式为auto，继续尝试从本地文件加载
                    logger.debug(f"尝试从本地文件加载提示词模板: {agent_key}")
        
        # 从本地文件加载提示词（如果模式为local，或auto模式下Langfuse失败）
        if not template and prompt_source_mode in ("local", "auto"):
            langfuse_template = agent_config.get("langfuse_template", "")
            if langfuse_template:
                local_filename = f"{langfuse_template}.txt"
            else:
                local_filename = f"{agent_key}_prompt.txt"
            
            local_file_path = Path("config/prompts/local") / local_filename
            
            # 尝试从项目根目录查找
            if not local_file_path.exists():
                local_file_path = Path.cwd() / local_file_path
            
            if local_file_path.exists():
                try:
                    with open(local_file_path, "r", encoding="utf-8") as f:
                        template = f.read()
                    
                    logger.debug(f"从本地文件加载提示词模板: {agent_key}, 文件: {local_file_path}")
                    return template
                except Exception as e:
                    logger.error(f"从本地文件加载提示词模板失败: {agent_key}, 错误: {str(e)}")
                    if prompt_source_mode == "local":
                        raise ValueError(f"无法从本地文件加载提示词模板: {agent_key}, 错误: {str(e)}")
            else:
                if prompt_source_mode == "local":
                    raise FileNotFoundError(f"未找到本地提示词文件: {agent_key}, 路径: {local_file_path}")
        
        if not template:
            raise ValueError(f"未找到提示词模板: {agent_key}")
        
        return template
```

#### 2.2.2 修改 `domain/agents/factory.py`

**移除提示词加载逻辑**，只保留占位符配置加载：

```python
@classmethod
def _create_agent_internal(
    cls,
    agent_key: str,
    llm: Optional[BaseChatModel] = None,
    tools: Optional[List[BaseTool]] = None
) -> CompiledStateGraph:
    """
    内部方法：实际创建智能体（不涉及缓存）
    
    职责：
    1. 创建 LLM 实例
    2. 加载工具列表
    3. 加载 Agent 特定占位符配置（用于运行时占位符填充）
    4. 创建 ReAct Agent 实例（不传入 prompt，由运行时动态注入系统消息）
    
    Args:
        agent_key: 智能体键名
        llm: LLM 实例（可选）
        tools: 工具列表（可选）
        
    Returns:
        CompiledStateGraph: 已编译的 LangGraph Agent 实例
    """
    
    agent_config = cls._config.get(agent_key)
    if not agent_config:
        raise ValueError(f"智能体配置不存在: {agent_key}")
    
    # 1. 获取 LLM 实例
    if not llm:
        llm_config = agent_config.get("llm", {})
        llm = get_llm(
            model=llm_config.get("model", settings.LLM_MODEL),
            temperature=llm_config.get(
                "temperature",
                settings.LLM_TEMPERATURE_DEFAULT
            )
        )
    
    # 2. 获取工具列表
    if not tools:
        tool_names = agent_config.get("tools", [])
        tools = [
            TOOL_REGISTRY[name]
            for name in tool_names
            if name in TOOL_REGISTRY
        ]
    
    # 3. 加载Agent特定占位符配置（用于运行时占位符填充）
    # 注意：这里只加载配置，不加载提示词模板
    # 提示词模板将在运行时（domain/router/graph.py:with_user_context）加载
    PlaceholderManager.load_agent_placeholders(agent_key, agent_config)
    
    # 4. 创建 ReAct Agent（不传入 prompt，由运行时动态注入系统消息）
    # 原因：
    # 1. 避免 create_agent 自动添加系统消息，导致运行时系统消息重复
    # 2. 系统消息将在运行时（domain/router/graph.py:with_user_context）动态注入
    # 3. 这样可以确保系统消息包含完整的上下文信息（已填充所有占位符）
    return create_agent(
        model=llm,
        tools=tools,
        # 不传入 prompt 参数，避免 create_agent 自动添加系统消息
        # 系统消息将在运行时（domain/router/graph.py:with_user_context）动态注入
    )
```

#### 2.2.3 修改 `domain/router/graph.py`

**使用统一的提示词加载服务**：

```python
from infrastructure.prompts.template_loader import AgentTemplateLoader

def _load_agent_template(agent_key: str) -> str:
    """
    加载 Agent 的原始提示词模板（包含占位符）
    
    使用统一的提示词加载服务，避免代码重复。
    
    Args:
        agent_key: Agent键名
        
    Returns:
        提示词模板内容（包含占位符）
    """
    # 获取 Agent 配置
    if not AgentFactory._config:
        AgentFactory.load_config()
    
    agent_config = AgentFactory._config.get(agent_key, {})
    if not agent_config:
        raise ValueError(f"Agent配置不存在: {agent_key}")
    
    # 使用统一的提示词加载服务
    return AgentTemplateLoader.load_template(agent_key, agent_config)
```

### 2.3 代码修改清单

#### 修改1：创建统一的提示词加载服务

**文件**：`infrastructure/prompts/template_loader.py`（新建）

**内容**：实现 `AgentTemplateLoader` 类，统一提示词加载逻辑

#### 修改2：修改 `domain/agents/factory.py`

**删除**：186-259行的提示词加载逻辑（约74行）

**保留**：191行的占位符配置加载逻辑

**添加**：清晰的注释说明职责

#### 修改3：修改 `domain/router/graph.py`

**修改**：`_load_agent_template` 函数，使用统一的加载服务

**删除**：29-103行的重复加载逻辑（约75行）

**替换为**：调用 `AgentTemplateLoader.load_template`

### 2.4 修改前后对比

#### 修改前

```
domain/agents/factory.py
├─ 提示词加载逻辑（70行）❌ 不使用
├─ 占位符配置加载 ✅
└─ Agent创建 ✅

domain/router/graph.py
├─ 提示词加载逻辑（70行）✅ 使用
├─ 占位符值获取 ✅
├─ 占位符填充 ✅
└─ 系统消息注入 ✅
```

**问题**：
- 代码重复约70行
- factory.py 中加载但不使用
- 维护成本高

#### 修改后

```
infrastructure/prompts/template_loader.py（新建）
└─ AgentTemplateLoader.load_template ✅ 统一加载逻辑

domain/agents/factory.py
├─ 占位符配置加载 ✅
└─ Agent创建 ✅

domain/router/graph.py
├─ 调用统一加载服务 ✅
├─ 占位符值获取 ✅
├─ 占位符填充 ✅
└─ 系统消息注入 ✅
```

**优势**：
- ✅ 代码不重复
- ✅ 职责清晰
- ✅ 维护成本低
- ✅ 易于扩展（如需添加新的加载源，只需修改一处）

## 三、实施计划

### 3.1 实施步骤

#### 步骤1：创建统一的提示词加载服务

1. 创建文件 `infrastructure/prompts/template_loader.py`
2. 实现 `AgentTemplateLoader` 类
3. 将 `graph.py` 中的加载逻辑迁移到新类
4. 添加单元测试

#### 步骤2：修改 `domain/router/graph.py`

1. 导入 `AgentTemplateLoader`
2. 修改 `_load_agent_template` 函数，使用统一服务
3. 删除重复的加载逻辑
4. 运行测试验证

#### 步骤3：修改 `domain/agents/factory.py`

1. 删除提示词加载逻辑（186-259行）
2. 保留占位符配置加载逻辑
3. 添加清晰的注释说明职责
4. 运行测试验证

#### 步骤4：测试验证

1. **单元测试**：测试 `AgentTemplateLoader` 的加载逻辑
2. **集成测试**：测试完整的 Agent 创建和调用流程
3. **回归测试**：确保所有 Agent 功能正常

### 3.2 风险评估

| 风险 | 影响 | 缓解措施 |
|------|------|----------|
| 修改后功能异常 | 高 | 充分测试，逐步迁移 |
| 代码兼容性问题 | 中 | 保持接口不变，只重构内部实现 |
| 性能影响 | 低 | 加载逻辑不变，性能影响可忽略 |

### 3.3 回滚方案

如果修改后出现问题，可以快速回滚：

1. **Git 回滚**：使用 Git 回滚到修改前的版本
2. **部分回滚**：只回滚有问题的部分，保留其他改进

## 四、预期收益

### 4.1 代码质量提升

- ✅ **消除代码重复**：减少约70行重复代码
- ✅ **职责清晰**：每个模块职责明确
- ✅ **可维护性提升**：修改加载逻辑只需修改一处

### 4.2 开发效率提升

- ✅ **开发速度**：新 Agent 开发时，提示词加载逻辑已统一，无需重复实现
- ✅ **调试效率**：代码结构清晰，问题定位更容易
- ✅ **代码审查**：代码更简洁，审查效率更高

### 4.3 扩展性提升

- ✅ **易于扩展**：如需支持新的提示词源（如数据库、API），只需修改 `AgentTemplateLoader`
- ✅ **易于测试**：统一的加载服务便于单元测试
- ✅ **易于监控**：可以在统一的服务中添加监控和日志

## 五、总结

### 5.1 核心改进

1. **统一提示词加载逻辑**：创建 `AgentTemplateLoader` 统一服务
2. **消除代码重复**：删除 `factory.py` 中不使用的加载逻辑
3. **职责清晰化**：`factory.py` 只负责 Agent 创建，`graph.py` 负责运行时系统消息注入

### 5.2 实施建议

**优先级**：🟡 中（代码质量改进，不影响功能）

**建议时机**：在下一个开发周期中实施，与功能开发并行进行

**预计工作量**：1-2天（包括开发、测试、文档）

### 5.3 后续优化方向

1. **缓存优化**：在 `AgentTemplateLoader` 中添加模板缓存机制
2. **错误处理增强**：统一错误处理逻辑，提供更友好的错误信息
3. **监控和日志**：添加详细的加载日志和性能监控