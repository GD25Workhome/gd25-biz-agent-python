# 当前系统时间的代码修改设计文档

## 1. 需求概述

### 1.1 背景

在测试血压趋势点评场景时，需要能够指定血压记录的日期和时间，以便系统能够正确计算趋势。当前系统使用 `{{current_date}}` 占位符，该占位符总是使用当前系统时间，无法满足测试场景中需要指定历史日期的需求。

### 1.2 目标

1. **前端支持**：在前端界面添加日期时间输入框，默认值为当前时间，支持手动输入和选择日期时间
2. **后端支持**：后端API接收前端传入的日期时间参数，并将其传递给占位符系统
3. **占位符系统支持**：占位符系统能够使用前端传入的日期时间，而不是总是使用当前系统时间

### 1.3 日期时间格式

- **格式**：`YYYY-MM-DD HH:mm`
- **示例**：`2025-01-14 08:00`
- **说明**：年月日 时分，24小时制

## 2. 前端修改设计

### 2.1 界面修改

**文件位置**：`web/chat.html`

**修改内容**：
1. 在会话Tab页的用户选择区域下方，添加日期时间输入框
2. 输入框默认值为当前日期时间（格式：`YYYY-MM-DD HH:mm`）
3. 支持以下功能：
   - 点击输入框显示日期时间选择器（如果浏览器支持）
   - 支持手动输入日期时间
   - 支持从文档中直接粘贴日期时间（如：`2025-01-14 08:00`）

**界面布局**：
```
┌─────────────────────────────────────┐
│ 用户选择: [搜索框/下拉选择]          │
│ 用户ID: [自动填充，只读]             │
│ 记录日期时间: [2025-01-14 08:00]    │ ← 新增
└─────────────────────────────────────┘
```

### 2.2 前端实现代码

**HTML部分**：
```html
<div class="form-row">
  <label>记录日期时间:</label>
  <input 
    type="datetime-local" 
    id="recordDateTime" 
    step="60"
    title="格式：YYYY-MM-DD HH:mm，可以直接粘贴日期时间"
  />
</div>
```

**JavaScript部分**：
```javascript
// 设置默认值为当前时间（格式：YYYY-MM-DD HH:mm）
function initDateTimeInput() {
  const dateTimeInput = document.getElementById('recordDateTime');
  if (dateTimeInput) {
    const now = new Date();
    const year = now.getFullYear();
    const month = String(now.getMonth() + 1).padStart(2, '0');
    const day = String(now.getDate()).padStart(2, '0');
    const hours = String(now.getHours()).padStart(2, '0');
    const minutes = String(now.getMinutes()).padStart(2, '0');
    
    // datetime-local 输入框需要的格式：YYYY-MM-DDTHH:mm
    const defaultValue = `${year}-${month}-${day}T${hours}:${minutes}`;
    dateTimeInput.value = defaultValue;
  }
}

// 在页面加载时初始化
window.addEventListener('DOMContentLoaded', () => {
  initDateTimeInput();
});

// 发送消息时获取日期时间
async function sendMessage() {
  // ... 现有逻辑 ...
  
  // 获取日期时间输入框的值
  const dateTimeInput = document.getElementById('recordDateTime');
  let currentDateTime = null;
  
  if (dateTimeInput && dateTimeInput.value) {
    // 将 datetime-local 格式（YYYY-MM-DDTHH:mm）转换为需要的格式（YYYY-MM-DD HH:mm）
    const dateTimeValue = dateTimeInput.value; // 格式：YYYY-MM-DDTHH:mm
    currentDateTime = dateTimeValue.replace('T', ' '); // 转换为：YYYY-MM-DD HH:mm
  }
  
  // 发送请求
  const resp = await fetch(chatApiUrl, {
    method: 'POST',
    headers: headers,
    body: JSON.stringify({
      message: text,
      session_id: currentSessionId,
      user_id: userId,
      conversation_history: history,
      user_info: userInfo,
      history_msg: historyMsg,
      current_date: currentDateTime,  // 新增：传入日期时间
    })
  });
  
  // ... 其余逻辑 ...
}
```

### 2.3 输入框类型说明

**使用 `datetime-local` 类型**：
- 优点：浏览器原生支持日期时间选择器，用户体验好
- 缺点：格式为 `YYYY-MM-DDTHH:mm`，需要转换为 `YYYY-MM-DD HH:mm`

**注意事项**：
1. `datetime-local` 输入框的值格式为 `YYYY-MM-DDTHH:mm`（使用T分隔日期和时间）
2. 后端需要接收的格式为 `YYYY-MM-DD HH:mm`（使用空格分隔）
3. 前端需要在发送请求前进行格式转换：`.replace('T', ' ')`
4. 输入框的 `step="60"` 属性表示时间选择精度为分钟（默认）
5. 支持手动输入，用户可以直接粘贴从文档中复制的日期时间（如：`2025-01-14 08:00`），浏览器会自动处理格式

### 2.4 兼容性处理

如果浏览器不支持 `datetime-local` 类型，可以降级为 `text` 类型，并提供格式提示：

```javascript
// 检测浏览器是否支持 datetime-local
function supportsDateTimeLocal() {
  const input = document.createElement('input');
  input.setAttribute('type', 'datetime-local');
  return input.type === 'datetime-local';
}

// 如果不支持，使用 text 类型并提供格式提示
if (!supportsDateTimeLocal()) {
  const dateTimeInput = document.getElementById('recordDateTime');
  dateTimeInput.type = 'text';
  dateTimeInput.placeholder = 'YYYY-MM-DD HH:mm (例如：2025-01-14 08:00)';
  dateTimeInput.pattern = '\\d{4}-\\d{2}-\\d{2} \\d{2}:\\d{2}';
}
```

## 3. 后端API修改设计

### 3.1 Schema修改

**文件位置**：`app/schemas/chat.py`

**修改内容**：
在 `ChatRequest` 类中添加 `current_date` 字段（可选）

```python
class ChatRequest(BaseModel):
    """聊天请求模型"""
    message: str = Field(..., description="用户消息")
    session_id: str = Field(..., description="会话ID")
    user_id: str = Field(..., description="用户ID")
    conversation_history: Optional[List[ChatMessage]] = Field(
        default=None,
        description="对话历史（可选）"
    )
    user_info: Optional[str] = Field(default=None, description="患者基础信息（多行文本）")
    history_msg: Optional[str] = Field(default=None, description="历史对话信息（格式化文本）")
    current_date: Optional[str] = Field(
        default=None, 
        description="当前日期时间（格式：YYYY-MM-DD HH:mm，可选，如果不提供则使用系统当前时间）"
    )
```

### 3.2 API路由修改

**文件位置**：`app/api/routes.py`

**修改内容**：
1. 接收 `current_date` 参数
2. 将 `current_date` 添加到 `RouterState` 中

```python
@router.post("/chat", response_model=ChatResponse)
async def chat(
    request: ChatRequest,
    app_request: Request,
    x_trace_id: Optional[str] = Header(None, alias="X-Trace-ID")
) -> ChatResponse:
    # ... 现有逻辑 ...
    
    # 构建初始状态（包含 trace_id、user_info、current_date）
    initial_state: RouterState = {
        "messages": messages,
        "current_intent": None,
        "current_agent": None,
        "need_reroute": True,
        "session_id": request.session_id,
        "user_id": request.user_id,
        "trace_id": trace_id,
        "user_info": request.user_info or "暂无患者基础信息",
        "history_msg": history_msg,
        "current_date": request.current_date,  # 新增：传入日期时间（如果提供）
    }
    
    # ... 其余逻辑保持不变 ...
```

### 3.3 RouterState修改

**文件位置**：`domain/router/state.py`

**修改内容**：
在 `RouterState` 中添加 `current_date` 字段（可选）

```python
class RouterState(TypedDict, total=False):
    """路由状态数据结构"""
    messages: List[BaseMessage]  # 消息列表
    current_intent: Optional[str]  # 当前意图：blood_pressure, health_event, medication, symptom, unclear
    current_agent: Optional[str]  # 当前活跃的智能体名称
    need_reroute: bool  # 是否需要重新路由
    session_id: str  # 会话ID
    user_id: str  # 用户ID
    trace_id: Optional[str]  # Langfuse Trace ID（用于链路追踪）
    user_info: Optional[str]  # 患者基础信息（多行文本）
    history_msg: Optional[str]  # 历史对话信息（格式化文本，由API层从conversation_history生成）
    current_date: Optional[str]  # 当前日期时间（格式：YYYY-MM-DD HH:mm，可选，如果不提供则使用系统当前时间）
```

## 4. 占位符系统修改设计

### 4.1 占位符管理器修改

**文件位置**：`infrastructure/prompts/placeholder.py`

**修改内容**：
修改 `SYSTEM_PLACEHOLDERS` 中的 `current_date` 和 `current_datetime` 占位符，优先使用state中的 `current_date`，如果没有提供则使用系统当前时间

```python
class PlaceholderManager:
    """占位符管理器"""
    
    # 系统占位符（从state中提取）
    SYSTEM_PLACEHOLDERS = {
        "user_id": lambda state: state.get("user_id", ""),
        "session_id": lambda state: state.get("session_id", ""),
        "current_date": lambda state: PlaceholderManager._get_current_date(state),
        "current_time": lambda state: PlaceholderManager._get_current_time(state),
        "current_datetime": lambda state: PlaceholderManager._get_current_datetime(state),
        "user_info": lambda state: state.get("user_info", "暂无患者基础信息"),
    }
    
    @staticmethod
    def _get_current_date(state: Dict[str, Any]) -> str:
        """
        获取当前日期（格式：YYYY-MM-DD）
        
        优先使用state中的current_date（如果提供），否则使用系统当前时间
        """
        current_date = state.get("current_date")
        if current_date:
            # 如果提供了完整日期时间（YYYY-MM-DD HH:mm），只提取日期部分
            if " " in current_date:
                return current_date.split(" ")[0]
            return current_date
        # 如果没有提供，使用系统当前时间
        from datetime import datetime
        return datetime.now().strftime("%Y-%m-%d")
    
    @staticmethod
    def _get_current_time(state: Dict[str, Any]) -> str:
        """
        获取当前时间（格式：HH:MM:SS）
        
        优先使用state中的current_date（如果提供），否则使用系统当前时间
        """
        current_date = state.get("current_date")
        if current_date:
            # 如果提供了完整日期时间（YYYY-MM-DD HH:mm），提取时间部分并补齐秒
            if " " in current_date:
                time_part = current_date.split(" ")[1]
                # 如果时间部分只有HH:mm，补齐为HH:mm:00
                if len(time_part) == 5:  # HH:mm
                    return time_part + ":00"
                return time_part
        # 如果没有提供，使用系统当前时间
        from datetime import datetime
        return datetime.now().strftime("%H:%M:%S")
    
    @staticmethod
    def _get_current_datetime(state: Dict[str, Any]) -> str:
        """
        获取当前日期时间（格式：YYYY-MM-DD HH:MM:SS）
        
        优先使用state中的current_date（如果提供），否则使用系统当前时间
        """
        current_date = state.get("current_date")
        if current_date:
            # 如果提供了日期时间（YYYY-MM-DD HH:mm），补齐秒为HH:mm:00
            if " " in current_date:
                date_part, time_part = current_date.split(" ")
                if len(time_part) == 5:  # HH:mm
                    return f"{date_part} {time_part}:00"
                return f"{date_part} {time_part}"
            # 如果只提供了日期（YYYY-MM-DD），使用00:00:00作为时间
            return f"{current_date} 00:00:00"
        # 如果没有提供，使用系统当前时间
        from datetime import datetime
        return datetime.now().strftime("%Y-%m-%d %H:%M:%S")
```

### 4.2 占位符格式说明

**`current_date` 占位符**：
- 如果state中提供了 `current_date`：使用提供的日期（格式：`YYYY-MM-DD`）
- 如果没有提供：使用系统当前日期

**`current_time` 占位符**：
- 如果state中提供了 `current_date`：使用提供的时间部分（格式：`HH:MM:SS`）
- 如果没有提供：使用系统当前时间

**`current_datetime` 占位符**：
- 如果state中提供了 `current_date`：使用提供的日期时间（格式：`YYYY-MM-DD HH:MM:SS`）
- 如果没有提供：使用系统当前日期时间

**注意**：
- 前端传入的格式为：`YYYY-MM-DD HH:mm`（没有秒）
- 占位符系统会自动补齐秒为：`YYYY-MM-DD HH:mm:00`
- 如果前端只传入日期（`YYYY-MM-DD`），时间部分默认为 `00:00:00`

## 5. 测试说明

### 5.1 测试场景

1. **默认行为测试**：
   - 不提供 `current_date` 参数
   - 验证占位符使用系统当前时间

2. **指定日期时间测试**：
   - 提供 `current_date` 参数（如：`2025-01-14 08:00`）
   - 验证占位符使用提供的日期时间

3. **格式转换测试**：
   - 前端传入 `YYYY-MM-DD HH:mm` 格式
   - 验证后端正确处理并传递给占位符系统
   - 验证占位符系统正确格式化（补齐秒）

4. **前端输入测试**：
   - 验证日期时间输入框默认值为当前时间
   - 验证可以手动输入日期时间
   - 验证可以从文档中粘贴日期时间
   - 验证日期时间选择器正常工作（如果浏览器支持）

### 5.2 测试用例

**测试用例1：默认使用系统时间**
```
请求参数：不提供 current_date
预期结果：占位符使用系统当前时间
```

**测试用例2：指定日期时间**
```
请求参数：current_date = "2025-01-14 08:00"
预期结果：
- current_date 占位符：2025-01-14
- current_time 占位符：08:00:00
- current_datetime 占位符：2025-01-14 08:00:00
```

**测试用例3：只指定日期**
```
请求参数：current_date = "2025-01-14"
预期结果：
- current_date 占位符：2025-01-14
- current_time 占位符：00:00:00
- current_datetime 占位符：2025-01-14 00:00:00
```

## 6. 开发计划

### 6.1 开发阶段

**阶段1：前端修改**（1-2小时）
1. 在 `web/chat.html` 中添加日期时间输入框
2. 实现默认值设置（当前时间）
3. 实现发送消息时获取日期时间值并格式转换
4. 测试前端功能

**阶段2：后端API修改**（1小时）
1. 修改 `app/schemas/chat.py`，添加 `current_date` 字段
2. 修改 `app/api/routes.py`，接收并传递 `current_date` 到state
3. 修改 `domain/router/state.py`，添加 `current_date` 字段
4. 测试API接口

**阶段3：占位符系统修改**（1-2小时）
1. 修改 `infrastructure/prompts/placeholder.py`，实现优先使用state中的 `current_date`
2. 实现日期时间格式转换逻辑
3. 测试占位符填充

**阶段4：联调测试**（1-2小时）
1. 前后端联调
2. 完整流程测试（指定日期时间 -> 占位符填充 -> 提示词生成）
3. 测试各种日期时间格式
4. Bug修复

### 6.2 测试要点

1. **前端测试**：
   - 日期时间输入框显示正常
   - 默认值为当前时间
   - 可以手动输入日期时间
   - 可以从文档粘贴日期时间
   - 发送请求时正确传递日期时间参数

2. **后端测试**：
   - API能够接收 `current_date` 参数
   - `current_date` 正确传递到RouterState
   - 参数为空时不报错（使用系统时间）

3. **占位符测试**：
   - 提供了 `current_date` 时，使用提供的日期时间
   - 没有提供时，使用系统当前时间
   - 日期时间格式正确（补齐秒）

4. **集成测试**：
   - 完整流程测试（前端输入 -> API接收 -> 占位符填充 -> 提示词生成）
   - 测试血压趋势点评场景（使用指定日期时间）

## 7. 注意事项

### 7.1 兼容性考虑

1. **日期时间格式**：
   - 前端使用 `datetime-local` 类型，格式为 `YYYY-MM-DDTHH:mm`
   - 后端接收格式为 `YYYY-MM-DD HH:mm`（空格分隔）
   - 前端需要在发送前进行格式转换

2. **浏览器兼容性**：
   - `datetime-local` 输入框在现代浏览器中支持良好
   - 对于不支持 `datetime-local` 的浏览器，可以降级为 `text` 类型

3. **时区处理**：
   - 当前实现不涉及时区转换
   - 所有日期时间都按照本地时区处理
   - 如果需要支持时区，需要后续扩展

### 7.2 安全性考虑

1. **输入验证**：
   - 前端应该验证日期时间格式
   - 后端应该验证日期时间格式和范围（避免未来的日期时间或过于久远的日期）

2. **日期范围限制**：
   - 可以限制日期时间范围（如：不能超过当前时间，不能早于某个日期）
   - 避免用户输入无效的日期时间

### 7.3 用户体验

1. **默认值**：
   - 日期时间输入框默认值为当前时间，方便日常使用

2. **格式提示**：
   - 如果不支持 `datetime-local`，使用 `text` 类型并提供格式提示
   - 输入框的 `title` 属性提供格式说明

3. **粘贴支持**：
   - 支持从文档中直接粘贴日期时间（如：`2025-01-14 08:00`）
   - 浏览器会自动处理格式转换

