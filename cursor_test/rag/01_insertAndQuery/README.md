# RAG向量存储与查询测试

## 简介

本目录包含RAG功能的基础测试代码，用于验证：
1. **向量存储**：将文本数据向量化并存储到PostgreSQL向量库
2. **向量查询**：基于向量相似度检索相关知识条目

## 文件说明

- `实现方案.md`：详细的实现方案文档
- `step1_insert.py`：第一步测试脚本（向量存储）
- `step2_query.py`：第二步测试脚本（向量查询）
- `README.md`：本文件

## 环境要求

1. **Conda环境**：`py_311_rag`
2. **Python包**：
   - `sentence-transformers>=5.1.1`
   - `pgvector>=0.2.4`
   - `psycopg>=3.2.12`
3. **数据库**：
   - PostgreSQL 17.6+
   - pgvector扩展 0.8.1+

## 快速开始

### 1. 激活环境

```bash
conda activate py_311_rag
```

### 2. 确保数据库配置正确

确保 `.env` 文件或环境变量中包含正确的数据库连接信息：

```bash
DATABASE_URL=postgresql+psycopg://postgres:password@localhost:5433/dbname
```

或者使用环境变量：
```bash
export DB_HOST=localhost
export DB_PORT=5433
export DB_USER=postgres
export DB_PASSWORD=your_password
export DB_NAME=gd25_biz_agent01_python
```

### 3. 运行测试

#### 第一步：向量存储测试

```bash
cd cursor_test/rag/01_insertAndQuery
python step1_insert.py
```

**预期输出**：
```
============================================================
第一步：向量存储测试
============================================================

正在连接数据库: localhost:5433/gd25_biz_agent01_python
✓ 数据库连接成功

正在创建测试表...
✓ 测试表创建成功

正在加载Embedding模型（moka-ai/m3e-base）...
  （首次运行会自动下载模型，可能需要一些时间）
✓ Embedding模型加载成功
  模型维度: 768

✓ 已清空测试表（准备插入新数据）

正在插入测试数据...
  [1/3] 插入：血压达标场景
  [2/3] 插入：血压轻度偏高场景
  [3/3] 插入：血压重度偏高场景

✓ 成功插入 3 条记录

验证数据：
  - 血压达标场景 (向量长度: ... 字符)
  - 血压轻度偏高场景 (向量长度: ... 字符)
  - 血压重度偏高场景 (向量长度: ... 字符)

============================================================
✓ 向量存储测试完成
============================================================
```

#### 第二步：向量查询测试

```bash
python step2_query.py
```

**预期输出**：
```
============================================================
第二步：向量查询测试
============================================================

正在连接数据库: localhost:5433/gd25_biz_agent01_python
✓ 数据库连接成功

✓ 测试表中有 3 条记录

正在加载Embedding模型（moka-ai/m3e-base）...
✓ Embedding模型加载成功

============================================================
开始向量查询测试...
============================================================

[测试 1/3]

查询: "我量了血压120/80，正常吗？"
  检索结果（Top-3）：

    [1] 血压达标场景 (相似度: 0.xxx) ████████████████████
        场景条件: 90<=收缩压<=目标值 且 舒张压<=目标值
        患者示例: 我今天量了血压，120/80
        回复模板: 赞！血压已达标，继续加油保持！

    [2] 血压轻度偏高场景 (相似度: 0.xxx) ████████
        ...

  [带阈值过滤（相似度>=0.7）]
  ...

============================================================
✓ 向量查询测试完成
============================================================
```

## 测试数据

### 测试场景

1. **血压达标场景**
   - 场景条件：90<=收缩压<=目标值 且 舒张压<=目标值
   - 患者示例：我今天量了血压，120/80
   - 回复模板：赞！血压已达标，继续加油保持！

2. **血压轻度偏高场景**
   - 场景条件：收缩压、舒张压任一值超过了对应设定目标值，但两者超过了均不到10mmHg
   - 患者示例：我今天的血压是135/85，有点高
   - 回复模板：我看到您本次测量的血压稍高，建议遵医嘱，规律用药，保持降压生活方式。

3. **血压重度偏高场景**
   - 场景条件：收缩压>=180 or 舒张压>=110
   - 患者示例：我量了血压，高压185，低压115
   - 回复模板：您本次测量的血压过高，建议您尽快到医院就诊，由医生判断是否需要调整治疗方案。

### 测试查询

1. "我量了血压120/80，正常吗？" → 应该匹配"血压达标场景"
2. "今天血压有点高，135/85" → 应该匹配"血压轻度偏高场景"
3. "血压185/115，怎么办？" → 应该匹配"血压重度偏高场景"

## 数据库表结构

测试使用的表：`test_knowledge_base`

```sql
CREATE TABLE test_knowledge_base (
    id SERIAL PRIMARY KEY,
    scene_name VARCHAR(200) NOT NULL,
    scene_conditions TEXT,
    patient_example TEXT,
    reply_template TEXT,
    embedding vector(768),  -- 768维向量
    created_at TIMESTAMP DEFAULT NOW()
);

-- 向量索引（HNSW）
CREATE INDEX test_knowledge_base_embedding_idx 
ON test_knowledge_base 
USING hnsw (embedding vector_cosine_ops);
```

## 注意事项

1. **首次运行**：`moka-ai/m3e-base` 模型会自动下载，需要一定时间（约几百MB）
2. **数据库连接**：确保数据库服务正在运行，且连接信息正确
3. **vector扩展**：确保数据库已安装pgvector扩展
4. **测试数据隔离**：使用 `test_knowledge_base` 表，不影响主业务数据
5. **向量维度**：确保使用768维向量（moka-ai/m3e-base的输出维度）

## 故障排查

### 问题1：无法连接数据库

**错误信息**：
```
✗ 数据库连接失败: ...
```

**解决方案**：
1. 检查数据库服务是否运行
2. 检查 `.env` 文件中的数据库配置
3. 检查数据库用户权限

### 问题2：找不到vector类型

**错误信息**：
```
TypeError: type 'vector' not found
```

**解决方案**：
1. 确保数据库已安装pgvector扩展：
   ```sql
   CREATE EXTENSION IF NOT EXISTS vector;
   ```
2. 确保已安装 `pgvector` Python包：
   ```bash
   pip install pgvector
   ```

### 问题3：模型下载失败

**错误信息**：
```
OSError: Can't load tokenizer for 'moka-ai/m3e-base'
```

**解决方案**：
1. 检查网络连接
2. 手动下载模型到本地缓存目录：`~/.cache/huggingface/hub/`
3. 或使用镜像站点

### 问题4：测试表中没有数据

**错误信息**：
```
⚠️  警告: 测试表中没有数据
```

**解决方案**：
先运行 `step1_insert.py` 插入测试数据

## 下一步

完成基础测试后，可以：

1. **扩展测试数据**：添加更多场景和示例
2. **优化向量化策略**：尝试不同的文本组合方式
3. **测试检索性能**：评估不同top_k和阈值的效果
4. **集成到主流程**：参考 `RAG集成方案分析报告.md`

---

**文档版本**: v1.0  
**创建时间**: 2025-01-XX
