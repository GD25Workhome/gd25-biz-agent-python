# V4.2 有害的B方案代码移除

## 一、概述

本文档列出项目中所有使用"兜底"、"兼容方案"、"多种数据源"等可能导致bug的代码位置。这些代码应该被移除，改为单一数据源、明确失败的方式。

## 二、问题分类

### 2.1 Langfuse 相关兼容代码

#### 2.1.1 Langfuse 适配器的降级机制

**位置**: `infrastructure/prompts/langfuse_adapter.py`

**问题代码**:
```python
def get_template(self, template_name: str, version: Optional[str] = None, fallback_to_local: bool = True) -> str:
    """
    fallback_to_local: 如果Langfuse不可用，是否降级到本地文件
    """
    # ... 从Langfuse获取模版
    except Exception as e:
        # 如果启用降级，尝试从本地文件加载
        if fallback_to_local:
            logger.warning(f"尝试从本地文件降级加载: {template_name}")
            try:
                return self._load_from_local_fallback(template_name)
            except Exception as fallback_error:
                # ...
```

**问题**: 
- 使用 `fallback_to_local` 参数允许降级到本地文件
- 当 Langfuse 失败时，静默降级到本地文件，可能导致使用错误的提示词版本
- 错误被隐藏，难以发现配置问题

**修复建议**:
- 移除 `fallback_to_local` 参数
- Langfuse 失败时直接抛出异常，不降级
- 确保所有提示词都从 Langfuse 加载

**相关调用位置**:
- `domain/agents/factory.py:204` - `fallback_to_local=True`
- `infrastructure/prompts/langfuse_loader.py:70` - `fallback_to_local=True`
- `domain/router/tools/router_tools.py:57` - `fallback_to_local=False` (这个是正确的)

---

#### 2.1.2 路由图中的 Fallback 提示词

**位置**: `domain/router/graph.py`

**问题代码**:
```python
# 第85-93行
if user_info_prompt:
    system_hint = SystemMessage(content=user_info_prompt)
    messages = [system_hint, *messages]
    logger.info(f"[AGENT_HINT] 使用PromptManager注入系统提示: {agent_name}")
else:
    # 如果PromptManager返回空，使用fallback
    logger.warning(f"PromptManager返回空提示词，使用fallback: {agent_name}")
    hint_content = (
        f"系统提供的用户ID：{user_id}。"
        "调用工具时直接使用该 user_id，无需向用户索取。"
    )
    system_hint = SystemMessage(content=hint_content)
    messages = [system_hint, *messages]
    logger.info(f"[AGENT_HINT] 使用fallback注入系统提示: {agent_name}")

# 第96-104行
except (FileNotFoundError, ValueError) as e:
    # 如果模板不存在，使用fallback
    logger.warning(f"提示词模板加载失败，使用fallback: {agent_name}, 错误: {str(e)}")
    hint_content = (
        f"系统提供的用户ID：{user_id}。"
        "调用工具时直接使用该 user_id，无需向用户索取。"
    )
    system_hint = SystemMessage(content=hint_content)
    messages = [system_hint, *messages]
    logger.info(f"[AGENT_HINT] 使用fallback注入系统提示: {agent_name}")
```

**问题**:
- 当 PromptManager 返回空或加载失败时，使用硬编码的 fallback 提示词
- 错误被隐藏，可能导致使用错误的提示词
- 应该直接失败，让配置问题暴露出来

**修复建议**:
- 移除所有 fallback 逻辑
- PromptManager 返回空或加载失败时，直接抛出异常
- 确保所有提示词都正确配置

---

### 2.2 Java 微服务降级逻辑

#### 2.2.1 预约工具的降级机制

**位置**: `domain/tools/appointment/create.py`

**问题代码**:
```python
# 第37-50行
# 如果配置了 Java 微服务，优先使用微服务
if settings.JAVA_SERVICE_BASE_URL:
    try:
        client = JavaServiceClient()
        result = await client.create_appointment(...)
        return f"成功创建预约：{result}"
    except Exception as e:
        # 如果微服务调用失败，降级到本地数据库
        pass

# 使用本地数据库创建预约
```

**问题**:
- 微服务失败时静默降级到本地数据库
- 错误被隐藏（`pass`），可能导致数据不一致
- 应该明确失败，让运维人员知道微服务有问题

**修复建议**:
- 移除降级逻辑
- 如果配置了 `JAVA_SERVICE_BASE_URL`，必须使用微服务，失败时抛出异常
- 如果没有配置，直接使用本地数据库（不要有降级逻辑）

**相关位置**:
- `domain/tools/appointment/query.py:29-38` - 同样的降级逻辑
- `domain/tools/appointment/update.py:39-57` - 同样的降级逻辑

---

#### 2.2.2 Java 微服务客户端的默认值

**位置**: `infrastructure/external/java_service.py`

**问题代码**:
```python
# 第25行
self.base_url = base_url or settings.JAVA_SERVICE_BASE_URL
```

**问题**:
- 使用 `or` 操作符提供默认值，可能导致使用错误的配置
- 应该明确检查配置，不允许隐式降级

**修复建议**:
- 移除 `or` 默认值逻辑
- 如果 `base_url` 为 None，直接使用 `settings.JAVA_SERVICE_BASE_URL`
- 如果两者都为 None，抛出明确的异常

---

### 2.3 配置相关的兼容代码

#### 2.3.1 配置中的默认值

**位置**: `app/core/config.py`

**问题代码**:
```python
# 第40-45行 - 数据库配置有默认值
DB_HOST: str = "localhost"
DB_PORT: int = 5432
DB_USER: str = "postgres"
DB_PASSWORD: str = "postgres"
DB_NAME: str = "langgraphflow"

# 第75-77行 - LLM配置有默认值
OPENAI_API_KEY: str = ""
OPENAI_BASE_URL: str = "https://api.deepseek.com/v1"
LLM_MODEL: str = "deepseek-chat"

# 第108行 - 提示词配置有默认值
PROMPT_USE_LANGFUSE: bool = True  # 是否优先使用Langfuse（默认true）
```

**问题**:
- 数据库配置有默认值，可能导致连接到错误的数据库
- LLM 配置有默认值，可能导致使用错误的 API
- 应该强制从 .env 读取，没有配置就失败

**修复建议**:
- 移除所有默认值（除了布尔值的 False）
- 关键配置（如数据库、LLM）必须从 .env 读取
- 如果 .env 中没有配置，启动时抛出异常

**注意**: Langfuse 配置已经修复（无默认值），但其他配置仍有问题。

---

#### 2.3.2 测试文件中的兼容代码

**位置**: `cursor_test/M3_test/langfuse/test_01_simple_graph.py` 和 `test_02_llm_graph.py`

**问题代码**:
```python
# test_01_simple_graph.py:145
langfuse_host = os.getenv("LANGFUSE_BASE_URL") or os.getenv("LANGFUSE_HOST", "https://cloud.langfuse.com")

# test_02_llm_graph.py:227
langfuse_host = os.getenv("LANGFUSE_BASE_URL") or os.getenv("LANGFUSE_HOST", "https://cloud.langfuse.com")
```

**问题**:
- 支持 `LANGFUSE_BASE_URL` 和 `LANGFUSE_HOST` 两种配置名
- 有默认值 `"https://cloud.langfuse.com"`
- 应该只使用 `LANGFUSE_HOST`，且无默认值

**修复建议**:
- 移除 `LANGFUSE_BASE_URL` 支持
- 移除默认值
- 只使用 `settings.LANGFUSE_HOST`

---

### 2.4 提示词加载的多种方案

#### 2.4.1 PromptManager 的多种加载方式

**位置**: `infrastructure/prompts/manager.py` 和 `infrastructure/prompts/registry.py`

**问题代码**:
```python
# registry.py:32-48 - 支持多种加载器
# 首先注册Langfuse加载器（如果可用）
if LANGFUSE_LOADER_AVAILABLE:
    try:
        langfuse_loader = LangfuseLoader()
        cls.register("langfuse", langfuse_loader)
    except Exception as e:
        logger.warning(f"注册Langfuse加载器失败: {e}，将跳过")

# 注册其他加载器
cls.register("dynamic", DynamicLoader())
cls.register("database", DatabaseLoader())
cls.register("config", ConfigLoader())
cls.register("file", FileLoader())

# manager.py:134 - 模块加载失败时继续处理
except Exception as e:
    logger.warning(f"加载模块 {module_name} 失败: {str(e)}，跳过该模块")
    # 继续处理其他模块，不中断流程
```

**问题**: 
- 支持多种加载器（langfuse, dynamic, database, config, file）
- 模块加载失败时静默跳过，可能导致提示词不完整
- 应该只支持 Langfuse，其他加载器应该移除

**修复建议**:
- 移除所有非 Langfuse 的加载器（dynamic, database, config, file）
- 模块加载失败时抛出异常，不静默跳过
- 确保只有单一数据源（Langfuse）

---

#### 2.4.2 LangfuseLoader 中的降级机制

**位置**: `infrastructure/prompts/langfuse_loader.py`

**问题代码**:
```python
# 第70行
template = self.adapter.get_template(
    template_name=source,
    version=version,
    fallback_to_local=True  # 启用降级机制
)
```

**问题**:
- 硬编码了 `fallback_to_local=True`
- 应该移除降级机制，失败时直接抛出异常

**修复建议**:
- 移除 `fallback_to_local=True`，改为 `fallback_to_local=False`
- 或者移除该参数，让适配器默认不降级

---

#### 2.4.2 Agent 配置中的降级配置

**位置**: `config/agents.yaml`

**问题代码**:
```yaml
# 第31-32行
# 降级配置（Langfuse不可用时使用）
system_prompt_path: "config/prompts/blood_pressure_prompt.txt"  # 可选：从文件加载提示词
```

**问题**:
- 配置文件中允许降级到本地文件
- 应该只使用 Langfuse，不允许降级

**修复建议**:
- 移除所有 `system_prompt_path` 配置
- 确保所有提示词都从 Langfuse 加载

---

### 2.5 向后兼容的废弃代码

#### 2.5.1 RouterState 中的废弃字段

**位置**: `domain/router/state.py`

**问题代码**:
```python
# 第15行
保留此类型仅用于向后兼容，新代码不应使用。

# 第32行
bp_form: NotRequired[BloodPressureForm]  # 血压表单槽位（已废弃，不再使用，保留仅用于向后兼容）
```

**问题**:
- 保留废弃字段用于向后兼容
- 可能导致代码混乱，难以维护

**修复建议**:
- 移除所有废弃字段
- 如果确实需要兼容，使用数据迁移脚本
- 不要保留废弃代码

---

### 2.6 LLM 客户端的默认值

#### 2.6.1 get_llm 函数的默认值

**位置**: `infrastructure/llm/client.py`

**问题代码**:
```python
def get_llm(
    model: Optional[str] = None,
    temperature: Optional[float] = None,
    log_context: Optional[LlmLogContext] = None,
    enable_logging: Optional[bool] = None,
    **kwargs
) -> BaseChatModel:
    # 使用默认值或配置值
```

**问题**:
- 参数都有默认值，可能导致使用错误的配置
- 应该明确要求传入参数，或从配置读取

**修复建议**:
- 检查所有默认值的使用
- 确保关键参数（如 model）必须明确指定
- 移除隐式的默认值逻辑

---

## 三、修复优先级

### 高优先级（立即修复）

1. **Langfuse 降级机制** - 可能导致使用错误的提示词版本
   - `infrastructure/prompts/langfuse_adapter.py`
   - `domain/router/graph.py` 中的 fallback 逻辑

2. **Java 微服务降级逻辑** - 可能导致数据不一致
   - `domain/tools/appointment/create.py`
   - `domain/tools/appointment/query.py`
   - `domain/tools/appointment/update.py`

3. **配置默认值** - 可能导致连接到错误的服务
   - `app/core/config.py` 中的数据库和 LLM 配置

### 中优先级（尽快修复）

4. **测试文件中的兼容代码** - 可能导致测试不准确
   - `cursor_test/M3_test/langfuse/test_01_simple_graph.py`
   - `cursor_test/M3_test/langfuse/test_02_llm_graph.py`

5. **Agent 配置中的降级配置** - 可能导致使用错误的提示词
   - `config/agents.yaml`

### 低优先级（计划修复）

6. **向后兼容的废弃代码** - 代码维护问题
   - `domain/router/state.py`

7. **LLM 客户端的默认值** - 可能导致使用错误的模型
   - `infrastructure/llm/client.py`

---

## 四、修复原则

1. **单一数据源**: 每个功能只允许一个数据源，不允许降级或兼容
2. **明确失败**: 配置错误或服务不可用时，直接抛出异常，不静默降级
3. **移除默认值**: 关键配置不允许有默认值，必须从 .env 读取
4. **移除废弃代码**: 不再保留向后兼容的废弃代码，使用数据迁移脚本处理兼容性

---

## 五、修复检查清单

- [ ] 移除 `infrastructure/prompts/langfuse_adapter.py` 中的 `fallback_to_local` 参数
- [ ] 移除 `domain/router/graph.py` 中的所有 fallback 提示词逻辑
- [ ] 移除 `domain/tools/appointment/*.py` 中的微服务降级逻辑
- [ ] 移除 `app/core/config.py` 中关键配置的默认值
- [ ] 移除测试文件中的 `LANGFUSE_BASE_URL` 兼容代码
- [ ] 移除 `config/agents.yaml` 中的 `system_prompt_path` 配置
- [ ] 移除 `domain/router/state.py` 中的废弃字段
- [ ] 检查并修复 `infrastructure/llm/client.py` 中的默认值逻辑
- [ ] 移除 `infrastructure/prompts/registry.py` 中的非 Langfuse 加载器
- [ ] 修复 `infrastructure/prompts/manager.py` 中模块加载失败时的静默跳过逻辑
- [ ] 移除 `infrastructure/prompts/langfuse_loader.py` 中的 `fallback_to_local=True`
- [ ] 检查并修复 `infrastructure/external/java_service.py` 中的默认值逻辑

---

## 六、相关文档

- [Langfuse 提示词模版对接使用指南](../../cursor_docs/Langfuse提示词模版对接使用指南.md)
- [外部服务调用管理分析与改进方案](../../cursor_docs/外部服务调用管理分析与改进方案.md)
- [阶段一Langfuse提示词模版对接开发总结](../../cursor_docs/阶段一Langfuse提示词模版对接开发总结.md)

---

**文档版本**: V4.2  
**创建日期**: 2025-01-XX  
**最后更新**: 2025-01-XX

