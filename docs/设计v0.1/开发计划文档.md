# GD25 Biz Agent Python 开发计划文档 (v0.3.0)

## 1. 总体进度概览

**当前状态**: 🚀 **Milestone 2 (核心业务) & Milestone 3 (RAG) 已完成，Milestone 4 (高级特性) 准备中**
**整体完成度**: 约 60%

本项目旨在重构并升级原有的医疗 Agent 系统。目前已完成基础设施搭建、核心数据库迁移、血压管理 Agent 以及基于 RAG 的诊断 Agent 开发。

---

## 2. 详细任务列表 (Backlog)

### 2.1 基础设施层 (Infrastructure Layer)

| 模块 | 任务项 | 状态 | 说明 |
| :--- | :--- | :--- | :--- |
| **Database** | PostgreSQL 异步连接配置 | ✅ 已完成 | `infrastructure/database/connection.py` |
| | **定义核心数据模型** | ✅ 已完成 | Users, BloodPressure, Appointments |
| | **定义辅助数据模型** | ✅ 已完成 | KnowledgeBase (PGVector), ChatHistory, AgentTraces |
| | Alembic 迁移脚本初始化 | ✅ 已完成 | 已执行 Initial Migration |
| **VectorDB** | 向量数据库连接 (PGVector/ADB PG) | ✅ 已完成 | 通过 SQLAlchemy Model 支持 |
| **Redis** | Redis 连接与缓存工具封装 | ⬜ 未开始 | 用于会话缓存或高频数据 |
| **LLM** | LLM Client 统一封装 | ✅ 已完成 | `infrastructure/llm/client.py` |
| **RAG** | RAG 引擎基础类 (Retriever) | ✅ 已完成 | `infrastructure/rag/vector_store.py` |
| | 混合检索 (Hybrid Search) 实现 | 🚧 部分完成 | 仅实现了向量检索 (Vector Search) |
| | Rerank (重排序) 模型集成 | ⬜ 未开始 | 引入 BGE-Reranker 等提升相关性 |
| | Query Rewriting (查询改写) | ⬜ 未开始 | 优化用户输入以适应检索 |

### 2.2 领域层 (Domain Layer - LangGraph)

| 模块 | 任务项 | 状态 | 说明 |
| :--- | :--- | :--- | :--- |
| **Router** | Supervisor 基础逻辑 | ✅ 已完成 | `domain/router/supervisor.py` |
| | 复杂路由策略 | ✅ 已完成 | 基于意图的路由 (BloodPressure vs Diagnosis) |
| | 意图识别 Prompt 优化 | ✅ 已完成 | 优化后的 Supervisor Prompt |
| **Agents** | **BaseAgent** 抽象基类 | ✅ 已完成 | `domain/agents/base.py` |
| | **Agent Factory** 模式实现 | ✅ 已完成 | `domain/agents/factory.py` |
| | **BloodPressureAgent** 实现 | ✅ 已完成 | `config/agents.yaml` + Factory |
| | **DiagnosisAgent** 实现 | ✅ 已完成 | `config/agents.yaml` + Factory |
| | **AppointmentAgent** 实现 | ⬜ 未开始 | 需集成预约工具 |
| | Agent 配置化加载 (YAML) | ✅ 已完成 | `config/agents.yaml` |
| **Tools** | 血压管理工具集 (CRUD) | ✅ 已完成 | `domain/tools/blood_pressure.py` |
| | 预约管理工具集 | ⬜ 未开始 | Book/Query Appointment |
| | 知识库检索工具 | ✅ 已完成 | `domain/tools/search.py` |
| **Workflow** | 完整 LangGraph 图构建 | ✅ 已完成 | Supervisor -> Agent Loop |
| | **Checkpointer** 状态持久化 | ⬜ 未开始 | 基于 Postgres 实现长短期记忆 |

### 2.3 应用层 (Application Layer)

| 模块 | 任务项 | 状态 | 说明 |
| :--- | :--- | :--- | :--- |
| **API** | `/chat` 基础接口 | ✅ 已完成 | `app/api/routes.py` |
| | 流式响应 (SSE) 支持 | ⬜ 未开始 | `text/event-stream` 格式输出 |
| | 历史记录查询接口 | ⬜ 未开始 | `/history/{session_id}` |
| | 用户反馈接口 | ⬜ 未开始 | `/feedback` |
| **Config** | 环境变量管理 (.env) | ✅ 已完成 | `app/core/config.py` |
| **Auth** | 简单用户认证/会话管理 | ⬜ 未开始 | 目前仅透传 user_id |

### 2.4 测试与工程化

| 模块 | 任务项 | 状态 | 说明 |
| :--- | :--- | :--- | :--- |
| **Tests** | 单元测试框架 (pytest) | ⬜ 未开始 | |
| | 集成测试 (Router 流程) | ✅ 已完成 | `scripts/verify_milestones.py` |
| **Docs** | 详细设计文档 | ✅ 已完成 | |
| | API 接口文档 (Swagger) | ✅ 已完成 | FastAPI 自带 |
| **Ops** | 链路追踪 (Tracing) | ⬜ 未开始 | 集成 LangSmith 或 Phoenix |

---

## 3. 里程碑规划 (Milestones)

为了稳步推进系统开发，将剩余工作拆解为 4 个关键里程碑。

### 🚀 Milestone 1: 基础设施与数据层就绪 (Infrastructure & Data Foundation)
**状态**: ✅ 已完成
**目标**: 完成数据库设计与连接，确保所有数据存储就绪，打通“代码-数据库”通路。
- [x] **M1.1 数据建模**: 定义 `Users`, `BloodPressure`, `Appointments` 表结构 (SQLAlchemy Models)。
- [x] **M1.2 辅助表建模**: 定义 `KnowledgeBase` (PGVector), `ChatHistory`, `AgentTraces` 表结构。
- [x] **M1.3 数据库迁移**: 初始化 Alembic，生成并执行第一次 Migration，确保数据库表创建成功。
- [x] **M1.4 环境配置**: 移除 Docker Compose，配置本地 PostgreSQL 连接。

### 🩺 Milestone 2: 核心业务 Agent (Core Business Agents)
**状态**: ✅ 已完成
**目标**: 实现血压管理业务闭环，跑通“用户 -> Router -> Agent -> DB”的完整链路。
- [x] **M2.1 工具实现**: 开发 `AddBloodPressureTool` 和 `QueryBloodPressureTool`。
- [x] **M2.2 Agent 完善**: 在 `BloodPressureAgent` 中挂载上述工具，并配置 Prompt。
- [x] **M2.3 配置加载**: 完善 `agents.yaml`，实现通过配置动态加载 Agent 参数。
- [x] **M2.4 路由调优**: 优化 Supervisor Prompt，确保能精准识别“血压管理”意图。

### 🧠 Milestone 3: RAG 增强与诊断能力 (RAG & Diagnosis Capability)
**状态**: ✅ 已完成
**目标**: 实现基于知识库的智能诊断能力，构建“医疗大脑”。
- [x] **M3.1 RAG 基础设施**: 集成本地 Embedding (m3e-base)，支持自动下载和国内镜像加速。
- [x] **M3.2 向量库写入**: 使用 pgvector 存储向量 (768维)。
- [x] **M3.3 检索工具**: 实现 `search_knowledge_base` (Vector Search)。
- [x] **M3.4 诊断 Agent**: 开发 `DiagnosisAgent`，集成检索工具，实现基于证据的问答。

### ⚡ Milestone 4: 高级特性与生产化 (Advanced Features & Production Readiness)
**状态**: ⬜ 未开始
**目标**: 提升系统可用性、交互体验和可观测性。
- [ ] **M4.1 状态持久化**: 启用 `PostgresCheckpointer`，实现对话状态保存与恢复 (Long-term Memory)。
- [ ] **M4.2 流式响应**: 改造 `/chat` 接口，支持 SSE 流式输出 Agent 思考过程和结果。
- [ ] **M4.3 预约业务**: 实现 `AppointmentAgent` 及其工具链。
- [ ] **M4.4 链路追踪**: 集成 LangSmith 或 Phoenix，监控 Token 消耗和延迟。

---

## 4. 差距分析 (Gap Analysis)

目前系统已具备核心业务能力，主要差距在于生产化特性：

*   **持久化**: 对话状态目前仅在内存中，重启后丢失。
*   **流式体验**: API 仍为同步阻塞式，体验待优化。
*   **RAG 精度**: 目前仅支持简单的向量检索，缺乏重排序和混合检索。
