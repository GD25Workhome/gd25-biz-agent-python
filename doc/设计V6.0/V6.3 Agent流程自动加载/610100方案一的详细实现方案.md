# 方案一详细实现方案：YAML流程定义 + 自定义解析器

## 一、当前架构分析

### 1.1 当前架构概览

当前系统采用**硬编码+yml混合**方式实现AI应答流程：

#### 核心组件

1. **路由图构建**（`domain/router/graph.py`）
   - `create_router_graph()`: 硬编码构建路由图结构
   - `with_user_context()`: Agent节点包装器（硬编码）
   - 图结构固定：`route` → `agent` → `route` 循环

2. **节点实现**（`domain/router/node.py`）
   - `route_node()`: 意图识别和路由决策（硬编码逻辑）
   - `clarify_intent_node()`: 意图澄清（硬编码逻辑）

3. **Agent工厂**（`domain/agents/factory.py`）
   - `AgentFactory`: 根据YAML配置创建Agent实例
   - 支持缓存和热更新

4. **Agent注册表**（`domain/agents/registry.py`）
   - `AgentRegistry`: 管理Agent配置和注册信息

5. **状态定义**（`domain/router/state.py`）
   - `RouterState`: 路由状态结构（TypedDict）

### 1.2 当前架构类图

```
┌─────────────────────────────────────────────────────────────┐
│                    当前架构核心类图                          │
└─────────────────────────────────────────────────────────────┘

┌──────────────────────┐
│   create_router_graph│  (函数，硬编码)
│   (graph.py)         │
└──────────┬───────────┘
           │
           ├─────────────────────────────────────┐
           │                                     │
           ▼                                     ▼
┌──────────────────────┐            ┌──────────────────────┐
│   StateGraph          │            │   RouterState         │
│   (LangGraph)         │            │   (TypedDict)         │
└──────────┬───────────┘            └──────────────────────┘
           │
           ├── add_node("route", route_node)
           ├── add_node("clarify_intent", clarify_intent_node)
           │
           ├── 动态添加Agent节点（循环）
           │   ┌─────────────────────────────────────┐
           │   │ for agent_key in AgentRegistry:     │
           │   │   agent = AgentFactory.create_agent │
           │   │   workflow.add_node(...)           │
           │   └─────────────────────────────────────┘
           │
           └── add_conditional_edges("route", route_to_agent, ...)
               └── route_to_agent()  (硬编码路由逻辑)

┌──────────────────────┐
│   route_node         │  (硬编码函数)
│   (node.py)          │
│   - 意图识别         │
│   - 路由决策         │
└──────────────────────┘

┌──────────────────────┐
│   clarify_intent_node│  (硬编码函数)
│   (node.py)          │
│   - 意图澄清         │
└──────────────────────┘

┌──────────────────────┐
│   AgentFactory        │  (类，支持配置)
│   - load_config()     │
│   - create_agent()    │
│   - 缓存机制          │
└──────────┬───────────┘
           │
           └── 读取 config/agents.yaml

┌──────────────────────┐
│   AgentRegistry       │  (类，支持配置)
│   - get_all_agents()  │
│   - 从配置加载        │
└──────────────────────┘
```

### 1.3 当前架构的问题

1. **图结构硬编码**
   - 节点添加逻辑在代码中写死
   - 边连接逻辑硬编码
   - 路由决策函数硬编码

2. **扩展性差**
   - 添加新节点类型需要修改代码
   - 修改流程结构需要修改代码
   - 无法支持多流程、多版本

3. **配置与代码耦合**
   - Agent配置在YAML中，但图结构在代码中
   - 无法通过配置文件定义完整流程

---

## 二、新方案架构设计

### 2.1 新方案核心思想

**通过YAML流程文件定义完整的图结构，解析后动态构建LangGraph图。**

### 2.2 流程文件格式设计

#### 2.2.1 流程文件结构（`config/flows/main_flow.yaml`）

```yaml
flow:
  name: "main_router_flow"
  version: "1.0"
  description: "主路由流程"
  entry_point: "route"
  state_type: "RouterState"  # 状态类型（对应RouterState）
  
  # 节点定义
  nodes:
    # 路由节点
    - name: "route"
      type: "intent_router"  # 节点类型
      config:
        intent_tool: "identify_intent"  # 意图识别工具
        clarify_on_unclear: true  # 意图不明确时是否澄清
    
    # 澄清节点
    - name: "clarify_intent"
      type: "clarify_node"  # 节点类型
      config:
        clarify_tool: "clarify_intent"  # 澄清工具
    
    # Agent节点（动态）
    - name: "blood_pressure_agent"
      type: "agent"  # 节点类型
      config:
        agent_key: "blood_pressure_agent"  # Agent键名
        # tools在agents.yaml中定义，这里不需要重复
    
    - name: "health_event_agent"
      type: "agent"
      config:
        agent_key: "health_event_agent"
  
  # 边定义
  edges:
    # 条件边：从route节点根据意图路由
    - from: "route"
      to: "blood_pressure_agent"
      type: "conditional"  # 条件边
      condition:
        type: "state_field"  # 条件类型：状态字段判断
        field: "current_intent"  # 状态字段名
        operator: "equals"  # 操作符
        value: "blood_pressure"  # 比较值
    
    - from: "route"
      to: "health_event_agent"
      type: "conditional"
      condition:
        type: "state_field"
        field: "current_intent"
        operator: "equals"
        value: "health_event"
    
    - from: "route"
      to: "clarify_intent"
      type: "conditional"
      condition:
        type: "state_field"
        field: "current_intent"
        operator: "equals"
        value: "unclear"
    
    # 直接边：Agent执行后返回route节点
    - from: "blood_pressure_agent"
      to: "route"
      type: "direct"  # 直接边
    
    - from: "health_event_agent"
      to: "route"
      type: "direct"
    
    - from: "clarify_intent"
      to: "route"
      type: "direct"
```

### 2.3 新方案架构类图

```
┌─────────────────────────────────────────────────────────────┐
│                    新方案架构核心类图                        │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     流程定义层                               │
│                                                              │
│  config/flows/main_flow.yaml  (流程配置文件)                │
│  config/flows/xxx_flow.yaml   (其他流程文件)                │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                     流程解析层                               │
│                                                              │
│  ┌──────────────────────┐                                  │
│  │   FlowParser          │  (流程解析器)                    │
│  │   - parse_flow()      │                                  │
│  │   - validate_flow()    │                                  │
│  └──────────┬───────────┘                                  │
│             │                                               │
│             ▼                                               │
│  ┌──────────────────────┐                                  │
│  │   FlowDefinition      │  (流程定义对象)                   │
│  │   - name              │                                  │
│  │   - version           │                                  │
│  │   - nodes: List[Node] │                                  │
│  │   - edges: List[Edge] │                                  │
│  └──────────────────────┘                                  │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                     节点工厂层                               │
│                                                              │
│  ┌──────────────────────┐                                  │
│  │   NodeFactory         │  (节点工厂)                      │
│  │   - register_type()   │                                  │
│  │   - create_node()     │                                  │
│  │   - _node_registry    │                                  │
│  └──────────┬───────────┘                                  │
│             │                                               │
│             ├─── intent_router ──> route_node()             │
│             ├─── clarify_node ──> clarify_intent_node()    │
│             └─── agent ─────────> with_user_context()     │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                     路由生成层                               │
│                                                              │
│  ┌──────────────────────┐                                  │
│  │   RouteGenerator      │  (路由函数生成器)                │
│  │   - generate_route()  │                                  │
│  │   - _build_condition()│                                  │
│  └──────────┬───────────┘                                  │
│             │                                               │
│             ▼                                               │
│  ┌──────────────────────┐                                  │
│  │   route_function      │  (动态生成的路由函数)            │
│  │   (根据edges定义生成) │                                  │
│  └──────────────────────┘                                  │
└──────────────────────────┬──────────────────────────────────┘
                           │
                           ▼
┌─────────────────────────────────────────────────────────────┐
│                     图构建层                                 │
│                                                              │
│  ┌──────────────────────┐                                  │
│  │   GraphBuilder        │  (图构建器)                     │
│  │   - build_graph()     │                                  │
│  │   - _add_nodes()      │                                  │
│  │   - _add_edges()      │                                  │
│  └──────────┬───────────┘                                  │
│             │                                               │
│             ▼                                               │
│  ┌──────────────────────┐                                  │
│  │   StateGraph          │  (LangGraph)                    │
│  │   - add_node()        │                                  │
│  │   - add_edge()        │                                  │
│  │   - add_conditional_edges()                             │
│  └──────────┬───────────┘                                  │
│             │                                               │
│             ▼                                               │
│  ┌──────────────────────┐                                  │
│  │   CompiledGraph       │  (编译后的图)                    │
│  └──────────────────────┘                                  │
└─────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────┐
│                     流程管理层                               │
│                                                              │
│  ┌──────────────────────┐                                  │
│  │   FlowManager         │  (流程管理器)                    │
│  │   - load_flow()       │                                  │
│  │   - get_flow()        │                                  │
│  │   - reload_flow()     │                                  │
│  │   - list_flows()      │                                  │
│  └──────────────────────┘                                  │
└─────────────────────────────────────────────────────────────┘
```

### 2.4 核心类设计

#### 2.4.1 FlowDefinition（流程定义对象）

```python
from dataclasses import dataclass
from typing import List, Optional, Dict, Any

@dataclass
class NodeDefinition:
    """节点定义"""
    name: str
    type: str  # intent_router, clarify_node, agent, ...
    config: Dict[str, Any]

@dataclass
class EdgeDefinition:
    """边定义"""
    from_node: str
    to_node: str
    type: str  # direct, conditional
    condition: Optional[Dict[str, Any]] = None  # 条件边需要

@dataclass
class FlowDefinition:
    """流程定义"""
    name: str
    version: str
    description: Optional[str] = None
    entry_point: str = "route"
    state_type: str = "RouterState"
    nodes: List[NodeDefinition] = None
    edges: List[EdgeDefinition] = None
```

#### 2.4.2 FlowParser（流程解析器）

```python
class FlowParser:
    """流程解析器：解析YAML流程文件"""
    
    @staticmethod
    def parse_flow(flow_file: str) -> FlowDefinition:
        """解析流程文件，返回流程定义对象"""
        pass
    
    @staticmethod
    def validate_flow(flow_def: FlowDefinition) -> bool:
        """验证流程定义的有效性"""
        pass
```

#### 2.4.3 NodeFactory（节点工厂）

```python
class NodeFactory:
    """节点工厂：根据节点定义创建节点函数"""
    
    _node_registry: Dict[str, Callable] = {}
    
    @classmethod
    def register_node_type(cls, node_type: str, factory_func: Callable):
        """注册节点类型"""
        cls._node_registry[node_type] = factory_func
    
    @classmethod
    def create_node(cls, node_def: NodeDefinition):
        """根据节点定义创建节点函数"""
        node_type = node_def.type
        factory = cls._node_registry.get(node_type)
        if not factory:
            raise ValueError(f"未知的节点类型: {node_type}")
        return factory(node_def)
```

#### 2.4.4 RouteGenerator（路由函数生成器）

```python
class RouteGenerator:
    """路由函数生成器：根据边定义生成路由函数"""
    
    @staticmethod
    def generate_route_function(
        edges: List[EdgeDefinition],
        node_names: List[str]
    ) -> Callable:
        """根据边定义生成路由函数"""
        pass
    
    @staticmethod
    def _build_condition(condition_def: Dict[str, Any]) -> Callable:
        """构建条件判断函数"""
        pass
```

#### 2.4.5 GraphBuilder（图构建器）

```python
class GraphBuilder:
    """图构建器：根据流程定义构建LangGraph图"""
    
    def __init__(self, flow_def: FlowDefinition):
        self.flow_def = flow_def
        self.workflow = StateGraph(RouterState)
        self.node_functions = {}  # 节点名称 -> 节点函数
    
    def build_graph(
        self,
        checkpointer: Optional[BaseCheckpointSaver] = None,
        store: Optional[BaseStore] = None
    ) -> CompiledGraph:
        """构建并编译图"""
        # 1. 添加节点
        self._add_nodes()
        
        # 2. 设置入口点
        self.workflow.set_entry_point(self.flow_def.entry_point)
        
        # 3. 添加边
        self._add_edges()
        
        # 4. 编译图
        return self._compile_graph(checkpointer, store)
    
    def _add_nodes(self):
        """添加所有节点"""
        for node_def in self.flow_def.nodes:
            node_func = NodeFactory.create_node(node_def)
            self.workflow.add_node(node_def.name, node_func)
            self.node_functions[node_def.name] = node_func
    
    def _add_edges(self):
        """添加所有边"""
        # 分组：直接边和条件边
        direct_edges = []
        conditional_edges = {}  # from_node -> List[EdgeDefinition]
        
        for edge in self.flow_def.edges:
            if edge.type == "direct":
                direct_edges.append(edge)
            elif edge.type == "conditional":
                if edge.from_node not in conditional_edges:
                    conditional_edges[edge.from_node] = []
                conditional_edges[edge.from_node].append(edge)
        
        # 添加直接边
        for edge in direct_edges:
            self.workflow.add_edge(edge.from_node, edge.to_node)
        
        # 添加条件边
        for from_node, edges in conditional_edges.items():
            route_func = RouteGenerator.generate_route_function(
                edges, [node.name for node in self.flow_def.nodes]
            )
            route_map = {edge.to_node: edge.to_node for edge in edges}
            route_map[END] = END
            self.workflow.add_conditional_edges(from_node, route_func, route_map)
```

#### 2.4.6 FlowManager（流程管理器）

```python
class FlowManager:
    """流程管理器：管理多个流程的加载和缓存"""
    
    _flows: Dict[str, CompiledGraph] = {}
    _flow_definitions: Dict[str, FlowDefinition] = {}
    _flow_mtimes: Dict[str, float] = {}
    
    @classmethod
    def load_flow(cls, flow_file: str, flow_name: Optional[str] = None) -> CompiledGraph:
        """加载流程文件并构建图"""
        flow_name = flow_name or os.path.basename(flow_file).replace('.yaml', '')
        
        # 解析流程定义
        flow_def = FlowParser.parse_flow(flow_file)
        
        # 构建图
        graph = GraphBuilder(flow_def).build_graph()
        
        # 缓存
        cls._flow_definitions[flow_name] = flow_def
        cls._flows[flow_name] = graph
        cls._flow_mtimes[flow_name] = os.path.getmtime(flow_file)
        
        return graph
    
    @classmethod
    def get_flow(cls, flow_name: str) -> Optional[CompiledGraph]:
        """获取流程图"""
        return cls._flows.get(flow_name)
    
    @classmethod
    def reload_flow(cls, flow_name: str) -> CompiledGraph:
        """重新加载流程（热更新）"""
        flow_def = cls._flow_definitions.get(flow_name)
        if not flow_def:
            raise ValueError(f"流程不存在: {flow_name}")
        
        # 重新构建图
        graph = GraphBuilder(flow_def).build_graph()
        cls._flows[flow_name] = graph
        
        return graph
```

---

## 三、核心类图对比

### 3.1 当前方案类图

```
┌─────────────────────────────────────────────────────────────┐
│                    当前方案类图                              │
└─────────────────────────────────────────────────────────────┘

┌──────────────────────┐
│   create_router_graph│  (函数)
│   (graph.py)         │
└──────────┬───────────┘
           │
           ├── 硬编码创建 StateGraph
           ├── 硬编码添加节点
           │   ├── add_node("route", route_node)
           │   ├── add_node("clarify_intent", clarify_intent_node)
           │   └── 循环添加Agent节点
           │
           ├── 硬编码路由函数 route_to_agent()
           │   └── 硬编码条件判断逻辑
           │
           └── 硬编码添加边
               ├── add_conditional_edges("route", route_to_agent, ...)
               └── add_edge(agent, "route")  (循环)

┌──────────────────────┐
│   route_node         │  (硬编码函数)
│   clarify_intent_node│
│   (node.py)          │
└──────────────────────┘

┌──────────────────────┐
│   AgentFactory        │  (类)
│   - create_agent()   │
│   - 从YAML加载配置    │
└──────────────────────┘

┌──────────────────────┐
│   AgentRegistry       │  (类)
│   - get_all_agents()  │
└──────────────────────┘

配置文件：
  config/agents.yaml  (Agent配置)
```

### 3.2 新方案类图

```
┌─────────────────────────────────────────────────────────────┐
│                    新方案类图                                │
└─────────────────────────────────────────────────────────────┘

┌──────────────────────┐
│   FlowManager        │  (类，流程管理器)
│   - load_flow()      │
│   - get_flow()       │
│   - reload_flow()    │
└──────────┬───────────┘
           │
           ├── 调用 FlowParser.parse_flow()
           │
           └── 调用 GraphBuilder.build_graph()

┌──────────────────────┐
│   FlowParser         │  (类，流程解析器)
│   - parse_flow()     │
│   - validate_flow()  │
└──────────┬───────────┘
           │
           └── 返回 FlowDefinition

┌──────────────────────┐
│   FlowDefinition     │  (数据类)
│   - name             │
│   - nodes: List[Node]│
│   - edges: List[Edge]│
└──────────┬───────────┘
           │
           └── 传递给 GraphBuilder

┌──────────────────────┐
│   GraphBuilder        │  (类，图构建器)
│   - build_graph()     │
│   - _add_nodes()      │
│   - _add_edges()      │
└──────────┬───────────┘
           │
           ├── 调用 NodeFactory.create_node()
           │   └── 根据节点类型创建节点函数
           │
           ├── 调用 RouteGenerator.generate_route_function()
           │   └── 根据边定义生成路由函数
           │
           └── 动态构建 StateGraph

┌──────────────────────┐
│   NodeFactory         │  (类，节点工厂)
│   - register_type()   │
│   - create_node()     │
│   - _node_registry    │
└──────────┬───────────┘
           │
           ├── intent_router ──> route_node()
           ├── clarify_node ──> clarify_intent_node()
           └── agent ─────────> with_user_context()

┌──────────────────────┐
│   RouteGenerator      │  (类，路由生成器)
│   - generate_route() │
│   - _build_condition()│
└──────────┬───────────┘
           │
           └── 动态生成路由函数

配置文件：
  config/flows/main_flow.yaml  (流程定义)
  config/agents.yaml           (Agent配置，保持不变)
```

### 3.3 关键差异对比

| 维度 | 当前方案 | 新方案 |
|------|---------|--------|
| **图结构定义** | 硬编码在 `create_router_graph()` 函数中 | YAML流程文件定义 |
| **节点添加** | 硬编码 `workflow.add_node()` | 通过 `NodeFactory` 动态创建 |
| **路由逻辑** | 硬编码 `route_to_agent()` 函数 | 通过 `RouteGenerator` 动态生成 |
| **边连接** | 硬编码 `add_edge()` 和 `add_conditional_edges()` | 通过 `GraphBuilder` 根据配置动态添加 |
| **扩展性** | 修改流程需要改代码 | 修改流程只需改YAML文件 |
| **多流程支持** | 不支持 | 支持（通过 `FlowManager`） |
| **热更新** | 仅支持Agent配置热更新 | 支持完整流程热更新 |

---

## 四、改造点详细分析

### 4.1 文件结构改造

#### 当前文件结构

```
domain/
├── router/
│   ├── graph.py          # 硬编码图构建
│   ├── node.py           # 节点实现（保持不变）
│   └── state.py          # 状态定义（保持不变）
└── agents/
    ├── factory.py        # Agent工厂（保持不变）
    └── registry.py        # Agent注册表（保持不变）

config/
└── agents.yaml           # Agent配置（保持不变）
```

#### 新文件结构

```
domain/
├── flows/                # 新增：流程管理模块
│   ├── __init__.py
│   ├── parser.py         # FlowParser：流程解析器
│   ├── definition.py     # FlowDefinition：流程定义对象
│   ├── node_factory.py   # NodeFactory：节点工厂
│   ├── route_generator.py # RouteGenerator：路由生成器
│   ├── graph_builder.py  # GraphBuilder：图构建器
│   └── manager.py        # FlowManager：流程管理器
├── router/
│   ├── graph.py          # 改造：使用FlowManager加载流程
│   ├── node.py           # 保持不变：节点实现
│   └── state.py          # 保持不变：状态定义
└── agents/
    ├── factory.py        # 保持不变：Agent工厂
    └── registry.py       # 保持不变：Agent注册表

config/
├── agents.yaml           # 保持不变：Agent配置
└── flows/                # 新增：流程配置文件目录
    ├── main_flow.yaml    # 主路由流程
    └── xxx_flow.yaml     # 其他流程
```

### 4.2 核心代码改造

#### 4.2.1 `domain/router/graph.py` 改造

**当前实现**：
```python
def create_router_graph(
    checkpointer: Optional[BaseCheckpointSaver] = None,
    pool: Optional[AsyncConnectionPool] = None,
    store: Optional[BaseStore] = None,
):
    """硬编码构建路由图"""
    workflow = StateGraph(RouterState)
    
    # 硬编码添加节点
    workflow.add_node("route", route_node)
    workflow.add_node("clarify_intent", clarify_intent_node)
    
    # 硬编码添加Agent节点
    for agent_key, agent_config in AgentRegistry.get_all_agents().items():
        agent = AgentFactory.create_agent(agent_key)
        node_name = AgentRegistry.get_agent_node_name(agent_key)
        workflow.add_node(node_name, with_user_context(agent, agent_key))
    
    # 硬编码路由函数
    def route_to_agent(state: RouterState) -> str:
        # 硬编码条件判断逻辑
        ...
    
    # 硬编码添加边
    workflow.add_conditional_edges("route", route_to_agent, route_map)
    for node_name in agent_node_names.values():
        workflow.add_edge(node_name, "route")
    
    return workflow.compile(**graph_config)
```

**新实现**：
```python
from domain.flows.manager import FlowManager

def create_router_graph(
    checkpointer: Optional[BaseCheckpointSaver] = None,
    pool: Optional[AsyncConnectionPool] = None,
    store: Optional[BaseStore] = None,
    flow_file: str = "config/flows/main_flow.yaml",  # 新增：流程文件路径
):
    """从流程文件构建路由图"""
    # 使用FlowManager加载流程
    graph = FlowManager.load_flow(flow_file)
    return graph

# 保留 with_user_context 函数（用于NodeFactory）
def with_user_context(agent_node, agent_name: str):
    """Agent节点包装器（保持不变）"""
    # ... 现有实现 ...
```

#### 4.2.2 新增 `domain/flows/definition.py`

```python
from dataclasses import dataclass
from typing import List, Optional, Dict, Any

@dataclass
class NodeDefinition:
    """节点定义"""
    name: str
    type: str  # intent_router, clarify_node, agent, ...
    config: Dict[str, Any]

@dataclass
class EdgeDefinition:
    """边定义"""
    from_node: str
    to_node: str
    type: str  # direct, conditional
    condition: Optional[Dict[str, Any]] = None

@dataclass
class FlowDefinition:
    """流程定义"""
    name: str
    version: str
    description: Optional[str] = None
    entry_point: str = "route"
    state_type: str = "RouterState"
    nodes: List[NodeDefinition] = None
    edges: List[EdgeDefinition] = None
```

#### 4.2.3 新增 `domain/flows/parser.py`

```python
import yaml
from typing import Dict, Any
from domain.flows.definition import FlowDefinition, NodeDefinition, EdgeDefinition

class FlowParser:
    """流程解析器"""
    
    @staticmethod
    def parse_flow(flow_file: str) -> FlowDefinition:
        """解析流程文件"""
        with open(flow_file, 'r', encoding='utf-8') as f:
            data = yaml.safe_load(f)
        
        flow_data = data.get('flow', {})
        
        # 解析节点
        nodes = []
        for node_data in flow_data.get('nodes', []):
            nodes.append(NodeDefinition(
                name=node_data['name'],
                type=node_data['type'],
                config=node_data.get('config', {})
            ))
        
        # 解析边
        edges = []
        for edge_data in flow_data.get('edges', []):
            edges.append(EdgeDefinition(
                from_node=edge_data['from'],
                to_node=edge_data['to'],
                type=edge_data['type'],
                condition=edge_data.get('condition')
            ))
        
        return FlowDefinition(
            name=flow_data['name'],
            version=flow_data.get('version', '1.0'),
            description=flow_data.get('description'),
            entry_point=flow_data.get('entry_point', 'route'),
            state_type=flow_data.get('state_type', 'RouterState'),
            nodes=nodes,
            edges=edges
        )
    
    @staticmethod
    def validate_flow(flow_def: FlowDefinition) -> bool:
        """验证流程定义"""
        # 验证节点名称唯一性
        node_names = [node.name for node in flow_def.nodes]
        if len(node_names) != len(set(node_names)):
            raise ValueError("节点名称必须唯一")
        
        # 验证入口点存在
        if flow_def.entry_point not in node_names:
            raise ValueError(f"入口点 '{flow_def.entry_point}' 不存在")
        
        # 验证边的节点存在
        for edge in flow_def.edges:
            if edge.from_node not in node_names:
                raise ValueError(f"边的源节点 '{edge.from_node}' 不存在")
            if edge.to_node not in node_names and edge.to_node != "END":
                raise ValueError(f"边的目标节点 '{edge.to_node}' 不存在")
        
        return True
```

#### 4.2.4 新增 `domain/flows/node_factory.py`

```python
from typing import Dict, Callable
from domain.flows.definition import NodeDefinition
from domain.router.node import route_node, clarify_intent_node
from domain.router.graph import with_user_context
from domain.agents.factory import AgentFactory

class NodeFactory:
    """节点工厂"""
    
    _node_registry: Dict[str, Callable] = {}
    
    @classmethod
    def register_node_type(cls, node_type: str, factory_func: Callable):
        """注册节点类型"""
        cls._node_registry[node_type] = factory_func
    
    @classmethod
    def create_node(cls, node_def: NodeDefinition) -> Callable:
        """根据节点定义创建节点函数"""
        node_type = node_def.type
        
        if node_type == "intent_router":
            # 使用现有的route_node函数
            return route_node
        
        elif node_type == "clarify_node":
            # 使用现有的clarify_intent_node函数
            return clarify_intent_node
        
        elif node_type == "agent":
            # 创建Agent节点
            agent_key = node_def.config.get("agent_key")
            if not agent_key:
                raise ValueError(f"Agent节点 '{node_def.name}' 缺少 agent_key 配置")
            
            # 创建Agent实例
            agent = AgentFactory.create_agent(agent_key)
            
            # 使用with_user_context包装
            return with_user_context(agent, agent_key)
        
        else:
            # 尝试从注册表获取
            factory = cls._node_registry.get(node_type)
            if factory:
                return factory(node_def)
            
            raise ValueError(f"未知的节点类型: {node_type}")
```

#### 4.2.5 新增 `domain/flows/route_generator.py`

```python
from typing import List, Callable
from langgraph.graph import END
from domain.router.state import RouterState
from domain.flows.definition import EdgeDefinition

class RouteGenerator:
    """路由函数生成器"""
    
    @staticmethod
    def generate_route_function(
        edges: List[EdgeDefinition],
        node_names: List[str]
    ) -> Callable:
        """根据边定义生成路由函数"""
        
        def route_func(state: RouterState) -> str:
            """动态生成的路由函数"""
            # 遍历所有条件边，找到匹配的条件
            for edge in edges:
                if edge.type == "conditional" and edge.condition:
                    if RouteGenerator._evaluate_condition(state, edge.condition):
                        return edge.to_node
            
            # 如果没有匹配的条件，返回END
            return END
        
        return route_func
    
    @staticmethod
    def _evaluate_condition(state: RouterState, condition: dict) -> bool:
        """评估条件"""
        condition_type = condition.get("type")
        
        if condition_type == "state_field":
            # 状态字段判断
            field = condition.get("field")
            operator = condition.get("operator", "equals")
            value = condition.get("value")
            
            state_value = state.get(field)
            
            if operator == "equals":
                return state_value == value
            elif operator == "not_equals":
                return state_value != value
            elif operator == "in":
                return state_value in value if isinstance(value, list) else False
            elif operator == "not_in":
                return state_value not in value if isinstance(value, list) else True
            else:
                raise ValueError(f"不支持的操作符: {operator}")
        
        else:
            raise ValueError(f"不支持的条件类型: {condition_type}")
```

#### 4.2.6 新增 `domain/flows/graph_builder.py`

```python
from typing import Optional, Dict
from langgraph.graph import StateGraph, END
from langgraph.checkpoint.base import BaseCheckpointSaver
from langgraph.store.base import BaseStore
from domain.router.state import RouterState
from domain.flows.definition import FlowDefinition
from domain.flows.node_factory import NodeFactory
from domain.flows.route_generator import RouteGenerator

class GraphBuilder:
    """图构建器"""
    
    def __init__(self, flow_def: FlowDefinition):
        self.flow_def = flow_def
        self.workflow = StateGraph(RouterState)
        self.node_functions: Dict[str, callable] = {}
    
    def build_graph(
        self,
        checkpointer: Optional[BaseCheckpointSaver] = None,
        store: Optional[BaseStore] = None
    ):
        """构建并编译图"""
        # 1. 添加节点
        self._add_nodes()
        
        # 2. 设置入口点
        self.workflow.set_entry_point(self.flow_def.entry_point)
        
        # 3. 添加边
        self._add_edges()
        
        # 4. 编译图
        graph_config = {}
        if checkpointer:
            graph_config["checkpointer"] = checkpointer
        if store:
            graph_config["store"] = store
        
        return self.workflow.compile(**graph_config)
    
    def _add_nodes(self):
        """添加所有节点"""
        for node_def in self.flow_def.nodes:
            node_func = NodeFactory.create_node(node_def)
            self.workflow.add_node(node_def.name, node_func)
            self.node_functions[node_def.name] = node_func
    
    def _add_edges(self):
        """添加所有边"""
        # 分组：直接边和条件边
        direct_edges = []
        conditional_edges: Dict[str, List] = {}
        
        for edge in self.flow_def.edges:
            if edge.type == "direct":
                direct_edges.append(edge)
            elif edge.type == "conditional":
                if edge.from_node not in conditional_edges:
                    conditional_edges[edge.from_node] = []
                conditional_edges[edge.from_node].append(edge)
        
        # 添加直接边
        for edge in direct_edges:
            self.workflow.add_edge(edge.from_node, edge.to_node)
        
        # 添加条件边
        for from_node, edges in conditional_edges.items():
            route_func = RouteGenerator.generate_route_function(
                edges,
                [node.name for node in self.flow_def.nodes]
            )
            route_map = {edge.to_node: edge.to_node for edge in edges}
            route_map[END] = END
            self.workflow.add_conditional_edges(from_node, route_func, route_map)
```

#### 4.2.7 新增 `domain/flows/manager.py`

```python
import os
import threading
from typing import Dict, Optional
from langgraph.graph.state import CompiledStateGraph
from domain.flows.parser import FlowParser
from domain.flows.definition import FlowDefinition
from domain.flows.graph_builder import GraphBuilder
from langgraph.checkpoint.base import BaseCheckpointSaver
from langgraph.store.base import BaseStore
import logging

logger = logging.getLogger(__name__)

class FlowManager:
    """流程管理器"""
    
    _flows: Dict[str, CompiledStateGraph] = {}
    _flow_definitions: Dict[str, FlowDefinition] = {}
    _flow_mtimes: Dict[str, float] = {}
    _flow_files: Dict[str, str] = {}  # flow_name -> flow_file
    _lock = threading.Lock()
    
    @classmethod
    def load_flow(
        cls,
        flow_file: str,
        flow_name: Optional[str] = None,
        checkpointer: Optional[BaseCheckpointSaver] = None,
        store: Optional[BaseStore] = None
    ) -> CompiledStateGraph:
        """加载流程文件并构建图"""
        flow_name = flow_name or os.path.basename(flow_file).replace('.yaml', '').replace('.yml', '')
        
        # 解析流程定义
        flow_def = FlowParser.parse_flow(flow_file)
        FlowParser.validate_flow(flow_def)
        
        # 构建图
        graph = GraphBuilder(flow_def).build_graph(checkpointer, store)
        
        # 缓存
        with cls._lock:
            cls._flow_definitions[flow_name] = flow_def
            cls._flows[flow_name] = graph
            cls._flow_files[flow_name] = flow_file
            if os.path.exists(flow_file):
                cls._flow_mtimes[flow_name] = os.path.getmtime(flow_file)
        
        logger.info(f"加载流程: {flow_name} from {flow_file}")
        return graph
    
    @classmethod
    def get_flow(cls, flow_name: str) -> Optional[CompiledStateGraph]:
        """获取流程图"""
        return cls._flows.get(flow_name)
    
    @classmethod
    def reload_flow(
        cls,
        flow_name: str,
        checkpointer: Optional[BaseCheckpointSaver] = None,
        store: Optional[BaseStore] = None
    ) -> CompiledStateGraph:
        """重新加载流程（热更新）"""
        flow_file = cls._flow_files.get(flow_name)
        if not flow_file:
            raise ValueError(f"流程不存在: {flow_name}")
        
        logger.info(f"重新加载流程: {flow_name}")
        return cls.load_flow(flow_file, flow_name, checkpointer, store)
    
    @classmethod
    def list_flows(cls) -> list:
        """列出所有已加载的流程"""
        return list(cls._flows.keys())
```

### 4.3 配置文件改造

#### 4.3.1 新增流程配置文件 `config/flows/main_flow.yaml`

```yaml
flow:
  name: "main_router_flow"
  version: "1.0"
  description: "主路由流程"
  entry_point: "route"
  state_type: "RouterState"
  
  nodes:
    - name: "route"
      type: "intent_router"
      config:
        intent_tool: "identify_intent"
        clarify_on_unclear: true
    
    - name: "clarify_intent"
      type: "clarify_node"
      config:
        clarify_tool: "clarify_intent"
    
    - name: "blood_pressure_agent"
      type: "agent"
      config:
        agent_key: "blood_pressure_agent"
    
    - name: "health_event_agent"
      type: "agent"
      config:
        agent_key: "health_event_agent"
    
    - name: "medication_agent"
      type: "agent"
      config:
        agent_key: "medication_agent"
    
    - name: "symptom_agent"
      type: "agent"
      config:
        agent_key: "symptom_agent"
    
    - name: "safety_boundary_agent"
      type: "agent"
      config:
        agent_key: "safety_boundary_agent"
  
  edges:
    # 条件边：从route节点根据意图路由
    - from: "route"
      to: "blood_pressure_agent"
      type: "conditional"
      condition:
        type: "state_field"
        field: "current_intent"
        operator: "equals"
        value: "blood_pressure"
    
    - from: "route"
      to: "health_event_agent"
      type: "conditional"
      condition:
        type: "state_field"
        field: "current_intent"
        operator: "equals"
        value: "health_event"
    
    - from: "route"
      to: "medication_agent"
      type: "conditional"
      condition:
        type: "state_field"
        field: "current_intent"
        operator: "equals"
        value: "medication"
    
    - from: "route"
      to: "symptom_agent"
      type: "conditional"
      condition:
        type: "state_field"
        field: "current_intent"
        operator: "equals"
        value: "symptom"
    
    - from: "route"
      to: "safety_boundary_agent"
      type: "conditional"
      condition:
        type: "state_field"
        field: "current_intent"
        operator: "equals"
        value: "safety_boundary"
    
    - from: "route"
      to: "clarify_intent"
      type: "conditional"
      condition:
        type: "state_field"
        field: "current_intent"
        operator: "equals"
        value: "unclear"
    
    # 直接边：Agent执行后返回route节点
    - from: "blood_pressure_agent"
      to: "route"
      type: "direct"
    
    - from: "health_event_agent"
      to: "route"
      type: "direct"
    
    - from: "medication_agent"
      to: "route"
      type: "direct"
    
    - from: "symptom_agent"
      to: "route"
      type: "direct"
    
    - from: "safety_boundary_agent"
      to: "route"
      type: "direct"
    
    - from: "clarify_intent"
      to: "route"
      type: "direct"
```

---

## 五、改造影响分析

### 5.1 向后兼容性

#### ✅ 完全兼容的部分

1. **节点实现**（`domain/router/node.py`）
   - `route_node()` 和 `clarify_intent_node()` 保持不变
   - 节点逻辑完全兼容

2. **Agent工厂**（`domain/agents/factory.py`）
   - `AgentFactory` 保持不变
   - Agent创建逻辑完全兼容

3. **Agent注册表**（`domain/agents/registry.py`）
   - `AgentRegistry` 保持不变
   - Agent注册逻辑完全兼容

4. **状态定义**（`domain/router/state.py`）
   - `RouterState` 保持不变
   - 状态结构完全兼容

5. **Agent配置文件**（`config/agents.yaml`）
   - 配置文件格式保持不变
   - 配置内容完全兼容

#### ⚠️ 需要适配的部分

1. **图创建函数**（`domain/router/graph.py`）
   - `create_router_graph()` 函数签名保持不变
   - 内部实现改为使用 `FlowManager`
   - 新增可选参数 `flow_file`

2. **应用启动**（`app/main.py`）
   - 需要确保流程文件存在
   - 可以添加流程文件路径配置

### 5.2 迁移策略

#### 阶段一：并行运行（推荐）

1. **保留现有代码**
   - 保留 `create_router_graph()` 的原有实现
   - 新增 `create_router_graph_from_flow()` 函数

2. **通过配置切换**
   - 添加配置项 `USE_FLOW_FILE`（默认 False）
   - 根据配置选择使用哪种方式

3. **逐步迁移**
   - 先在测试环境验证新方案
   - 确认无误后切换到新方案

#### 阶段二：完全切换

1. **移除硬编码实现**
   - 移除 `create_router_graph()` 中的硬编码逻辑
   - 改为使用 `FlowManager`

2. **更新文档**
   - 更新开发文档
   - 更新部署文档

---

## 六、实施步骤

### 6.1 第一阶段：基础框架（1-2周）

1. **创建流程定义模块**
   - [ ] 创建 `domain/flows/` 目录
   - [ ] 实现 `FlowDefinition` 数据类
   - [ ] 实现 `FlowParser` 解析器
   - [ ] 编写单元测试

2. **创建节点工厂**
   - [ ] 实现 `NodeFactory` 类
   - [ ] 注册现有节点类型（intent_router, clarify_node, agent）
   - [ ] 编写单元测试

3. **创建路由生成器**
   - [ ] 实现 `RouteGenerator` 类
   - [ ] 支持基本条件判断（equals, not_equals）
   - [ ] 编写单元测试

### 6.2 第二阶段：图构建（1-2周）

1. **创建图构建器**
   - [ ] 实现 `GraphBuilder` 类
   - [ ] 实现节点添加逻辑
   - [ ] 实现边添加逻辑
   - [ ] 编写集成测试

2. **创建流程管理器**
   - [ ] 实现 `FlowManager` 类
   - [ ] 实现流程加载和缓存
   - [ ] 实现热更新机制
   - [ ] 编写单元测试

3. **创建流程配置文件**
   - [ ] 创建 `config/flows/` 目录
   - [ ] 编写 `main_flow.yaml` 流程文件
   - [ ] 验证流程文件格式

### 6.3 第三阶段：集成与测试（1周）

1. **改造现有代码**
   - [ ] 改造 `create_router_graph()` 函数
   - [ ] 添加流程文件路径配置
   - [ ] 保持向后兼容

2. **集成测试**
   - [ ] 端到端测试
   - [ ] 性能测试
   - [ ] 兼容性测试

3. **文档更新**
   - [ ] 更新开发文档
   - [ ] 更新部署文档
   - [ ] 编写使用指南

### 6.4 第四阶段：扩展功能（可选，1-2周）

1. **支持更多节点类型**
   - [ ] 支持自定义节点类型
   - [ ] 支持节点插件机制

2. **支持更多条件类型**
   - [ ] 支持复杂条件表达式
   - [ ] 支持Python表达式

3. **支持多流程管理**
   - [ ] 流程注册表
   - [ ] 流程选择逻辑

---

## 七、总结

### 7.1 核心优势

1. **配置驱动**
   - 流程定义完全在YAML文件中
   - 修改流程无需改代码

2. **扩展性强**
   - 支持动态添加节点类型
   - 支持复杂的路由条件

3. **向后兼容**
   - 保留现有节点实现
   - 保留现有Agent工厂

4. **易于维护**
   - 流程定义清晰
   - 易于版本控制

### 7.2 关键改造点

1. **新增流程管理模块**（`domain/flows/`）
   - FlowParser：解析YAML流程文件
   - NodeFactory：动态创建节点
   - RouteGenerator：动态生成路由函数
   - GraphBuilder：动态构建图
   - FlowManager：管理多个流程

2. **改造图创建函数**（`domain/router/graph.py`）
   - 从硬编码改为使用FlowManager
   - 保留with_user_context函数

3. **新增流程配置文件**（`config/flows/`）
   - 定义完整的流程结构
   - 定义节点和边的连接关系

### 7.3 实施建议

1. **渐进式迁移**
   - 先实现基础框架
   - 再逐步替换现有逻辑
   - 最后移除硬编码代码

2. **充分测试**
   - 单元测试覆盖核心逻辑
   - 集成测试验证端到端流程
   - 性能测试确保性能不下降

3. **文档完善**
   - 编写流程文件格式文档
   - 编写使用指南
   - 编写迁移指南

