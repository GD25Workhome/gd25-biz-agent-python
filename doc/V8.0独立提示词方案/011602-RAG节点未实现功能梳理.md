# RAG节点未实现功能梳理

## 文档说明

本文档梳理节点2（RAG检索节点）的未实现功能，帮助开发者了解当前实现状态和待完成的工作。

**文档版本**：V1.0  
**创建时间**：2025-01-16  
**对应节点**：`retrieval_node`（`config/flows/medical_agent_v5/flow.yaml`）

---

## 一、实现状态总览

### 1.1 已实现的功能

根据代码检查，以下功能已经实现：

#### ✅ 代码层面（已完成）

1. **数据库模型定义**
   - ✅ 文件：`backend/infrastructure/database/models/rag_models.py`
   - ✅ 包含4个表模型：`QAExample`、`RecordExample`、`QueryExample`、`GreetingExample`
   - ✅ 使用 `pgvector.sqlalchemy.Vector(768)` 定义向量字段

2. **Alembic迁移脚本**
   - ✅ 文件：`alembic/versions/613132195757_add_rag_vector_tables.py`
   - ✅ 包含表创建、索引创建、pgvector扩展安装

3. **数据导入功能**
   - ✅ 文件：`backend/infrastructure/rag/data_import.py`
   - ✅ 实现Excel文件解析、数据清洗、向量化、批量插入
   - ✅ 支持4个Sheet：`qa_examples`、`record_examples`、`query_examples`、`greeting_examples`

4. **向量检索功能**
   - ✅ 文件：`backend/infrastructure/rag/retrieval.py`
   - ✅ 实现单表检索、多表检索、相似度阈值过滤、降级策略
   - ✅ 支持多路召回（多表检索 + 合并排序）

5. **结果格式化功能**
   - ✅ 文件：`backend/infrastructure/rag/formatter.py`
   - ✅ 实现检索结果格式化、提示词文本生成

6. **节点函数实现**
   - ✅ 文件：`backend/domain/flows/retrieval_node.py`
   - ✅ 实现状态读取、向量检索、结果格式化、状态写入
   - ✅ 包含错误处理和降级策略

7. **节点注册机制**
   - ✅ 文件：`backend/domain/flows/builder.py`
   - ✅ 支持 `type: function` 节点类型
   - ✅ 已注册 `retrieval_node` 节点映射

8. **流程配置**
   - ✅ 文件：`config/flows/medical_agent_v5/flow.yaml`
   - ✅ 节点2配置为 `type: function`
   - ✅ 边配置正确：`intent_recognition → retrieval_node → core_agent`

### 1.2 可能未完成的工作

#### ❓ 数据库层面（需要确认）

1. **数据库表是否已创建**
   - ❓ Alembic迁移脚本已存在，但需要确认是否已执行
   - ❓ 需要执行：`alembic upgrade head`
   - ❓ 需要验证：表是否存在、索引是否创建、pgvector扩展是否安装

2. **数据是否已导入**
   - ❓ 数据导入功能已实现，但需要确认是否已执行
   - ❓ 需要准备Excel文件（按文档格式）
   - ❓ 需要执行导入脚本：`backend/rag/scripts/import_data.py`（如果存在）

#### ❓ 测试与验证（需要确认）

1. **节点触发验证**
   - ❓ 需要验证节点是否正确触发
   - ❓ 需要检查日志，确认节点执行情况
   - ❓ 需要验证数据传递是否正确

2. **端到端测试**
   - ❓ 需要测试完整流程：节点1 → 节点2 → 节点3
   - ❓ 需要验证检索结果是否有效
   - ❓ 需要验证节点3是否能正确使用检索结果

---

## 二、未实现功能详细分析

### 2.1 数据库表创建验证

#### 问题描述

虽然Alembic迁移脚本已存在，但需要确认数据库表是否已创建。

#### 检查步骤

1. **检查迁移状态**
   ```bash
   # 查看当前迁移版本
   alembic current
   
   # 查看迁移历史
   alembic history
   
   # 检查是否有未应用的迁移
   alembic check
   ```

2. **执行迁移（如果未执行）**
   ```bash
   # 执行所有未应用的迁移
   alembic upgrade head
   ```

3. **验证表结构**
   ```sql
   -- 连接数据库，检查表是否存在
   \d gd2502_qa_examples
   \d gd2502_record_examples
   \d gd2502_query_examples
   \d gd2502_greeting_examples
   
   -- 检查索引是否存在
   \di gd2502_qa_examples_embedding_idx
   \di gd2502_record_examples_embedding_idx
   \di gd2502_query_examples_embedding_idx
   \di gd2502_greeting_examples_embedding_idx
   
   -- 检查pgvector扩展是否安装
   SELECT * FROM pg_extension WHERE extname = 'vector';
   ```

#### 预期结果

- ✅ 4个表都存在
- ✅ 每个表都有对应的向量索引（HNSW）
- ✅ pgvector扩展已安装

#### 如果表不存在

执行以下命令创建表：

```bash
# 确保在项目根目录
cd /Users/m684620/work/github_GD25/gd25-biz-agent-python_cursor

# 执行迁移
alembic upgrade head
```

### 2.2 数据导入验证

#### 问题描述

虽然数据导入功能已实现，但需要确认是否有数据已导入到向量库。

#### 检查步骤

1. **检查数据是否存在**
   ```sql
   -- 连接数据库，检查每个表的数据量
   SELECT COUNT(*) FROM gd2502_qa_examples;
   SELECT COUNT(*) FROM gd2502_record_examples;
   SELECT COUNT(*) FROM gd2502_query_examples;
   SELECT COUNT(*) FROM gd2502_greeting_examples;
   ```

2. **检查向量是否已生成**
   ```sql
   -- 检查是否有向量数据（非空）
   SELECT COUNT(*) FROM gd2502_qa_examples WHERE embedding IS NOT NULL;
   ```

#### 预期结果

- ✅ 每个表至少有一些数据（建议每个表至少10-20条）
- ✅ 所有记录的embedding字段都不为空

#### 如果数据不存在

需要执行数据导入：

1. **准备Excel文件**
   - 按照文档格式创建Excel文件
   - 包含4个Sheet：`qa_examples`、`record_examples`、`query_examples`、`greeting_examples`
   - 每个Sheet包含字段：`user_input`、`agent_response`、`tags`（可选）、`quality_grade`（可选）

2. **执行导入脚本**
   ```python
   # 如果存在导入脚本
   from backend.infrastructure.rag.data_import import DataImporter
   from pathlib import Path
   
   excel_path = Path("path/to/提示词案例库.xlsx")
   importer = DataImporter()
   results = importer.import_from_excel(excel_path)
   print(results)
   ```

   或者创建命令行脚本：
   ```bash
   # 创建导入脚本：backend/rag/scripts/import_data.py
   python backend/rag/scripts/import_data.py --excel_path 提示词案例库.xlsx
   ```

### 2.3 节点触发验证

#### 问题描述

需要验证节点是否正确触发，以及数据传递是否正确。

#### 检查步骤

1. **检查日志**
   - 查看应用日志，确认节点是否执行
   - 查找日志关键字：`"开始向量库检索"`、`"检索完成"`、`"RAG检索节点执行失败"`

2. **检查状态传递**
   - 在节点1执行后，检查 `state.prompt_vars` 是否包含 `query_text` 和 `keywords`
   - 在节点2执行后，检查 `state.prompt_vars` 是否包含 `retrieved_examples`

3. **检查节点执行流程**
   - 使用调试工具或日志，确认流程执行顺序：`intent_recognition → retrieval_node → core_agent`
   - 确认节点2没有被跳过

#### 可能的问题

1. **节点1未输出数据**
   - 问题：节点1没有输出 `query_text` 或 `keywords`
   - 解决：检查节点1的提示词和输出格式

2. **节点2执行失败但被降级**
   - 问题：节点2执行时出错，但被降级处理，返回空结果
   - 解决：查看日志中的错误信息，修复问题

3. **节点2未被触发**
   - 问题：流程配置或边配置有问题，节点2未被触发
   - 解决：检查 `flow.yaml` 配置，确认边配置正确

#### 调试方法

1. **添加详细日志**
   ```python
   # 在 retrieval_node.py 中添加日志
   logger.info(f"节点2开始执行，state.prompt_vars: {state.get('prompt_vars', {})}")
   logger.info(f"query_text: {query_text}, keywords: {keywords}")
   logger.info(f"检索结果数量: {len(retrieved_examples)}")
   ```

2. **使用断点调试**
   - 在 `retrieval_node` 函数开始处设置断点
   - 确认函数是否被调用
   - 检查输入参数和返回值

3. **检查流程执行**
   ```python
   # 在流程执行时添加日志
   async for event in graph.astream(initial_state, config=config):
       for node_name, node_output in event.items():
           logger.info(f"节点执行: {node_name}, 输出: {node_output}")
   ```

### 2.4 数据传递验证

#### 问题描述

需要验证节点1的输出是否正确传递给节点2，以及节点2的输出是否正确传递给节点3。

#### 检查步骤

1. **节点1输出检查**
   ```python
   # 在节点1执行后，检查 state.prompt_vars
   prompt_vars = state.get("prompt_vars", {})
   assert "query_text" in prompt_vars, "节点1未输出 query_text"
   assert "keywords" in prompt_vars, "节点1未输出 keywords"
   ```

2. **节点2输入检查**
   ```python
   # 在 retrieval_node 函数开始处检查
   prompt_vars = state.get("prompt_vars", {})
   query_text = prompt_vars.get("query_text", "")
   keywords = prompt_vars.get("keywords", [])
   
   logger.info(f"节点2接收到的数据: query_text='{query_text}', keywords={keywords}")
   ```

3. **节点2输出检查**
   ```python
   # 在 retrieval_node 函数结束处检查
   retrieved_examples = new_state.get("prompt_vars", {}).get("retrieved_examples", [])
   logger.info(f"节点2输出的数据: retrieved_examples数量={len(retrieved_examples)}")
   ```

4. **节点3输入检查**
   ```python
   # 在节点3的提示词构建时检查
   retrieved_examples = state.get("prompt_vars", {}).get("retrieved_examples", [])
   logger.info(f"节点3接收到的数据: retrieved_examples数量={len(retrieved_examples)}")
   ```

#### 可能的问题

1. **节点1输出格式不正确**
   - 问题：节点1输出的JSON格式不正确，导致无法解析
   - 解决：检查节点1的提示词，确保输出格式正确

2. **状态传递丢失**
   - 问题：节点2执行时，`state.prompt_vars` 为空或丢失
   - 解决：检查状态复制逻辑，确保 `prompt_vars` 被正确传递

3. **节点3无法读取数据**
   - 问题：节点3的提示词构建时，无法读取 `retrieved_examples`
   - 解决：检查提示词占位符替换逻辑

---

## 三、待完成任务清单

### 3.1 数据库层面

- [ ] **验证数据库表是否已创建**
  - [ ] 执行 `alembic current` 检查迁移状态
  - [ ] 如果未执行，执行 `alembic upgrade head`
  - [ ] 验证4个表是否存在
  - [ ] 验证向量索引是否存在
  - [ ] 验证pgvector扩展是否安装

- [ ] **验证数据是否已导入**
  - [ ] 检查每个表的数据量
  - [ ] 检查向量数据是否已生成
  - [ ] 如果数据不存在，准备Excel文件并执行导入

### 3.2 功能验证

- [ ] **验证节点触发**
  - [ ] 添加详细日志，确认节点是否执行
  - [ ] 检查流程执行顺序
  - [ ] 确认节点2没有被跳过

- [ ] **验证数据传递**
  - [ ] 检查节点1输出是否正确
  - [ ] 检查节点2输入是否正确
  - [ ] 检查节点2输出是否正确
  - [ ] 检查节点3输入是否正确

- [ ] **验证检索功能**
  - [ ] 测试向量检索是否正常工作
  - [ ] 测试检索结果是否相关
  - [ ] 测试降级策略是否有效

### 3.3 测试与文档

- [ ] **编写单元测试**
  - [ ] 测试向量检索功能
  - [ ] 测试结果格式化功能
  - [ ] 测试节点函数

- [ ] **编写集成测试**
  - [ ] 测试完整流程：节点1 → 节点2 → 节点3
  - [ ] 测试数据传递
  - [ ] 测试错误处理

- [ ] **编写使用文档**
  - [ ] 数据导入使用说明
  - [ ] 节点配置说明
  - [ ] 问题排查指南

---

## 四、问题排查指南

### 4.1 节点未触发

#### 症状
- 日志中没有节点2的执行记录
- 流程直接从节点1跳到节点3

#### 可能原因
1. 流程配置错误（边配置不正确）
2. 节点注册失败
3. 条件边判断错误

#### 排查步骤
1. 检查 `flow.yaml` 配置：
   ```yaml
   edges:
     - from: intent_recognition
       to: retrieval_node
       condition: always
   ```

2. 检查节点注册：
   ```python
   # 在 builder.py 中检查
   node_function_map = {
       "retrieval_node": "backend.domain.flows.retrieval_node.retrieval_node",
   }
   ```

3. 检查流程执行日志，确认节点执行顺序

### 4.2 检索结果为空

#### 症状
- 节点2执行成功，但 `retrieved_examples` 为空列表
- 日志显示：`"检索完成：检索到 0 个示例"`

#### 可能原因
1. 数据库表为空（没有数据）
2. 相似度阈值过高
3. 查询文本向量化失败
4. 数据库连接失败

#### 排查步骤
1. 检查数据库表是否有数据：
   ```sql
   SELECT COUNT(*) FROM gd2502_qa_examples;
   ```

2. 检查相似度阈值设置：
   ```python
   # 在 retrieval_node.py 中，阈值默认是 0.7
   # 如果结果为空，可以尝试降低阈值
   similarity_threshold=0.6  # 或 0.5
   ```

3. 检查向量化是否成功：
   ```python
   # 在 retrieval.py 中添加日志
   logger.info(f"查询向量维度: {query_embedding.shape}")
   ```

4. 检查数据库连接：
   ```python
   # 在 retrieval.py 中检查连接
   conn = get_vector_db_connection()
   logger.info(f"数据库连接成功: {conn}")
   ```

### 4.3 数据传递失败

#### 症状
- 节点2无法读取节点1的输出
- 节点3无法读取节点2的输出

#### 可能原因
1. 节点1输出格式不正确
2. 状态复制时丢失数据
3. 字段名不匹配

#### 排查步骤
1. 检查节点1输出：
   ```python
   # 在节点1执行后
   prompt_vars = state.get("prompt_vars", {})
   logger.info(f"节点1输出: {prompt_vars}")
   ```

2. 检查状态复制：
   ```python
   # 在 retrieval_node.py 中
   new_state = state.copy()  # 确保使用 copy() 方法
   ```

3. 检查字段名：
   ```python
   # 确保字段名一致
   # 节点1输出：query_text, keywords
   # 节点2读取：query_text, keywords
   # 节点2输出：retrieved_examples
   # 节点3读取：retrieved_examples
   ```

### 4.4 性能问题

#### 症状
- 节点2执行时间过长（> 1秒）
- 数据库查询慢

#### 可能原因
1. 向量索引未创建
2. 数据量过大
3. 模型加载慢

#### 排查步骤
1. 检查向量索引：
   ```sql
   \di gd2502_qa_examples_embedding_idx
   ```

2. 检查数据量：
   ```sql
   SELECT COUNT(*) FROM gd2502_qa_examples;
   ```

3. 检查模型缓存：
   ```python
   # EmbeddingModelCache 使用单例模式，首次加载后应该缓存
   # 如果每次都要加载，检查缓存逻辑
   ```

---

## 五、快速验证清单

使用以下清单快速验证RAG节点功能是否正常：

### ✅ 数据库验证
- [ ] 执行 `alembic current`，确认迁移已应用
- [ ] 执行 `SELECT COUNT(*) FROM gd2502_qa_examples;`，确认有数据
- [ ] 执行 `\di gd2502_qa_examples_embedding_idx;`，确认索引存在

### ✅ 功能验证
- [ ] 发送测试请求，触发流程执行
- [ ] 查看日志，确认节点2执行
- [ ] 检查日志，确认检索到结果（数量 > 0）
- [ ] 检查节点3的提示词，确认包含检索结果

### ✅ 数据验证
- [ ] 检查节点1输出：`query_text` 和 `keywords` 存在
- [ ] 检查节点2输出：`retrieved_examples` 不为空
- [ ] 检查节点3输入：能正确读取 `retrieved_examples`

---

## 六、总结

### 6.1 实现状态

**代码层面**：✅ 已完成
- 所有核心功能代码已实现
- 节点注册机制已实现
- 流程配置已正确

**数据层面**：❓ 需要确认
- 数据库表可能未创建（需要执行迁移）
- 数据可能未导入（需要执行导入）

**测试层面**：❓ 需要验证
- 节点触发需要验证
- 数据传递需要验证
- 端到端流程需要测试

### 6.2 下一步行动

1. **立即执行**：
   - 验证数据库表是否已创建
   - 验证数据是否已导入
   - 添加详细日志，验证节点触发

2. **后续工作**：
   - 编写单元测试
   - 编写集成测试
   - 编写使用文档

3. **优化方向**：
   - 性能优化（如果发现性能问题）
   - 检索策略优化（根据实际效果调整）
   - 错误处理完善（根据实际遇到的问题）

---

**文档版本**：V1.0  
**创建时间**：2025-01-16  
**最后更新**：2025-01-16
