# 多轮血压流程执行链路与缺陷分析

## 背景与场景
- 测试用例：`cursor_test/M2_test/integration/test_multi_turn_conversation.py` 场景 2（多轮数据收集）。
- 对话输入：1）“我想记录血压” → 2）“收缩压是120” → 3）“舒张压是80，心率是70”。
- 实际现象：第二、三轮都重复第一轮的追问回复，未触发工具调用，`bp_form` 未更新。

## 执行链路拆解（以场景 2 为例）
1) **入口与路由**
   - `run_conversation` 逐轮把用户消息追加到 `state["messages"]`，入口节点固定为 `route`。
   - `route_node` 做意图识别，写入 `current_intent/current_agent/need_reroute`。
2) **第一次用户消息**
   - `route_node` 识别到 `blood_pressure`，因为当前无 agent → `need_reroute=True`。
   - `route_to_agent` 将流转到 `blood_pressure_agent`。
3) **血压智能体包装逻辑**
   - `with_user_context` 抽取槽位 `_extract_bp_form`（此时为空）。
   - 检测缺少必填字段 → 直接构造 AI 追问消息，设置 `need_reroute=True`，返回 state。
4) **回到 route**
   - 下一次进入 `route` 时，最后一条是 AI 消息 → `route_node` 早退并强制 `need_reroute=False`，`route_to_agent` 立刻 END；结束第一轮，AI 追问已经写入 `messages`。
5) **第二次用户消息**
   - 新的 HumanMessage 被 append 到同一个 `messages` 列表后再次进入 `route_node`。
   - 由于意图/agent 未变且 `need_clarification=False`，`need_reroute` 被保持为 False。
   - `route_to_agent` 因 “不需要重新路由且已有 agent” 直接 END，导致未再进入 `blood_pressure_agent`，槽位解析和工具调用都不发生。
   - 第三轮同理，用户新增的血压数值被完全忽略。

## 主要缺陷与影响
- **缺陷 1：新用户消息未触发 reroute，导致智能体不再执行**
  - 位置：`domain/router/node.py` 中 `route_node` + `route_to_agent` 组合逻辑。
  - 问题：`need_reroute` 只由意图变化/澄清控制，忽略“有新的人类输入”这一事实；当已有 agent 且不需澄清时，`route_to_agent` 直接 END，跳过智能体节点。
  - 影响：多轮收集停在第一轮的追问，后续用户补充的数据不进入槽位抽取，工具永远不被调用。
  - 修正思路：只要检测到“最新消息是 HumanMessage”，应优先标记 `need_reroute=True` 或直接绕过 `need_reroute` 判断，让路由继续到当前 agent，再由 agent 内部处理槽位/工具。

- **缺陷 2：user_id 强制转 int，非纯数字 ID 会崩溃**
  - 位置：`domain/router/graph.py` `with_user_context` 调用血压工具时 `user_id=int(user_id)`。
  - 场景：测试用例传入 `test_user_002`（非数字），一旦修复缺陷 1 进入工具调用会抛 `ValueError`，流程中断。
  - 修正思路：a）改为直接传递字符串，或 b）在上游强制要求/转换出数字 ID，并在缺失或非法时返回可读错误提示。

- **缺陷 3：血压追问逻辑与路由退出条件耦合，存在重复提示风险**
  - 位置：`with_user_context` 在缺必填字段时直接追加 AIMessage 并 `need_reroute=True`，随后 `route_node` 看到 AIMessage 会把 `need_reroute` 置 False。
  - 影响：如果后续还有轻微上下文变更但意图未变，可能卡在“只输出第一次追问”的状态；同时系统提示注入依赖 `has_context` 文本匹配，若后续清空或替换消息可能重复注入。
  - 修正思路：在 route 层显式标识“有新用户消息即重新执行 agent”；或在 agent 内部记录最近一轮已问过哪些字段，防止重复追问。

## 优先级建议
1) **先修复 reroute 判定**（缺陷 1）：确保每次新的人类输入都会进入当前 agent 节点，触发槽位更新和工具调用。
2) **同步调整 user_id 处理**（缺陷 2）：避免修复后出现新的运行时错误。
3) **优化追问与提示注入策略**（缺陷 3，可次要）：减少重复追问与提示噪音，提升多轮体验。

## 参考代码位置
```30:105:domain/router/node.py
def route_node(state: RouterState) -> RouterState:
    ...
    if isinstance(last_message, AIMessage):
        state["need_reroute"] = False
        return state
    ...
    # need_reroute 仅基于意图/agent 变化或澄清，忽略“有新用户消息”
```

```136:252:domain/router/graph.py
async def with_user_context(agent_node, agent_name: str):
    ...
    tool_args: Dict[str, Any] = {
        "user_id": int(user_id) if user_id is not None else None,  # 非数字会抛异常
        "systolic": int(bp_form["systolic"]),
        "diastolic": int(bp_form["diastolic"]),
    }
```
