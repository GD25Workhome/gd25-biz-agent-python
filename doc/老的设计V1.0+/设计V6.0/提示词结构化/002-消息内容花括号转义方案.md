# 消息内容花括号转义方案

## 问题描述

当用户消息中包含花括号（如 `{test1}`）时，LangChain 的 `ChatPromptTemplate` 会将其识别为变量占位符，导致缺少变量的错误。

### 错误示例

```
KeyError: "Input to ChatPromptTemplate is missing variables {'test1'}.  
Expected: ['current_intent', 'history', 'query', 'test1'] 
Received: ['query', 'history', 'current_intent']"
```

### 问题根源

1. **LangChain 模板机制**：`ChatPromptTemplate` 使用花括号 `{}` 作为变量占位符
2. **用户消息直接插入**：用户消息内容被直接插入到提示词模板中
3. **误识别为变量**：当用户消息包含 `{test1}` 时，LangChain 会将其识别为需要填充的变量

### 影响范围

- `domain/router/tools/router_tools.py`：
  - `identify_intent()` 函数：意图识别时处理用户消息
  - `clarify_intent()` 函数：生成澄清问题时处理用户消息
- `domain/router/node.py`：
  - `route_node()` 函数：调用意图识别工具
  - `clarify_intent_node()` 函数：调用澄清工具

## 解决方案

### 方案概述

在将用户消息内容插入到 `ChatPromptTemplate` 之前，对消息内容进行转义处理：
- 将单个花括号 `{` 转义为双花括号 `{{`
- 将单个花括号 `}` 转义为双花括号 `}}`

这样 LangChain 就不会将其识别为变量占位符，而是作为普通文本处理。

### 实现方案

#### 1. 创建转义工具函数

在 `domain/router/tools/router_tools.py` 中添加转义函数：

```python
def _escape_braces_for_template(text: str) -> str:
    """
    转义文本中的花括号，防止 LangChain 将其识别为变量占位符
    
    Args:
        text: 需要转义的文本
        
    Returns:
        转义后的文本（{ 变为 {{，} 变为 }}）
    """
    if not text:
        return text
    
    # 转义花括号：{ -> {{，} -> }}
    # 注意：需要先转义 {，再转义 }，避免重复转义
    escaped = text.replace("{", "{{").replace("}", "}}")
    return escaped
```

#### 2. 在消息提取时转义

修改 `_extract_conversation_context()` 函数，在提取消息内容后立即转义：

```python
def _extract_conversation_context(messages: list[BaseMessage]) -> tuple[str, str]:
    """
    从消息列表中提取当前用户消息和对话历史（已转义花括号）
    ...
    """
    # ... 提取消息内容 ...
    
    # 转义花括号，防止 LangChain 误识别为变量
    current_query = _escape_braces_for_template(current_query)
    history_text = _escape_braces_for_template(history_text)
    
    return current_query, history_text
```

#### 3. 在澄清函数中转义

修改 `clarify_intent()` 函数，在接收用户查询时转义：

```python
@tool
def clarify_intent(query: str) -> str:
    """
    生成意图澄清问题
    ...
    """
    # 转义用户查询中的花括号
    escaped_query = _escape_braces_for_template(query)
    
    # 使用转义后的查询
    prompt_template = _load_router_prompt(
        template_name="router_clarify_intent_prompt",
        context={"query": escaped_query}
    )
    
    # ...
    response = chain.invoke({"query": escaped_query})
    # ...
```

### 技术细节

#### 转义规则

- **输入**：`"测试一下能否通过{test1}"`
- **输出**：`"测试一下能否通过{{test1}}"`

#### 转义时机

1. **消息提取阶段**：在 `_extract_conversation_context()` 中提取消息内容后立即转义
2. **查询处理阶段**：在 `clarify_intent()` 中接收查询参数后立即转义

#### 注意事项

1. **只转义用户输入**：系统提示词模板中的占位符（如 `{{user_id}}`）不应转义
2. **转义顺序**：先转义 `{`，再转义 `}`，避免重复转义
3. **空值处理**：如果消息内容为空或 None，直接返回，不进行转义

### 测试场景

#### 场景1：用户消息包含单个花括号

**输入**：
```
用户消息: "测试一下能否通过{test1}"
```

**预期行为**：
- 转义后：`"测试一下能否通过{{test1}}"`
- LangChain 不会将其识别为变量
- 正常执行，不报错

#### 场景2：用户消息包含多个花括号

**输入**：
```
用户消息: "测试{test1}和{test2}"
```

**预期行为**：
- 转义后：`"测试{{test1}}和{{test2}}"`
- 正常执行，不报错

#### 场景3：用户消息包含嵌套花括号

**输入**：
```
用户消息: "测试{{test1}}"
```

**预期行为**：
- 转义后：`"测试{{{{test1}}}}"`
- 虽然会变成4个花括号，但不会导致错误
- 在最终输出时，LLM 会正确处理

#### 场景4：用户消息不包含花括号

**输入**：
```
用户消息: "我想记录血压"
```

**预期行为**：
- 转义后：`"我想记录血压"`（无变化）
- 正常执行，不影响功能

### 兼容性考虑

#### 与现有占位符系统的兼容

- **系统占位符**：使用 `{{placeholder}}` 格式，不受影响
- **用户消息**：转义后使用 `{{text}}` 格式，作为普通文本处理
- **两者不冲突**：系统占位符在模板填充阶段处理，用户消息转义在消息提取阶段处理

#### 向后兼容性

- **现有功能不受影响**：不包含花括号的消息处理逻辑不变
- **新增功能**：支持包含花括号的消息，不会导致错误

### 实施步骤

1. ✅ 创建转义工具函数 `_escape_braces_for_template()`
2. ✅ 修改 `_extract_conversation_context()` 函数，添加转义逻辑
3. ✅ 修改 `clarify_intent()` 函数，添加转义逻辑
4. ✅ 测试各种场景，确保功能正常

### 相关文件

- `domain/router/tools/router_tools.py`：主要修改文件
- `domain/router/node.py`：调用工具的地方（无需修改，自动受益）

### 风险评估

- **低风险**：转义操作简单，不会影响现有功能
- **测试覆盖**：需要测试包含花括号的各种场景
- **性能影响**：转义操作开销极小，可忽略不计

## 总结

通过在消息提取和处理阶段对用户消息内容进行花括号转义，可以有效防止 LangChain 将用户消息中的花括号误识别为变量占位符，从而解决 `KeyError` 异常问题。该方案简单、安全、向后兼容，不会影响现有功能。

