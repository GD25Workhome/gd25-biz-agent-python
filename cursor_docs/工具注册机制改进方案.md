# 工具注册机制改进方案

## 一、改进目标

1. **清理过时代码**：移除不再使用的 `wrapper.py` 文件
2. **实现自动注册**：采用自定义装饰器方案，实现工具的自动注册
3. **降低维护成本**：新增工具时无需手动修改注册代码

---

## 二、过时代码清理方案

### 2.1 过时代码分析

#### 2.1.1 废弃文件：`backend/domain/tools/wrapper.py`

**文件内容**：
- `TokenInjectedTool` 类：工具包装器，用于自动注入 tokenId
- `wrap_tools_with_token_context()` 函数：批量包装工具

**废弃原因**：
- 当前工具实现已改为在工具内部直接使用 `get_token_id()` 获取 token_id
- 不再需要通过包装器注入 token_id 参数
- 代码注释已明确标记为废弃（见 `__init__.py` 第14-15行）

**使用情况检查**：
- ✅ `backend/domain/tools/__init__.py` 中已注释掉相关导入
- ✅ 代码库中无其他地方使用 `TokenInjectedTool` 或 `wrap_tools_with_token_context`
- ✅ 所有工具（如 `blood_pressure.py`）已改为直接使用 `get_token_id()`

### 2.2 清理步骤

#### 步骤 1：删除废弃文件

```bash
# 删除 wrapper.py 文件
rm backend/domain/tools/wrapper.py
```

#### 步骤 2：清理 `__init__.py` 中的废弃注释

**文件**：`backend/domain/tools/__init__.py`

**需要删除的内容**：
```python
# TokenInjectedTool 已废弃：工具内部已使用 get_token_id() 获取 token_id，不再需要包装器
# from backend.domain.tools.wrapper import TokenInjectedTool, wrap_tools_with_token_context
```

**以及 `__all__` 中的注释**：
```python
# TokenInjectedTool 已废弃：工具内部已使用 get_token_id() 获取 token_id
# "TokenInjectedTool",
# "wrap_tools_with_token_context",
```

#### 步骤 3：验证清理结果

- [ ] 确认 `wrapper.py` 文件已删除
- [ ] 确认 `__init__.py` 中无废弃代码引用
- [ ] 运行测试确保系统正常工作

---

## 三、工具自动注册方案（方案二：自定义装饰器）

### 3.1 方案设计

#### 3.1.1 核心思路

创建一个自定义装饰器 `@register_tool`，在装饰工具函数时自动将其注册到工具注册表。这样：
- 工具定义时即完成注册，无需在 `init_tools()` 中手动注册
- 显式声明，代码可读性强
- 支持选择性注册（可通过参数控制）

#### 3.1.2 实现架构

```
backend/domain/tools/
├── __init__.py          # 工具系统入口，包含 init_tools()
├── registry.py          # 工具注册表（已存在，无需修改）
├── decorator.py         # 【新增】工具注册装饰器
├── context.py           # 运行时上下文（已存在）
└── blood_pressure.py    # 工具定义文件（需要修改，添加装饰器）
```

### 3.2 实现代码

#### 3.2.1 创建装饰器模块：`backend/domain/tools/decorator.py`

```python
"""
工具注册装饰器
提供 @register_tool 装饰器，自动注册工具到工具注册表
"""
import logging
from functools import wraps
from langchain_core.tools import tool
from backend.domain.tools.registry import tool_registry

logger = logging.getLogger(__name__)


def register_tool(func=None, *, auto_register=True):
    """
    工具注册装饰器
    
    用法1（推荐）：
        @register_tool
        async def my_tool(...):
            ...
    
    用法2（带参数）：
        @register_tool(auto_register=True)
        async def my_tool(...):
            ...
    
    用法3（不自动注册）：
        @register_tool(auto_register=False)
        async def my_tool(...):
            ...
    
    Args:
        func: 被装饰的函数（当作为装饰器使用时为 None）
        auto_register: 是否自动注册到工具注册表（默认 True）
    
    Returns:
        装饰后的工具函数（BaseTool 实例）
    """
    def decorator(f):
        # 先使用 @tool 装饰器，将函数转换为 BaseTool 实例
        tool_func = tool(f)
        
        # 自动注册到工具注册表
        if auto_register:
            tool_name = getattr(tool_func, 'name', None)
            
            # 检查是否已注册（防止重复注册）
            existing_tool = tool_registry.get_tool(tool_name) if tool_name else None
            if existing_tool is None:
                tool_registry.register(tool_func)
                logger.info(f"自动注册工具: {tool_name}")
            else:
                logger.debug(f"工具 {tool_name} 已注册，跳过重复注册")
        
        return tool_func
    
    # 支持两种用法：@register_tool 和 @register_tool(auto_register=True)
    if func is None:
        # 用法2：@register_tool(auto_register=True)
        return decorator
    else:
        # 用法1：@register_tool
        return decorator(func)
```

#### 3.2.2 修改 `__init__.py`：导入装饰器并简化 `init_tools()`

**文件**：`backend/domain/tools/__init__.py`

**修改内容**：

```python
"""
工具系统
"""
from backend.domain.tools.registry import ToolRegistry, tool_registry
from backend.domain.tools.context import (
    RuntimeContext,
    get_token_id,
    set_token_id,
    get_session_id,
    set_session_id,
    get_trace_id,
    set_trace_id
)
# 导入工具注册装饰器
from backend.domain.tools.decorator import register_tool


# 初始化工具注册表（自动注册所有工具）
def init_tools():
    """
    初始化工具注册表
    
    注意：工具现在通过 @register_tool 装饰器自动注册，
    此函数只需要导入工具模块即可触发注册。
    
    导入顺序：
    1. 导入所有工具模块
    2. 模块加载时，@register_tool 装饰器自动执行注册
    """
    # 导入工具模块（触发自动注册）
    # 注意：导入顺序很重要，确保所有工具模块都被导入
    from backend.domain.tools import blood_pressure  # noqa: F401
    
    # 可以在这里导入更多工具模块
    # from backend.domain.tools import appointment  # noqa: F401
    # from backend.domain.tools import medication  # noqa: F401
    
    # 获取已注册的工具数量
    registered_tools = tool_registry.get_all_tools()
    logger.info(f"工具注册表初始化完成，共注册 {len(registered_tools)} 个工具")


__all__ = [
    "ToolRegistry",
    "tool_registry",
    "RuntimeContext",
    "get_token_id",
    "set_token_id",
    "get_session_id",
    "set_session_id",
    "get_trace_id",
    "set_trace_id",
    "register_tool",  # 导出装饰器，供工具定义使用
    "init_tools",
]
```

#### 3.2.3 修改工具定义文件：添加装饰器

**文件**：`backend/domain/tools/blood_pressure.py`

**修改内容**：

```python
"""
血压记录工具
支持记录、查询、更新血压数据
"""
import logging
import json
from typing import Optional
from datetime import datetime, timedelta
from dateutil import parser as date_parser
from langchain_core.tools import tool

from backend.infrastructure.database.connection import get_session_factory
from backend.infrastructure.database.repository.blood_pressure_repository import BloodPressureRepository
from backend.domain.tools.context import get_token_id
from backend.domain.tools.decorator import register_tool  # 【新增】导入装饰器

logger = logging.getLogger(__name__)


# ... parse_datetime 函数保持不变 ...


@register_tool  # 【修改】添加自动注册装饰器
async def record_blood_pressure(
    systolic: int,
    diastolic: int,
    heart_rate: Optional[int] = None,
    notes: Optional[str] = None,
    record_time: Optional[str] = None
) -> str:
    """
    记录血压数据
    
    Args:
        systolic: 收缩压（mmHg）
        diastolic: 舒张压（mmHg）
        heart_rate: 心率（次/分钟，可选）
        notes: 备注（可选）
        record_time: 记录时间（可选，格式：YYYY-MM-DD 或 YYYY-MM-DD HH:MM 或 YYYY-MM-DD HH:MM:SS，如果不提供则使用当前时间）
        
    Returns:
        记录结果的文本描述
        
    记录时间格式说明：
    - 支持格式：YYYY-MM-DD、YYYY-MM-DD HH:MM、YYYY-MM-DD HH:MM:SS
    - 例如：2024-03-15、2024-03-15 14:30、2024-03-15 14:30:00
    - 如果不提供record_time参数，系统将使用当前时间作为记录时间
    """
    # ... 函数实现保持不变 ...


@register_tool  # 【修改】添加自动注册装饰器
async def query_blood_pressure(
    days: Optional[int] = None,
    start_date: Optional[str] = None,
    end_date: Optional[str] = None
) -> str:
    """
    查询血压记录
    
    Args:
        days: 查询天数（默认14天，最大14天）
        start_date: 开始日期（格式：YYYY-MM-DD，可选）
        end_date: 结束日期（格式：YYYY-MM-DD，可选，默认为当前日期）
        
    Returns:
        血压记录列表的文本描述（格式化输出）
        
    使用场景：
    - 用户询问"查看我的血压记录" → 查询最近14天
    - 用户询问"查看我最近7天的血压" → days=7
    - 用户询问"查看我3月1日到3月7日的血压" → start_date="2024-03-01", end_date="2024-03-07"
    """
    # ... 函数实现保持不变 ...


@register_tool  # 【修改】添加自动注册装饰器
async def update_blood_pressure(
    systolic: Optional[int] = None,
    diastolic: Optional[int] = None,
    heart_rate: Optional[int] = None,
    notes: Optional[str] = None,
    record_time: Optional[str] = None
) -> str:
    """
    更新最新的血压记录
    
    Args:
        systolic: 收缩压（mmHg，可选）
        diastolic: 舒张压（mmHg，可选）
        heart_rate: 心率（次/分钟，可选）
        notes: 备注（可选）
        record_time: 记录时间（可选，格式：YYYY-MM-DD 或 YYYY-MM-DD HH:MM 或 YYYY-MM-DD HH:MM:SS）
        
    Returns:
        更新结果的文本描述
        
    使用场景：
    - 用户说"我刚才记录的血压有误，应该是120/80" → 更新最新记录
    - 用户说"修改一下刚才的备注" → 只更新备注字段
    - 用户说"修改记录时间为今天上午10点" → 更新记录时间
    
    限制：
    - 只能更新最新的血压记录
    - 如果用户没有血压记录，返回错误提示
    """
    # ... 函数实现保持不变 ...
```

### 3.3 工作原理

#### 3.3.1 装饰器执行流程

```
1. 定义工具函数
   ↓
2. @register_tool 装饰器执行
   ↓
3. 内部调用 @tool 装饰器，将函数转换为 BaseTool 实例
   ↓
4. 检查 auto_register 参数
   ↓
5. 如果为 True，调用 tool_registry.register() 注册工具
   ↓
6. 返回装饰后的工具实例
```

#### 3.3.2 模块导入触发注册

```
1. init_tools() 被调用（在 main.py 的 lifespan 中）
   ↓
2. 导入工具模块：from backend.domain.tools import blood_pressure
   ↓
3. Python 执行模块代码，遇到 @register_tool 装饰器
   ↓
4. 装饰器自动执行，工具被注册到 tool_registry
   ↓
5. 模块导入完成，所有工具已注册
```

### 3.4 优势分析

#### 3.4.1 相比手动注册的优势

| 特性 | 手动注册 | 自动注册（装饰器） |
|------|---------|------------------|
| **新增工具** | 需要修改 `init_tools()` | 只需添加 `@register_tool` |
| **维护成本** | 高（容易遗漏） | 低（自动完成） |
| **代码可读性** | 工具定义和注册分离 | 工具定义处即声明注册 |
| **错误发现** | 运行时才发现 | 导入时即注册，更早发现 |
| **灵活性** | 固定 | 可通过参数控制是否注册 |

#### 3.4.2 相比其他自动注册方案的优势

- **显式声明**：在工具定义处明确表示需要注册，代码可读性强
- **灵活性高**：可以选择是否自动注册（`auto_register=False`）
- **向后兼容**：可以逐步迁移现有工具
- **实现简单**：代码量少，易于理解和维护

---

## 四、迁移计划

### 4.1 迁移步骤

#### 阶段一：准备工作（不修改代码）

1. **创建备份**
   ```bash
   git checkout -b feature/tool-auto-register
   git add -A
   git commit -m "备份：准备工具自动注册改造"
   ```

2. **创建测试用例**
   - 验证工具注册功能
   - 验证工具调用功能
   - 验证向后兼容性

#### 阶段二：清理过时代码

1. **删除 `wrapper.py` 文件**
   ```bash
   rm backend/domain/tools/wrapper.py
   ```

2. **清理 `__init__.py` 中的废弃注释**
   - 删除废弃的导入注释
   - 删除 `__all__` 中的废弃项注释

3. **验证清理结果**
   - 运行测试确保系统正常
   - 检查日志无错误

#### 阶段三：实现自动注册机制

1. **创建装饰器模块**
   - 创建 `backend/domain/tools/decorator.py`
   - 实现 `register_tool` 装饰器

2. **修改 `__init__.py`**
   - 导入 `register_tool` 装饰器
   - 简化 `init_tools()` 函数
   - 更新 `__all__` 导出列表

3. **修改工具定义文件**
   - 在 `blood_pressure.py` 中导入装饰器
   - 为三个工具函数添加 `@register_tool` 装饰器

4. **验证功能**
   - 运行应用，检查工具是否自动注册
   - 验证工具调用是否正常
   - 检查日志确认注册成功

#### 阶段四：测试与验证

1. **功能测试**
   - [ ] 工具自动注册功能正常
   - [ ] 工具调用功能正常
   - [ ] 日志输出正确

2. **回归测试**
   - [ ] 血压记录功能正常
   - [ ] 血压查询功能正常
   - [ ] 血压更新功能正常
   - [ ] Agent 创建和使用正常

3. **性能测试**
   - [ ] 启动时间无明显增加
   - [ ] 工具注册无性能问题

#### 阶段五：文档更新

1. **更新代码注释**
   - 更新 `init_tools()` 的文档字符串
   - 添加装饰器使用说明

2. **更新开发文档**
   - 更新工具开发指南
   - 添加装饰器使用示例

### 4.2 回滚方案

如果迁移过程中出现问题，可以快速回滚：

```bash
# 回滚到迁移前的状态
git checkout main
git branch -D feature/tool-auto-register
```

或者保留分支，逐步修复问题。

### 4.3 风险控制

#### 4.3.1 潜在风险

1. **装饰器执行顺序问题**
   - 风险：模块导入时装饰器可能早于 `tool_registry` 初始化
   - 控制：确保 `tool_registry` 在模块级别已初始化（单例模式）

2. **重复注册问题**
   - 风险：模块被多次导入可能导致重复注册
   - 控制：装饰器中已实现重复注册检查

3. **向后兼容性问题**
   - 风险：现有工具可能依赖手动注册逻辑
   - 控制：保持 `init_tools()` 函数接口不变，内部实现改为自动注册

#### 4.3.2 测试策略

1. **单元测试**：测试装饰器功能
2. **集成测试**：测试工具注册和调用流程
3. **回归测试**：确保现有功能不受影响

---

## 五、代码变更清单

### 5.1 新增文件

- ✅ `backend/domain/tools/decorator.py` - 工具注册装饰器

### 5.2 修改文件

- ✅ `backend/domain/tools/__init__.py` - 简化 `init_tools()`，导入装饰器
- ✅ `backend/domain/tools/blood_pressure.py` - 添加 `@register_tool` 装饰器

### 5.3 删除文件

- ✅ `backend/domain/tools/wrapper.py` - 废弃的工具包装器

### 5.4 文件变更详情

#### 文件 1：`backend/domain/tools/decorator.py`（新增）

```python
# 完整代码见 3.2.1 节
```

#### 文件 2：`backend/domain/tools/__init__.py`（修改）

**变更前**：
```python
from backend.domain.tools.blood_pressure import (
    record_blood_pressure,
    query_blood_pressure,
    update_blood_pressure
)

def init_tools():
    tool_registry.register(record_blood_pressure)
    tool_registry.register(query_blood_pressure)
    tool_registry.register(update_blood_pressure)
```

**变更后**：
```python
from backend.domain.tools.decorator import register_tool

def init_tools():
    from backend.domain.tools import blood_pressure  # noqa: F401
    registered_tools = tool_registry.get_all_tools()
    logger.info(f"工具注册表初始化完成，共注册 {len(registered_tools)} 个工具")
```

#### 文件 3：`backend/domain/tools/blood_pressure.py`（修改）

**变更前**：
```python
@tool
async def record_blood_pressure(...):
    ...
```

**变更后**：
```python
from backend.domain.tools.decorator import register_tool

@register_tool
async def record_blood_pressure(...):
    ...
```

---

## 六、验证检查清单

### 6.1 代码检查

- [ ] `wrapper.py` 文件已删除
- [ ] `__init__.py` 中无废弃代码引用
- [ ] `decorator.py` 文件已创建
- [ ] 所有工具函数已添加 `@register_tool` 装饰器
- [ ] `init_tools()` 函数已简化

### 6.2 功能检查

- [ ] 应用启动时工具自动注册成功
- [ ] 日志显示工具注册信息
- [ ] 工具调用功能正常
- [ ] 无重复注册警告

### 6.3 测试检查

- [ ] 单元测试通过
- [ ] 集成测试通过
- [ ] 回归测试通过
- [ ] 性能测试通过

---

## 七、后续优化建议

### 7.1 工具命名规范

建议制定工具命名规范，便于管理和识别：

- 工具函数名：使用 `动词_名词` 格式，如 `record_blood_pressure`
- 工具文件：按业务领域组织，如 `blood_pressure.py`、`appointment.py`

### 7.2 工具分类管理

可以考虑按业务领域分类管理工具：

```python
# 未来可以考虑按领域分类
from backend.domain.tools.medical import blood_pressure, appointment
from backend.domain.tools.system import health_check, log_query
```

### 7.3 工具文档生成

可以基于装饰器自动生成工具文档：

```python
@register_tool
@tool_doc(category="医疗", description="记录血压数据")
async def record_blood_pressure(...):
    ...
```

---

## 八、总结

### 8.1 改进成果

1. **清理过时代码**：移除了不再使用的 `wrapper.py` 文件
2. **实现自动注册**：通过装饰器实现工具的自动注册
3. **降低维护成本**：新增工具时无需修改注册代码
4. **提高代码质量**：代码更简洁，可读性更强

### 8.2 关键改进点

- ✅ **自动化**：工具定义时即完成注册
- ✅ **显式声明**：在工具定义处明确表示需要注册
- ✅ **向后兼容**：保持 `init_tools()` 接口不变
- ✅ **易于维护**：新增工具只需添加装饰器

### 8.3 预期效果

- **开发效率提升**：新增工具时无需修改注册代码
- **错误率降低**：不会因为忘记注册而导致运行时错误
- **代码质量提升**：代码更简洁，维护成本更低

---

## 附录：完整代码示例

### A.1 装饰器完整代码

见 3.2.1 节。

### A.2 修改后的 `__init__.py` 完整代码

见 3.2.2 节。

### A.3 修改后的工具定义示例

见 3.2.3 节。

---

**文档版本**：v1.0  
**创建日期**：2026-01-14  
**最后更新**：2026-01-14

