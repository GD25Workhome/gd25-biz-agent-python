# 问答式Agent方案讨论

## 一、安全边界规则文档分析

### 1.1 文档内容结构

**文件**：`config/prompts/local/素材/211-安全边界规则（兜底Agent）.md`

**文档规模**：1435行

**核心组成部分**：

1. **核心原则**（7大原则，约25行）：
   - 个人信息保护
   - 内容准确性&专业性&安全性
   - 科室领域限制
   - 非诊断原则
   - 非治疗原则
   - 涉药原则
   - 紧急情况指引

2. **边界场景定义及回复话术**（8大类场景，约1410行）：
   - **诊疗相关**（约13行）
   - **药物相关**（约20行）
   - **危重症等紧急情况**（约630行，16种具体症状）
     - 慢病及其并发症相关的危急症状（13种）
     - 非慢病的危急症状（11种）
   - **院内资源/政策咨询**（约14行）
   - **通用打招呼**（约36行）
   - **其他科室问题咨询**（约5行）
   - **非医学类问题**（约12行）
   - **涉及儿童内容回答边界**（约17行）

### 1.2 文档特点分析

**适合作为问答式Agent的特点**：
- ✅ **场景明确**：每个场景都有明确的特征描述和回复话术
- ✅ **规则清晰**：核心原则和边界定义清晰，便于LLM理解和执行
- ✅ **话术丰富**：提供了大量固定话术模板，确保回复的合规性
- ✅ **覆盖全面**：覆盖了医疗AI助手可能遇到的各种边界场景

**潜在挑战**：
- ⚠️ **文档体量大**：1435行，转换为提示词后可能过大
- ⚠️ **场景复杂**：16种危急症状，每种都有多个子场景
- ⚠️ **固定话术多**：大量固定话术模板，需要LLM准确匹配

---

## 二、作为问答式Agent的可行性分析

### 2.1 ✅ **可行性：高度可行**

**理由**：

1. **职责匹配**：
   - 安全边界规则的核心职责是"根据用户问题匹配场景，返回符合安全边界的回复"
   - 这正是问答式Agent的典型职责：理解问题 → 匹配规则 → 生成回复

2. **场景明确**：
   - 文档中每个场景都有明确的特征描述（"特征情况"）
   - LLM可以根据用户问题匹配到对应的场景
   - 每个场景都有明确的回复话术（"推荐文案"）

3. **无需复杂工具**：
   - 大部分场景只需要返回固定话术，不需要调用工具
   - 只有少数场景可能需要查询药品说明书（可以通过工具实现）

4. **符合当前架构**：
   - 可以像其他Agent一样，通过`AgentFactory`创建
   - 可以添加到路由图中，作为独立的节点
   - 可以使用现有的提示词加载机制

### 2.2 所有章节是否都可以放在这里？

#### ✅ **可以，但需要优化**

**可以放在这里的章节**：

1. ✅ **核心原则**（7大原则）
   - 必须放在提示词开头，作为Agent的基本原则
   - 这些原则适用于所有场景

2. ✅ **边界场景定义及回复话术**（8大类场景）
   - **诊疗相关**：✅ 可以
   - **药物相关**：✅ 可以（可能需要工具支持药品说明书查询）
   - **危重症等紧急情况**：✅ 可以（但场景较多，需要优化结构）
   - **院内资源/政策咨询**：✅ 可以
   - **通用打招呼**：✅ 可以
   - **其他科室问题咨询**：✅ 可以
   - **非医学类问题**：✅ 可以
   - **涉及儿童内容回答边界**：✅ 可以

**需要优化的地方**：

1. **提示词结构优化**：
   - 当前文档是Markdown格式，需要转换为更适合LLM理解的提示词格式
   - 需要明确场景匹配的优先级和逻辑
   - 需要简化重复的话术模板

2. **场景匹配逻辑**：
   - 16种危急症状场景较多，需要设计清晰的匹配逻辑
   - 建议使用"特征关键词匹配 + LLM理解"的混合方式

3. **固定话术处理**：
   - 大量固定话术可以提取为模板库
   - LLM只需要匹配场景，然后填充模板中的变量（如症状名称）

---

## 三、路由提示词调整

### 3.1 当前路由逻辑

**当前意图类型**（`domain/router/tools/router_tools.py`）：
- `blood_pressure`：血压相关
- `health_event`：健康事件相关
- `medication`：用药相关
- `symptom`：症状相关
- `unclear`：意图不明确

### 3.2 需要新增的意图类型

**新增意图类型**：`safety_boundary` 或 `qa`（问答式）

**路由决策逻辑调整**：

1. **方案A：作为兜底Agent**（推荐）
   - 当其他Agent无法处理时，路由到安全边界Agent
   - 路由优先级：`blood_pressure` > `health_event` > `medication` > `symptom` > `safety_boundary`
   - 优点：确保所有问题都有回复，符合"兜底"定位
   - 缺点：可能影响正常业务流程

2. **方案B：作为独立意图类型**
   - 在意图识别时，直接识别为`safety_boundary`
   - 路由优先级：与其他Agent平级
   - 优点：职责清晰，不影响其他Agent
   - 缺点：需要意图识别工具能够识别安全边界场景

3. **方案C：混合方案**（最推荐）
   - 意图识别时，如果检测到安全边界场景，直接识别为`safety_boundary`
   - 如果其他Agent执行后，检测到回复不符合安全边界，路由到安全边界Agent进行修正
   - 优点：既保证了安全边界检查，又保证了正常业务流程

### 3.3 路由提示词调整建议

**需要修改的文件**：`config/prompts/local/router_intent_identification_prompt.txt`

**调整内容**：

1. **新增意图类型说明**：
   ```
   支持的意图类型：
   - blood_pressure: 血压相关（记录、查询、更新血压）
   - health_event: 健康事件相关（记录、查询、更新健康事件）
   - medication: 用药相关（记录、查询、更新用药）
   - symptom: 症状相关（记录、查询、更新症状）
   - safety_boundary: 安全边界相关（诊疗咨询、药物咨询、紧急情况、通用问答等）
   - unclear: 意图不明确
   ```

2. **新增安全边界场景识别规则**：
   ```
   如果用户问题涉及以下场景，应识别为safety_boundary意图：
   - 疾病诊断咨询（如"我这是什么病？"）
   - 治疗方案咨询（如"我应该吃什么药？"）
   - 药物推荐、剂量调整、换药建议
   - 紧急症状描述（胸痛、剧烈头痛、呼吸困难等）
   - 院内资源/政策咨询
   - 通用打招呼、服务定位咨询
   - 非医学类问题
   - 涉及儿童内容咨询
   ```

3. **意图识别优先级**：
   ```
   意图识别优先级：
   1. 如果用户明确提到记录/查询/更新数据（血压、健康事件、用药、症状），优先识别为对应意图
   2. 如果用户问题涉及安全边界场景，识别为safety_boundary
   3. 如果无法确定，识别为unclear
   ```

---

## 四、代码调整（简单概括）

### 4.1 配置文件调整

**文件**：`config/agents.yaml`

**新增Agent配置**：
```yaml
agents:
  # 安全边界问答Agent（新增）
  safety_boundary_agent:
    name: "安全边界问答Agent"
    description: "负责处理安全边界相关的问答，包括诊疗咨询、药物咨询、紧急情况处理等"
    llm:
      temperature: 0.3  # 较低温度，确保回复的准确性和一致性
    tools:
      # 可选：如果需要查询药品说明书
      # - query_medication_info
    langfuse_template: "safety_boundary_agent_prompt"
    routing:
      node_name: "safety_boundary_agent"
      intent_type: "safety_boundary"
```

### 4.2 路由图调整

**文件**：`domain/router/graph.py`

**调整内容**：
1. 在`create_router_graph()`中，添加`safety_boundary_agent`节点（与其他Agent节点一样）
2. 在`route_to_agent()`中，添加`safety_boundary`意图的路由逻辑

### 4.3 路由工具调整

**文件**：`domain/router/tools/router_tools.py`

**调整内容**：
1. 在`_parse_intent_result()`中，添加`safety_boundary`到有效意图列表
2. 在意图识别提示词中，添加安全边界场景的识别规则

### 4.4 提示词模板创建

**文件**：`config/prompts/local/safety_boundary_agent_prompt.txt`（新建）

**内容来源**：基于`211-安全边界规则（兜底Agent）.md`转换

**转换要点**：
1. 保留核心原则（7大原则）
2. 保留所有场景定义和回复话术
3. 优化结构，使其更适合LLM理解
4. 明确场景匹配的优先级和逻辑

### 4.5 可选：工具支持

**如果需要查询药品说明书**：
- 创建工具：`domain/tools/safety_boundary/query_medication_info.py`
- 在Agent配置中添加该工具

---

## 五、其他方案对比

### 5.1 方案对比

| 方案 | 优点 | 缺点 | 推荐度 |
|------|------|------|--------|
| **方案A：独立问答式Agent** | ✅ 职责清晰<br>✅ 易于维护<br>✅ 符合当前架构 | ⚠️ 需要新增意图类型<br>⚠️ 路由逻辑需要调整 | ⭐⭐⭐⭐⭐ |
| **方案B：作为兜底检查节点** | ✅ 覆盖所有回复<br>✅ 不影响正常流程 | ❌ 增加一次LLM调用<br>❌ 职责不够清晰 | ⭐⭐⭐ |
| **方案C：嵌入到所有Agent** | ✅ 不需要路由调整 | ❌ 提示词过于庞大<br>❌ 维护困难 | ⭐⭐ |
| **方案D：混合方案** | ✅ 既保证安全边界，又保证正常流程 | ⚠️ 实现复杂度较高 | ⭐⭐⭐⭐ |

### 5.2 推荐方案：独立问答式Agent + 兜底检查（混合）

**架构设计**：

```
route节点（入口）
  ├─→ clarify_intent节点（意图不明确时）
  │     └─→ 返回route节点
  │
  └─→ Agent节点（意图明确时）
        ├─→ blood_pressure_agent
        ├─→ health_event_agent
        ├─→ medication_agent
        ├─→ symptom_agent
        ├─→ safety_boundary_agent（新增）
        └─→ safety_boundary_check节点（新增，可选）
              └─→ 返回route节点或END
```

**执行流程**：

1. **意图识别阶段**：
   - 如果识别为安全边界场景，直接路由到`safety_boundary_agent`
   - 如果识别为业务意图，路由到对应的业务Agent

2. **业务Agent执行后**（可选）：
   - 如果检测到回复可能不符合安全边界，路由到`safety_boundary_check`节点
   - `safety_boundary_check`节点检查并修正回复

**优点**：
- ✅ 职责清晰：安全边界Agent专门处理安全边界场景
- ✅ 覆盖全面：通过兜底检查确保所有回复都符合安全边界
- ✅ 性能可控：大部分场景直接由安全边界Agent处理，不需要额外检查
- ✅ 易于维护：安全边界规则独立管理

---

## 六、实施建议

### 6.1 阶段一：创建独立问答式Agent（推荐先实施）

**步骤**：

1. **创建提示词模板**：
   - 将`211-安全边界规则（兜底Agent）.md`转换为`config/prompts/local/safety_boundary_agent_prompt.txt`
   - 优化结构，使其更适合LLM理解

2. **添加Agent配置**：
   - 在`config/agents.yaml`中添加`safety_boundary_agent`配置

3. **调整路由逻辑**：
   - 在`domain/router/tools/router_tools.py`中添加`safety_boundary`意图类型
   - 在`domain/router/graph.py`中添加`safety_boundary_agent`节点

4. **测试验证**：
   - 测试各种安全边界场景是否能够正确路由和处理

### 6.2 阶段二：添加兜底检查节点（可选）

**步骤**：

1. **创建安全检查节点**：
   - 在`domain/router/node.py`中添加`safety_boundary_check_node()`函数

2. **修改路由图**：
   - 在所有业务Agent节点后添加安全检查节点

3. **测试验证**：
   - 测试业务Agent的回复是否能够被正确检查和修正

### 6.3 阶段三：优化性能（可选）

**步骤**：

1. **实现规则引擎**：
   - 使用规则引擎进行初步筛选，只对可疑回复进行LLM检查

2. **实现缓存机制**：
   - 缓存常见的安全边界检查结果

3. **使用更小的模型**：
   - 对于安全检查，可以使用更小的模型以降低成本

---

## 七、总结

### 7.1 核心结论

**将安全边界规则作为问答式Agent是可行的**，主要原因：

1. ✅ **职责匹配**：安全边界规则的核心职责是"根据用户问题匹配场景，返回符合安全边界的回复"，这正是问答式Agent的典型职责

2. ✅ **场景明确**：文档中每个场景都有明确的特征描述和回复话术，LLM可以准确匹配

3. ✅ **符合架构**：可以像其他Agent一样，通过现有的AgentFactory创建和管理

4. ✅ **所有章节都可以放在这里**：但需要优化结构，使其更适合LLM理解

### 7.2 需要调整的内容

1. **路由提示词**：
   - 新增`safety_boundary`意图类型
   - 添加安全边界场景的识别规则
   - 明确意图识别优先级

2. **代码调整**：
   - 在`config/agents.yaml`中添加`safety_boundary_agent`配置
   - 在`domain/router/graph.py`中添加节点
   - 在`domain/router/tools/router_tools.py`中添加意图类型支持
   - 创建提示词模板文件

### 7.3 推荐方案

**独立问答式Agent + 兜底检查（混合方案）**：

- 意图识别时，如果检测到安全边界场景，直接路由到安全边界Agent
- 业务Agent执行后，通过安全检查节点确保回复符合安全边界
- 既保证了安全边界检查，又保证了正常业务流程

### 7.4 下一步行动

1. **确认方案**：与团队确认是否采用独立问答式Agent方案
2. **创建提示词模板**：将`211-安全边界规则（兜底Agent）.md`转换为提示词模板
3. **添加Agent配置**：在`config/agents.yaml`中添加配置
4. **调整路由逻辑**：修改路由提示词和代码
5. **测试验证**：测试各种场景是否能够正确路由和处理

---

**文档生成时间**：2025-01-XX  
**基于代码版本**：当前代码库状态  
**分析依据**：
- `config/prompts/local/素材/211-安全边界规则（兜底Agent）.md` - 安全边界规则文档
- `config/agents.yaml` - Agent配置文件
- `domain/router/graph.py` - 路由图结构
- `domain/router/tools/router_tools.py` - 路由工具实现
- `domain/agents/factory.py` - Agent工厂实现

