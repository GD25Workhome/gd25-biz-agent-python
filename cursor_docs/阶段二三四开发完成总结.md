# é˜¶æ®µäºŒã€ä¸‰ã€å››å¼€å‘å®Œæˆæ€»ç»“

## âœ… å·²å®Œæˆçš„å·¥ä½œ

### é˜¶æ®µäºŒï¼šå·¥å…·å±‚å¼€å‘

#### 1. å·¥å…·ç›®å½•ç»“æ„åˆ›å»º âœ…

å·²åˆ›å»ºä¸‰ä¸ªå·¥å…·ç›®å½•ï¼Œæ¯ä¸ªç›®å½•åŒ…å«ï¼š
- `__init__.py`
- `record.py` - è®°å½•å·¥å…·
- `query.py` - æŸ¥è¯¢å·¥å…·
- `update.py` - æ›´æ–°å·¥å…·

**ç›®å½•ç»“æ„**ï¼š
```
domain/tools/
â”œâ”€â”€ health_event/
â”‚   â”œâ”€â”€ __init__.py âœ…
â”‚   â”œâ”€â”€ record.py âœ…
â”‚   â”œâ”€â”€ query.py âœ…
â”‚   â””â”€â”€ update.py âœ…
â”œâ”€â”€ medication/
â”‚   â”œâ”€â”€ __init__.py âœ…
â”‚   â”œâ”€â”€ record.py âœ…
â”‚   â”œâ”€â”€ query.py âœ…
â”‚   â””â”€â”€ update.py âœ…
â””â”€â”€ symptom/
    â”œâ”€â”€ __init__.py âœ…
    â”œâ”€â”€ record.py âœ…
    â”œâ”€â”€ query.py âœ…
    â””â”€â”€ update.py âœ…
```

#### 2. å·¥å…·å‡½æ•°å®ç° âœ…

**å¥åº·äº‹ä»¶å·¥å…·**ï¼š
- âœ… `record_health_event` - è®°å½•å¥åº·äº‹ä»¶ï¼ˆäº‹ä»¶ç±»å‹ã€äº‹ä»¶åç§°ã€æ—¥æœŸã€åœ°ç‚¹ç­‰ï¼‰
- âœ… `query_health_event` - æŸ¥è¯¢å¥åº·äº‹ä»¶è®°å½•
- âœ… `update_health_event` - æ›´æ–°å¥åº·äº‹ä»¶è®°å½•

**ç”¨è¯è®°å½•å·¥å…·**ï¼š
- âœ… `record_medication` - è®°å½•ç”¨è¯ï¼ˆè¯ç‰©åç§°ã€å‰‚é‡ã€é¢‘ç‡ã€æ—¥æœŸç­‰ï¼‰
- âœ… `query_medication` - æŸ¥è¯¢ç”¨è¯è®°å½•
- âœ… `update_medication` - æ›´æ–°ç”¨è¯è®°å½•

**ç—‡çŠ¶è®°å½•å·¥å…·**ï¼š
- âœ… `record_symptom` - è®°å½•ç—‡çŠ¶ï¼ˆç—‡çŠ¶åç§°ã€ä¸¥é‡ç¨‹åº¦ã€æ—¶é—´ã€éƒ¨ä½ç­‰ï¼‰
- âœ… `query_symptom` - æŸ¥è¯¢ç—‡çŠ¶è®°å½•
- âœ… `update_symptom` - æ›´æ–°ç—‡çŠ¶è®°å½•

#### 3. å·¥å…·æ³¨å†Œ âœ…

åœ¨ `domain/tools/registry.py` ä¸­å·²æ³¨å†Œæ‰€æœ‰æ–°å·¥å…·ï¼š
- âœ… `record_health_event`, `query_health_event`, `update_health_event`
- âœ… `record_medication`, `query_medication`, `update_medication`
- âœ… `record_symptom`, `query_symptom`, `update_symptom`

### é˜¶æ®µä¸‰ï¼šAgenté…ç½®ä¸æç¤ºè¯

#### 1. æç¤ºè¯æ¨¡å—ç›®å½•åˆ›å»º âœ…

å·²ä¸ºä¸‰ä¸ªAgentåˆ›å»ºå®Œæ•´çš„æç¤ºè¯æ¨¡å—ï¼š

**å¥åº·äº‹ä»¶Agent** (`config/prompts/modules/health_event/`)ï¼š
- âœ… `role.txt` - Agentè§’è‰²å®šä¹‰
- âœ… `function_description.txt` - åŠŸèƒ½è¯´æ˜
- âœ… `clarification.txt` - æ¾„æ¸…æœºåˆ¶
- âœ… `data_validation.txt` - æ•°æ®éªŒè¯è§„åˆ™
- âœ… `response_format.txt` - å›å¤æ ¼å¼è¦æ±‚
- âœ… `few_shot_examples.txt` - ç¤ºä¾‹å¯¹è¯
- âœ… `notes.txt` - æ³¨æ„äº‹é¡¹

**ç”¨è¯è®°å½•Agent** (`config/prompts/modules/medication/`)ï¼š
- âœ… æ‰€æœ‰æç¤ºè¯æ–‡ä»¶å·²åˆ›å»ºï¼ˆåŒä¸Šï¼‰

**ç—‡çŠ¶è®°å½•Agent** (`config/prompts/modules/symptom/`)ï¼š
- âœ… æ‰€æœ‰æç¤ºè¯æ–‡ä»¶å·²åˆ›å»ºï¼ˆåŒä¸Šï¼‰

#### 2. Agenté…ç½® âœ…

åœ¨ `config/agents.yaml` ä¸­æ·»åŠ äº†ä¸‰ä¸ªAgenté…ç½®ï¼š

- âœ… `health_event_agent` - å¥åº·äº‹ä»¶è®°å½•æ™ºèƒ½ä½“
  - å·¥å…·ï¼šrecord_health_event, query_health_event, update_health_event
  - æç¤ºè¯è·¯å¾„ï¼šconfig/prompts/modules/health_event/role.txt

- âœ… `medication_agent` - ç”¨è¯è®°å½•æ™ºèƒ½ä½“
  - å·¥å…·ï¼šrecord_medication, query_medication, update_medication
  - æç¤ºè¯è·¯å¾„ï¼šconfig/prompts/modules/medication/role.txt

- âœ… `symptom_agent` - ç—‡çŠ¶è®°å½•æ™ºèƒ½ä½“
  - å·¥å…·ï¼šrecord_symptom, query_symptom, update_symptom
  - æç¤ºè¯è·¯å¾„ï¼šconfig/prompts/modules/symptom/role.txt

### é˜¶æ®µå››ï¼šè·¯ç”±å±‚é›†æˆ

#### 1. æ„å›¾è¯†åˆ«æ›´æ–° âœ…

åœ¨ `domain/router/tools/router_tools.py` ä¸­ï¼š

- âœ… æ›´æ–° `INTENT_IDENTIFICATION_PROMPT_FALLBACK`
  - æ·»åŠ äº†ä¸‰ä¸ªæ–°æ„å›¾ç±»å‹ï¼šhealth_event, medication, symptom
  - æ›´æ–°äº†æ„å›¾ä¼˜å…ˆçº§è§„åˆ™
  - æ›´æ–°äº†ç¤ºä¾‹å’Œå…³é”®è¯

- âœ… æ›´æ–° `_parse_intent_result()` å‡½æ•°
  - æ·»åŠ æ–°æ„å›¾åˆ°æœ‰æ•ˆæ„å›¾åˆ—è¡¨ï¼š`["blood_pressure", "appointment", "health_event", "medication", "symptom", "unclear"]`

- âœ… æ›´æ–° `identify_intent()` å·¥å…·æè¿°
  - æ·»åŠ äº†æ–°æ„å›¾ç±»å‹çš„è¯´æ˜

#### 2. è·¯ç”±èŠ‚ç‚¹æ›´æ–° âœ…

åœ¨ `domain/router/node.py` ä¸­ï¼š

- âœ… æ›´æ–° `route_node()` å‡½æ•°
  - æ·»åŠ äº†æ–°æ„å›¾åˆ°Agentçš„æ˜ å°„ï¼š
    - `health_event` â†’ `health_event_agent`
    - `medication` â†’ `medication_agent`
    - `symptom` â†’ `symptom_agent`

#### 3. è·¯ç”±å›¾æ›´æ–° âœ…

åœ¨ `domain/router/graph.py` ä¸­ï¼š

- âœ… åˆ›å»ºæ–°AgentèŠ‚ç‚¹
  - `health_event_agent` èŠ‚ç‚¹
  - `medication_agent` èŠ‚ç‚¹
  - `symptom_agent` èŠ‚ç‚¹

- âœ… æ›´æ–° `route_to_agent()` å‡½æ•°
  - æ·»åŠ äº†æ–°Agentçš„è·¯ç”±é€»è¾‘

- âœ… æ›´æ–°æ¡ä»¶è¾¹é…ç½®
  - æ·»åŠ äº†æ–°AgentèŠ‚ç‚¹åˆ°è·¯ç”±æ˜ å°„

#### 4. æ¾„æ¸…æç¤ºè¯æ›´æ–° âœ…

åœ¨ `domain/router/tools/router_tools.py` ä¸­ï¼š

- âœ… æ›´æ–° `CLARIFY_INTENT_PROMPT_FALLBACK`
  - æ·»åŠ äº†ä¸‰ä¸ªæ–°åŠŸèƒ½çš„è¯´æ˜
  - æ›´æ–°äº†æ¾„æ¸…é—®é¢˜çš„è¦æ±‚

- âœ… æ›´æ–°æ¾„æ¸…é—®é¢˜éªŒè¯é€»è¾‘
  - æ·»åŠ äº†æ–°åŠŸèƒ½å…³é”®è¯çš„æ£€æŸ¥

- âœ… æ›´æ–°é»˜è®¤æ¾„æ¸…é—®é¢˜
  - åŒ…å«æ‰€æœ‰äº”ä¸ªåŠŸèƒ½

## ğŸ“‹ ä»£ç è´¨é‡æ£€æŸ¥

- âœ… æ‰€æœ‰ä»£ç é€šè¿‡ linter æ£€æŸ¥ï¼Œæ— é”™è¯¯
- âœ… ä»£ç é£æ ¼ä¸ç°æœ‰ä»£ç ä¿æŒä¸€è‡´
- âœ… æ‰€æœ‰å·¥å…·å‡½æ•°éƒ½åŒ…å«å®Œæ•´çš„ç±»å‹æç¤ºå’Œæ–‡æ¡£å­—ç¬¦ä¸²
- âœ… æ‰€æœ‰æç¤ºè¯æ–‡ä»¶å†…å®¹å®Œæ•´ä¸”ç¬¦åˆè§„èŒƒ

## ğŸ“ æ–‡ä»¶æ¸…å•

### æ–°å¢æ–‡ä»¶ï¼ˆå·¥å…·å±‚ï¼‰

1. `domain/tools/health_event/__init__.py`
2. `domain/tools/health_event/record.py`
3. `domain/tools/health_event/query.py`
4. `domain/tools/health_event/update.py`
5. `domain/tools/medication/__init__.py`
6. `domain/tools/medication/record.py`
7. `domain/tools/medication/query.py`
8. `domain/tools/medication/update.py`
9. `domain/tools/symptom/__init__.py`
10. `domain/tools/symptom/record.py`
11. `domain/tools/symptom/query.py`
12. `domain/tools/symptom/update.py`

### æ–°å¢æ–‡ä»¶ï¼ˆæç¤ºè¯ï¼‰

1. `config/prompts/modules/health_event/role.txt`
2. `config/prompts/modules/health_event/function_description.txt`
3. `config/prompts/modules/health_event/clarification.txt`
4. `config/prompts/modules/health_event/data_validation.txt`
5. `config/prompts/modules/health_event/response_format.txt`
6. `config/prompts/modules/health_event/few_shot_examples.txt`
7. `config/prompts/modules/health_event/notes.txt`
8. `config/prompts/modules/medication/` (7ä¸ªæ–‡ä»¶)
9. `config/prompts/modules/symptom/` (7ä¸ªæ–‡ä»¶)

### ä¿®æ”¹æ–‡ä»¶

1. `domain/tools/registry.py` - æ³¨å†Œæ–°å·¥å…·
2. `config/agents.yaml` - æ·»åŠ ä¸‰ä¸ªAgenté…ç½®
3. `domain/router/tools/router_tools.py` - æ›´æ–°æ„å›¾è¯†åˆ«å’Œæ¾„æ¸…æç¤ºè¯
4. `domain/router/node.py` - æ›´æ–°è·¯ç”±èŠ‚ç‚¹
5. `domain/router/graph.py` - æ›´æ–°è·¯ç”±å›¾

## ğŸ¯ åŠŸèƒ½éªŒè¯

æ‰€æœ‰å¼€å‘ä»»åŠ¡å·²å®Œæˆï¼Œç³»ç»Ÿç°åœ¨æ”¯æŒï¼š

1. âœ… **å¥åº·äº‹ä»¶è®°å½•**ï¼šç”¨æˆ·å¯ä»¥è®°å½•ã€æŸ¥è¯¢ã€æ›´æ–°å¥åº·äº‹ä»¶ï¼ˆä½“æ£€ã€æ£€æŸ¥ã€æ‰‹æœ¯ç­‰ï¼‰
2. âœ… **ç”¨è¯è®°å½•**ï¼šç”¨æˆ·å¯ä»¥è®°å½•ã€æŸ¥è¯¢ã€æ›´æ–°ç”¨è¯ä¿¡æ¯
3. âœ… **ç—‡çŠ¶è®°å½•**ï¼šç”¨æˆ·å¯ä»¥è®°å½•ã€æŸ¥è¯¢ã€æ›´æ–°ç—‡çŠ¶ä¿¡æ¯
4. âœ… **æ„å›¾è¯†åˆ«**ï¼šç³»ç»Ÿèƒ½å¤Ÿæ­£ç¡®è¯†åˆ«æ–°æ„å›¾å¹¶è·¯ç”±åˆ°å¯¹åº”Agent
5. âœ… **å¤šè½®å¯¹è¯**ï¼šæ‰€æœ‰Agentæ”¯æŒå¤šè½®å¯¹è¯å’Œæ§½ä½å¡«å……

## âš ï¸ æ³¨æ„äº‹é¡¹

1. **æ•°æ®åº“è¿ç§»**ï¼šç¡®ä¿å·²æ‰§è¡Œæ•°æ®åº“è¿ç§»ï¼ˆé˜¶æ®µä¸€å®Œæˆï¼‰
   ```bash
   alembic upgrade head
   ```

2. **æµ‹è¯•å»ºè®®**ï¼š
   - æµ‹è¯•æ¯ä¸ªAgentçš„è®°å½•ã€æŸ¥è¯¢ã€æ›´æ–°åŠŸèƒ½
   - æµ‹è¯•æ„å›¾è¯†åˆ«æ˜¯å¦æ­£ç¡®è·¯ç”±
   - æµ‹è¯•å¤šè½®å¯¹è¯å’Œæ§½ä½å¡«å……
   - æµ‹è¯•æ¾„æ¸…æœºåˆ¶

3. **åç»­ä¼˜åŒ–**ï¼š
   - å¯ä»¥æ ¹æ®å®é™…ä½¿ç”¨æƒ…å†µè°ƒæ•´æç¤ºè¯
   - å¯ä»¥æ·»åŠ æ›´å¤šçš„æ•°æ®éªŒè¯è§„åˆ™
   - å¯ä»¥ä¼˜åŒ–æŸ¥è¯¢ç»“æœçš„å±•ç¤ºæ ¼å¼

## ğŸ“š å‚è€ƒæ–‡æ¡£

- å¼€å‘æ–¹æ¡ˆï¼š`doc/è®¾è®¡V3.0/V3.2 é‡æ„èŠå¤©é“¾è·¯/æ–°å¢Agentå¼€å‘æ–¹æ¡ˆä¸å®ç°è®¡åˆ’.md`
- é˜¶æ®µä¸€æ€»ç»“ï¼š`cursor_docs/é˜¶æ®µä¸€æ•°æ®åº“å±‚å¼€å‘å®Œæˆæ€»ç»“.md`
