# RAG数据导入功能使用说明

## 文档信息

- **创建时间**：2025-01-16
- **对应阶段**：阶段三：数据导入功能开发
- **功能模块**：`backend/rag/data_import.py` 和 `backend/rag/scripts/import_data.py`

---

## 功能概述

RAG数据导入功能用于从Excel文件导入数据到向量库，支持以下功能：

1. **Excel文件解析**：按Sheet分类读取数据
2. **数据清洗和验证**：自动验证数据完整性
3. **向量化**：使用moka-ai/m3e-base模型生成768维向量
4. **批量导入**：支持批量插入，提高导入效率
5. **进度显示**：实时显示导入进度和统计信息

---

## Excel文件格式要求

### Sheet名称

Excel文件应包含以下Sheet（Sheet名称必须完全匹配）：

- `qa_examples`：健康咨询问答示例
- `record_examples`：数据记录示例
- `query_examples`：数据查询示例
- `greeting_examples`：问候示例

### 列字段要求

每个Sheet必须包含以下列：

**必需列**：
- `user_input`：用户输入（文本，必填）
- `agent_response`：Agent回复（文本，必填）

**可选列**：
- `tags`：标签（文本，逗号分隔，如：`健康咨询,高血压,普通咨询`）
- `quality_grade`：质量等级（文本，如：`优秀`、`良好`、`一般`）
- `notes`：备注（文本，仅用于数据管理，不会导入到数据库）

### 示例

| user_input | agent_response | tags | quality_grade | notes |
|------------|----------------|------|---------------|-------|
| 我今天量了血压，120/80 | 赞！血压已达标，继续加油保持！ | 血压记录,达标 | 优秀 | 示例数据 |
| 我的血压正常吗？ | 根据您提供的数据，您的血压在正常范围内。 | 健康咨询,血压 | 良好 | - |

---

## 使用方法

### 1. 安装依赖

确保已安装以下依赖：

```bash
pip install pandas openpyxl sentence-transformers pgvector
```

或使用项目的requirements.txt：

```bash
pip install -r requirements.txt
```

### 2. 准备Excel文件

确保Excel文件格式符合要求（见上文）。

### 3. 运行导入脚本

#### 基本用法

```bash
cd backend/rag/scripts
python import_data.py --excel <excel文件路径>
```

#### 完整参数

```bash
python import_data.py \
    --excel <excel文件路径> \
    [--clear] \
    [--log-level <日志级别>]
```

**参数说明**：
- `--excel`：Excel文件路径（支持相对路径和绝对路径，必填）
- `--clear`：导入前清空现有数据（可选，默认：否）
- `--log-level`：日志级别（可选，默认：INFO，可选值：DEBUG、INFO、WARNING、ERROR）

#### 示例

```bash
# 基本导入（使用项目根目录的相对路径，推荐）
python import_data.py --excel static/rag_source/第二步格式化/提示词案例库.xlsx

# 导入前清空现有数据
python import_data.py --excel static/rag_source/第二步格式化/提示词案例库.xlsx --clear

# 使用DEBUG日志级别（查看详细信息）
python import_data.py --excel static/rag_source/第二步格式化/提示词案例库.xlsx --log-level DEBUG

# 使用绝对路径
python import_data.py --excel /absolute/path/to/提示词案例库.xlsx
```

**注意**：相对路径会自动相对于项目根目录解析，无需使用 `../../` 这样的相对路径。

---

## 代码使用示例

### 在Python代码中使用

```python
from pathlib import Path
from backend.rag.data_import import DataImporter, get_db_connection

# 连接数据库
conn = get_db_connection()

# 创建导入器
importer = DataImporter(conn)

# 导入数据
excel_path = Path("data.xlsx")
results = importer.import_from_excel(
    excel_path,
    clear_existing=False  # 是否清空现有数据
)

# 查看结果
for sheet_name, stats in results.items():
    print(f"{sheet_name}: 成功 {stats['success']} 条，失败 {stats['fail']} 条")

# 关闭连接
conn.close()
```

---

## 功能特性

### 1. 模型缓存机制

向量化模型（moka-ai/m3e-base）使用单例模式缓存，首次加载后会在内存中保持，避免重复加载。

### 2. 批量处理

数据导入采用批量处理机制，默认批次大小为100条，可根据需要调整。

### 3. 错误处理

- 自动跳过无效数据行，记录警告日志
- 批量处理失败时自动回滚
- 提供详细的错误信息

### 4. 进度显示

实时显示导入进度：
- 当前处理的Sheet
- 批次进度（如：批次 1/5）
- 成功/失败统计

---

## 数据验证规则

### 必需字段验证

- `user_input` 和 `agent_response` 不能为空
- 空值或仅包含空白字符的行会被跳过

### 可选字段处理

- `tags`：如果为空或NaN，则设置为None；如果存在，则按逗号分隔转换为列表
- `quality_grade`：如果为空或NaN，则设置为None

### Sheet验证

- 未知的Sheet会被跳过（仅处理预定义的Sheet）
- 缺少必需列的Sheet会被跳过

---

## 导入结果

导入完成后，会返回统计信息：

```python
{
    "qa_examples": {
        "success": 100,  # 成功导入数量
        "fail": 0        # 失败数量
    },
    "record_examples": {
        "success": 50,
        "fail": 2
    },
    # ...
}
```

---

## 注意事项

1. **数据库连接**：确保数据库连接配置正确（通过`.env`文件或环境变量）
2. **模型下载**：首次运行时，如果本地没有模型缓存，会自动下载（可能需要一些时间）
3. **向量维度**：使用moka-ai/m3e-base模型，向量维度为768
4. **表前缀**：数据会导入到带前缀的表（如：`gd2502_qa_examples`）
5. **数据清空**：使用`--clear`选项会清空所有现有数据，请谨慎使用

---

## 测试

运行测试脚本验证功能：

```bash
cd cursor_test/rag
python test_data_import.py
```

测试内容包括：
1. Excel文件解析测试
2. 向量化模型测试
3. 数据库连接和数据导入器初始化测试

---

## 故障排查

### 问题1：Excel文件读取失败

**可能原因**：
- 文件路径不正确
- 文件格式不支持（仅支持.xlsx和.xls）
- 文件被其他程序占用

**解决方法**：
- 检查文件路径是否正确
- 确保文件格式为.xlsx或.xls
- 关闭其他可能占用文件的程序

### 问题2：数据库连接失败

**可能原因**：
- 数据库配置不正确
- 数据库服务未启动
- 网络连接问题

**解决方法**：
- 检查`.env`文件中的`DATABASE_URL`配置
- 确认数据库服务已启动
- 检查网络连接

### 问题3：模型加载失败

**可能原因**：
- 网络连接问题（首次下载模型）
- 磁盘空间不足
- 模型文件损坏

**解决方法**：
- 检查网络连接
- 确保有足够的磁盘空间
- 删除缓存后重新下载（`~/.cache/huggingface/hub/`）

### 问题4：数据导入失败

**可能原因**：
- 数据格式不符合要求
- 数据库表不存在
- 向量维度不匹配

**解决方法**：
- 检查Excel文件格式是否符合要求
- 确认数据库表已创建（运行Alembic迁移）
- 检查向量维度是否为768

---

## 相关文件

- **数据导入模块**：`backend/rag/data_import.py`
- **导入脚本**：`backend/rag/scripts/import_data.py`
- **测试脚本**：`cursor_test/rag/test_data_import.py`
- **数据库模型**：`backend/infrastructure/database/models/rag_models.py`
- **设计文档**：`doc/V8.0独立提示词方案/011601-节点二方案设计.md`

---

## 更新日志

- **2025-01-16**：初始版本，实现基本的数据导入功能
