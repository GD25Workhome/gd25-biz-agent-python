# 血压工具功能扩展改动方案

## 一、需求概述

为血压Agent追加更多工具功能，包括：
1. **记录血压**（已存在，需要完善持久化）
2. **查询血压**（默认14天内，或指定14天内的时间段）
3. **血压更新**（只能更新最新的血压数据）

## 二、当前状态分析

### 2.1 现有代码结构

#### 2.1.1 工具层（`backend/domain/tools/blood_pressure.py`）
- ✅ `record_blood_pressure` 工具已存在
- ❌ 当前仅记录日志，未持久化到数据库
- ❌ 缺少 `query_blood_pressure` 工具
- ❌ 缺少 `update_blood_pressure` 工具

#### 2.1.2 仓储层（`backend/infrastructure/database/repository/blood_pressure_repository.py`）
- ✅ `get_by_user_id()` - 根据用户ID查询（支持分页）
- ✅ `get_by_date_range()` - 根据日期范围查询
- ❌ 缺少获取最新血压记录的方法
- ❌ 缺少更新血压记录的方法（BaseRepository可能有，需确认）

#### 2.1.3 流程配置（`config/flows/medical_agent/flow.yaml`）
- ✅ 已注册 `record_blood_pressure` 工具
- ❌ 未注册 `query_blood_pressure` 工具
- ❌ 未注册 `update_blood_pressure` 工具

#### 2.1.4 提示词（`config/flows/medical_agent/prompts/10-blood_pressure_agent.md`）
- ✅ 已说明 `record_blood_pressure` 工具的使用场景
- ❌ 未说明 `query_blood_pressure` 工具的使用场景
- ❌ 未说明 `update_blood_pressure` 工具的使用场景

### 2.2 技术架构要点

1. **工具自动注入机制**：
   - 使用 `TokenInjectedTool` 包装工具，自动注入 `token_id`（用户ID）
   - `token_id` 从上下文（`TokenContext`）获取

2. **数据库会话获取**：
   - 工具中需要通过 `get_async_session()` 获取数据库会话
   - 需要确认工具中如何正确获取和使用数据库会话

3. **工具注册机制**：
   - 工具通过 `ToolRegistry` 注册
   - Agent 从注册表获取工具列表

## 三、改动方案

### 3.1 仓储层改动（`backend/infrastructure/database/repository/blood_pressure_repository.py`）

#### 3.1.1 需要添加的方法

**方法1：`get_latest_by_user_id()`**
```python
async def get_latest_by_user_id(
    self,
    user_id: str
) -> Optional[BloodPressureRecord]:
    """
    获取用户最新的血压记录
    
    Args:
        user_id: 用户ID
        
    Returns:
        最新的血压记录，如果不存在则返回None
    """
    # 实现逻辑：按 record_time 或 created_at 倒序，取第一条
```

**方法2：`get_recent_by_user_id()`**
```python
async def get_recent_by_user_id(
    self,
    user_id: str,
    days: int = 14,
    start_date: Optional[datetime] = None,
    end_date: Optional[datetime] = None
) -> List[BloodPressureRecord]:
    """
    获取用户最近N天的血压记录（默认14天）
    
    Args:
        user_id: 用户ID
        days: 天数（默认14天），如果指定了 start_date 和 end_date，则忽略此参数
        start_date: 开始日期（可选）
        end_date: 结束日期（可选，默认为当前时间）
        
    Returns:
        血压记录列表（按记录时间倒序）
        
    逻辑说明：
    - 如果指定了 start_date 和 end_date，使用日期范围查询
    - 如果只指定了 start_date，end_date 默认为当前时间
    - 如果只指定了 end_date，start_date = end_date - days
    - 如果都未指定，start_date = 当前时间 - days，end_date = 当前时间
    - 时间范围限制：最多查询14天内的数据
    """
```

**方法3：确认 `update()` 方法**
- ✅ `BaseRepository` 已有 `update(id: str, **kwargs)` 方法
- ✅ 方法功能满足需求：根据ID更新记录，只更新非None的字段
- 无需额外实现，直接使用即可

#### 3.1.2 改动清单

- [ ] 添加 `get_latest_by_user_id()` 方法
- [ ] 添加 `get_recent_by_user_id()` 方法（支持默认14天或指定时间段）
- [x] 确认 `update()` 方法（BaseRepository 已有，无需实现）
- [ ] 添加单元测试（可选，但建议）

### 3.2 工具层改动（`backend/domain/tools/blood_pressure.py`）

#### 3.2.1 完善 `record_blood_pressure` 工具

**当前问题**：
- 仅记录日志，未持久化到数据库

**改动方案**：
1. 在工具中获取数据库会话
2. 创建 `BloodPressureRepository` 实例
3. 调用 `create()` 方法持久化数据
4. 返回成功消息

**注意事项**：
- 需要处理数据库异常
- 需要确保数据库会话正确关闭
- 保持现有的数据验证逻辑

#### 3.2.2 新增 `query_blood_pressure` 工具

**功能说明**：
- 查询用户最近14天内的血压记录（默认）
- 或查询指定时间段内的血压记录（最多14天）

**参数设计**：
```python
@tool
def query_blood_pressure(
    days: Optional[int] = None,  # 查询天数（默认14天）
    start_date: Optional[str] = None,  # 开始日期（格式：YYYY-MM-DD）
    end_date: Optional[str] = None,  # 结束日期（格式：YYYY-MM-DD）
    token_id: str = ""  # 由TokenInjectedTool自动注入
) -> str:
    """
    查询血压记录
    
    Args:
        days: 查询天数（默认14天，最大14天）
        start_date: 开始日期（格式：YYYY-MM-DD，可选）
        end_date: 结束日期（格式：YYYY-MM-DD，可选，默认为当前日期）
        token_id: 用户ID（由系统自动注入，无需手动传递）
        
    Returns:
        血压记录列表的文本描述（格式化输出）
        
    使用场景：
    - 用户询问"查看我的血压记录" → 查询最近14天
    - 用户询问"查看我最近7天的血压" → days=7
    - 用户询问"查看我3月1日到3月7日的血压" → start_date="2024-03-01", end_date="2024-03-07"
    """
```

**实现要点**：
1. 参数验证：确保时间范围不超过14天
2. 日期解析：将字符串日期转换为 `datetime` 对象
3. 调用 Repository 的 `get_recent_by_user_id()` 方法
4. 格式化输出：将查询结果转换为易读的文本格式
5. 异常处理：处理数据库异常和参数错误

#### 3.2.3 新增 `update_blood_pressure` 工具

**功能说明**：
- 只能更新用户最新的血压记录
- 如果用户没有血压记录，返回错误提示

**参数设计**：
```python
@tool
def update_blood_pressure(
    systolic: Optional[int] = None,  # 收缩压（可选）
    diastolic: Optional[int] = None,  # 舒张压（可选）
    heart_rate: Optional[int] = None,  # 心率（可选）
    notes: Optional[str] = None,  # 备注（可选）
    token_id: str = ""  # 由TokenInjectedTool自动注入
) -> str:
    """
    更新最新的血压记录
    
    Args:
        systolic: 收缩压（mmHg，可选）
        diastolic: 舒张压（mmHg，可选）
        heart_rate: 心率（次/分钟，可选）
        notes: 备注（可选）
        token_id: 用户ID（由系统自动注入，无需手动传递）
        
    Returns:
        更新结果的文本描述
        
    使用场景：
    - 用户说"我刚才记录的血压有误，应该是120/80" → 更新最新记录
    - 用户说"修改一下刚才的备注" → 只更新备注字段
    
    限制：
    - 只能更新最新的血压记录
    - 如果用户没有血压记录，返回错误提示
    """
```

**实现要点**：
1. 获取最新记录：调用 Repository 的 `get_latest_by_user_id()` 方法
2. 验证记录存在：如果不存在，返回友好的错误提示
3. 参数验证：只更新非None的字段
4. 数据验证：如果提供了血压值，需要验证范围
5. 调用更新：使用 Repository 的 `update()` 方法
6. 返回结果：格式化输出更新后的数据

#### 3.2.4 数据库会话获取方案

**问题**：工具中如何获取数据库会话？

**方案1：在工具函数中直接获取（推荐）**
```python
from backend.infrastructure.database.connection import get_session_factory

async def record_blood_pressure(...):
    session_factory = get_session_factory()
    async with session_factory() as session:
        repo = BloodPressureRepository(session)
        # ... 执行操作
        await session.commit()
```

**方案2：通过上下文传递（如果已有机制）**
- 检查是否有现有的数据库会话传递机制
- 如果有，使用现有机制

**注意事项**：
- 确保数据库会话正确关闭
- 处理事务提交和回滚
- 处理异步操作

#### 3.2.5 改动清单

- [ ] 完善 `record_blood_pressure` 工具，实现数据库持久化
- [ ] 新增 `query_blood_pressure` 工具
- [ ] 新增 `update_blood_pressure` 工具
- [ ] 实现数据库会话获取机制
- [ ] 添加异常处理和日志记录
- [ ] 确保工具支持异步调用（如果需要）

### 3.3 流程配置改动（`config/flows/medical_agent/flow.yaml`）

#### 3.3.1 工具注册

**当前配置**：
```yaml
tools:
  - record_blood_pressure
```

**改动后配置**：
```yaml
tools:
  - record_blood_pressure
  - query_blood_pressure
  - update_blood_pressure
```

#### 3.3.2 改动清单

- [ ] 在 `blood_pressure_agent` 节点的 `tools` 列表中添加 `query_blood_pressure`
- [ ] 在 `blood_pressure_agent` 节点的 `tools` 列表中添加 `update_blood_pressure`

### 3.4 提示词改动（`config/flows/medical_agent/prompts/10-blood_pressure_agent.md`）

#### 3.4.1 是否需要修改提示词？

**判断依据**：
1. ✅ **需要修改**：当前提示词只说明了 `record_blood_pressure` 工具的使用场景
2. ✅ **需要修改**：新增了两个工具，需要在提示词中明确告知模型何时使用这些工具
3. ✅ **需要修改**：提示词中的"功能/工具说明"章节需要补充新工具的说明

**理由**：
- LLM 需要知道有哪些工具可用
- LLM 需要知道在什么场景下使用哪个工具
- 明确的工具使用说明可以提高工具调用的准确率
- 当前提示词中只有"记录血压"的说明，缺少"查询血压"和"更新血压"的说明

#### 3.4.2 提示词改动内容

**位置**：`# 功能/工具说明` 章节（第20-24行）

**当前内容**：
```markdown
## 1. 记录血压
当用户提供血压数据（收缩压、舒张压、心率等）时，使用 `record_blood_pressure` 工具记录。
```

**改动后内容**：
```markdown
## 1. 记录血压
当用户提供血压数据（收缩压、舒张压、心率等）时，使用 `record_blood_pressure` 工具记录。

## 2. 查询血压
当用户询问血压记录、查看历史血压数据时，使用 `query_blood_pressure` 工具查询。
- 如果用户未指定时间范围，默认查询最近14天的记录
- 如果用户指定了时间范围（如"最近7天"、"3月1日到3月7日"），使用相应的参数查询
- 查询结果会以易读的格式展示给用户

使用场景示例：
- "查看我的血压记录" → 查询最近14天
- "看看我最近一周的血压" → days=7
- "查看我3月1日到3月7日的血压" → start_date="2024-03-01", end_date="2024-03-07"

## 3. 更新血压
当用户需要修改刚才记录的血压数据时，使用 `update_blood_pressure` 工具更新。
- 只能更新用户最新的血压记录
- 可以更新部分字段（如只更新收缩压，或只更新备注）
- 如果用户没有血压记录，友好地提示用户先记录血压

使用场景示例：
- "我刚才记录的血压有误，应该是120/80" → 更新最新记录的收缩压和舒张压
- "修改一下刚才的备注" → 只更新备注字段
- "更新一下心率" → 只更新心率字段
```

**位置2**：`# 工作流程` 章节（第27-49行）

**需要补充**：
- 在"第一步：血压数据收集"中，可以说明如果用户想查看历史记录，使用查询工具
- 在"第二步：血压数据点评"中，可以说明如果需要修改记录，使用更新工具

#### 3.4.3 改动清单

- [ ] 在"功能/工具说明"章节添加 `query_blood_pressure` 工具说明
- [ ] 在"功能/工具说明"章节添加 `update_blood_pressure` 工具说明
- [ ] 在工作流程章节补充工具使用场景说明（可选，但建议）

## 四、技术实现细节

### 4.1 数据库会话管理

**方案**：在工具函数中直接获取数据库会话

```python
from backend.infrastructure.database.connection import get_session_factory
from backend.infrastructure.database.repository.blood_pressure_repository import BloodPressureRepository

async def record_blood_pressure(...):
    session_factory = get_session_factory()
    async with session_factory() as session:
        try:
            repo = BloodPressureRepository(session)
            record = await repo.create(...)
            await session.commit()
            return "记录成功"
        except Exception as e:
            await session.rollback()
            logger.error(f"记录失败: {e}")
            return f"错误：{str(e)}"
```

### 4.2 日期处理

**需求**：
- 支持字符串日期解析（格式：YYYY-MM-DD）
- 支持相对日期计算（如"最近7天"）
- 限制查询范围不超过14天

**实现**：
```python
from datetime import datetime, timedelta
from dateutil import parser  # 如果需要更灵活的日期解析

def parse_date_range(days: Optional[int], start_date: Optional[str], end_date: Optional[str]) -> tuple[datetime, datetime]:
    """
    解析日期范围，确保不超过14天
    """
    now = datetime.now()
    
    if start_date and end_date:
        start = datetime.strptime(start_date, "%Y-%m-%d")
        end = datetime.strptime(end_date, "%Y-%m-%d")
    elif start_date:
        start = datetime.strptime(start_date, "%Y-%m-%d")
        end = now
    elif end_date:
        end = datetime.strptime(end_date, "%Y-%m-%d")
        start = end - timedelta(days=14)
    elif days:
        start = now - timedelta(days=min(days, 14))
        end = now
    else:
        # 默认14天
        start = now - timedelta(days=14)
        end = now
    
    # 确保不超过14天
    if (end - start).days > 14:
        start = end - timedelta(days=14)
    
    return start, end
```

### 4.3 数据格式化输出

**需求**：将查询结果格式化为易读的文本

**实现**：
```python
def format_blood_pressure_records(records: List[BloodPressureRecord]) -> str:
    """
    格式化血压记录列表为文本
    """
    if not records:
        return "您在此时间段内没有血压记录。"
    
    lines = [f"共找到 {len(records)} 条血压记录：\n"]
    for i, record in enumerate(records, 1):
        line = f"{i}. "
        if record.record_time:
            line += f"{record.record_time.strftime('%Y-%m-%d %H:%M')} - "
        line += f"收缩压 {record.systolic} mmHg，舒张压 {record.diastolic} mmHg"
        if record.heart_rate:
            line += f"，心率 {record.heart_rate} 次/分钟"
        if record.notes:
            line += f"，备注：{record.notes}"
        lines.append(line)
    
    return "\n".join(lines)
```

### 4.4 工具异步支持

**需求**：确保工具支持异步调用

**注意事项**：
- LangChain 工具默认支持异步
- 如果工具函数是异步的，使用 `async def`
- 如果工具函数是同步的，但需要调用异步 Repository 方法，需要使用 `asyncio.run()` 或类似机制

**建议**：工具函数使用异步实现，直接调用异步 Repository 方法

**实现方式**：
```python
from langchain_core.tools import tool

@tool
async def record_blood_pressure(...):
    """
    异步工具函数
    LangChain 的 @tool 装饰器支持异步函数，会自动处理异步调用
    """
    session_factory = get_session_factory()
    async with session_factory() as session:
        repo = BloodPressureRepository(session)
        record = await repo.create(...)
        await session.commit()
        return "记录成功"
```

**注意**：当前 `record_blood_pressure` 是同步函数，需要改为异步函数以支持数据库操作

## 五、测试建议

### 5.1 单元测试

**仓储层测试**：
- [ ] `get_latest_by_user_id()` 方法测试
- [ ] `get_recent_by_user_id()` 方法测试（各种参数组合）
- [ ] `update()` 方法测试

**工具层测试**：
- [ ] `record_blood_pressure` 工具测试（数据库持久化）
- [ ] `query_blood_pressure` 工具测试（各种查询场景）
- [ ] `update_blood_pressure` 工具测试（更新最新记录）

### 5.2 集成测试

- [ ] 完整的记录-查询-更新流程测试
- [ ] 多用户数据隔离测试
- [ ] 异常场景测试（如没有记录时更新）

### 5.3 端到端测试

- [ ] 通过 Agent 调用工具，验证工具调用准确性
- [ ] 验证提示词是否有效指导 LLM 使用工具

## 六、风险评估

### 6.1 技术风险

1. **数据库会话管理**：
   - 风险：工具中获取数据库会话可能导致连接泄漏
   - 缓解：使用 `async with` 确保会话正确关闭

2. **异步调用**：
   - 风险：工具函数可能需要支持异步，但 LangChain 工具调用机制需要确认
   - 缓解：查阅 LangChain 文档，确认工具异步支持方式

3. **日期解析**：
   - 风险：用户可能使用各种日期格式
   - 缓解：使用标准格式（YYYY-MM-DD），在提示词中明确说明

### 6.2 业务风险

1. **数据一致性**：
   - 风险：更新最新记录时，如果用户同时记录新数据，可能导致更新错误的记录
   - 缓解：在更新前再次确认记录是否为最新（通过时间戳比较）

2. **查询性能**：
   - 风险：如果用户有大量历史数据，查询可能较慢
   - 缓解：限制查询范围为14天，使用索引优化查询

## 七、实施计划

### 7.1 实施步骤

1. **第一步：仓储层改动**
   - 实现 `get_latest_by_user_id()` 方法
   - 实现 `get_recent_by_user_id()` 方法
   - 确认或实现 `update()` 方法
   - 编写单元测试

2. **第二步：工具层改动**
   - 完善 `record_blood_pressure` 工具（数据库持久化）
   - 实现 `query_blood_pressure` 工具
   - 实现 `update_blood_pressure` 工具
   - 编写单元测试

3. **第三步：流程配置改动**
   - 在 `flow.yaml` 中注册新工具

4. **第四步：提示词改动**
   - 更新提示词，添加新工具说明

5. **第五步：测试验证**
   - 运行单元测试
   - 运行集成测试
   - 端到端测试

### 7.2 优先级

- **P0（必须）**：仓储层方法实现、工具实现、流程配置、提示词更新
- **P1（重要）**：单元测试、异常处理
- **P2（可选）**：集成测试、性能优化

## 八、其他补充

### 8.1 需要考虑的场景

1. **边界情况**：
   - 用户没有血压记录时，查询和更新如何处理
   - 时间范围超过14天时，如何处理
   - 日期格式错误时，如何处理

2. **用户体验**：
   - 错误提示要友好、清晰
   - 查询结果要易读、格式化
   - 更新成功要有明确的反馈

3. **数据安全**：
   - 确保用户只能查询和更新自己的数据
   - 通过 `token_id` 确保数据隔离

### 8.2 后续优化方向

1. **功能增强**：
   - 支持更灵活的日期格式解析（如"昨天"、"上周"）
   - 支持血压数据统计（平均值、趋势等）

2. **性能优化**：
   - 查询结果缓存
   - 数据库查询优化

3. **可观测性**：
   - 添加工具调用日志
   - 添加性能监控

## 九、总结

本改动方案涵盖了血压工具功能扩展的所有方面：
1. ✅ 仓储层：添加查询和更新方法
2. ✅ 工具层：完善记录工具，新增查询和更新工具
3. ✅ 流程配置：注册新工具
4. ✅ 提示词：明确告知模型工具使用场景（**需要修改，理由已说明**）

所有改动都基于现有代码架构，保持一致性，并考虑了异常处理、用户体验和数据安全等方面。

