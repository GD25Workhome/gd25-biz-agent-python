# 提示词升级问题记录：查询血压工具仍被调用问题

## 问题描述

在移除提示词中查询和更新血压工具的描述后，Agent 仍然调用了 `query_blood_pressure` 工具，导致系统错误。

### 错误日志

```
2025-12-29 18:34:10 - app.api.routes - ERROR - [Chat异常] session_id=session-1767004315333, error='NoneType' object has no attribute 'strftime', error_type=AttributeError
...
File "/Users/m684620/work/github_GD25/gd25-biz-agent-python_cursor/domain/tools/blood_pressure/query.py", line 40, in query_blood_pressure
    f"- 时间：{record.record_time.strftime('%Y-%m-%d %H:%M:%S')}，"
               ^^^^^^^^^^^^^^^^^^^^^^^^^^^
AttributeError: 'NoneType' object has no attribute 'strftime'
```

### 问题现象

1. 用户记录血压后，Agent 自动调用了 `query_blood_pressure` 工具
2. 工具执行时遇到 `record.record_time` 为 `None` 的情况，导致 `AttributeError`
3. 根据新的提示词逻辑，系统应该自动提供历史数据，不应该调用查询工具

## 问题分析

### 根本原因

**提示词与工具配置不一致**：虽然提示词中已经移除了查询和更新工具的描述，但 `config/agents.yaml` 配置文件中仍然包含这些工具。

### 详细分析

#### 1. 工具注册机制

**文件**：`domain/tools/registry.py`

```python
def init_tools():
    """初始化工具注册表"""
    # 导入血压记录工具
    from domain.tools.blood_pressure.record import record_blood_pressure
    from domain.tools.blood_pressure.query import query_blood_pressure
    from domain.tools.blood_pressure.update import update_blood_pressure
    
    # 注册工具
    register_tool("record_blood_pressure", record_blood_pressure)
    register_tool("query_blood_pressure", query_blood_pressure)
    register_tool("update_blood_pressure", update_blood_pressure)
```

**说明**：所有工具在系统启动时都会被注册到 `TOOL_REGISTRY` 中。

#### 2. Agent 工具加载机制

**文件**：`domain/agents/factory.py`

```python
# 2. 获取工具列表
if not tools:
    tool_names = agent_config.get("tools", [])
    tools = [
        TOOL_REGISTRY[name]
        for name in tool_names
        if name in TOOL_REGISTRY
    ]
```

**说明**：AgentFactory 根据 `config/agents.yaml` 中的 `tools` 列表，从 `TOOL_REGISTRY` 中获取工具实例并传递给 Agent。

#### 3. 当前配置文件状态

**文件**：`config/agents.yaml`

```yaml
blood_pressure_agent:
  tools:
    - record_blood_pressure
    - query_blood_pressure      # ❌ 仍然存在
    - update_blood_pressure       # ❌ 仍然存在
```

**说明**：配置文件中仍然包含查询和更新工具。

#### 4. LangGraph ReAct Agent 工具暴露机制

**关键点**：LangGraph 的 `create_react_agent` 会自动将传入的工具列表暴露给 LLM。

**工作原理**：
1. LangGraph 会将工具列表转换为工具描述（使用工具的 docstring）
2. 这些工具描述会被包含在 LLM 的系统提示中（由 LangGraph 自动生成）
3. LLM 可以根据工具描述决定是否调用工具
4. **即使提示词中没有说明，只要工具在列表中，LLM 仍然可以看到并调用这些工具**

#### 5. 为什么 Agent 会调用查询工具

从日志看，Agent 在记录血压后，回复说：
> "血压记录成功！现在让我先查询一下您的历史血压数据，以便为您提供更全面的健康点评。"

**分析**：
- Agent 可能根据工具描述（"查询用户的血压记录"）判断需要调用查询工具
- 或者 Agent 根据历史对话模式（之前可能使用过查询工具）决定调用
- 虽然提示词中说"系统会自动提供"，但 LLM 看到工具可用时，可能会主动调用

### 问题总结

| 层面 | 状态 | 说明 |
|------|------|------|
| 提示词 | ✅ 已修改 | 已移除查询和更新工具的描述 |
| 工具注册 | ✅ 正常 | 工具仍然在注册表中（这是正常的，其他 Agent 可能使用） |
| **配置文件** | ❌ **未同步** | **`config/agents.yaml` 中仍然包含查询和更新工具** |
| Agent 工具列表 | ❌ **包含不需要的工具** | Agent 仍然可以访问这些工具 |
| LLM 行为 | ❌ **调用了工具** | LLM 看到工具可用，主动调用 |

## 改造方案

### 方案概述

需要确保**提示词、工具配置、实际行为**三者一致：
- 提示词：已移除查询和更新工具描述 ✅
- 工具配置：需要从 `config/agents.yaml` 中移除查询和更新工具 ⚠️
- 系统行为：需要确保历史数据通过其他方式提供（如上下文注入） ⚠️

### 方案一：移除配置文件中的工具（推荐）

**适用场景**：完全移除查询和更新功能，历史数据通过系统自动提供。

#### 1.1 修改配置文件

**文件**：`config/agents.yaml`

```yaml
blood_pressure_agent:
  tools:
    - record_blood_pressure
    # 移除以下工具：
    # - query_blood_pressure
    # - update_blood_pressure
```

**优点**：
- 简单直接，彻底解决问题
- Agent 无法访问这些工具，不会误调用
- 符合新的业务逻辑（系统自动提供数据）

**缺点**：
- 如果未来需要恢复查询功能，需要重新添加配置

#### 1.2 清除 Agent 缓存

修改配置后，需要清除 Agent 缓存，使新配置生效：

```python
# 方式1：通过代码清除
from domain.agents.factory import AgentFactory
AgentFactory.clear_cache("blood_pressure_agent")

# 方式2：重启服务（会自动重新加载配置）
```

**注意**：AgentFactory 有缓存机制，修改配置后需要清除缓存或重启服务。

### 方案二：修复工具实现（临时方案）

**适用场景**：如果暂时保留工具但不想让 Agent 调用，或者需要修复工具本身的 bug。

#### 2.1 修复 `query_blood_pressure` 工具的空值处理

**文件**：`domain/tools/blood_pressure/query.py`

**问题**：`record.record_time` 可能为 `None`，导致 `strftime` 调用失败。

**修复方案**：

```python
for record in records:
    # 处理 record_time 为 None 的情况
    time_str = (
        record.record_time.strftime('%Y-%m-%d %H:%M:%S')
        if record.record_time
        else '未记录时间'
    )
    result_lines.append(
        f"- 时间：{time_str}，"
        f"收缩压：{record.systolic} mmHg，"
        f"舒张压：{record.diastolic} mmHg，"
        f"心率：{record.heart_rate or '未记录'} bpm"
    )
```

**说明**：这只是修复工具本身的 bug，不能解决 Agent 不应该调用工具的问题。

### 方案三：通过上下文注入提供历史数据（完整方案）

**适用场景**：系统自动提供历史数据，Agent 不需要调用查询工具。

#### 3.1 在 Agent 执行前注入历史数据

**位置**：`domain/router/graph.py` 的 `_run` 函数

**思路**：
1. 在调用 Agent 之前，查询用户的历史血压数据
2. 将历史数据作为上下文信息注入到系统提示词或消息中
3. Agent 可以直接使用这些数据，无需调用查询工具

**实现要点**：
- 在 `with_user_context` 装饰器中或 `_run` 函数中查询历史数据
- 将历史数据格式化为文本，添加到系统提示词或用户消息中
- 确保数据格式符合提示词中"系统会自动提供"的描述

#### 3.2 修改提示词明确数据来源

**文件**：`config/prompts/local/blood_pressure_agent_prompt.txt`

在"第二步：血压数据点评"部分，明确说明：
- 历史数据已经通过上下文提供，无需调用查询工具
- 数据格式和位置说明

### 方案四：工具权限控制（高级方案）

**适用场景**：需要更细粒度的工具访问控制。

**思路**：
- 在工具注册时添加权限标记
- Agent 创建时根据权限过滤工具
- 或者通过工具描述中的特殊标记，让 LLM 知道某些工具不应该被调用

**实现复杂度**：较高，需要修改工具注册和 Agent 创建逻辑。

## 推荐方案

### 短期方案（立即执行）

1. **移除配置文件中的工具**（方案一）
   - 修改 `config/agents.yaml`，移除 `query_blood_pressure` 和 `update_blood_pressure`
   - 清除 Agent 缓存或重启服务

2. **修复工具 bug**（方案二，可选）
   - 修复 `query_blood_pressure` 的空值处理问题
   - 防止未来如果工具被误调用时不会崩溃

### 长期方案（后续优化）

3. **实现上下文数据注入**（方案三）
   - 在 Agent 执行前自动查询并注入历史数据
   - 确保系统行为与提示词描述一致
   - 提供更好的用户体验

## 实施步骤

### 步骤 1：修改配置文件

1. 打开 `config/agents.yaml`
2. 找到 `blood_pressure_agent` 配置
3. 从 `tools` 列表中移除：
   - `query_blood_pressure`
   - `update_blood_pressure`
4. 保存文件

### 步骤 2：清除 Agent 缓存

**方式 A：代码清除**
```python
from domain.agents.factory import AgentFactory
AgentFactory.clear_cache("blood_pressure_agent")
```

**方式 B：重启服务**
- 服务重启后会自动重新加载配置

### 步骤 3：验证

1. 测试记录血压功能
2. 确认 Agent 不再调用查询工具
3. 确认血压点评功能正常（如果已实现上下文数据注入）

### 步骤 4：修复工具 bug（可选）

1. 修改 `domain/tools/blood_pressure/query.py`
2. 添加空值检查
3. 测试工具本身的功能（通过其他方式调用）

## 注意事项

1. **Agent 缓存机制**：
   - AgentFactory 有缓存机制，修改配置后必须清除缓存
   - 可以通过代码清除或重启服务

2. **其他 Agent 的影响**：
   - 移除工具注册不会影响其他 Agent
   - 如果其他 Agent 需要使用这些工具，需要在各自的配置中添加

3. **历史数据提供**：
   - 如果系统还未实现自动提供历史数据的功能，需要先实现
   - 否则 Agent 无法进行血压点评

4. **向后兼容性**：
   - 如果未来需要恢复查询功能，可以重新添加配置
   - 建议保留工具实现代码，只移除配置

## 相关文件清单

### 需要修改的文件

1. `config/agents.yaml` - 移除查询和更新工具配置
2. `domain/tools/blood_pressure/query.py` - 修复空值处理（可选）

### 相关代码文件

1. `domain/tools/registry.py` - 工具注册表
2. `domain/agents/factory.py` - Agent 工厂，工具加载逻辑
3. `domain/router/graph.py` - 路由图，Agent 执行逻辑
4. `config/prompts/local/blood_pressure_agent_prompt.txt` - 提示词（已修改）

## 问题追踪

- **问题发现时间**：2025-12-29
- **问题类型**：配置不一致导致的逻辑错误
- **影响范围**：血压记录 Agent
- **优先级**：高（影响核心功能）
- **状态**：待修复

