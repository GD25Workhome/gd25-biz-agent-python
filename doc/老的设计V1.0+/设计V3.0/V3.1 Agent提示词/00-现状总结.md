# Agent提示词现状总结

## 一、概述

本文档总结了当前系统中Agent提示词的使用情况，为后续设计统一的提示词管理模块提供基础。

## 二、提示词分布情况

### 2.1 Agent系统提示词

#### 2.1.1 存储位置
- **配置文件**：`config/agents.yaml`
- **提示词文件**：`config/prompts/` 目录
  - `blood_pressure_prompt.txt` - 血压记录智能体提示词
  - `appointment_prompt.txt` - 复诊管理智能体提示词

#### 2.1.2 加载方式
- **代码位置**：`domain/agents/factory.py` 的 `AgentFactory.create_agent()` 方法
- **加载逻辑**：
  1. 优先从 `system_prompt_path` 指定的文件路径加载
  2. 如果文件不存在，则使用配置中的 `system_prompt` 字段
  3. 最终传递给 `create_react_agent()` 作为 `prompt` 参数

```python
# domain/agents/factory.py (91-97行)
# 3. 获取系统提示词
system_prompt = agent_config.get("system_prompt", "")
# 支持从文件加载提示词
prompt_path = agent_config.get("system_prompt_path")
if prompt_path and os.path.exists(prompt_path):
    with open(prompt_path, "r", encoding="utf-8") as f:
        system_prompt = f.read()
```

#### 2.1.3 当前Agent列表
1. **blood_pressure_agent**（血压记录智能体）
   - 配置文件：`config/agents.yaml` (6-46行)
   - 提示词文件：`config/prompts/blood_pressure_prompt.txt`
   - 功能：记录、查询、更新血压数据

2. **appointment_agent**（复诊管理智能体）
   - 配置文件：`config/agents.yaml` (48-91行)
   - 提示词文件：`config/prompts/appointment_prompt.txt`
   - 功能：创建、查询、更新预约

#### 2.1.4 提示词内容特点
- 包含角色定义、功能说明、多轮对话支持、数据完整性检查、澄清机制、注意事项等
- 提示词较长（约30行），包含详细的业务逻辑说明
- 支持多轮对话和数据收集

### 2.2 路由工具提示词

#### 2.2.1 存储位置
- **代码位置**：`domain/router/tools/router_tools.py`
- **硬编码在代码中**，未使用外部文件

#### 2.2.2 提示词列表
1. **INTENT_IDENTIFICATION_PROMPT**（意图识别提示词）
   - 位置：`domain/router/tools/router_tools.py` (18-48行)
   - 用途：识别用户意图（blood_pressure/appointment/unclear）
   - 使用方式：通过 `ChatPromptTemplate.from_messages()` 构建
   - 特点：包含意图类型说明、关键词、示例、规则等

2. **CLARIFY_INTENT_PROMPT**（意图澄清提示词）
   - 位置：`domain/router/tools/router_tools.py` (277-291行)
   - 用途：当用户意图不明确时，生成友好的澄清问题
   - 使用方式：通过 `ChatPromptTemplate.from_messages()` 构建
   - 特点：引导用户说明具体需求

#### 2.2.3 使用场景
- `identify_intent()` 工具：使用 `INTENT_IDENTIFICATION_PROMPT`
- `clarify_intent()` 工具：使用 `CLARIFY_INTENT_PROMPT`

### 2.3 动态提示词注入

#### 2.3.1 位置
- **代码位置**：`domain/router/graph.py` 的 `with_user_context()` 函数
- **功能**：在运行时动态构建系统提示词并注入到消息列表

#### 2.3.2 动态构建逻辑
1. **用户上下文提示**（`_build_bp_context_hint()`）
   - 为血压智能体构建表单上下文提示
   - 列出已收集字段和待补全字段
   - 位置：`domain/router/graph.py` (104-133行)

2. **系统消息注入**（`with_user_context()`）
   - 根据智能体类型构建不同的系统提示
   - 血压智能体：包含表单槽位信息
   - 其他智能体：仅包含用户ID信息
   - 位置：`domain/router/graph.py` (136-292行)

```python
# domain/router/graph.py (170-182行)
if user_id and not has_context:
    # 根据不同智能体构建上下文提示
    if agent_name == "blood_pressure_agent":
        hint_content = _build_bp_context_hint(user_id, bp_form)
    else:
        hint_content = (
            f"系统提供的用户ID：{user_id}。"
            "调用工具时直接使用该 user_id，无需向用户索取。"
        )
    
    system_hint = SystemMessage(content=hint_content)
    messages = [system_hint, *messages]
```

## 三、提示词使用流程

### 3.1 Agent创建流程
```
config/agents.yaml 或 config/prompts/*.txt
    ↓
AgentFactory.create_agent()
    ↓
读取 system_prompt 或 system_prompt_path
    ↓
create_react_agent(model, tools, prompt=system_prompt)
```

### 3.2 路由工具提示词使用流程
```
domain/router/tools/router_tools.py
    ↓
硬编码的提示词常量（INTENT_IDENTIFICATION_PROMPT / CLARIFY_INTENT_PROMPT）
    ↓
ChatPromptTemplate.from_messages()
    ↓
LLM调用
```

### 3.3 动态提示词注入流程
```
domain/router/graph.py
    ↓
with_user_context() 包装器
    ↓
运行时根据状态构建 SystemMessage
    ↓
注入到消息列表
    ↓
传递给Agent执行
```

## 四、存在的问题

### 4.1 分散管理
- **问题**：提示词分散在多个位置（YAML配置、TXT文件、Python代码）
- **影响**：难以统一管理和维护，查找和修改提示词需要跨多个文件

### 4.2 硬编码问题
- **问题**：路由工具的提示词直接硬编码在Python代码中
- **影响**：修改提示词需要修改代码并重新部署，不支持热更新

### 4.3 缺乏统一接口
- **问题**：不同位置的提示词加载方式不一致
- **影响**：新增提示词时需要了解不同的加载机制

### 4.4 动态提示词构建逻辑分散
- **问题**：动态提示词构建逻辑分散在业务代码中
- **影响**：难以复用和维护，逻辑耦合度高

### 4.5 缺乏版本管理
- **问题**：提示词没有版本管理机制
- **影响**：无法追踪提示词变更历史，难以回滚

### 4.6 缺乏模板化支持
- **问题**：动态提示词通过字符串拼接构建
- **影响**：容易出错，难以维护，不支持复杂的模板逻辑

### 4.7 缺乏验证机制
- **问题**：提示词内容没有验证机制
- **影响**：可能包含错误或不符合规范的提示词

## 五、提示词统计

### 5.1 数量统计
- **Agent系统提示词**：2个（blood_pressure_agent, appointment_agent）
- **路由工具提示词**：2个（INTENT_IDENTIFICATION_PROMPT, CLARIFY_INTENT_PROMPT）
- **动态提示词构建函数**：1个（_build_bp_context_hint）

### 5.2 存储方式统计
- **YAML配置**：2个（与TXT文件重复）
- **TXT文件**：2个
- **Python代码常量**：2个
- **Python代码动态构建**：1个

### 5.3 使用场景统计
- **Agent初始化**：2个（Agent系统提示词）
- **路由决策**：2个（路由工具提示词）
- **运行时注入**：1个（动态提示词）

## 六、相关文件清单

### 6.1 配置文件
- `config/agents.yaml` - Agent配置（包含提示词）
- `config/prompts/blood_pressure_prompt.txt` - 血压智能体提示词文件
- `config/prompts/appointment_prompt.txt` - 预约智能体提示词文件

### 6.2 代码文件
- `domain/agents/factory.py` - Agent工厂（加载提示词）
- `domain/router/tools/router_tools.py` - 路由工具（硬编码提示词）
- `domain/router/graph.py` - 路由图构建（动态提示词注入）

### 6.3 相关文档
- `doc/设计V2.0/V2.1多轮会话设计/多轮会话设计与开发计划V2.1.md` - 包含提示词设计说明
- `cursor_docs/M2.1.2-2.1.6多轮会话功能开发总结.md` - 包含提示词更新记录

## 七、改进方向建议

### 7.1 统一管理
- 创建统一的提示词管理模块
- 所有提示词集中存储和管理
- 提供统一的加载接口

### 7.2 支持模板化
- 支持变量替换（如 {user_id}, {form_data}）
- 支持条件逻辑（如根据智能体类型选择不同模板）
- 支持模板继承和组合

### 7.3 支持热更新
- 提示词修改后无需重启服务
- 支持版本管理和回滚
- 支持A/B测试

### 7.4 增强可维护性
- 提供提示词编辑界面或工具
- 支持提示词验证和测试
- 提供提示词使用统计和效果分析

### 7.5 解耦业务逻辑
- 将动态提示词构建逻辑从业务代码中抽离
- 提供配置化的动态提示词构建规则
- 支持插件化的提示词构建器

## 八、总结

当前系统的提示词管理存在以下特点：
1. **分散存储**：提示词分布在YAML、TXT文件和Python代码中
2. **加载方式不统一**：不同位置的提示词加载方式不同
3. **硬编码问题**：路由工具提示词硬编码在代码中
4. **动态构建分散**：动态提示词构建逻辑耦合在业务代码中
5. **缺乏统一管理**：没有统一的提示词管理模块

建议设计一个统一的提示词管理模块，解决上述问题，提高系统的可维护性和可扩展性。
