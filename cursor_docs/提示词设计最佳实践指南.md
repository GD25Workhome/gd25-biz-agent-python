# 提示词设计最佳实践指南

## 一、模型提示词结构设计原则

### 1.1 对模型理解更好的结构

根据LLM的工作原理和大量实践，以下结构对模型理解效果更好：

#### ✅ **推荐结构：层次化 + 模块化 + 明确分隔**

```
【角色定义】
  ↓
【核心任务说明】
  ↓
【上下文信息】
  ↓
【功能/工具说明】
  ↓
【行为规则】
  ↓
【输出格式要求】
  ↓
【示例（Few-shot）】
```

#### 关键设计要点：

1. **清晰的层次结构**
   - 使用明确的标题和分隔符（如 `##`、`---`、`===`）
   - 每个部分职责单一，避免混合
   - 重要信息放在前面（LLM会优先关注开头）

2. **结构化标记**
   - 使用 Markdown 格式（`#`、`##`、`-`、`1.`）
   - 使用 XML 标签（`<role>`、`<instructions>`、`<format>`）
   - 使用分隔线（`---`、`===`）

3. **明确的指令语言**
   - 使用动作词：`必须`、`应该`、`可以`、`禁止`
   - 使用条件语句：`如果...则...`、`当...时...`
   - 避免模糊表达：`尽量`、`可能`、`也许`

4. **信息密度控制**
   - 关键信息重复强调（在多个位置提及）
   - 长段落拆分成短句
   - 使用列表而非长段落

### 1.2 具体结构模板

#### 模板A：标准结构（推荐用于复杂Agent）

```markdown
# 角色定义

你是一个[具体角色]，你的职责是[核心职责]。

# 上下文信息

用户ID: {{user_id}}
会话ID: {{session_id}}
当前日期: {{current_date}}

# 核心功能

## 功能1：[功能名称]
- 触发条件：[何时使用]
- 操作步骤：[具体步骤]
- 工具调用：[使用的工具]

## 功能2：[功能名称]
...

# 行为规则

## 规则1：[规则名称]
- 规则描述
- 示例场景

## 规则2：[规则名称]
...

# 输出格式要求

你的所有回复必须严格按照以下JSON格式返回：
{
    "response_content": "...",
    "reasoning_summary": "...",
    "additional_fields": {}
}

# 注意事项

1. [重要注意点1]
2. [重要注意点2]
```

#### 模板B：模块化结构（推荐用于大型提示词）

```yaml
# 使用 YAML 配置文件定义模块
modules:
  role:
    type: required
    source: modules/role.txt
    
  context:
    type: required
    source: modules/context.txt
    
  functions:
    type: business
    source: modules/functions.txt
    
  rules:
    type: business
    source: modules/rules.txt
    
  format:
    type: required
    source: modules/format.txt

composition:
  order: [role, context, functions, rules, format]
  separator: "\n\n"
```

### 1.3 结构对比分析

| 结构类型 | 优点 | 缺点 | 适用场景 |
|---------|------|------|---------|
| **单文件扁平结构** | 简单直接，易于查看 | 难以维护，难以复用 | 小型提示词（<500字） |
| **模块化结构** | 易于维护，可复用，支持热更新 | 需要额外工具支持 | 大型提示词（>1000字） |
| **层次化结构** | 逻辑清晰，易于理解 | 需要合理设计层次 | 中型提示词（500-1000字） |
| **混合结构** | 兼顾灵活性和可维护性 | 复杂度较高 | 企业级应用（推荐） |

## 二、提示词可维护性和可调优性设计

### 2.1 设计原则

#### 原则1：关注点分离（Separation of Concerns）

```
✅ 正确：将不同职责的内容分离到不同模块
- role.txt：角色定义
- functions.txt：功能说明
- rules.txt：业务规则
- format.txt：输出格式

❌ 错误：所有内容混在一个文件中
```

#### 原则2：可配置化

```yaml
# 使用配置文件控制模块启用/禁用
modules:
  rule_validation:
    enabled: true  # 可以快速开关
    condition: "{user_type == 'premium'}"  # 条件加载
    
  advanced_analysis:
    enabled: false  # 新功能可以先禁用
```

#### 原则3：版本化管理

```yaml
# 模板文件包含版本信息
version: 1.2.0
description: "血压Agent提示词模板 v1.2.0"

# 支持版本回滚和对比
```

### 2.2 目录结构设计

```
config/prompts/
├── templates/              # 模板配置文件（YAML）
│   ├── blood_pressure_agent.yaml
│   └── router_agent.yaml
│
├── modules/                # 模块化提示词文件
│   ├── blood_pressure/
│   │   ├── role.txt                    # 角色定义
│   │   ├── function_description.txt    # 功能说明
│   │   ├── data_validation.txt         # 数据验证规则
│   │   ├── clarification.txt           # 澄清机制
│   │   ├── response_format.txt         # 输出格式
│   │   ├── few_shot_examples.txt       # 示例
│   │   └── notes.txt                   # 注意事项
│   │
│   └── shared/             # 共享模块
│       ├── common_rules.txt
│       └── safety_guidelines.txt
│
└── local/                  # 本地开发/测试用提示词
    └── 素材/               # 原始素材和文档
        ├── 101-血压点评规则.md
        └── 110-血压Agent提示词.md
```

### 2.3 命名规范

#### 文件命名规范

```
✅ 推荐命名方式：
- role.txt                    # 功能明确
- data_validation.txt          # 使用下划线
- few_shot_examples.txt       # 描述清晰

❌ 不推荐：
- prompt1.txt                 # 无意义
- 规则.txt                    # 中文文件名（可能编码问题）
- validation-rules.txt        # 使用连字符（不一致）
```

#### 模块命名规范

```yaml
modules:
  # 使用语义化名称
  role:                    # 角色定义
  context:                 # 上下文信息
  function_description:    # 功能说明
  data_validation:         # 数据验证
  clarification:           # 澄清机制
  response_format:         # 输出格式
  few_shot_examples:       # 示例
  notes:                   # 注意事项
  business_rules:          # 业务规则
  safety_guidelines:       # 安全指南
```

### 2.4 注释和文档

#### 在模板文件中添加注释

```yaml
modules:
  # ========== 必需模块 ==========
  role:
    type: required
    source: modules/blood_pressure/role.txt
    enabled: true
    description: "定义Agent的角色和核心职责"
  
  # ========== 业务模块 ==========
  data_validation:
    type: business
    source: modules/blood_pressure/data_validation.txt
    enabled: true
    description: "数据完整性检查规则，需要根据业务需求定期调整"
    # 调优提示：如果发现模型经常遗漏某些字段，在这里添加明确的检查规则
```

#### 在提示词文件中添加注释

```markdown
# 角色定义

你是一个专业的血压记录助手。

# 功能说明

## 1. 记录血压
<!-- 调优点：如果用户经常混淆收缩压和舒张压，可以在这里添加更详细的说明 -->
当用户提供血压数据时，使用 record_blood_pressure 工具记录。

## 2. 查询血压
<!-- 调优点：如果查询结果不准确，可以调整查询条件的描述 -->
当用户询问血压记录时，使用 query_blood_pressure 工具查询。

# 数据验证规则

<!-- 重要调优点：这是最常需要调整的部分 -->
记录血压需要的信息：
- 收缩压（systolic）：必填
- 舒张压（diastolic）：必填
- 心率（heart_rate）：可选
- 记录时间（record_time）：可选，默认为当前时间

<!-- 调优提示：如果发现模型经常接受不完整数据，可以在这里添加更严格的验证规则 -->
```

### 2.5 调优标记系统

#### 使用标记标识调优点

```markdown
# 业务规则

## 规则1：血压达标判断
<!-- [调优点-001] 血压达标标准，需要根据医学指南定期更新 -->
- 达标标准：90 <= 收缩压 <= 目标值 且 舒张压 <= 目标值
- 如果标准变更，需要更新此规则

## 规则2：预警阈值
<!-- [调优点-002] 预警阈值，需要根据临床反馈调整 -->
- 收缩压 >= 180 或 舒张压 >= 110：重度偏高（需预警）
- 如果误报率过高，可以适当提高阈值

## 规则3：趋势分析
<!-- [调优点-003] 趋势分析逻辑，需要根据数据质量调整 -->
- 数据量要求：14天中数据天数 >= 6天
- 如果数据质量改善，可以降低数据量要求
```

#### 创建调优点索引文档

```markdown
# 提示词调优点索引

## blood_pressure_agent 调优点

| 调优点ID | 位置 | 描述 | 调优频率 | 最后更新 |
|---------|------|------|---------|---------|
| 001 | data_validation.txt | 血压达标标准 | 季度 | 2024-01-15 |
| 002 | notes.txt | 预警阈值 | 月度 | 2024-02-01 |
| 003 | clarification.txt | 澄清话术 | 周度 | 2024-02-10 |

## 调优建议

1. **调优点-001**：如果发现模型判断不准确，检查达标标准是否与最新医学指南一致
2. **调优点-002**：如果误报率 > 5%，考虑提高预警阈值
3. **调优点-003**：根据用户反馈调整澄清话术，使其更友好自然
```

### 2.6 版本控制和变更追踪

#### 在模块文件中添加版本信息

```markdown
# 数据验证规则
# 版本：v1.2.0
# 最后更新：2024-02-15
# 更新说明：添加了心率范围验证

记录血压需要的信息：
- 收缩压（systolic）：必填，范围 40-300
- 舒张压（diastolic）：必填，范围 20-200
- 心率（heart_rate）：可选，范围 30-220
  <!-- v1.2.0 新增：心率范围验证 -->
```

#### 使用变更日志

```markdown
# CHANGELOG.md

## [1.2.0] - 2024-02-15

### 修改
- `data_validation.txt`: 添加心率范围验证（30-220）
- `clarification.txt`: 优化澄清话术，使其更友好

### 新增
- `few_shot_examples.txt`: 添加心率异常场景示例

## [1.1.0] - 2024-01-20

### 修改
- `notes.txt`: 更新预警阈值（收缩压 >= 180）
```

## 三、实际应用建议

### 3.1 大型提示词改造步骤

#### 步骤1：分析现有提示词

```python
# 分析提示词结构
1. 识别核心职责
2. 识别功能模块
3. 识别业务规则
4. 识别输出格式要求
```

#### 步骤2：拆分模块

```
原始提示词（单文件）
  ↓
拆分成模块：
  - role.txt
  - functions.txt
  - rules.txt
  - format.txt
  - examples.txt
```

#### 步骤3：创建模板配置

```yaml
# templates/blood_pressure_agent.yaml
agent_key: blood_pressure_agent
version: 1.0.0

modules:
  role:
    type: required
    source: modules/blood_pressure/role.txt
    
  functions:
    type: business
    source: modules/blood_pressure/function_description.txt
    
  # ... 其他模块

composition:
  order: [role, functions, ...]
  separator: "\n\n"
```

#### 步骤4：添加调优标记

```markdown
# 在每个模块文件中添加调优标记
<!-- [调优点-XXX] 描述 -->
```

### 3.2 调优工作流程

```
1. 发现问题
   ↓
2. 定位调优点（使用调优点索引）
   ↓
3. 修改对应模块文件
   ↓
4. 更新版本号和变更日志
   ↓
5. 测试验证
   ↓
6. 部署（热更新）
```

### 3.3 最佳实践总结

#### ✅ 推荐做法

1. **使用模块化结构**：将大型提示词拆分成多个模块
2. **使用配置文件**：通过 YAML 管理模块组合
3. **添加调优标记**：在关键位置添加 `<!-- [调优点-XXX] -->` 注释
4. **版本化管理**：每个模块包含版本信息和变更说明
5. **创建索引文档**：维护调优点索引，方便快速定位
6. **使用语义化命名**：文件名和模块名清晰表达功能

#### ❌ 避免做法

1. **避免单文件巨型提示词**：超过 1000 字的提示词应该拆分
2. **避免硬编码**：不要在提示词中硬编码具体数值，使用变量
3. **避免重复内容**：相同内容应该提取到共享模块
4. **避免无注释**：关键逻辑必须添加注释说明
5. **避免混乱命名**：使用统一的命名规范

## 四、示例：血压Agent提示词改造

### 4.1 改造前（单文件结构）

```markdown
你是一个专业的血压记录助手。你的职责是帮助用户记录、查询和管理血压数据。

用户ID: {{user_id}}
会话ID: {{session_id}}
当前日期: {{current_date}}

正常血压范围: {{normal_range}}
测量时间格式: {{measurement_time_format}}

功能说明：
1. 记录血压：当用户提供血压数据（收缩压、舒张压、心率等）时，使用 record_blood_pressure 工具记录
2. 查询血压：当用户询问血压记录时，使用 query_blood_pressure 工具查询
3. 更新血压：当用户需要修改已记录的血压数据时，使用 update_blood_pressure 工具更新

多轮对话支持：
- 如果用户提供的信息不完整（例如只提供了收缩压，缺少舒张压），你应该主动询问缺失的信息
- 如果用户提供的信息有歧义（例如时间不明确），你应该友好地澄清
- 在对话过程中，要理解上下文，记住之前提到的信息
- 当收集到完整信息后，立即使用相应的工具执行操作

数据完整性检查：
- 记录血压需要的信息：收缩压（systolic）、舒张压（diastolic）
- 可选信息：心率（heart_rate）、记录时间（record_time）、备注（notes）
- 如果缺少必要信息，不要调用工具，而是询问用户

澄清机制：
- 如果用户提供的信息不完整或有歧义，主动询问
- 使用友好的语言，例如："请问您的舒张压是多少？" 而不是 "缺少舒张压"
- 一次只询问一个缺失的信息，避免一次性问太多问题

注意事项：
- 血压的正常范围：{{normal_range}}
- 如果用户提供的血压值异常，应该提醒用户注意
- 记录时间默认为当前时间，如果用户指定了时间，请使用用户指定的时间
- 回答要简洁、专业、友好
- 在对话中保持上下文连贯性，理解用户的多轮回复

返回结果格式要求：
你的所有回复必须严格按照以下JSON格式返回：
{
    "response_content": "你的回复内容（直接面向用户的文本）",
    "reasoning_summary": "你的推理过程小结（简要说明你的思考过程和决策依据）",
    "additional_fields": {
        "key1": "value1",
        "key2": "value2"
    }
}

字段说明：
1. response_content（回复内容，必填）
   - 这是直接返回给用户的文本内容
   - 应该简洁、专业、友好
   - 不要包含技术细节或内部推理过程

2. reasoning_summary（推理小结，必填）
   - 简要说明你的思考过程和决策依据
   - 例如：为什么选择这个工具、如何理解用户意图、如何处理不完整信息等
   - 长度控制在50-200字之间

3. additional_fields（其它字段，可选）
   - 用于存储额外的结构化信息
   - 例如：识别的实体、提取的关键信息、工具调用结果等
   - 如果不需要额外字段，可以设置为空对象 {}

重要规则：
- 必须严格按照JSON格式返回，不要返回纯文本
- 必须包含 response_content 和 reasoning_summary 两个字段
- response_content 应该是用户可以直接阅读的自然语言文本
- reasoning_summary 应该简洁明了，说明你的思考过程
- 如果使用了工具，可以在 additional_fields 中记录工具调用信息
```

### 4.2 改造后（模块化结构）

#### 模板配置文件

```yaml
# templates/blood_pressure_agent.yaml
agent_key: blood_pressure_agent
version: 1.0.0
description: "血压记录智能体提示词模板"

modules:
  # ========== 必需模块 ==========
  role:
    type: required
    loader: config
    source: config/prompts/modules/blood_pressure/role.txt
    enabled: true
    description: "定义Agent的角色和核心职责"
  
  function_description:
    type: business
    loader: config
    source: config/prompts/modules/blood_pressure/function_description.txt
    enabled: true
    description: "功能说明，包括记录、查询、更新血压"
  
  data_validation:
    type: business
    loader: config
    source: config/prompts/modules/blood_pressure/data_validation.txt
    enabled: true
    description: "数据完整性检查规则 [调优点-001]"
  
  clarification:
    type: business
    loader: config
    source: config/prompts/modules/blood_pressure/clarification.txt
    enabled: true
    description: "澄清机制和话术 [调优点-002]"
  
  response_format:
    type: required
    loader: config
    source: config/prompts/modules/blood_pressure/response_format.txt
    enabled: true
    description: "输出格式要求"
  
  # ========== 动态模块 ==========
  user_context:
    type: optional
    loader: dynamic
    source: runtime
    enabled: true
    condition: "{user_id is not None}"
    template: |
      用户ID: {user_id}
      会话ID: {session_id}
      当前日期: {current_date}
      正常血压范围: {normal_range}
  
  # ========== 可选模块 ==========
  few_shot_examples:
    type: optional
    loader: config
    source: config/prompts/modules/blood_pressure/few_shot_examples.txt
    enabled: true
    description: "Few-shot示例，用于提升模型理解"
  
  notes:
    type: business
    loader: config
    source: config/prompts/modules/blood_pressure/notes.txt
    enabled: true
    description: "注意事项和业务规则 [调优点-003]"

composition:
  order:
    - role
    - function_description
    - data_validation
    - clarification
    - response_format
    - user_context
    - few_shot_examples
    - notes
  separator: "\n\n"
```

#### 模块文件示例

```markdown
# modules/blood_pressure/data_validation.txt
# 版本：v1.0.0
# 最后更新：2024-02-15
# 调优点：001

# 数据完整性检查规则

<!-- [调优点-001] 数据验证规则，如果发现模型经常接受不完整数据，需要在这里添加更严格的验证规则 -->

## 必填字段
记录血压需要的信息：
- 收缩压（systolic）：必填，范围 40-300
- 舒张压（diastolic）：必填，范围 20-200

## 可选字段
- 心率（heart_rate）：可选，范围 30-220
- 记录时间（record_time）：可选，默认为当前时间
- 备注（notes）：可选

## 验证规则
- 如果缺少必要信息，不要调用工具，而是询问用户
- 如果数值超出合理范围，应该提醒用户确认
```

```markdown
# modules/blood_pressure/clarification.txt
# 版本：v1.0.0
# 最后更新：2024-02-15
# 调优点：002

# 澄清机制

<!-- [调优点-002] 澄清话术，需要根据用户反馈定期优化，使其更友好自然 -->

## 澄清原则
- 如果用户提供的信息不完整或有歧义，主动询问
- 使用友好的语言，例如："请问您的舒张压是多少？" 而不是 "缺少舒张压"
- 一次只询问一个缺失的信息，避免一次性问太多问题

## 多轮对话支持
- 在对话过程中，要理解上下文，记住之前提到的信息
- 当收集到完整信息后，立即使用相应的工具执行操作
```

## 五、总结

### 5.1 核心要点

1. **结构设计**：使用层次化 + 模块化结构，对模型理解效果更好
2. **可维护性**：通过模块化、配置文件、版本控制实现
3. **可调优性**：通过调优标记、索引文档、变更日志实现

### 5.2 实施建议

1. **渐进式改造**：不要一次性改造所有提示词，先选择一个进行试点
2. **建立规范**：制定团队统一的提示词编写规范
3. **工具支持**：利用现有的 PromptManager 实现模块化加载
4. **持续优化**：根据使用反馈不断优化提示词结构

### 5.3 参考资源

- 项目现有模块化提示词：`config/prompts/modules/`
- 提示词管理器：`infrastructure/prompts/manager.py`
- 模板加载器：`infrastructure/prompts/loader.py`
