# 数据记录功能设计文档

## 1. 概述

本文档描述药品记录、症状信息、健康事件三个数据记录功能的数据库存储逻辑和工具代码设计。设计参考血压记录（`BloodPressureRecord`）的实现模式，保持代码风格和架构一致性。

### 1.1 功能范围

- **药品记录**：记录患者的用药信息
- **症状信息**：记录患者的症状及恢复状态
- **健康事件**：记录患者的健康行为打卡

### 1.2 设计原则

1. **一致性**：参考血压记录的实现模式，保持代码风格统一
2. **简洁性**：每个表提供记录和查询两个核心工具（暂不提供更新功能）
3. **可扩展性**：使用仓储模式，便于后续扩展功能

## 2. 数据库模型设计

### 2.1 药品记录模型（MedicationRecord）

**表名**：`gd2502_medication_records`

**字段设计**：

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | String(50) | PK, Index | 记录ID（ULID） |
| user_id | String(50) | NOT NULL, Index | 用户ID |
| medication_name | String(200) | NOT NULL | 药品名称（冗余字段，便于查询和显示） |
| medication_time | DateTime(timezone=True) | NULL, Index | 用药时间（可选，不提供则使用当前时间） |
| dosage | Integer | NOT NULL | 每次服用剂量（如：2） |
| dosage_unit | String(50) | NOT NULL | 剂量单位（如：片、粒、ml、mg等） |
| notes | Text | NULL | 备注（可选） |
| created_at | DateTime(timezone=True) | NOT NULL | 创建时间（自动生成） |
| updated_at | DateTime(timezone=True) | NULL | 更新时间（自动更新） |

**模型类**：`backend.infrastructure.database.models.medication.MedicationRecord`

### 2.2 症状信息模型（SymptomRecord）

**表名**：`gd2502_symptom_records`

**字段设计**：

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | String(50) | PK, Index | 记录ID（ULID） |
| user_id | String(50) | NOT NULL, Index | 用户ID |
| symptom_name | String(200) | NOT NULL | 症状名 |
| record_time | DateTime(timezone=True) | NULL, Index | 症状记录时间（可选，不提供则使用当前时间） |
| recovery_status | String(20) | NOT NULL | 是否已经痊愈（枚举：新记录、老记录、痊愈） |
| notes | Text | NULL | 备注（可选） |
| created_at | DateTime(timezone=True) | NOT NULL | 创建时间（自动生成） |
| updated_at | DateTime(timezone=True) | NULL | 更新时间（自动更新） |

**模型类**：`backend.infrastructure.database.models.symptom.SymptomRecord`

**恢复状态枚举值**：
- `新记录`：刚记录的新症状
- `老记录`：持续存在的症状
- `痊愈`：症状已痊愈

### 2.3 健康事件模型（HealthEventRecord）

**表名**：`gd2502_health_event_records`

**字段设计**：

| 字段名 | 类型 | 约束 | 说明 |
|--------|------|------|------|
| id | String(50) | PK, Index | 记录ID（ULID） |
| user_id | String(50) | NOT NULL, Index | 用户ID |
| event_type | String(100) | NOT NULL | 健康事件类型（如：少吃盐、运动、心情放松、睡眠良好） |
| check_in_time | DateTime(timezone=True) | NULL, Index | 打卡时间（可选，不提供则使用当前时间） |
| notes | Text | NULL | 备注（可选） |
| created_at | DateTime(timezone=True) | NOT NULL | 创建时间（自动生成） |
| updated_at | DateTime(timezone=True) | NULL | 更新时间（自动更新） |

**模型类**：`backend.infrastructure.database.models.health_event.HealthEventRecord`

## 3. 仓储类设计

### 3.1 药品记录仓储（MedicationRepository）

**类路径**：`backend.infrastructure.database.repository.medication_repository.MedicationRepository`

**继承**：`BaseRepository[MedicationRecord]`

**自定义方法**：

1. `get_by_user_id(user_id: str, limit: int = 100, offset: int = 0) -> List[MedicationRecord]`
   - 根据用户ID查询药品记录
   - 按用药时间倒序排列

2. `get_by_date_range(user_id: str, start_date: datetime, end_date: datetime) -> List[MedicationRecord]`
   - 根据日期范围查询药品记录
   - 按用药时间倒序排列

3. `get_recent_by_user_id(user_id: str, days: int = 14, start_date: Optional[datetime] = None, end_date: Optional[datetime] = None) -> List[MedicationRecord]`
   - 获取用户最近N天的药品记录（默认14天，最大14天）
   - 支持日期范围查询
   - 逻辑参考 `BloodPressureRepository.get_recent_by_user_id`

### 3.2 症状信息仓储（SymptomRepository）

**类路径**：`backend.infrastructure.database.repository.symptom_repository.SymptomRepository`

**继承**：`BaseRepository[SymptomRecord]`

**自定义方法**：

1. `get_by_user_id(user_id: str, limit: int = 100, offset: int = 0) -> List[SymptomRecord]`
   - 根据用户ID查询症状记录
   - 按记录时间倒序排列

2. `get_by_date_range(user_id: str, start_date: datetime, end_date: datetime) -> List[SymptomRecord]`
   - 根据日期范围查询症状记录
   - 按记录时间倒序排列

3. `get_recent_by_user_id(user_id: str, days: int = 14, start_date: Optional[datetime] = None, end_date: Optional[datetime] = None) -> List[SymptomRecord]`
   - 获取用户最近N天的症状记录（默认14天，最大14天）
   - 支持日期范围查询

4. `get_by_recovery_status(user_id: str, recovery_status: str) -> List[SymptomRecord]`
   - 根据恢复状态查询症状记录
   - 按记录时间倒序排列

### 3.3 健康事件仓储（HealthEventRepository）

**类路径**：`backend.infrastructure.database.repository.health_event_repository.HealthEventRepository`

**继承**：`BaseRepository[HealthEventRecord]`

**自定义方法**：

1. `get_by_user_id(user_id: str, limit: int = 100, offset: int = 0) -> List[HealthEventRecord]`
   - 根据用户ID查询健康事件记录
   - 按打卡时间倒序排列

2. `get_by_date_range(user_id: str, start_date: datetime, end_date: datetime) -> List[HealthEventRecord]`
   - 根据日期范围查询健康事件记录
   - 按打卡时间倒序排列

3. `get_recent_by_user_id(user_id: str, days: int = 14, start_date: Optional[datetime] = None, end_date: Optional[datetime] = None) -> List[HealthEventRecord]`
   - 获取用户最近N天的健康事件记录（默认14天，最大14天）
   - 支持日期范围查询

4. `get_by_event_type(user_id: str, event_type: str) -> List[HealthEventRecord]`
   - 根据事件类型查询健康事件记录
   - 按打卡时间倒序排列

## 4. 工具设计

### 4.1 药品记录工具

**文件路径**：`backend.domain.tools.medication`

**工具函数**：

#### 4.1.1 record_medication

```python
@register_tool
async def record_medication(
    medication_name: str,
    dosage: int,
    dosage_unit: str,
    medication_time: Optional[str] = None,
    notes: Optional[str] = None
) -> str
```

**功能**：记录药品服用信息

**参数**：
- `medication_name`: 药品名称（必填）
- `dosage`: 每次服用剂量（必填，整数）
- `dosage_unit`: 剂量单位（必填，如：片、粒、ml、mg等）
- `medication_time`: 用药时间（可选，格式：YYYY-MM-DD 或 YYYY-MM-DD HH:MM，不提供则使用当前时间）
- `notes`: 备注（可选）

**返回**：记录结果的文本描述

**实现要点**：
- 从运行时上下文获取 `token_id`（用户ID）
- 解析时间格式（使用 `parse_datetime` 辅助函数）
- 创建记录并提交事务
- 生成友好的回复文本

#### 4.1.2 query_medication

```python
@register_tool
async def query_medication(
    days: Optional[int] = None,
    start_date: Optional[str] = None,
    end_date: Optional[str] = None
) -> str
```

**功能**：查询药品记录

**参数**：
- `days`: 查询天数（默认14天，最大14天）
- `start_date`: 开始日期（格式：YYYY-MM-DD，可选）
- `end_date`: 结束日期（格式：YYYY-MM-DD，可选，默认为当前日期）

**返回**：药品记录列表的文本描述（格式化输出）

**实现要点**：
- 支持按天数查询和按日期范围查询
- 格式化输出，包含时间、药品名称、剂量、单位、备注等信息
- 如果没有记录，返回友好提示

### 4.2 症状信息工具

**文件路径**：`backend.domain.tools.symptom`

**工具函数**：

#### 4.2.1 record_symptom

```python
@register_tool
async def record_symptom(
    symptom_name: str,
    recovery_status: str,
    record_time: Optional[str] = None,
    notes: Optional[str] = None
) -> str
```

**功能**：记录症状信息

**参数**：
- `symptom_name`: 症状名（必填）
- `recovery_status`: 是否已经痊愈（必填，枚举值：新记录、老记录、痊愈）
- `record_time`: 症状记录时间（可选，格式：YYYY-MM-DD 或 YYYY-MM-DD HH:MM，不提供则使用当前时间）
- `notes`: 备注（可选）

**返回**：记录结果的文本描述

**实现要点**：
- 验证 `recovery_status` 是否为有效枚举值
- 其他实现要点同 `record_medication`

#### 4.2.2 query_symptom

```python
@register_tool
async def query_symptom(
    days: Optional[int] = None,
    start_date: Optional[str] = None,
    end_date: Optional[str] = None,
    recovery_status: Optional[str] = None
) -> str
```

**功能**：查询症状记录

**参数**：
- `days`: 查询天数（默认14天，最大14天）
- `start_date`: 开始日期（格式：YYYY-MM-DD，可选）
- `end_date`: 结束日期（格式：YYYY-MM-DD，可选，默认为当前日期）
- `recovery_status`: 恢复状态过滤（可选，枚举值：新记录、老记录、痊愈）

**返回**：症状记录列表的文本描述（格式化输出）

**实现要点**：
- 支持按恢复状态过滤
- 格式化输出，包含时间、症状名、恢复状态、备注等信息

### 4.3 健康事件工具

**文件路径**：`backend.domain.tools.health_event`

**工具函数**：

#### 4.3.1 record_health_event

```python
@register_tool
async def record_health_event(
    event_type: str,
    check_in_time: Optional[str] = None,
    notes: Optional[str] = None
) -> str
```

**功能**：记录健康事件打卡

**参数**：
- `event_type`: 健康事件类型（必填，如：少吃盐、运动、心情放松、睡眠良好）
- `check_in_time`: 打卡时间（可选，格式：YYYY-MM-DD 或 YYYY-MM-DD HH:MM，不提供则使用当前时间）
- `notes`: 备注（可选）

**返回**：记录结果的文本描述

**实现要点**：
- 其他实现要点同 `record_medication`

#### 4.3.2 query_health_event

```python
@register_tool
async def query_health_event(
    days: Optional[int] = None,
    start_date: Optional[str] = None,
    end_date: Optional[str] = None,
    event_type: Optional[str] = None
) -> str
```

**功能**：查询健康事件记录

**参数**：
- `days`: 查询天数（默认14天，最大14天）
- `start_date`: 开始日期（格式：YYYY-MM-DD，可选）
- `end_date`: 结束日期（格式：YYYY-MM-DD，可选，默认为当前日期）
- `event_type`: 事件类型过滤（可选，如：少吃盐、运动、心情放松、睡眠良好）

**返回**：健康事件记录列表的文本描述（格式化输出）

**实现要点**：
- 支持按事件类型过滤
- 格式化输出，包含时间、事件类型、备注等信息

## 5. 实现计划

### 5.1 文件清单

#### 数据库模型文件
1. `backend/infrastructure/database/models/medication.py` - 药品记录模型
2. `backend/infrastructure/database/models/symptom.py` - 症状信息模型
3. `backend/infrastructure/database/models/health_event.py` - 健康事件模型
4. `backend/infrastructure/database/models/__init__.py` - 更新模型导出

#### 仓储文件
1. `backend/infrastructure/database/repository/medication_repository.py` - 药品记录仓储
2. `backend/infrastructure/database/repository/symptom_repository.py` - 症状信息仓储
3. `backend/infrastructure/database/repository/health_event_repository.py` - 健康事件仓储

#### 工具文件
1. `backend/domain/tools/medication.py` - 药品记录工具
2. `backend/domain/tools/symptom.py` - 症状信息工具
3. `backend/domain/tools/health_event.py` - 健康事件工具

### 5.2 实现步骤

1. **创建数据库模型**
   - 创建三个模型文件
   - 更新 `models/__init__.py` 导出新模型
   - 创建 Alembic 迁移文件

2. **创建仓储类**
   - 创建三个仓储文件
   - 实现自定义查询方法

3. **创建工具函数**
   - 创建三个工具文件
   - 实现记录和查询工具
   - 使用 `@register_tool` 装饰器注册工具

4. **测试验证**
   - 测试数据库模型创建
   - 测试仓储方法
   - 测试工具函数调用

### 5.3 注意事项

1. **时间处理**：
   - 所有时间字段支持多种格式（YYYY-MM-DD、YYYY-MM-DD HH:MM、YYYY-MM-DD HH:MM:SS）
   - 使用 `parse_datetime` 辅助函数解析时间
   - 如果不提供时间，使用当前时间

2. **用户ID获取**：
   - 使用 `get_token_id()` 从运行时上下文获取用户ID
   - 如果获取失败，返回错误提示

3. **错误处理**：
   - 所有数据库操作使用 try-except 包裹
   - 失败时回滚事务并返回友好错误信息
   - 记录错误日志

4. **查询限制**：
   - 查询天数默认14天，最大14天
   - 日期范围查询也限制在14天内

5. **代码风格**：
   - 参考 `blood_pressure.py` 的代码风格
   - 使用中文注释和文档字符串
   - 保持代码格式一致

## 6. 参考实现

- 数据库模型参考：`backend/infrastructure/database/models/blood_pressure.py`
- 仓储实现参考：`backend/infrastructure/database/repository/blood_pressure_repository.py`
- 工具实现参考：`backend/domain/tools/blood_pressure.py`
