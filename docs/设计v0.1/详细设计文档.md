# GD25 Biz Agent Python 详细设计文档 (v0.1)

## 1. 模块设计

### 1.1 应用层 (app)
- **API (app/api)**: 使用 FastAPI 实现，提供 `/api/v1/chat` 接口。
- **配置 (app/core/config.py)**: 基于 `pydantic-settings` 加载环境变量，支持 `.env` 文件。
- **Schema (app/schemas)**: 定义请求和响应的数据模型 (Pydantic)。

### 1.2 领域层 (domain)
- **Agent 基类 (domain/agents/base.py)**:
  - `BaseAgent`: 抽象基类，负责加载配置、初始化 LLM 和 Tools。
  - `ReactAgent`: 具体实现，使用 `create_react_agent` 构建 ReAct 模式的智能体。
  - **设计模式**: 工厂模式 + 策略模式。
- **路由 (domain/router)**:
  - `Supervisor`: 使用 LangGraph `StateGraph` 实现。
  - **逻辑**: Supervisor 节点调用 LLM 判断下一步意图，分发给 `BloodPressureAgent` 或 `DiagnosisAgent`，或者结束对话。
- **状态 (domain/router/state.py)**:
  - `RouterState`: 定义全局状态，包含 `messages` (消息历史) 和 `next_agent` (下一跳)。

### 1.3 基础设施层 (infrastructure)
- **数据库 (infrastructure/database)**: 使用 `SQLAlchemy` (Async) + `alembic`。
- **LLM (infrastructure/llm)**: 封装 `langchain_openai.ChatOpenAI`，统一管理 API Key 和 Model 配置。
- **RAG (infrastructure/rag)**:
  - **Embedding**: 支持本地模型 (`HuggingFaceEmbeddings`) 和远程 API (`OpenAIEmbeddings`) 双模式切换。默认使用 `moka-ai/m3e-base` (768维)。
  - **VectorStore**: 基于 `pgvector` 的 PostgreSQL 向量存储，支持余弦相似度检索。

## 2. 核心流程

### 2.1 对话流程
1. 用户发送请求至 `/api/v1/chat`。
2. API 层封装 `RouterState`，包含用户消息。
3. `create_workflow` 创建 LangGraph 图实例。
4. **Supervisor Node** 接收消息，Prompt 让 LLM 决定下一个 Worker。
5. 根据 LLM 输出：
   - 若包含 "BloodPressure"，路由至 `BloodPressureAgent`。
   - 若包含 "Diagnosis"，路由至 `DiagnosisAgent` (Mock)。
   - 若为 "FINISH"，结束流程。
6. Agent 执行完毕后，返回结果给 Supervisor (循环)。
7. 最终响应返回给 API 层。

## 3. 扩展性设计
- **新增 Agent**: 只需继承 `BaseAgent`，在 `config/agents.yaml` 中添加配置，并在 `supervisor.py` 中注册节点。
- **新增 Tool**: 实现 `BaseTool` 并在 Agent 初始化时注入。
- **配置化**: 核心参数均通过 `.env` 或 YAML 配置，无需修改代码。
